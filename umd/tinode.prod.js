!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.tinode=t():e.tinode=t()}(this,function(){return function(){"use strict";var e={767:function(e){const t="text/x-drafty-fr",s=["act","height","duration","incoming","mime","name","premime","preref","preview","ref","size","state","url","val","width"],i=new Intl.Segmenter,r=[{name:"ST",start:/(?:^|[\W_])(\*)[^\s*]/,end:/[^\s*](\*)(?=$|[\W_])/},{name:"EM",start:/(?:^|\W)(_)[^\s_]/,end:/[^\s_](_)(?=$|\W)/},{name:"DL",start:/(?:^|[\W_])(~)[^\s~]/,end:/[^\s~](~)(?=$|[\W_])/},{name:"CO",start:/(?:^|\W)(`)[^`]/,end:/[^`](`)(?=$|\W)/}],n=["QQ"],a=[{name:"LN",dataName:"url",pack:function(e){return/^[a-z]+:\/\//i.test(e)||(e="http://"+e),{url:e}},re:/(?:(?:https?|ftp):\/\/|www\.|ftp\.)[-A-Z0-9+&@#\/%=~_|$?!:,.]*[A-Z0-9+&@#\/%=~_|$]/gi},{name:"MN",dataName:"val",pack:function(e){return{val:e.slice(1)}},re:/\B@([\p{L}\p{N}][._\p{L}\p{N}]*[\p{L}\p{N}])/gu},{name:"HT",dataName:"val",pack:function(e){return{val:e.slice(1)}},re:/\B#([\p{L}\p{N}][._\p{L}\p{N}]*[\p{L}\p{N}])/gu}],o={AU:{html_tag:"audio",md_tag:void 0,isVoid:!1},BN:{html_tag:"button",md_tag:void 0,isVoid:!1},BR:{html_tag:"br",md_tag:"\n",isVoid:!0},CO:{html_tag:"tt",md_tag:"`",isVoid:!1},DL:{html_tag:"del",md_tag:"~",isVoid:!1},EM:{html_tag:"i",md_tag:"_",isVoid:!1},EX:{html_tag:"",md_tag:void 0,isVoid:!0},FM:{html_tag:"div",md_tag:void 0,isVoid:!1},HD:{html_tag:"",md_tag:void 0,isVoid:!1},HL:{html_tag:"span",md_tag:void 0,isVoid:!1},HT:{html_tag:"a",md_tag:void 0,isVoid:!1},IM:{html_tag:"img",md_tag:void 0,isVoid:!1},LN:{html_tag:"a",md_tag:void 0,isVoid:!1},MN:{html_tag:"a",md_tag:void 0,isVoid:!1},RW:{html_tag:"div",md_tag:void 0,isVoid:!1},QQ:{html_tag:"div",md_tag:void 0,isVoid:!1},ST:{html_tag:"b",md_tag:"*",isVoid:!1},VC:{html_tag:"div",md_tag:void 0,isVoid:!1},VD:{html_tag:"video",md_tag:void 0,isVoid:!1}};function c(e,t,s){if(!e)return null;try{const s=atob(e),i=s.length,r=new ArrayBuffer(i),n=new Uint8Array(r);for(let e=0;e<i;e++)n[e]=s.charCodeAt(e);return URL.createObjectURL(new Blob([r],{type:t}))}catch(e){s&&s("Drafty: failed to convert object.",e.message)}return null}function h(e,t){return e?"data:"+(t=t||"image/jpeg")+";base64,"+e:null}const d={ST:{open:e=>"<b>",close:e=>"</b>"},EM:{open:e=>"<i>",close:e=>"</i>"},DL:{open:e=>"<del>",close:e=>"</del>"},CO:{open:e=>"<tt>",close:e=>"</tt>"},BR:{open:e=>"<br/>",close:e=>""},HD:{open:e=>"",close:e=>""},HL:{open:e=>'<span style="color:teal">',close:e=>"</span>"},LN:{open:e=>'<a href="'+e.url+'">',close:e=>"</a>",props:e=>e?{href:e.url,target:"_blank"}:null},MN:{open:e=>'<a href="#'+e.val+'">',close:e=>"</a>",props:e=>e?{id:e.val}:null},HT:{open:e=>'<a href="#'+e.val+'">',close:e=>"</a>",props:e=>e?{id:e.val}:null},BN:{open:e=>"<button>",close:e=>"</button>",props:e=>e?{"data-act":e.act,"data-val":e.val,"data-name":e.name,"data-ref":e.ref}:null},AU:{open:e=>'<audio controls src="'+(e.ref||c(e.val,e.mime,l.logger))+'">',close:e=>"</audio>",props:e=>e?{src:e.ref||c(e.val,e.mime,l.logger),"data-preload":e.ref?"metadata":"auto","data-duration":e.duration,"data-name":e.name,"data-size":e.val?.75*e.val.length|0:0|e.size,"data-mime":e.mime}:null},IM:{open:e=>{const t=h(e._tempPreview,e.mime),s=c(e.val,e.mime,l.logger),i=e.ref||s;return(e.name?'<a href="'+i+'" download="'+e.name+'">':"")+'<img src="'+(t||s)+'"'+(e.width?' width="'+e.width+'"':"")+(e.height?' height="'+e.height+'"':"")+' border="0" />'},close:e=>e.name?"</a>":"",props:e=>e?{src:h(e._tempPreview,e.mime)||e.ref||c(e.val,e.mime,l.logger),title:e.name,alt:e.name,"data-width":e.width,"data-height":e.height,"data-name":e.name,"data-size":e.ref?0|e.size:e.val?.75*e.val.length|0:0|e.size,"data-mime":e.mime}:null},FM:{open:e=>"<div>",close:e=>"</div>"},RW:{open:e=>"<div>",close:e=>"</div>"},QQ:{open:e=>"<div>",close:e=>"</div>",props:e=>e?{}:null},VC:{open:e=>"<div>",close:e=>"</div>",props:e=>e?{"data-duration":e.duration,"data-state":e.state}:{}},VD:{open:e=>{const t=h(e._tempPreview,e.mime),s=e.ref||c(e.preview,e.premime||"image/jpeg",l.logger);return'<img src="'+(t||s)+'"'+(e.width?' width="'+e.width+'"':"")+(e.height?' height="'+e.height+'"':"")+' border="0" />'},close:e=>"",props:e=>{if(!e)return null;const t=e.preref||c(e.preview,e.premime||"image/jpeg",l.logger);return{src:t,"data-src":e.ref||c(e.val,e.mime,l.logger),"data-width":e.width,"data-height":e.height,"data-preload":e.ref?"metadata":"auto","data-preview":t,"data-duration":0|e.duration,"data-name":e.name,"data-size":e.ref?0|e.size:e.val?.75*e.val.length|0:0|e.size,"data-mime":e.mime}}}},l=function(){this.txt="",this.fmt=[],this.ent=[]};function u(e,t,s,i){const r=[];if(0==i.length)return[];for(let s in i){const n=i[s];n.at>t&&r.push({txt:e.slice(t,n.at)});const a={tp:n.tp},o=u(e,n.at+1,n.end,n.children);o.length>0?a.children=o:a.txt=n.txt,r.push(a),t=n.end+1}return t<s&&r.push({txt:e.slice(t,s)}),r}function p(e){if(0==e.length)return[];const t=[e[0]];let s=e[0];for(let i=1;i<e.length;i++)e[i].at>s.end?(t.push(e[i]),s=e[i]):e[i].end<=s.end&&s.children.push(e[i]);for(let e in t)t[e].children=p(t[e].children);return t}function g(e){if(!e)return null;e="string"==typeof e?{txt:e}:e;let{txt:t,fmt:s,ent:i}=e;if(t=t||"",Array.isArray(i)||(i=[]),!Array.isArray(s)||0==s.length){if(0==i.length)return{text:t};s=[{at:0,len:0,key:0}]}const r=[],a=[];s.forEach(e=>{if(!e||"object"!=typeof e)return;if(!["undefined","number"].includes(typeof e.at))return;if(!["undefined","number"].includes(typeof e.len))return;let s=0|e.at,n=0|e.len;if(n<0)return;let o=e.key||0;i.length>0&&("number"!=typeof o||o<0||o>=i.length)||(s<=-1?a.push({start:-1,end:0,key:o}):s+n>R(t).length||(e.tp?r.push({type:e.tp,start:s,end:s+n}):i.length>0&&"object"==typeof i[o]&&r.push({start:s,end:s+n,key:o})))}),r.sort((e,t)=>{let s=e.start-t.start;return 0!=s?s:(s=t.end-e.end,0!=s?s:n.indexOf(t.type)-n.indexOf(e.type))}),a.length>0&&r.push(...a),r.forEach(e=>{i.length>0&&!e.type&&i[e.key]&&"object"==typeof i[e.key]&&(e.type=i[e.key].tp,e.data=i[e.key].data),e.type||(e.type="HD")});const o=R(t);let c=f({},o,0,o.length,r);return c=b(c,function(e){if(Array.isArray(e.children)&&1==e.children.length){const t=e.children[0];if(e.type)t.type||t.children||(e.text=t.text,delete e.children);else{const s=e.parent;(e=t).parent=s}}return e}),c}function m(e,t){return t?(e.children||(e.children=[]),e.text&&(e.children.push({text:e.text,parent:e}),delete e.text),t.parent=e,e.children.push(t),e):e}function f(e,t,s,i,r){if(!r||0==r.length)return s<i&&m(e,{text:t.slice(s,i).map(e=>e.segment).join("")}),e;for(let i=0;i<r.length;i++){const n=r[i];if(n.start<0&&"EX"==n.type){m(e,{type:n.type,data:n.data,key:n.key,att:!0});continue}s<n.start&&(m(e,{text:t.slice(s,n.start).map(e=>e.segment).join("")}),s=n.start);const a=[];for(;i<r.length-1;){const e=r[i+1];if(e.start<0)break;if(!(e.start<n.end))break;if(e.end<=n.end){const t=o[e.tp]||{};(e.start<e.end||t.isVoid)&&a.push(e)}i++}m(e,f({type:n.type,data:n.data,key:n.key},t,s,n.end,a)),s=n.end}return s<i&&m(e,{text:t.slice(s,i).map(e=>e.segment).join("")}),e}function _(e,t,s){if(!t)return e;e.txt=e.txt||"";const i=R(e.txt).length;if(t.text?e.txt+=t.text:Array.isArray(t.children)&&t.children.forEach(t=>{_(e,t,s)}),t.type){const r=R(e.txt).length-i;if(e.fmt=e.fmt||[],Object.keys(t.data||{}).length>0){e.ent=e.ent||[];const n=void 0===s[t.key]?e.ent.length:s[t.key];s[t.key]=n,e.ent[n]={tp:t.type,data:t.data},t.att?e.fmt.push({at:-1,len:0,key:n}):e.fmt.push({at:i,len:r,key:n})}else e.fmt.push({tp:t.type,at:i,len:r})}return e}function b(e,t,s){if(!e)return null;let i=t.call(s,e);if(!i||!i.children)return i;const r=[];for(let e in i.children){let n=i.children[e];n&&(n=b(n,t,s),n&&r.push(n))}return 0==r.length?i.children=null:i.children=r,i}function w(e,t,s,i,r){if(!e)return null;i&&e.type&&i.push(e.type);let n=[];for(let s in e.children){const a=w(e.children[s],t,s,i,r);a&&n.push(a)}return 0==n.length&&(n=e.text?[e.text]:null),i&&e.type&&i.pop(),t.call(r,e.type,e.data,n,s,i)}function v(e,t,s){return e?(s&&(t-=s.length),b(e,function(e){if(t<=-1)return null;if(e.att)return e;if(0==t)e.text=s,t=-1;else if(e.text){const i=R(e.text);i.length>t?(e.text=i.slice(0,t).map(e=>e.segment).join("")+s,t=-1):t-=i.length}return e})):null}function y(e,t){return b(e,e=>{const s=S(e.data,!0,t?t(e):null);return s?e.data=s:delete e.data,e})}function M(e){if("BR"==e.type)e=null;else if(e.text)e.type||(e.text=e.text.trimStart(),e.text||(e=null));else if(!e.type&&e.children&&e.children.length>0){const t=M(e.children[0]);t?e.children[0]=t:(e.children.shift(),e.type||0!=e.children.length||(e=null))}return e}function x(e,t){if(!e)return null;if(e.att)e.text=" ",delete e.att,delete e.children;else if(e.children){const s=[],i=[];for(let r in e.children){const n=e.children[r];if(n.att){if(s.length==t)continue;if(l.isFormResponseType(n.data.mime))continue;delete n.att,delete n.children,n.text=" ",s.push(n)}else i.push(n)}e.children=i.concat(s)}return e}function T(e,t){let s="",i=[];for(let r in e){const n=e[r];if(!n.txt){const e=T(n.children,s.length+t);n.txt=e.txt,i=i.concat(e.fmt)}n.tp&&i.push({at:s.length+t,len:n.txt.length,tp:n.tp}),s+=n.txt}return{txt:s,fmt:i}}function S(e,t,i){if(e&&Object.entries(e).length>0){i=i||[];const r={};if(s.forEach(s=>{if(e[s]){if(t&&!i.includes(s)&&("string"==typeof e[s]||Array.isArray(e[s]))&&e[s].length>64)return;if("object"==typeof e[s])return;r[s]=e[s]}}),0!=Object.entries(r).length)return r}return null}function P(e){return 0==Object.keys(e??{}).length}function A(e,t,s){const r=function(e){const t=[];let s=0,i=0;for(const{segment:r}of e){for(let e=0;e<r.length;e++)t[i+e]=s;i+=r.length,s++}return t}(t=t??i.segment(s)),n=r[e.at];return{at:n,len:(e.at+e.len<=s.length?r[e.at+e.len-1]-n:e.len)+1}}function R(e){return Array.from(i.segment(e))}l.init=function(e){if(void 0===e)e="";else if("string"!=typeof e)return null;return{txt:e}},l.parse=function(e){if("string"!=typeof e)return null;const t=e.split(/\r?\n/),s=[],n={},o=[];t.forEach(e=>{let t,i,c=[];if(r.forEach(t=>{c=c.concat(function(e,t,s,i){const r=[];let n=0,a=e.slice(0);for(;a.length>0;){const o=t.exec(a);if(null==o)break;let c=o.index+o[0].lastIndexOf(o[1]);a=a.slice(c+1),c+=n,n=c+1;const h=s?s.exec(a):null;if(null==h)break;let d=h.index+h[0].indexOf(h[1]);a=a.slice(d+1),d+=n,n=d+1,r.push({txt:e.slice(c+1,d),children:[],at:c,end:d,tp:i})}return r}(e,t.start,t.end,t.name))}),0==c.length)i={txt:e};else{c.sort((e,t)=>{const s=e.at-t.at;return 0!=s?s:t.end-e.end}),c=p(c);const t=T(u(e,0,e.length,c),0);i={txt:t.txt,fmt:t.fmt}}if(t=function(e){let t,s=[];if(a.forEach(i=>{for(;null!==(t=i.re.exec(e));)s.push({offset:t.index,len:t[0].length,unique:t[0],data:i.pack(t[0]),type:i.name})}),0==s.length)return s;s.sort((e,t)=>e.offset-t.offset);let i=-1;return s=s.filter(e=>{const t=e.offset>i;return i=e.offset+e.len,t}),s}(i.txt),t.length>0){const e=[];for(let i in t){const r=t[i];let a=n[r.unique];a||(a=s.length,n[r.unique]=a,s.push({tp:r.type,data:r.data})),e.push({at:r.offset,len:r.len,key:a})}i.ent=e}o.push(i)});const c={txt:""};if(o.length>0){if(c.txt=o[0].txt,c.fmt=(o[0].fmt||[]).concat(o[0].ent||[]),c.fmt.length){const e=i.segment(c.txt);for(const t of c.fmt)({at:t.at,len:t.len}=A(t,e,c.txt))}for(let e=1;e<o.length;e++){const t=o[e],s=R(c.txt).length+1;c.fmt.push({tp:"BR",len:1,at:s-1});let r={};c.txt+=" "+t.txt,t.fmt&&(r=i.segment(t.txt),c.fmt=c.fmt.concat(t.fmt.map(e=>{const{at:i,len:n}=A(e,r,t.txt);return e.at=i+s,e.len=n,e}))),t.ent&&(P(r)&&(r=i.segment(t.txt)),c.fmt=c.fmt.concat(t.ent.map(e=>{const{at:i,len:n}=A(e,r,t.txt);return e.at=i+s,e.len=n,e})))}0==c.fmt.length&&delete c.fmt,s.length>0&&(c.ent=s)}return c},l.append=function(e,t){if(!e)return t;if(!t)return e;e.txt=e.txt||"";const s=R(e.txt).length;return"string"==typeof t?e.txt+=t:t.txt&&(e.txt+=t.txt),Array.isArray(t.fmt)&&(e.fmt=e.fmt||[],Array.isArray(t.ent)&&(e.ent=e.ent||[]),t.fmt.forEach(i=>{const r={at:(0|i.at)+s,len:0|i.len};-1==i.at&&(r.at=-1,r.len=0),i.tp?r.tp=i.tp:(r.key=e.ent.length,e.ent.push(t.ent[i.key||0])),e.fmt.push(r)})),e},l.insertImage=function(e,t,s){(e=e||{txt:" "}).ent=e.ent||[],e.fmt=e.fmt||[],e.fmt.push({at:0|t,len:1,key:e.ent.length});const i={tp:"IM",data:{mime:s.mime,ref:s.refurl,val:s.bits||s.preview,width:s.width,height:s.height,name:s.filename,size:0|s.size}};return s.urlPromise&&(i.data._tempPreview=s._tempPreview,i.data._processing=!0,s.urlPromise.then(e=>{i.data.ref=e,i.data._tempPreview=void 0,i.data._processing=void 0},e=>{i.data._processing=void 0})),e.ent.push(i),e},l.insertVideo=function(e,t,s){(e=e||{txt:" "}).ent=e.ent||[],e.fmt=e.fmt||[],e.fmt.push({at:0|t,len:1,key:e.ent.length});const i={tp:"VD",data:{mime:s.mime,ref:s.refurl,val:s.bits,preref:s.preref,preview:s.preview,width:s.width,height:s.height,duration:0|s.duration,name:s.filename,size:0|s.size}};return s.urlPromise&&(i.data._tempPreview=s._tempPreview,i.data._processing=!0,s.urlPromise.then(e=>{i.data.ref=e[0],i.data.preref=e[1],i.data._tempPreview=void 0,i.data._processing=void 0},e=>{i.data._processing=void 0})),e.ent.push(i),e},l.insertAudio=function(e,t,s){(e=e||{txt:" "}).ent=e.ent||[],e.fmt=e.fmt||[],e.fmt.push({at:0|t,len:1,key:e.ent.length});const i={tp:"AU",data:{mime:s.mime,val:s.bits,duration:0|s.duration,preview:s.preview,name:s.filename,size:0|s.size,ref:s.refurl}};return s.urlPromise&&(i.data._processing=!0,s.urlPromise.then(e=>{i.data.ref=e,i.data._processing=void 0},e=>{i.data._processing=void 0})),e.ent.push(i),e},l.videoCall=function(e){return{txt:" ",fmt:[{at:0,len:1,key:0}],ent:[{tp:"VC",data:{aonly:e}}]}},l.updateVideoCall=function(e,t){const s=((e||{}).fmt||[])[0];if(!s)return e;let i;if("VC"==s.tp)delete s.tp,s.key=0,i={tp:"VC"},e.ent=[i];else if(i=(e.ent||[])[0|s.key],!i||"VC"!=i.tp)return e;return i.data=i.data||{},Object.assign(i.data,t),e},l.quote=function(e,t,s){const i=l.append(l.appendLineBreak(l.mention(e,t)),s);return i.fmt.push({at:0,len:R(i.txt).length,tp:"QQ"}),i},l.mention=function(e,t){return{txt:e||"",fmt:[{at:0,len:R(e||"").length,key:0}],ent:[{tp:"MN",data:{val:t}}]}},l.appendLink=function(e,t){(e=e||{txt:""}).ent=e.ent||[],e.fmt=e.fmt||[],e.fmt.push({at:e.txt.length,len:t.txt.length,key:e.ent.length}),e.txt+=t.txt;const s={tp:"LN",data:{url:t.url}};return e.ent.push(s),e},l.appendImage=function(e,t){return(e=e||{txt:""}).txt+=" ",l.insertImage(e,e.txt.length-1,t)},l.appendAudio=function(e,t){return(e=e||{txt:""}).txt+=" ",l.insertAudio(e,e.txt.length-1,t)},l.attachFile=function(e,t){(e=e||{txt:""}).ent=e.ent||[],e.fmt=e.fmt||[],e.fmt.push({at:-1,len:0,key:e.ent.length});const s={tp:"EX",data:{mime:t.mime,val:t.data,name:t.filename,ref:t.refurl,size:0|t.size}};return t.urlPromise&&(s.data._processing=!0,t.urlPromise.then(e=>{s.data.ref=e,s.data._processing=void 0},e=>{s.data._processing=void 0})),e.ent.push(s),e},l.wrapInto=function(e,t,s,i){return"string"==typeof e&&(e={txt:e}),e.fmt=e.fmt||[],e.fmt.push({at:s||0,len:i||e.txt.length,tp:t}),e},l.wrapAsForm=function(e,t,s){return l.wrapInto(e,"FM",t,s)},l.insertButton=function(e,t,s,i,r,n,a){return"string"==typeof e&&(e={txt:e}),!e||!e.txt||e.txt.length<t+s||s<=0||-1==["url","pub"].indexOf(r)?null:"url"!=r||a?(a=""+a,e.ent=e.ent||[],e.fmt=e.fmt||[],e.fmt.push({at:0|t,len:s,key:e.ent.length}),e.ent.push({tp:"BN",data:{act:r,val:n,ref:a,name:i}}),e):null},l.appendButton=function(e,t,s,i,r,n){const a=(e=e||{txt:""}).txt.length;return e.txt+=t,l.insertButton(e,a,t.length,s,i,r,n)},l.attachJSON=function(e,s){return(e=e||{txt:""}).ent=e.ent||[],e.fmt=e.fmt||[],e.fmt.push({at:-1,len:0,key:e.ent.length}),e.ent.push({tp:"EX",data:{mime:t,val:s}}),e},l.appendLineBreak=function(e){return(e=e||{txt:""}).fmt=e.fmt||[],e.fmt.push({at:R(e.txt).length,len:1,tp:"BR"}),e.txt+=" ",e},l.UNSAFE_toHTML=function(e){return w(g(e),function(e,t,s){const i=d[e];let r=s?s.join(""):"";return i&&(r=i.open(t)+r+i.close(t)),r},0)},l.format=function(e,t,s){return w(g(e),t,0,[],s)},l.shorten=function(e,t,s){let i=g(e);return i=v(i,t,"…"),i&&s&&(i=y(i)),_({},i,[])},l.forwardedContent=function(e){let t=g(e);return t=b(t,function(e){return"MN"!=e.type||e.parent&&e.parent.type?e:null}),t=M(t),_({},t,[])},l.replyContent=function(e,t){let s=g(e);return s?(s=b(s,function(e){return"QQ"==e.type?null:("MN"==e.type?e.parent&&e.parent.type||!(e.text||"").startsWith("➦")||(e.text="➦",delete e.children,delete e.data):"BR"==e.type&&(e.text=" ",delete e.type,delete e.children),e)}),s=x(s,3),s=v(s,t,"…"),s=y(s,e=>{switch(e.type){case"IM":return["val"];case"VD":return["preview"]}return null}),_({},s,[])):e},l.preview=function(e,t,s){let i=g(e);if(i=x(i,3),i=b(i,function(e){return"MN"==e.type?e.parent&&e.parent.type||!(e.text||"").startsWith("➦")||(e.text="➦",delete e.children):"QQ"==e.type?(e.text=" ",delete e.children):"BR"==e.type&&(e.text=" ",delete e.children,delete e.type),e}),i=v(i,t,"…"),s){const e={IM:["val"],VD:["preview"]};i=y(i,t=>e[t.type])}else i=y(i);return _({},i,[])},l.toPlainText=function(e){return"string"==typeof e?e:e.txt},l.isPlainText=function(e){return"string"==typeof e||!(e.fmt||e.ent)},l.toMarkdown=function(e){return w(g(e),function(e,t,s){const i=o[e];let r=s?s.join(""):"";return i&&(i.isVoid?r=i.md_tag||"":i.md_tag&&(r=i.md_tag+r+i.md_tag)),r},0)},l.isValid=function(e){if(!e)return!1;const{txt:t,fmt:s,ent:i}=e;if(!t&&""!==t&&!s&&!i)return!1;const r=typeof t;return!("string"!=r&&"undefined"!=r&&null!==t||void 0!==s&&!Array.isArray(s)&&null!==s||void 0!==i&&!Array.isArray(i)&&null!==i)},l.hasAttachments=function(e){if(!Array.isArray(e.fmt))return!1;for(let t in e.fmt){const s=e.fmt[t];if(s&&s.at<0){const t=e.ent[0|s.key];return t&&"EX"==t.tp&&t.data}}return!1},l.attachments=function(e,t,s){if(!Array.isArray(e.fmt))return;let i=0;for(let r in e.fmt){let n=e.fmt[r];if(n&&n.at<0){const r=e.ent[0|n.key];if(r&&"EX"==r.tp&&r.data&&t.call(s,r.data,i++,"EX"))break}}},l.hasEntities=function(e){return e.ent&&e.ent.length>0},l.entities=function(e,t,s){if(e.ent&&e.ent.length>0)for(let i in e.ent)if(e.ent[i]&&t.call(s,e.ent[i].data,i,e.ent[i].tp))break},l.styles=function(e,t,s){if(e.fmt&&e.fmt.length>0)for(let i in e.fmt){const r=e.fmt[i];if(r&&t.call(s,r.tp,r.at,r.len,r.key,i))break}},l.sanitizeEntities=function(e){if(e&&e.ent&&e.ent.length>0)for(let t in e.ent){const s=e.ent[t];if(s&&s.data){const i=S(s.data);i?e.ent[t].data=i:delete e.ent[t].data}}return e},l.getDownloadUrl=function(e){let t=null;return!l.isFormResponseType(e.mime)&&e.val?t=c(e.val,e.mime,l.logger):"string"==typeof e.ref&&(t=e.ref),t},l.isProcessing=function(e){return!!e._processing},l.getPreviewUrl=function(e){return e.val?c(e.val,e.mime,l.logger):null},l.getEntitySize=function(e){return e.size?e.size:e.val?.75*e.val.length|0:0},l.getEntityMimeType=function(e){return e.mime||"text/plain"},l.tagName=function(e){return o[e]&&o[e].html_tag},l.attrValue=function(e,t){if(t&&d[e]&&d[e].props)return d[e].props(t)},l.getContentType=function(){return"text/x-drafty"},l.isFormResponseType=function(e){return e===t||"application/json"===e},e.exports=l}},t={};function s(i){var r=t[i];if(void 0!==r)return r.exports;var n=t[i]={exports:{}};return e[i](n,n.exports,s),n.exports}s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,{a:t}),t},s.d=function(e,t){for(var i in t)s.o(t,i)&&!s.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},s.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};s.r(i),s.d(i,{AccessMode:function(){return r},Drafty:function(){return U()},Tinode:function(){return $}});class r{constructor(e){e&&(this.given="number"==typeof e.given?e.given:r.decode(e.given),this.want="number"==typeof e.want?e.want:r.decode(e.want),this.mode=e.mode?"number"==typeof e.mode?e.mode:r.decode(e.mode):this.given&this.want)}static#e(e,t,s){if(["given","want","mode"].includes(t=t||"mode"))return 0!=(e[t]&s);throw new Error(`Invalid AccessMode component '${t}'`)}static decode(e){if(!e)return null;if("number"==typeof e)return e&r._BITMASK;if("N"===e||"n"===e)return r._NONE;const t={J:r._JOIN,R:r._READ,W:r._WRITE,P:r._PRES,A:r._APPROVE,S:r._SHARE,D:r._DELETE,O:r._OWNER};let s=r._NONE;for(let i=0;i<e.length;i++){const r=t[e.charAt(i).toUpperCase()];r&&(s|=r)}return s}static encode(e){if(null===e||e===r._INVALID)return null;if(e===r._NONE)return"N";const t=["J","R","W","P","A","S","D","O"];let s="";for(let i=0;i<t.length;i++)e&1<<i&&(s+=t[i]);return s}static update(e,t){if(!t||"string"!=typeof t)return e;let s=t.charAt(0);if("+"==s||"-"==s){let i=e;const n=t.split(/([-+])/);for(let t=1;t<n.length-1;t+=2){s=n[t];const a=r.decode(n[t+1]);if(a==r._INVALID)return e;null!=a&&("+"===s?i|=a:"-"===s&&(i&=~a))}e=i}else{const s=r.decode(t);s!=r._INVALID&&(e=s)}return e}static diff(e,t){return e=r.decode(e),t=r.decode(t),e==r._INVALID||t==r._INVALID?r._INVALID:e&~t}toString(){return'{"mode": "'+r.encode(this.mode)+'", "given": "'+r.encode(this.given)+'", "want": "'+r.encode(this.want)+'"}'}jsonHelper(){return{mode:r.encode(this.mode),given:r.encode(this.given),want:r.encode(this.want)}}setMode(e){return this.mode=r.decode(e),this}updateMode(e){return this.mode=r.update(this.mode,e),this}getMode(){return r.encode(this.mode)}setGiven(e){return this.given=r.decode(e),this}updateGiven(e){return this.given=r.update(this.given,e),this}getGiven(){return r.encode(this.given)}setWant(e){return this.want=r.decode(e),this}updateWant(e){return this.want=r.update(this.want,e),this}getWant(){return r.encode(this.want)}getMissing(){return r.encode(this.want&~this.given)}getExcessive(){return r.encode(this.given&~this.want)}updateAll(e){return e&&(this.updateGiven(e.given),this.updateWant(e.want),this.mode=this.given&this.want),this}isOwner(e){return r.#e(this,e,r._OWNER)}isPresencer(e){return r.#e(this,e,r._PRES)}isMuted(e){return!this.isPresencer(e)}isJoiner(e){return r.#e(this,e,r._JOIN)}isReader(e){return r.#e(this,e,r._READ)}isWriter(e){return r.#e(this,e,r._WRITE)}isApprover(e){return r.#e(this,e,r._APPROVE)}isAdmin(e){return this.isOwner(e)||this.isApprover(e)}isSharer(e){return this.isAdmin(e)||r.#e(this,e,r._SHARE)}isDeleter(e){return r.#e(this,e,r._DELETE)}}r._NONE=0,r._JOIN=1,r._READ=2,r._WRITE=4,r._PRES=8,r._APPROVE=16,r._SHARE=32,r._DELETE=64,r._OWNER=128,r._BITMASK=r._JOIN|r._READ|r._WRITE|r._PRES|r._APPROVE|r._SHARE|r._DELETE|r._OWNER,r._INVALID=1048576;const n="0.26.0-alpha1",a="tinodejs/"+n,o="new",c="nch",h="me",d="fnd",l="grp",u=268435455,p="␡",g="alias:",m="reactions",f="maxReactions";class _ extends Error{constructor(e,t){super(`${e} (${t})`),this.name="CommError",this.code=t}}function b(e,t){if("string"==typeof t&&t.length>=20&&t.length<=24&&["ts","touched","updated","created","when","deleted","expires"].includes(e)){const e=new Date(t);if(!isNaN(e))return e}else if("acs"===e&&"object"==typeof t)return new r(t);return t}function w(e){return e&&!/^\s*([a-z][a-z0-9+.-]*:|\/\/)/im.test(e)}function v(e){return e instanceof Date&&!isNaN(e)&&0!=e.getTime()}function y(e,t){if("object"!=typeof t){if(void 0===t)return e;if(t===p)return;return t}if(null===t)return e;if(t instanceof Date&&!isNaN(t))return!e||!(e instanceof Date)||isNaN(e)||e<t?t:e;if(t instanceof r)return new r(t);if(t instanceof Array)return t;e&&e!==p||(e=t.constructor());for(let s in t)if(t.hasOwnProperty(s)&&"_noForwarding"!=s)try{e[s]=y(e[s],t[s])}catch(e){console.warn("Error merging property:",s,e)}return e}function M(e,t,s){return e[t]=y(e[t],s),e[t]}function x(e){return Object.keys(e).forEach(t=>{"_"==t[0]?delete e[t]:e[t]?Array.isArray(e[t])&&0==e[t].length?delete e[t]:e[t]?e[t]instanceof Date?v(e[t])||delete e[t]:"object"==typeof e[t]&&(x(e[t]),0==Object.getOwnPropertyNames(e[t]).length&&delete e[t]):delete e[t]:delete e[t]}),e}function T(e,t){return Array.isArray(e)?(e.sort((e,t)=>e.low<t.low?-1:e.low==t.low?(0|t.hi)-e.hi:1),e=(e=e.reduce((e,s)=>(s.low<u&&s.low>0&&(!s.hi||s.hi<u?e.push(s):e.push({low:s.low,hi:t+1})),e),[])).reduce((e,t)=>{if(0==e.length)e.push(t);else{let s=e[e.length-1];t.low<=s.hi?s.hi=Math.max(s.hi,t.hi):e.push(t)}return e},[])):[]}function S(e){return e.sort((e,t)=>e-t),e.reduce((e,t)=>{if(0==e.length)e.push({low:t});else{let s=e[e.length-1];!s.hi&&t!=s.low+1||t>s.hi?e.push({low:t}):s.hi=s.hi?Math.max(s.hi,t+1):t+1}return e},[])}let P,A;const R="Connection failed",E=418,D="Disconnected by client";function N(e,t,s,i){let r=null;return["http","https","ws","wss"].includes(t)&&(r=`${t}://${e}`,"/"!==r.charAt(r.length-1)&&(r+="/"),r+="v"+s+"/channels",["http","https"].includes(t)&&(r+="/lp"),r+="?apikey="+i),r}class I{static#t=e=>{};#s=null;#i=0;#r=!1;#n=null;host;secure;apiKey;version;autoreconnect;initialized;constructor(e,t,s){if(this.host=e.host,this.secure=e.secure,this.apiKey=e.apiKey,this.version=t,this.autoreconnect=s,"lp"===e.transport?(this.#a(),this.initialized="lp"):"ws"===e.transport&&(this.#o(),this.initialized="ws"),!this.initialized)throw I.#t("Unknown or invalid network transport. Running under Node? Call 'Tinode.setNetworkProviders()'."),new Error("Unknown or invalid network transport. Running under Node? Call 'Tinode.setNetworkProviders()'.")}static setNetworkProviders(e,t){P=e,A=t}static set logger(e){I.#t=e}connect(e,t){return Promise.reject(null)}reconnect(e){}disconnect(){}sendText(e){}isConnected(){return!1}transport(){return this.initialized}probe(){this.sendText("1")}backoffReset(){this.#c()}#h(){clearTimeout(this.#s);const e=Math.pow(2,this.#i)*(1+.3*Math.random())*2e3;this.#i=this.#i>=10?this.#i:this.#i+1,this.onAutoreconnectIteration&&this.onAutoreconnectIteration(e),this.#s=setTimeout(t=>{if(I.#t(`Reconnecting, iter=${this.#i}, timeout=${e}`),this.#r)this.onAutoreconnectIteration&&this.onAutoreconnectIteration(-1);else{const e=this.connect();this.onAutoreconnectIteration?this.onAutoreconnectIteration(0,e):e.catch(e=>{})}},e)}#d(){clearTimeout(this.#s),this.#s=null}#c(){this.#i=0}#a(){let e=null,t=null,s=null,i=(t,s,r)=>{let n=new A,a=!1;return n.onreadystatechange=o=>{if(4==n.readyState)if(201==n.status){let r=JSON.parse(n.responseText,b);e=t+"&sid="+r.ctrl.params.sid,n=i(e),n.send(null),this.onOpen&&this.onOpen(),s&&(a=!0,s()),this.autoreconnect&&this.#d()}else if(n.status>0&&n.status<400)this.onMessage&&this.onMessage(n.responseText),n=i(e),n.send(null);else{if(r&&!a&&(a=!0,r(n.responseText)),this.onMessage&&n.responseText&&this.onMessage(n.responseText),this.onDisconnect){const e=n.status||(this.#r?E:503),t=n.responseText||(this.#r?D:R);this.onDisconnect(new _(t,e),e)}n=null,!this.#r&&this.autoreconnect&&this.#h()}},n.open("POST",t,!0),n};this.connect=(e,s)=>{if(this.#r=!1,t){if(!s)return Promise.resolve();t.onreadystatechange=void 0,t.abort(),t=null}return e&&(this.host=e),new Promise((e,s)=>{const r=N(this.host,this.secure?"https":"http",this.version,this.apiKey);I.#t("LP connecting to:",r),t=i(r,e,s),t.send(null)}).catch(e=>{I.#t("LP connection failed:",e)})},this.reconnect=e=>{this.#d(),this.connect(null,e)},this.disconnect=i=>{this.#r=!0,this.#d(),s&&(s.onreadystatechange=void 0,s.abort(),s=null),t&&(t.onreadystatechange=void 0,t.abort(),t=null),this.onDisconnect&&this.onDisconnect(new _(D,E),E),e=null},this.sendText=t=>{if(s=(e=>{const t=new A;return t.onreadystatechange=e=>{if(4==t.readyState&&t.status>=400)throw new _("LP sender failed",t.status)},t.open("POST",e,!0),t})(e),!s||1!=s.readyState)throw new Error("Long poller failed to connect");s.send(t)},this.isConnected=e=>t&&!0}#o(){this.connect=(e,t)=>{if(this.#r=!1,this.#n){if(!t&&this.#n.readyState==this.#n.OPEN)return this.probe(),Promise.resolve();this.#n.close(),this.#n=null}return e&&(this.host=e),new Promise((e,t)=>{const s=N(this.host,this.secure?"wss":"ws",this.version,this.apiKey);I.#t("WS connecting to: ",s);const i=new P(s);i.onerror=e=>{t(e)},i.onopen=t=>{this.autoreconnect&&this.#d(),this.onOpen&&this.onOpen(),e()},i.onclose=e=>{if(this.#n=null,this.onDisconnect){const e=this.#r?E:503;this.onDisconnect(new _(this.#r?D:R,e),e)}!this.#r&&this.autoreconnect&&this.#h()},i.onmessage=e=>{this.onMessage&&this.onMessage(e.data)},this.#n=i})},this.reconnect=e=>{this.#d(),this.connect(null,e)},this.disconnect=e=>{this.#r=!0,this.#d(),this.#n&&(this.#n.close(),this.#n=null)},this.sendText=e=>{if(!this.#n||this.#n.readyState!=this.#n.OPEN)throw new Error("Websocket is not connected");this.#n.send(e)},this.isConnected=e=>this.#n&&this.#n.readyState==this.#n.OPEN}onMessage=void 0;onDisconnect=void 0;onOpen=void 0;onAutoreconnectIteration=void 0}I.NETWORK_ERROR=503,I.NETWORK_ERROR_TEXT=R,I.NETWORK_USER=E,I.NETWORK_USER_TEXT=D;const k="tinode-web";let C;class q{#l=e=>{};#u=e=>{};db=null;disabled=!0;constructor(e,t){this.#l=e||this.#l,this.#u=t||this.#u}#p(e,t,s){return this.db?new Promise((i,r)=>{const n=this.db.transaction([e]);n.onerror=t=>{this.#u("PCache","mapObjects",e,t.target.error),r(t.target.error)},n.objectStore(e).getAll().onsuccess=e=>{t&&e.target.result.forEach(e=>{t.call(s,e)}),i(e.target.result)}}):disabled?Promise.resolve([]):Promise.reject(new Error("not initialized"))}initDatabase(){return new Promise((e,t)=>{const s=C.open(k,3);s.onsuccess=t=>{this.db=t.target.result,this.disabled=!1,this.db.onversionchange=e=>{this.#u("PCache","another tab tries to upgrade DB, shutting down"),this.db.close(),this.db=null,this.disabled=!0},e(this.db)},s.onerror=e=>{this.#u("PCache","failed to initialize",e),t(e.target.error),this.#l(e.target.error)},s.onupgradeneeded=e=>{if(this.db=e.target.result,this.db.onerror=e=>{this.#u("PCache","failed to create storage",e),this.#l(e.target.error)},this.db.objectStoreNames.contains("topic")||this.db.createObjectStore("topic",{keyPath:"name"}),this.db.objectStoreNames.contains("user")||this.db.createObjectStore("user",{keyPath:"uid"}),this.db.objectStoreNames.contains("subscription")||this.db.createObjectStore("subscription",{keyPath:["topic","uid"]}),this.db.objectStoreNames.contains("message")||this.db.createObjectStore("message",{keyPath:["topic","seq"]}),!this.db.objectStoreNames.contains("dellog")){const e=this.db.createObjectStore("dellog",{keyPath:["topic","low","hi"]});e.indexNames.contains("topic_clear")||e.createIndex("topic_clear",["topic","clear"],{unique:!1})}}})}deleteDatabase(){return this.db&&(this.db.close(),this.db=null),new Promise((e,t)=>{const s=C.deleteDatabase(k);s.onblocked=e=>{this.db&&this.db.close();const s=new Error("blocked");this.#u("PCache","deleteDatabase",s),t(s)},s.onsuccess=t=>{this.db=null,this.disabled=!0,e(!0)},s.onerror=e=>{this.#u("PCache","deleteDatabase",e.target.error),t(e.target.error)}})}isReady(){return!!this.db}updTopic(e){return this.isReady()?new Promise((t,s)=>{const i=this.db.transaction(["topic"],"readwrite");i.oncomplete=e=>{t(e.target.result)},i.onerror=e=>{this.#u("PCache","updTopic",e.target.error),s(e.target.error)};const r=i.objectStore("topic").get(e.name);r.onsuccess=t=>{i.objectStore("topic").put(q.#g(r.result,e)),i.commit()}}):this.disabled?Promise.resolve():Promise.reject(new Error("not initialized"))}markTopicAsDeleted(e,t){return this.isReady()?new Promise((s,i)=>{const r=this.db.transaction(["topic"],"readwrite");r.oncomplete=e=>{s(e.target.result)},r.onerror=e=>{this.#u("PCache","markTopicAsDeleted",e.target.error),i(e.target.error)},r.objectStore("topic").get(e).onsuccess=e=>{const s=e.target.result;s&&s._deleted!=t&&(s._deleted=t,r.objectStore("topic").put(s)),r.commit()}}):this.disabled?Promise.resolve():Promise.reject(new Error("not initialized"))}remTopic(e){return this.isReady()?new Promise((t,s)=>{const i=this.db.transaction(["topic","subscription","message"],"readwrite");i.oncomplete=e=>{t(e.target.result)},i.onerror=e=>{this.#u("PCache","remTopic",e.target.error),s(e.target.error)},i.objectStore("topic").delete(IDBKeyRange.only(e)),i.objectStore("subscription").delete(IDBKeyRange.bound([e,"-"],[e,"~"])),i.objectStore("message").delete(IDBKeyRange.bound([e,0],[e,Number.MAX_SAFE_INTEGER])),i.commit()}):this.disabled?Promise.resolve():Promise.reject(new Error("not initialized"))}mapTopics(e,t){return this.#p("topic",e,t)}deserializeTopic(e,t){q.#m(e,t)}updUser(e,t){if(!(arguments.length<2||void 0===t))return this.isReady()?new Promise((s,i)=>{const r=this.db.transaction(["user"],"readwrite");r.oncomplete=e=>{s(e.target.result)},r.onerror=e=>{this.#u("PCache","updUser",e.target.error),i(e.target.error)},r.objectStore("user").put({uid:e,public:t}),r.commit()}):this.disabled?Promise.resolve():Promise.reject(new Error("not initialized"))}remUser(e){return this.isReady()?new Promise((t,s)=>{const i=this.db.transaction(["user"],"readwrite");i.oncomplete=e=>{t(e.target.result)},i.onerror=e=>{this.#u("PCache","remUser",e.target.error),s(e.target.error)},i.objectStore("user").delete(IDBKeyRange.only(e)),i.commit()}):this.disabled?Promise.resolve():Promise.reject(new Error("not initialized"))}mapUsers(e,t){return this.#p("user",e,t)}getUser(e){return this.isReady()?new Promise((t,s)=>{const i=this.db.transaction(["user"]);i.oncomplete=e=>{const s=e.target.result;t({user:s.uid,public:s.public})},i.onerror=e=>{this.#u("PCache","getUser",e.target.error),s(e.target.error)},i.objectStore("user").get(e)}):this.disabled?Promise.resolve():Promise.reject(new Error("not initialized"))}updSubscription(e,t,s){return this.isReady()?new Promise((i,r)=>{const n=this.db.transaction(["subscription"],"readwrite");n.oncomplete=e=>{i(e.target.result)},n.onerror=e=>{this.#u("PCache","updSubscription",e.target.error),r(e.target.error)},n.objectStore("subscription").get([e,t]).onsuccess=i=>{n.objectStore("subscription").put(q.#f(i.target.result,e,t,s)),n.commit()}}):this.disabled?Promise.resolve():Promise.reject(new Error("not initialized"))}mapSubscriptions(e,t,s){return this.isReady()?new Promise((i,r)=>{const n=this.db.transaction(["subscription"]);n.onerror=e=>{this.#u("PCache","mapSubscriptions",e.target.error),r(e.target.error)},n.objectStore("subscription").getAll(IDBKeyRange.bound([e,"-"],[e,"~"])).onsuccess=e=>{t&&e.target.result.forEach(e=>{t.call(s,e)}),i(e.target.result)}}):this.disabled?Promise.resolve([]):Promise.reject(new Error("not initialized"))}addMessage(e){return this.isReady()?new Promise((t,s)=>{const i=this.db.transaction(["message"],"readwrite");i.onsuccess=e=>{t(e.target.result)},i.onerror=e=>{this.#u("PCache","addMessage",e.target.error),s(e.target.error)},i.objectStore("message").add(q.#_(null,e)),i.commit()}):this.disabled?Promise.resolve():Promise.reject(new Error("not initialized"))}updMessageStatus(e,t,s){return this.isReady()?new Promise((i,r)=>{const n=this.db.transaction(["message"],"readwrite");n.onsuccess=e=>{i(e.target.result)},n.onerror=e=>{this.#u("PCache","updMessageStatus",e.target.error),r(e.target.error)};const a=n.objectStore("message").get(IDBKeyRange.only([e,t]));a.onsuccess=i=>{const r=a.result||i.target.result;r&&r._status!=s&&n.objectStore("message").put(q.#_(r,{topic:e,seq:t,_status:s})),n.commit()}}):this.disabled?Promise.resolve():Promise.reject(new Error("not initialized"))}updMessageReact(e,t,s){return this.isReady()?new Promise((i,r)=>{const n=this.db.transaction(["message"],"readwrite");n.onsuccess=e=>{i(e.target.result)},n.onerror=e=>{this.#u("PCache","updMessageReact",e.target.error),r(e.target.error)};const a=n.objectStore("message").get(IDBKeyRange.only([e,t]));a.onsuccess=i=>{const r=a.result||i.target.result;r&&r.react!==s&&n.objectStore("message").put(q.#_(r,{topic:e,seq:t,react:s})),n.commit()}}):this.disabled?Promise.resolve():Promise.reject(new Error("not initialized"))}remMessages(e,t,s){return this.isReady()?new Promise((i,r)=>{t||s||(t=0,s=Number.MAX_SAFE_INTEGER);const n=s>0?IDBKeyRange.bound([e,t],[e,s],!1,!0):IDBKeyRange.only([e,t]),a=this.db.transaction(["message"],"readwrite");a.onsuccess=e=>{i(e.target.result)},a.onerror=e=>{this.#u("PCache","remMessages",e.target.error),r(e.target.error)},a.objectStore("message").delete(n),a.commit()}):this.disabled?Promise.resolve():Promise.reject(new Error("not initialized"))}readMessages(e,t,s,i){if(t=t||{},!this.isReady())return this.disabled?Promise.resolve([]):Promise.reject(new Error("not initialized"));const r=this.db.transaction(["message"]);let n=[];return Array.isArray(t.ranges)?new Promise((a,o)=>{r.onerror=e=>{this.#u("PCache","readMessages",e.target.error),o(e.target.error)};let c=0;t.ranges.forEach(o=>{const h=o.hi?IDBKeyRange.bound([e,o.low],[e,o.hi],!1,!0):IDBKeyRange.only([e,o.low]);r.objectStore("message").getAll(h).onsuccess=e=>{const r=e.target.result;r&&(s&&s.call(i,r),Array.isArray(r)?n=n.concat(r):n.push(r)),c++,c==t.ranges.length&&a(n)}})}):new Promise((a,o)=>{const c=t.since>0?t.since:0,h=t.before>0?t.before:Number.MAX_SAFE_INTEGER,d=0|t.limit;r.onerror=e=>{this.#u("PCache","readMessages",e.target.error),o(e.target.error)};const l=IDBKeyRange.bound([e,c],[e,h],!1,!0);r.objectStore("message").openCursor(l,"prev").onsuccess=e=>{const t=e.target.result;t?(s&&s.call(i,t.value),n.push(t.value),d<=0||n.length<d?t.continue():a(n)):a(n)}})}addDelLog(e,t,s){return this.isReady()?new Promise((i,r)=>{const n=this.db.transaction(["dellog"],"readwrite");n.onsuccess=e=>{i(e.target.result)},n.onerror=e=>{this.#u("PCache","addDelLog",e.target.error),r(e.target.error)},s.forEach(s=>n.objectStore("dellog").add({topic:e,clear:t,low:s.low,hi:s.hi||s.low+1})),n.commit()}):this.disabled?Promise.resolve():Promise.reject(new Error("not initialized"))}readDelLog(e,t){if(t=t||{},!this.isReady())return this.disabled?Promise.resolve([]):Promise.reject(new Error("not initialized"));const s=this.db.transaction(["dellog"]);let i=[];return Array.isArray(t.ranges)?new Promise((r,n)=>{s.onerror=e=>{this.#u("PCache","readDelLog",e.target.error),n(e.target.error)};let a=0;t.ranges.forEach(n=>{const o=n.hi||n.low+1,c=IDBKeyRange.bound([e,0,n.low],[e,o,Number.MAX_SAFE_INTEGER],!1,!0);s.objectStore("dellog").getAll(c).onsuccess=e=>{const s=e.target.result;s&&(Array.isArray(s)?i=i.concat(s.map(e=>({low:e.low,hi:e.hi}))):i.push({low:s.low,hi:s.hi})),a++,a==t.ranges.length&&r(i)}})}):new Promise((i,r)=>{const n=t.since>0?t.since:0,a=t.before>0?t.before:Number.MAX_SAFE_INTEGER,o=0|t.limit;s.onerror=e=>{this.#u("PCache","readDelLog",e.target.error),r(e.target.error)};let c=0;const h=[],d=IDBKeyRange.bound([e,0,n],[e,a,Number.MAX_SAFE_INTEGER],!1,!0);s.objectStore("dellog").openCursor(d,"prev").onsuccess=e=>{const t=e.target.result;t?(h.push({low:t.value.low,hi:t.value.hi}),c+=t.value.hi-t.value.low,o<=0||c<o?t.continue():i(h)):i(h)}})}maxDelId(e){return this.isReady()?new Promise((t,s)=>{const i=this.db.transaction(["dellog"]);i.onerror=e=>{this.#u("PCache","maxDelId",e.target.error),s(e.target.error)},i.objectStore("dellog").index("topic_clear").openCursor(IDBKeyRange.bound([e,0],[e,Number.MAX_SAFE_INTEGER]),"prev").onsuccess=e=>{e.target.result&&t(e.target.result.value)}}):this.disabled?Promise.resolve(0):Promise.reject(new Error("not initialized"))}static#b=["created","updated","deleted","touched","read","recv","seq","clear","mrrid","defacs","creds","public","trusted","private","_aux","_deleted","_mrrSeen"];static#m(e,t){q.#b.forEach(s=>{t.hasOwnProperty(s)&&(e[s]=t[s])}),Array.isArray(t.tags)&&(e._tags=t.tags),t.acs&&e.setAccessMode(t.acs),e.seq|=0,e.read|=0,e.unread=Math.max(0,e.seq-e.read)}static#g(e,t){const s=e||{name:t.name};return q.#b.forEach(e=>{t.hasOwnProperty(e)&&(s[e]=t[e])}),Array.isArray(t._tags)&&(s.tags=t._tags),t.acs&&(s.acs=t.getAccessMode().jsonHelper()),s}static#f(e,t,s,i){const r=e||{topic:t,uid:s};return["updated","mode","read","recv","clear","lastSeen","userAgent"].forEach(e=>{i.hasOwnProperty(e)&&(r[e]=i[e])}),r}static#_(e,t){const s=e||{};return["topic","seq","ts","_status","from","head","content","react"].forEach(e=>{t.hasOwnProperty(e)&&(s[e]=t[e])}),s}static setDatabaseProvider(e){C=e}}var O=s(767),U=s.n(O);let j,L,V,G;class W{constructor(e,t){this._tinode=e,this._version=t,this._apiKey=e._apiKey,this._authToken=e.getAuthToken(),this.xhr=[]}uploadWithBaseUrl(e,t,s,i,r,n){let a=`/v${this._version}/file/u/`;if(e){let t=e;if(t.endsWith("/")&&(t=t.slice(0,-1)),!t.startsWith("http://")&&!t.startsWith("https://"))throw new Error(`Invalid base URL '${e}'`);a=t+a}const o=this,c=new j;this.xhr.push(c),c.open("POST",a,!0),c.setRequestHeader("X-Tinode-APIKey",this._apiKey),this._authToken&&c.setRequestHeader("X-Tinode-Auth",`Token ${this._authToken.token}`);let h=null,d=null;const l=new Promise((e,t)=>{h=e,d=t});c.upload.onprogress=e=>{e.lengthComputable&&(i&&i(e.loaded/e.total),this.onProgress&&this.onProgress(e.loaded/e.total))},c.onload=function(){let e;try{e=JSON.parse(this.response,b)}catch(t){o._tinode.logger("ERROR: Invalid server response in LargeFileHelper",this.response),e={ctrl:{code:this.status,text:this.statusText}}}this.status>=200&&this.status<300?(h&&h(e.ctrl.params.url),r&&r(e.ctrl)):this.status>=400?(d&&d(new _(e.ctrl.text,e.ctrl.code)),n&&n(e.ctrl)):o._tinode.logger("ERROR: Unexpected server response status",this.status,this.response)},c.onerror=function(e){d&&d(e||new Error("failed")),n&&n(null)},c.onabort=function(e){d&&d(new Error("upload cancelled by user")),n&&n(null)};try{const e=new FormData;e.append("file",t),e.set("id",this._tinode.getNextUniqueId()),s&&e.set("topic",s),c.send(e)}catch(e){d&&d(e),n&&n(null)}return l}upload(e,t,s,i,r){const n=(this._tinode._secure?"https://":"http://")+this._tinode._host;return this.uploadWithBaseUrl(n,e,t,s,i,r)}download(e,t,s,i,r){if(!w(e))return void(r&&r(`The URL '${e}' must be relative, not absolute`));if(!this._authToken)return void(r&&r("Must authenticate first"));const n=this,a=new j;this.xhr.push(a),e=function(e){const t=new URL(e,window.location.origin);return t.searchParams.append("asatt","1"),t.toString().substring(window.location.origin.length)}(e),a.open("GET",e,!0),a.setRequestHeader("X-Tinode-APIKey",this._apiKey),a.setRequestHeader("X-Tinode-Auth","Token "+this._authToken.token),a.responseType="blob",a.onprogress=function(e){i&&i(e.loaded)};let o=null,c=null;const h=new Promise((e,t)=>{o=e,c=t});a.onload=function(){if(200==this.status){const e=document.createElement("a");e.href=window.URL.createObjectURL(new Blob([this.response],{type:s})),e.style.display="none",e.setAttribute("download",t),document.body.appendChild(e),e.click(),document.body.removeChild(e),window.URL.revokeObjectURL(e.href),o&&o()}else if(this.status>=400&&c){const e=new FileReader;e.onload=function(){try{const e=JSON.parse(this.result,b);c(new _(e.ctrl.text,e.ctrl.code))}catch(e){n._tinode.logger("ERROR: Invalid server response in LargeFileHelper",this.result),c(e)}},e.readAsText(this.response)}},a.onerror=function(e){c&&c(new Error("failed")),r&&r(e)},a.onabort=function(){c&&c(null)};try{a.send()}catch(e){c&&c(e),r&&r(e)}return h}cancel(){this.xhr.forEach(e=>{e.readyState<4&&e.abort()})}static setNetworkProvider(e){j=e}}class z{constructor(e){this.topic=e,this.what={}}#w(){return this.topic._deleted?void 0:this.topic.updated}#v(){return this.topic.isP2PType()?this.#w():this.topic._deleted?void 0:this.topic._lastSubsUpdate}withData(e,t,s){return this.what.data={since:e,before:t,limit:s},this}withLaterData(e){return this.withData(this.topic._maxSeq>0?this.topic._maxSeq+1:void 0,void 0,e)}withDataRanges(e,t){return this.what.data={ranges:T(e,this.topic._maxSeq),limit:t},this}withDataList(e){return this.withDataRanges(S(e))}withEarlierData(e){return this.withData(void 0,this.topic._minSeq>0?this.topic._minSeq:void 0,e)}withDesc(e){return this.what.desc={ims:e},this}withLaterDesc(){return this.withDesc(this.#w())}withSub(e,t,s){const i={ims:e,limit:t};return"me"==this.topic.getType()?i.topic=s:i.user=s,this.what.sub=i,this}withOneSub(e,t){return this.withSub(e,void 0,t)}withLaterOneSub(e){return this.withOneSub(this.topic._lastSubsUpdate,e)}withLaterSub(e){return this.withSub(this.#v(),e)}withTags(){return this.what.tags=!0,this}withCred(){return"me"==this.topic.getType()?this.what.cred=!0:this.topic._tinode.logger("ERROR: Invalid topic type for MetaGetBuilder:withCreds",this.topic.getType()),this}withAux(){return this.what.aux=!0,this}withDel(e,t){return(e||t)&&(this.what.del={since:e,limit:t}),this}withLaterDel(e){return this.withDel(this.topic._maxSeq>0?this.topic._maxDel+1:void 0,e)}extract(e){return this.what[e]}build(){const e=[];let t={};return["data","sub","desc","tags","cred","aux","del"].forEach(s=>{this.what.hasOwnProperty(s)&&(e.push(s),Object.getOwnPropertyNames(this.what[s]).length>0&&(t[s]=this.what[s]))}),e.length>0?t.what=e.join(" "):t=void 0,t}}class F{#y=void 0;#M=!1;buffer=[];constructor(e,t){this.#y=e||((e,t)=>e===t?0:e<t?-1:1),this.#M=t}#x(e,t,s){let i=0,r=t.length-1,n=0,a=0,o=!1;for(;i<=r;)if(n=(i+r)/2|0,a=this.#y(t[n],e),a<0)i=n+1;else{if(!(a>0)){o=!0;break}r=n-1}return o?{idx:n,exact:!0}:s?{idx:-1}:{idx:a<0?n+1:n}}#T(e,t){const s=this.#x(e,t,!1),i=s.exact&&this.#M?1:0;return t.splice(s.idx,i,e),t}getAt(e){return this.buffer[e]}getLast(e){return e?this.buffer.findLast(e):this.buffer[this.buffer.length-1]}put(){let e;e=1==arguments.length&&Array.isArray(arguments[0])?arguments[0]:arguments;for(let t in e)this.#T(e[t],this.buffer)}delAt(e){e|=0;let t=this.buffer.splice(e,1);if(t&&t.length>0)return t[0]}delRange(e,t){return this.buffer.splice(e,t-e)}length(){return this.buffer.length}reset(){this.buffer=[]}forEach(e,t,s,i){t=Math.max(0,0|t),s=Math.min(s||this.buffer.length,this.buffer.length);for(let r=t;r<s;r++)e.call(i,this.buffer[r],r>t?this.buffer[r-1]:void 0,r<s-1?this.buffer[r+1]:void 0,r)}find(e,t){const{idx:s}=this.#x(e,this.buffer,!t);return s}filter(e,t){let s=0;for(let i=0;i<this.buffer.length;i++)e.call(t,this.buffer[i],i)&&(this.buffer[s]=this.buffer[i],s++);this.buffer.splice(s)}isEmpty(){return 0==this.buffer.length}}class B{constructor(e,t){this._tinode=null,this.name=e,this.created=null,this.updated=null,this.touched=new Date(0),this.acs=new r(null),this.private=null,this.public=null,this.trusted=null,this.seq=0,this.read=0,this.recv=0,this.clear=0,this.mrrid=0,this._users={},this._queuedSeqId=u,this._maxSeq=0,this._minSeq=0,this._noEarlierMsgs=!1,this._maxDel=0,this._mrrSeen=0,this._recvNotificationTimer=null,this._tags=[],this._credentials=[],this._aux={},this._messageVersions={},this._messages=new F((e,t)=>e.seq-t.seq,!0),this._attached=!1,this._lastSubsUpdate=new Date(0),this._new=!0,this._deleted=!1,this._delayedLeaveTimer=null,t&&(this.onData=t.onData,this.onMeta=t.onMeta,this.onPres=t.onPres,this.onInfo=t.onInfo,this.onMetaDesc=t.onMetaDesc,this.onMetaSub=t.onMetaSub,this.onSubsUpdated=t.onSubsUpdated,this.onTagsUpdated=t.onTagsUpdated,this.onCredsUpdated=t.onCredsUpdated,this.onAuxUpdated=t.onAuxUpdated,this.onReact=t.onReact,this.onDeleteTopic=t.onDeleteTopic,this.onAllMessagesReceived=t.onAllMessagesReceived)}static topicType(e){return{me:h,fnd:d,grp:l,new:l,nch:l,chn:l,usr:"p2p",sys:"sys",slf:"slf"}["string"==typeof e?e.substring(0,3):"xxx"]}static isMeTopicName(e){return B.topicType(e)==h}static isSelfTopicName(e){return"slf"==B.topicType(e)}static isGroupTopicName(e){return B.topicType(e)==l}static isP2PTopicName(e){return"p2p"==B.topicType(e)}static isCommTopicName(e){return B.isP2PTopicName(e)||B.isGroupTopicName(e)||B.isSelfTopicName(e)}static isNewGroupTopicName(e){return"string"==typeof e&&(e.substring(0,3)==o||e.substring(0,3)==c)}static isChannelTopicName(e){return"string"==typeof e&&("chn"==e.substring(0,3)||e.substring(0,3)==c)}static#S(e){return e.head&&e.head.replace}isSubscribed(){return this._attached}subscribe(e,t){return clearTimeout(this._delayedLeaveTimer),this._delayedLeaveTimer=null,this._attached?Promise.resolve(this):this._tinode.subscribe(this.name||o,e,t).then(e=>{if(e.code>=300)return e;if(this._attached=!0,this._deleted=!1,this.acs=e.params&&e.params.acs?e.params.acs:this.acs,this._new){if(delete this._new,this.name!=e.topic&&(this._cacheDelSelf(),this.name=e.topic),this._cachePutSelf(),this.created=e.ts,this.updated=e.ts,this.name!=h&&this.name!=d){const e=this._tinode.getMeTopic();e.onMetaSub&&e.onMetaSub(this),e.onSubsUpdated&&e.onSubsUpdated([this.name],1)}t&&t.desc&&(t.desc._noForwarding=!0,this._processMetaDesc(t.desc))}return e})}createMessage(e,t){return this._tinode.createMessage(this.name,e,t)}publish(e,t){return this.publishMessage(this.createMessage(e,t))}publishMessage(e){if(!this._attached)return Promise.reject(new Error("Cannot publish on inactive topic"));if(this._sending)return Promise.reject(new Error("The message is already being sent"));e._sending=!0,e._failed=!1;let t=null;return U().hasEntities(e.content)&&(t=[],U().entities(e.content,e=>{e&&(e.ref&&t.push(e.ref),e.preref&&t.push(e.preref))}),0==t.length&&(t=null)),this._tinode.publishMessage(e,t).then(t=>(e._sending=!1,e.ts=t.ts,this.swapMessageId(e,t.params.seq),this._maybeUpdateMessageVersionsCache(e),this._routeData(e),t)).catch(t=>{this._tinode.logger("WARNING: Message rejected by the server",t),e._sending=!1,e._failed=!0,this.onData&&this.onData()})}publishDraft(e,t){const s=e.seq||this._getQueuedSeqId();return e._noForwarding||(e._noForwarding=!0,e.seq=s,e.ts=new Date,e.from=this._tinode.getCurrentUserID(),e.noecho=!0,this._messages.put(e),this._tinode._db.addMessage(e),this.onData&&this.onData(e)),(t||Promise.resolve()).then(t=>e._cancelled?{code:300,text:"cancelled"}:this.publishMessage(e)).catch(t=>{throw this._tinode.logger("WARNING: Message draft rejected",t),e._sending=!1,e._failed=!0,e._fatal=t instanceof _&&t.code>=400&&t.code<500,this.onData&&this.onData(),t})}leave(e){return this._attached||e?this._tinode.leave(this.name,e).then(t=>(this._resetSub(),e&&this._gone(),t)):Promise.reject(new Error("Cannot leave inactive topic"))}leaveDelayed(e,t){clearTimeout(this._delayedLeaveTimer),this._delayedLeaveTimer=setTimeout(t=>{this._delayedLeaveTimer=null,this.leave(e)},t)}getMeta(e){return this._tinode.getMeta(this.name,e)}getMessagesPage(e,t,s,i,r){let n=t?this.startMetaQuery().withDataRanges(t,e):r?this.startMetaQuery().withData(s,void 0,e):this.startMetaQuery().withData(void 0,i,e);return this._loadMessages(this._tinode._db,n.extract("data")).then(a=>0==(t=this.msgHasMoreMessages(s,i,r)).length?Promise.resolve({topic:this.name,code:200,params:{count:a}}):(e-=a,n=this.startMetaQuery().withDataRanges(t,e),this.getMeta(n.build())))}getPinnedMessages(){const e=this.aux("pins");if(!Array.isArray(e))return Promise.resolve(0);const t=[];let s=e;return this._tinode._db.readMessages(this.name,{ranges:S(s)}).then(i=>(i.forEach(e=>{e&&(t.push(e.seq),this._messages.put(e),this._maybeUpdateMessageVersionsCache(e))}),t.length<e.length?(s=e.filter(e=>!t.includes(e)),this._tinode._db.readMessages(this.name,{ranges:S(s)})):null)).then(i=>(i&&s.forEach(e=>{i.find(t=>t.low<=e&&t.hi>e)&&t.push(e)}),t.length==e.length?Promise.resolve({topic:this.name,code:200,params:{count:t.length}}):(s=e.filter(e=>!t.includes(e)),this.getMeta(this.startMetaQuery().withDataList(s).build()))))}setMeta(e){return e.tags&&(e.tags=function(e){let t=[];if(Array.isArray(e)){for(let s=0,i=e.length;s<i;s++){let i=e[s];i&&(i=i.trim().toLowerCase(),i.length>1&&t.push(i))}t=t.sort().filter((e,t,s)=>!t||e!=s[t-1])}return 0==t.length&&t.push(p),t}(e.tags)),this._tinode.setMeta(this.name,e).then(t=>(t&&t.code>=300||(e.sub&&(e.sub.topic=this.name,t.params&&t.params.acs&&(e.sub.acs=t.params.acs,e.sub.updated=t.ts),e.sub.user||(e.sub.user=this._tinode.getCurrentUserID(),e.desc||(e.desc={})),e.sub._noForwarding=!0,this._processMetaSubs([e.sub])),e.desc&&(t.params&&t.params.acs&&(e.desc.acs=t.params.acs,e.desc.updated=t.ts),this._processMetaDesc(e.desc)),e.tags&&this._processMetaTags(e.tags),e.cred&&this._processMetaCreds([e.cred],!0),e.aux&&this._processMetaAux(e.aux),e.react&&(e.react.mrrid=0|t.params?.mrrid,this._processMetaReact(void 0,e.react))),t))}updateMode(e,t){const s=e?this.subscriber(e):null,i=s?s.acs.updateGiven(t).getGiven():this.getAccessMode().updateWant(t).getWant();return this.setMeta({sub:{user:e,mode:i}})}invite(e,t){return this.setMeta({sub:{user:e,mode:t}})}archive(e){return this.private&&!this.private.arch==!e?Promise.resolve(e):this.setMeta({desc:{private:{arch:!!e||p}}})}pinMessage(e,t){let s=this.aux("pins");Array.isArray(s)||(s=[]);let i=!1;return t?s.includes(e)||(i=!0,5==s.length&&s.shift(),s.push(e)):s.includes(e)&&(i=!0,s=s.filter(t=>t!=e),0==s.length&&(s=p)),i?this.setMeta({aux:{pins:s}}):Promise.resolve()}pinTopic(e,t){return Promise.reject(new Error("Pinning topics is not supported here"))}pinnedTopicRank(e){return 0}react(e,t){if(!e||!t)return Promise.reject(new Error("Invalid parameters"));this.msgMyReaction(e)==t&&(t=p),this.setMeta({react:{seq:e,val:t}})}reactions(){const e=this.aux("react");return e?e.vals:this._tinode.getServerParam(m)}maxReactions(){const e=this.aux("react");return e?e.max:this._tinode.getServerParam(f,0)}markReactionsSeen(){this._mrrSeen!=this.mrrid&&(this._mrrSeen=this.mrrid,this._tinode.getMeTopic()._refreshContact("react",this))}delMessages(e,t){if(!this._attached)return Promise.reject(new Error("Cannot delete messages in inactive topic"));const s=T(e,this._maxSeq);let i;return i=s.length>0?this._tinode.delMessages(this.name,s,t):Promise.resolve({params:{del:0}}),i.then(t=>(t.params.del>this._maxDel&&(this._maxDel=Math.max(t.params.del,this._maxDel),this.clear=Math.max(t.params.del,this.clear)),e.forEach(e=>{e.hi?this.flushMessageRange(e.low,e.hi):this.flushMessage(e.low),this._messages.put({seq:e.low,low:e.low,hi:e.hi,_deleted:!0})}),this._tinode._db.addDelLog(this.name,t.params.del,e),this.onData&&this.onData(),t))}delMessagesAll(e){return!this._maxSeq||this._maxSeq<=0?Promise.resolve():this.delMessages([{low:1,hi:this._maxSeq+1,_all:!0}],e)}delMessagesList(e,t){return this.delMessages(S(e),t)}delMessagesEdits(e,t){const s=[e];return this.messageVersions(e,e=>s.push(e.seq)),this.delMessagesList(s,t)}delTopic(e){return this._deleted?(this._gone(),Promise.resolve(null)):this._tinode.delTopic(this.name,e).then(e=>(this._deleted=!0,this._resetSub(),this._gone(),e))}delSubscription(e){return this._attached?this._tinode.delSubscription(this.name,e).then(t=>(delete this._users[e],this.onSubsUpdated&&this.onSubsUpdated(Object.keys(this._users)),t)):Promise.reject(new Error("Cannot delete subscription in inactive topic"))}note(e,t){if(!this._attached)return;const s=this._users[this._tinode.getCurrentUserID()];let i=!1;s?(!s[e]||s[e]<t)&&(s[e]=t,i=!0):i=(0|this[e])<t,i&&(this._tinode.note(this.name,e,t),this._updateMyReadRecv(e,t),null!=this.acs&&!this.acs.isMuted())&&this._tinode.getMeTopic()._refreshContact(e,this)}noteRecv(e){this.note("recv",e)}noteRead(e){(e=e||this._maxSeq)>0&&this.note("read",e)}noteKeyPress(){this._attached?this._tinode.noteKeyPress(this.name):this._tinode.logger("INFO: Cannot send notification in inactive topic")}noteRecording(e){this._attached?this._tinode.noteKeyPress(this.name,e?"kpa":"kpv"):this._tinode.logger("INFO: Cannot send notification in inactive topic")}videoCall(e,t,s){(this._attached||["ringing","hang-up"].includes(e))&&this._tinode.videoCall(this.name,t,e,s)}_updateMyReadRecv(e,t,s){let i,r=!1;switch(t|=0,this.seq=0|this.seq,this.read=0|this.read,this.recv=0|this.recv,e){case"recv":i=this.recv,this.recv=Math.max(this.recv,t),r=i!=this.recv;break;case"read":i=this.read,this.read=Math.max(this.read,t),r=i!=this.read;break;case"msg":i=this.seq,this.seq=Math.max(this.seq,t),(!this.touched||this.touched<s)&&(this.touched=s),r=i!=this.seq}return this.recv<this.read&&(this.recv=this.read,r=!0),this.seq<this.recv&&(this.seq=this.recv,(!this.touched||this.touched<s)&&(this.touched=s),r=!0),this.unread=this.seq-this.read,r}userDesc(e){const t=this._cacheGetUser(e);if(t)return t}p2pPeerDesc(){if(this.isP2PType())return this._users[this.name]}subscribers(e,t){const s=e||this.onMetaSub;if(s)for(let e in this._users)s.call(t,this._users[e],e,this._users)}tags(){return this._tags.slice(0)}aux(e){return this._aux[e]}alias(){const e=this._tags&&this._tags.find(e=>e.startsWith(g));if(e)return e.substring(6)}subscriber(e){return this._users[e]}messageVersions(e,t,s){if(!t)return;const i=this._messageVersions[e];i&&i.forEach(t,void 0,void 0,s)}messages(e,t,s,i){const r=e||this.onData;if(r){const e="number"==typeof t?this._messages.find({seq:t},!0):void 0,n="number"==typeof s?this._messages.find({seq:s},!0):void 0;if(-1!=e&&-1!=n){let t=[];this._messages.forEach((e,s,i,r)=>{if(B.#S(e))return;if(e._deleted)return;const n=this.latestMsgVersion(e.seq)||e;n._origTs||(n._origTs=n.ts,n._origSeq=n.seq,n.ts=e.ts,n.seq=e.seq),t.push({data:n,idx:r})},e,n,{}),t.forEach((e,s)=>{r.call(i,e.data,s>0?t[s-1].data:void 0,s<t.length-1?t[s+1].data:void 0,e.idx)})}}}findMessage(e){const t=this._messages.find({seq:e});if(t>=0)return this._messages.getAt(t)}latestMessage(){return this._messages.getLast(e=>!e._deleted)}latestMsgVersion(e){const t=this._messageVersions[e];return t?t.getLast():null}maxMsgSeq(){return this._maxSeq}minMsgSeq(){return this._minSeq}maxClearId(){return this._maxDel}messageCount(){return this._messages.length()}queuedMessages(e,t){if(!e)throw new Error("Callback must be provided");this.messages(e,u,void 0,t)}msgReceiptCount(e,t){let s=0;if(t>0){const i=this._tinode.getCurrentUserID();for(let r in this._users){const n=this._users[r];n.user!==i&&n[e]>=t&&s++}}return s}msgReadCount(e){return this.msgReceiptCount("read",e)}msgRecvCount(e){return this.msgReceiptCount("recv",e)}msgReactions(e){const t=this.findMessage(e);return t&&t.react||[]}msgMyReaction(e){const t=this.msgReactions(e),s=this._tinode.getCurrentUserID();for(let e=0;e<t.length;e++)if((t[e].users||[]).includes(s))return t[e].val;return null}hasUnseenReactions(){return this.mrrid>this._mrrSeen}msgHasMoreMessages(e,t,s){const i=[];if(e>=t)return i;let r,n=0;return this._messages.forEach((a,o)=>{const c=o||{seq:0},h=c._deleted?c.hi:c.seq+1;r=a.seq>h?{low:h,hi:a.seq}:null,r&&(s?r.hi>=e:r.low<t)&&i.push(r),n=h}),n<this.seq&&(r={low:n+1,hi:this.seq+1},(s?r.hi>=e:r.low<t)&&i.push(r)),i}isNewMessage(e){return this._maxSeq<=e}flushMessage(e){const t=this._messages.find({seq:e});if(delete this._messageVersions[e],t>=0)return this._tinode._db.remMessages(this.name,e),this._messages.delAt(t)}flushMessageRange(e,t){this._tinode._db.remMessages(this.name,e,t);for(let s=e;s<t;s++)delete this._messageVersions[s];const s=this._messages.find({seq:e},!0);return s>=0?this._messages.delRange(s,this._messages.find({seq:t},!0)):[]}swapMessageId(e,t){const s=this._messages.find(e),i=this._messages.length();0<=s&&s<i&&(this._messages.delAt(s),this._tinode._db.remMessages(this.name,e.seq),e.seq=t,this._messages.put(e),this._tinode._db.addMessage(e))}cancelSend(e){const t=this._messages.find({seq:e});if(t>=0){const s=this._messages.getAt(t),i=this.msgStatus(s);if(10==i||30==i||40==i)return this._tinode._db.remMessages(this.name,e),s._cancelled=!0,this._messages.delAt(t),this.onData&&this.onData(),!0}return!1}getType(){return B.topicType(this.name)}getAccessMode(){return this.acs}setAccessMode(e){return this.acs=new r(e)}getDefaultAccess(){return this.defacs}startMetaQuery(){return new z(this)}isArchived(){return this.private&&!!this.private.arch}isMeType(){return B.isMeTopicName(this.name)}isSelfType(){return B.isSelfTopicName(this.name)}isChannelType(){return B.isChannelTopicName(this.name)}isGroupType(){return B.isGroupTopicName(this.name)}isP2PType(){return B.isP2PTopicName(this.name)}isCommType(){return B.isCommTopicName(this.name)}msgStatus(e,t){let s=0;return this._tinode.isMe(e.from)?e._sending?s=20:e._fatal||e._cancelled?s=40:e._failed?s=30:e.seq>=u?s=10:this.msgReadCount(e.seq)>0?s=70:this.msgRecvCount(e.seq)>0?s=60:e.seq>0&&(s=50):s=80,t&&e._status!=s&&(e._status=s,this._tinode._db.updMessageStatus(this.name,e.seq,s)),s}_maybeUpdateMessageVersionsCache(e){if(!B.#S(e))return void(this._messageVersions[e.seq]&&(this._messageVersions[e.seq].filter(t=>t.from==e.from),this._messageVersions[e.seq].isEmpty()&&delete this._messageVersions[e.seq]));const t=parseInt(e.head.replace.split(":")[1]);if(t>e.seq)return;const s=this.findMessage(t);if(s&&s.from!=e.from)return;const i=this._messageVersions[t]||new F((e,t)=>e.seq-t.seq,!0);i.put(e),this._messageVersions[t]=i}_routeData(e){e.content&&(!this.touched||this.touched<e.ts)&&(this.touched=e.ts,this._tinode._db.updTopic(this)),e.seq>this._maxSeq&&(this._maxSeq=e.seq,this.msgStatus(e,!0),clearTimeout(this._recvNotificationTimer),this._recvNotificationTimer=setTimeout(e=>{this._recvNotificationTimer=null,this.noteRecv(this._maxSeq)},100)),(e.seq<this._minSeq||0==this._minSeq)&&(this._minSeq=e.seq);const t=!this.isChannelType()&&!e.from||this._tinode.isMe(e.from);if(e.head&&e.head.webrtc&&e.head.mime==U().getContentType()&&e.content){const s={state:e.head.webrtc,duration:e.head["webrtc-duration"],incoming:!t};e.head.vc&&(s.vc=!0),e.content=U().updateVideoCall(e.content,s)}if(e.react){let t=0;e.react=(e.react||[]).map(e=>(t=Math.max(t,e.mrrid),{mrrid:e.mrrid,val:e.val,count:0|e.count,users:Array.isArray(e.users)?e.users.slice():[]})),this.mrrid<t&&(this.mrrid=t)}e._noForwarding||(this._messages.put(e),this._tinode._db.addMessage(e),this._maybeUpdateMessageVersionsCache(e)),this.onData&&this.onData(e);const s=t?"read":"msg";this._updateMyReadRecv(s,e.seq,e.ts),!t&&e.from&&this._routeInfo({what:"read",from:e.from,seq:e.seq,_noForwarding:!0}),this._tinode.getMeTopic()._refreshContact(s,this)}_routeMeta(e){e.desc&&this._processMetaDesc(e.desc),e.sub&&e.sub.length>0&&this._processMetaSubs(e.sub),e.del&&this._processDelMessages(e.del.clear,e.del.delseq),e.tags&&this._processMetaTags(e.tags),e.cred&&this._processMetaCreds(e.cred),e.aux&&this._processMetaAux(e.aux),e.react&&this._processMetaReact(e.react),this.onMeta&&this.onMeta(e)}_routePres(e){let t,s;switch(e.what){case"del":this._processDelMessages(e.clear,e.delseq);break;case"on":case"off":t=this._users[e.src],t?t.online="on"==e.what:this._tinode.logger("WARNING: Presence update for an unknown user",this.name,e.src);break;case"term":this._resetSub();break;case"upd":e.src&&!this._tinode.isTopicCached(e.src)&&this.getMeta(this.startMetaQuery().withOneSub(void 0,e.src).build());break;case"aux":this.getMeta(this.startMetaQuery().withAux().build());break;case"react":this._processMetaReact(void 0,{mrrid:0|e.id2,seq:0|e.seq,user:e.act,val:e.val});break;case"acs":if(s=e.src||this._tinode.getCurrentUserID(),t=this._users[s],t)t.acs.updateAll(e.dacs),this._processMetaSubs([{user:s,updated:new Date,acs:t.acs}]);else{const i=(new r).updateAll(e.dacs);i&&i.mode!=r._NONE&&(t=this._cacheGetUser(s),t?t.acs=i:(t={user:s,acs:i},this.getMeta(this.startMetaQuery().withOneSub(void 0,s).build())),t.updated=new Date,this._processMetaSubs([t]))}break;default:this._tinode.logger("INFO: Ignored presence update",e.what)}this.onPres&&this.onPres(e)}_routeInfo(e){switch(e.what){case"recv":case"read":const t=this._users[e.from];t&&(t[e.what]=e.seq,t.recv<t.read&&(t.recv=t.read));const s=this.latestMessage();s&&this.msgStatus(s,!0),this._tinode.isMe(e.from)&&!e._noForwarding&&this._updateMyReadRecv(e.what,e.seq),this._tinode.getMeTopic()._refreshContact(e.what,this);break;case"kp":case"kpa":case"kpv":case"call":break;default:this._tinode.logger("INFO: Ignored info update",e.what)}this.onInfo&&this.onInfo(e)}_processMetaDesc(e){if(this.isP2PType()&&(delete e.defacs,this._tinode._db.updUser(this.name,e.public)),y(this,e),this._tinode._db.updTopic(this),this.name!==h&&!e._noForwarding){const e=this._tinode.getMeTopic();e.onMetaSub&&e.onMetaSub(this),e.onSubsUpdated&&e.onSubsUpdated([this.name],1)}this.onMetaDesc&&this.onMetaDesc(this)}_processMetaSubs(e){for(let t in e){const s=e[t];s.online=!!s.online,this._lastSubsUpdate=new Date(Math.max(this._lastSubsUpdate,s.updated));let i=null;s.deleted?(delete this._users[s.user],i=s,this.subcnt--):(this._tinode.isMe(s.user)&&s.acs&&this._processMetaDesc({updated:s.updated,touched:s.touched,acs:s.acs}),this._users[s.user]||this.subcnt++,i=this._updateCachedUser(s.user,s)),this.onMetaSub&&this.onMetaSub(i)}this.onSubsUpdated&&this.onSubsUpdated(Object.keys(this._users))}_processMetaTags(e){(e==p||1==e.length&&e[0]==p)&&(e=[]),this._tags=e,this._tinode._db.updTopic(this),this.onTagsUpdated&&this.onTagsUpdated(e)}_processMetaCreds(e){}_processMetaAux(e){e=e&&e!=p?e:{},this._aux=y(this._aux,e),this._tinode._db.updTopic(this),this.onAuxUpdated&&this.onAuxUpdated(this._aux)}_handleReactionDiff(e,t){const s=[...e.react||[]],i=t.users[0],r=i?s.findIndex(e=>e.users.includes(i)):-1;if(r>=0){const e=s[r];if(t.val==p||e.val==t.val)if(e.count--,e.mrrid=Math.max(e.mrrid,t.mrrid),e.count<=0)s.splice(r,1);else{const t=e.users.indexOf(i);e.users.splice(t,1)}else{const n=e.users.indexOf(i);e.users.splice(n,1),e.count--,e.count<=0&&s.splice(r,1);const a=s.findIndex(e=>e.val==t.val);a>=0?(s[a].users.push(i),s[a].count++,s[a].mrrid=Math.max(s[a].mrrid,t.mrrid)):s.push({mrrid:t.mrrid,users:[i],count:1,val:t.val})}}else if(t.val!=p){const e=s.findIndex(e=>e.val==t.val);e>=0?(i&&s[e].users.push(i),s[e].count++,s[e].mrrid=Math.max(s[e].mrrid,t.mrrid)):s.push({mrrid:t.mrrid,users:i?[i]:[],count:1,val:t.val})}return s}_processMetaReact(e,t){if(!Array.isArray(e)){if(!t.seq||!t.val)return void this._tinode.logger("WARNING: invalid reaction");e=[{_diff:!0,seq:t.seq,data:[{mrrid:t.mrrid,val:t.val,count:1,users:[t.user||this._tinode.getCurrentUserID()]}]}]}const s=[];e.forEach(e=>{const t=this.findMessage(e.seq);if(s.push(e.seq),t){let s;s=e._diff?this._handleReactionDiff(t,e.data[0]):(e.data||[]).map(e=>({mrrid:e.mrrid,val:e.val,count:0|e.count,users:Array.isArray(e.users)?e.users.slice():[]})),t.react=s;const i=s.reduce((e,t)=>Math.max(e,t.mrrid),0);this.mrrid<i&&(this.mrrid=i),this._tinode._db.updMessageReact(this.name,e.seq,t.react)}}),this.onReact&&this.onReact(s)}_processDelMessages(e,t){this._maxDel=Math.max(e,this._maxDel),this.clear=Math.max(e,this.clear);let s=0;Array.isArray(t)&&(t.forEach(e=>{e.hi?(s+=e.hi-e.low,this.flushMessageRange(e.low,e.hi)):(s++,this.flushMessage(e.low)),this._messages.put({seq:e.low,low:e.low,hi:e.hi,_deleted:!0})}),this._tinode._db.addDelLog(this.name,e,t)),s>0&&this.onData&&this.onData()}_allMessagesReceived(e){this.onAllMessagesReceived&&this.onAllMessagesReceived(e)}_resetSub(){this._attached=!1}_gone(){this._messages.reset(),this._tinode._db.remMessages(this.name),this._users={},this.acs=new r(null),this.private=null,this.public=null,this.trusted=null,this._maxSeq=0,this._minSeq=0,this._maxDel=0,this._maxReact=0,this._attached=!1;const e=this._tinode.getMeTopic();e&&e._routePres({_noForwarding:!0,what:"gone",topic:h,src:this.name}),this.onDeleteTopic&&this.onDeleteTopic()}_updateCachedUser(e,t){let s=this._cacheGetUser(e);return s=y(s||{},t),this._cachePutUser(e,s),M(this._users,e,s)}_getQueuedSeqId(){return this._queuedSeqId++}_loadMessages(e,t){(t=t||{}).limit=t.limit||24;let s=0;return e.readMessages(this.name,t).then(e=>{e.forEach(e=>{e.seq>this._maxSeq&&(this._maxSeq=e.seq),(e.seq<this._minSeq||0==this._minSeq)&&(this._minSeq=e.seq),this._messages.put(e),this._maybeUpdateMessageVersionsCache(e)}),s=e.length}).then(s=>e.readDelLog(this.name,t)).then(e=>e.forEach(e=>{this._messages.put({seq:e.low,low:e.low,hi:e.hi,_deleted:!0})})).then(e=>s)}_updateReceived(e,t){this.touched=new Date,this.seq=0|e,t&&!this._tinode.isMe(t)||(this.read=this.read?Math.max(this.read,this.seq):this.seq,this.recv=this.recv?Math.max(this.read,this.recv):this.read),this.unread=this.seq-(0|this.read),this._tinode._db.updTopic(this)}}class K extends B{_contacts={};constructor(e){super(d,e)}_processMetaSubs(e){let t=Object.getOwnPropertyNames(this._contacts).length;this._contacts={};for(let s in e){let i=e[s];const r=i.topic?i.topic:i.user;i=M(this._contacts,r,i),t++,this.onMetaSub&&this.onMetaSub(i)}t>0&&this.onSubsUpdated&&this.onSubsUpdated(Object.keys(this._contacts))}publish(){return Promise.reject(new Error("Publishing to 'fnd' is not supported"))}setMeta(e){return Object.getPrototypeOf(K.prototype).setMeta.call(this,e).then(e=>{Object.keys(this._contacts).length>0&&(this._contacts={},this.onSubsUpdated&&this.onSubsUpdated([]))})}checkTagUniqueness(e,t){return new Promise((s,i)=>{this.subscribe().then(t=>this.setMeta({desc:{public:e}})).then(e=>this.getMeta(this.startMetaQuery().withTags().build())).then(e=>{e&&Array.isArray(e.tags)&&0!=e.tags.length||s(!0);const i=e.tags.filter(e=>e!==t);s(0==i.length)}).catch(e=>{i(e)})})}contacts(e,t){const s=e||this.onMetaSub;if(s)for(let e in this._contacts)s.call(t,this._contacts[e],e,this._contacts)}}class H extends B{onContactUpdate;constructor(e){super(h,e),e&&(this.onContactUpdate=e.onContactUpdate)}_processMetaDesc(e){const t=e.acs&&!e.acs.isPresencer()&&this.acs&&this.acs.isPresencer();y(this,e),this._tinode._db.updTopic(this),this._updateCachedUser(this._tinode._myUID,e),t&&this._tinode.mapTopics(e=>{e.online&&(e.online=!1,e.seen=Object.assign(e.seen||{},{when:new Date}),this._refreshContact("off",e))}),this.onMetaDesc&&this.onMetaDesc(this)}_processMetaSubs(e){let t=0;if(e.forEach(e=>{const s=e.topic;if(s==d||s==h)return;e.online=!!e.online;let i=null;if(e.deleted)i=e,this._tinode.cacheRemTopic(s),this._tinode._db.remTopic(s);else{void 0!==e.seq&&(e.seq=0|e.seq,e.recv=0|e.recv,e.read=0|e.read,e.unread=e.seq-e.read);const t=this._tinode.getTopic(s);t._new&&delete t._new,i=y(t,e),this._tinode._db.updTopic(i),B.isP2PTopicName(s)&&(this._cachePutUser(s,i),this._tinode._db.updUser(s,i.public)),!e._noForwarding&&t&&(e._noForwarding=!0,t._processMetaDesc(e))}t++,this.onMetaSub&&this.onMetaSub(i)}),this.onSubsUpdated&&t>0){const s=[];e.forEach(e=>{s.push(e.topic)}),this.onSubsUpdated(s,t)}}_processMetaCreds(e,t){1==e.length&&e[0]==p&&(e=[]),t?e.forEach(e=>{if(e.val){let t=this._credentials.findIndex(t=>t.meth==e.meth&&t.val==e.val);t<0?(e.done||(t=this._credentials.findIndex(t=>t.meth==e.meth&&!t.done),t>=0&&this._credentials.splice(t,1)),this._credentials.push(e)):this._credentials[t].done=e.done}else if(e.resp){const t=this._credentials.findIndex(t=>t.meth==e.meth&&!t.done);t>=0&&(this._credentials[t].done=!0)}}):this._credentials=e,this.onCredsUpdated&&this.onCredsUpdated(this._credentials)}_routePres(e){if("term"==e.what)return void this._resetSub();if("upd"==e.what&&e.src==h)return void this.getMeta(this.startMetaQuery().withDesc().build());const t=this._tinode.cacheGetTopic(e.src);if(t){switch(e.what){case"on":t.online=!0;break;case"off":t.online&&(t.online=!1,t.seen=Object.assign(t.seen||{},{when:new Date}));break;case"msg":t._updateReceived(e.seq,e.act);break;case"upd":this.getMeta(this.startMetaQuery().withLaterOneSub(e.src).build());break;case"acs":e.tgt||(t.acs?t.acs.updateAll(e.dacs):t.acs=(new r).updateAll(e.dacs),t.touched=new Date);break;case"ua":t.seen={when:new Date,ua:e.val};break;case"recv":e.seq=0|e.seq,t.recv=t.recv?Math.max(t.recv,e.seq):e.seq;break;case"read":e.seq=0|e.seq,t.read=t.read?Math.max(t.read,e.seq):e.seq,t.recv=t.recv?Math.max(t.read,t.recv):t.recv,t.unread=t.seq-t.read;break;case"gone":this._tinode.cacheRemTopic(e.src),t._deleted?this._tinode._db.remTopic(e.src):(t._deleted=!0,t._attached=!1,this._tinode._db.markTopicAsDeleted(e.src,!0));break;case"del":break;case"react":t._processMetaReact(void 0,{mrrid:0|e.id2,seq:e.seq,user:e.actor,val:e.val});break;default:this._tinode.logger("INFO: Unsupported presence update in 'me'",e.what)}this._refreshContact(e.what,t)}else{if("acs"==e.what){const t=new r(e.dacs);if(!t||t.mode==r._INVALID)return void this._tinode.logger("ERROR: Invalid access mode update",e.src,e.dacs);if(t.mode==r._NONE)return void this._tinode.logger("WARNING: Removing non-existent subscription",e.src,e.dacs);{this.getMeta(this.startMetaQuery().withOneSub(void 0,e.src).build());const s=this._tinode.getTopic(e.src);s.topic=e.src,s.online=!1,s.acs=t,this._tinode._db.updTopic(s)}}else if("tags"==e.what)this.getMeta(this.startMetaQuery().withTags().build());else if("msg"==e.what){this.getMeta(this.startMetaQuery().withOneSub(void 0,e.src).build());const t=this._tinode.getTopic(e.src);t._deleted=!1,this._tinode._db.updTopic(t)}this._refreshContact(e.what,t)}this.onPres&&this.onPres(e)}_refreshContact(e,t){this.onContactUpdate&&this.onContactUpdate(e,t)}publish(){return Promise.reject(new Error("Publishing to 'me' is not supported"))}delCredential(e,t){return this._attached?this._tinode.delCredential(e,t).then(s=>{const i=this._credentials.findIndex(s=>s.meth==e&&s.val==t);return i>-1&&this._credentials.splice(i,1),this.onCredsUpdated&&this.onCredsUpdated(this._credentials),s}):Promise.reject(new Error("Cannot delete credential in inactive 'me' topic"))}contacts(e,t,s){this._tinode.mapTopics((i,r)=>{!i.isCommType()||t&&!t(i)||e.call(s,i,r)})}getContact(e){return this._tinode.cacheGetTopic(e)}getAccessMode(e){if(e){const t=this._tinode.cacheGetTopic(e);return t?t.acs:null}return this.acs}isArchived(e){const t=this._tinode.cacheGetTopic(e);return t&&t.private&&!!t.private.arch}getCredentials(){return this._credentials}pinTopic(e,t){if(!this._attached)return Promise.reject(new Error("Cannot pin topic in inactive 'me' topic"));if(!B.isCommTopicName(e))return Promise.reject(new Error("Invalid topic to pin"));const s=Array.isArray(this.private&&this.private.tpin)?this.private.tpin:[],i=s.includes(e);return t&&i||!t&&!i?Promise.resolve(s):(t?s.unshift(e):s.splice(s.indexOf(e),1),this.setMeta({desc:{private:{tpin:s.length>0?s:p}}}))}pinnedTopicRank(e){if(!this.private||!this.private.tpin)return 0;const t=this.private.tpin.indexOf(e);return t<0?0:this.private.tpin.length-t}}function Q(e){return btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode("0x"+t)}))}function X(e,t){return"string"==typeof t&&t.length>128?"<"+t.length+", bytes: "+t.substring(0,12)+"..."+t.substring(t.length-12)+">":function(e,t){if(t instanceof Date)t=function(e){if(!v(e))return;const t=function(e,t){return"0".repeat((t=t||2)-(""+e).length)+e},s=e.getUTCMilliseconds();return e.getUTCFullYear()+"-"+t(e.getUTCMonth()+1)+"-"+t(e.getUTCDate())+"T"+t(e.getUTCHours())+":"+t(e.getUTCMinutes())+":"+t(e.getUTCSeconds())+(s?"."+t(s,3):"")+"Z"}(t);else if(t instanceof r)t=t.jsonHelper();else if(null==t||!1===t||Array.isArray(t)&&0==t.length||"object"==typeof t&&0==Object.keys(t).length)return;return t}(0,t)}"undefined"!=typeof WebSocket&&(L=WebSocket),"undefined"!=typeof XMLHttpRequest&&(V=XMLHttpRequest),"undefined"!=typeof indexedDB&&(G=indexedDB),function(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";"undefined"==typeof btoa&&(s.g.btoa=function(t=""){let s=t,i="";for(let t,r=0,n=0,a=e;s.charAt(0|n)||(a="=",n%1);i+=a.charAt(63&r>>8-n%1*8)){if(t=s.charCodeAt(n+=3/4),t>255)throw new Error("'btoa' failed: The string to be encoded contains characters outside of the Latin1 range.");r=r<<8|t}return i}),"undefined"==typeof atob&&(s.g.atob=function(t=""){let s=t.replace(/=+$/,""),i="";if(s.length%4==1)throw new Error("'atob' failed: The string to be decoded is not correctly encoded.");for(let t,r=0,n=0,a=0;t=s.charAt(a++);~t&&(n=r%4?64*n+t:t,r++%4)?i+=String.fromCharCode(255&n>>(-2*r&6)):0)t=e.indexOf(t);return i}),"undefined"==typeof window&&(s.g.window={WebSocket:L,XMLHttpRequest:V,indexedDB:G,URL:{createObjectURL:function(){throw new Error("Unable to use URL.createObjectURL in a non-browser application")}}}),I.setNetworkProviders(L,V),W.setNetworkProvider(V),q.setDatabaseProvider(G)}();class ${_host;_secure;_appName;_apiKey;_browser="";_platform;_hwos="undefined";_humanLanguage="xx";_loggingEnabled=!1;_trimLongStrings=!1;_myUID=null;_authenticated=!1;_login=null;_authToken=null;_inPacketCount=0;_messageId=Math.floor(65535*Math.random()+65535);_serverInfo=null;_deviceToken=null;_pendingPromises={};_expirePromises=null;_connection=null;_persist=!1;_db=null;_cache={};constructor(e,t){if(this._host=e.host,this._secure=e.secure,this._appName=e.appName||"Undefined",this._apiKey=e.apiKey,this._platform=e.platform||"web","undefined"!=typeof navigator&&(this._browser=function(e,t){e=e||"";let s,i="";/reactnative/i.test(t)&&(i="ReactNative; ");let r=(e=e.replace(" (KHTML, like Gecko)","")).match(/(AppleWebKit\/[.\d]+)/i);if(r){const t=["edg","chrome","safari","mobile","version"];let i,n=e.substr(r.index+r[0].length).split(" "),a=[];for(let e=0;e<n.length;e++){let s=/([\w.]+)[\/]([\.\d]+)/.exec(n[e]);s&&(a.push([s[1],s[2],t.findIndex(e=>s[1].toLowerCase().startsWith(e))]),"Version"==s[1]&&(i=s[2]))}a.sort((e,t)=>e[2]-t[2]),a.length>0?(a[0][0].toLowerCase().startsWith("edg")?a[0][0]="Edge":"OPR"==a[0][0]?a[0][0]="Opera":"Safari"==a[0][0]&&i&&(a[0][1]=i),s=a[0][0]+"/"+a[0][1]):s=r[1]}else/firefox/i.test(e)?(r=/Firefox\/([.\d]+)/g.exec(e),s=r?"Firefox/"+r[1]:"Firefox/?"):(r=/([\w.]+)\/([.\d]+)/.exec(e),r?s=r[1]+"/"+r[2]:(r=e.split(" "),s=r[0]));if(r=s.split("/"),r.length>1){const e=r[1].split("."),t=e[1]?"."+e[1].substr(0,2):"";s=`${r[0]}/${e[0]}${t}`}return i+s}(navigator.userAgent,navigator.product),this._hwos=navigator.platform,this._humanLanguage=navigator.language||"en-US"),I.logger=this.logger,U().logger=this.logger,"lp"!=e.transport&&"ws"!=e.transport&&(e.transport=function(){if("object"==typeof window){if(window.WebSocket)return"ws";if(window.XMLHttpRequest)return"lp"}return null}()),this._connection=new I(e,"0",!0),this._connection.onMessage=e=>{this.#P(e)},this._connection.onOpen=e=>this.#A(),this._connection.onDisconnect=(e,t)=>this.#R(e,t),this._connection.onAutoreconnectIteration=(e,t)=>{this.onAutoreconnectIteration&&this.onAutoreconnectIteration(e,t)},this._persist=e.persist,this._db=new q(this.logger,this.logger),this._persist){const e=[];this._db.initDatabase().then(t=>this._db.mapTopics(t=>{let s=this.#E("topic",t.name);s||(s=t.name==h?new H:t.name==d?new K:new B(t.name),this._db.deserializeTopic(s,t),this.#D(s),s._cachePutSelf(),this._db.maxDelId(s.name).then(e=>{s._maxDel=Math.max(s._maxDel,e||0)}),delete s._new,e.push(s._loadMessages(this._db)))})).then(e=>this._db.mapUsers(e=>{this.#N("user",e.uid,y({},e.public))})).then(t=>Promise.all(e)).then(e=>{t&&t(),this.logger("Persistent cache initialized.")}).catch(e=>{t&&t(e),this.logger("Failed to initialize persistent cache:",e)})}else this._db.deleteDatabase().then(e=>{t&&t()})}logger(e,...t){if(this._loggingEnabled){const s=new Date,i=("0"+s.getUTCHours()).slice(-2)+":"+("0"+s.getUTCMinutes()).slice(-2)+":"+("0"+s.getUTCSeconds()).slice(-2)+"."+("00"+s.getUTCMilliseconds()).slice(-3);console.log("["+i+"]",e,t.join(" "))}}#I(e){let t=null;return e&&(t=new Promise((t,s)=>{this._pendingPromises[e]={resolve:t,reject:s,ts:new Date}})),t}#k(e,t,s,i){const r=this._pendingPromises[e];r&&(delete this._pendingPromises[e],t>=200&&t<400?r.resolve&&r.resolve(s):r.reject&&r.reject(new _(i,t)))}#C(e,t){let s;t&&(s=this.#I(t)),e=x(e);let i=JSON.stringify(e);this.logger("out: "+(this._trimLongStrings?JSON.stringify(e,X):i));try{this._connection.sendText(i)}catch(e){if(!t)throw e;this.#k(t,I.NETWORK_ERROR,null,e.message)}return s}#P(e){if(!e)return;if(this._inPacketCount++,this.onRawMessage&&this.onRawMessage(e),"0"===e)return void(this.onNetworkProbe&&this.onNetworkProbe());let t=JSON.parse(e,b);t?(this.logger("in: "+(this._trimLongStrings?JSON.stringify(t,X):e)),this.onMessage&&this.onMessage(t),t.ctrl?(this.onCtrlMessage&&this.onCtrlMessage(t.ctrl),t.ctrl.id&&this.#k(t.ctrl.id,t.ctrl.code,t.ctrl,t.ctrl.text),setTimeout(e=>{if(205==t.ctrl.code&&"evicted"==t.ctrl.text){const e=this.#E("topic",t.ctrl.topic);e&&(e._resetSub(),t.ctrl.params&&t.ctrl.params.unsub&&e._gone())}else if(t.ctrl.code<300&&t.ctrl.params)if("data"==t.ctrl.params.what){const e=this.#E("topic",t.ctrl.topic);e&&e._allMessagesReceived(t.ctrl.params.count)}else if("sub"==t.ctrl.params.what){const e=this.#E("topic",t.ctrl.topic);e&&e._processMetaSubs([])}},0)):setTimeout(e=>{if(t.meta){const e=this.#E("topic",t.meta.topic);e&&e._routeMeta(t.meta),t.meta.id&&this.#k(t.meta.id,200,t.meta,"META"),this.onMetaMessage&&this.onMetaMessage(t.meta)}else if(t.data){const e=this.#E("topic",t.data.topic);e&&e._routeData(t.data),this.onDataMessage&&this.onDataMessage(t.data)}else if(t.pres){const e=this.#E("topic",t.pres.topic);e&&e._routePres(t.pres),this.onPresMessage&&this.onPresMessage(t.pres)}else if(t.info){const e=this.#E("topic",t.info.topic);e&&e._routeInfo(t.info),this.onInfoMessage&&this.onInfoMessage(t.info)}else this.logger("ERROR: Unknown packet received.")},0)):(this.logger("in: "+e),this.logger("ERROR: failed to parse data"))}#A(){this._expirePromises||(this._expirePromises=setInterval(e=>{const t=new _("timeout",504),s=new Date((new Date).getTime()-5e3);for(let e in this._pendingPromises){let i=this._pendingPromises[e];i&&i.ts<s&&(this.logger("Promise expired",e),delete this._pendingPromises[e],i.reject&&i.reject(t))}},1e3)),this.hello()}#R(e,t){this._inPacketCount=0,this._serverInfo=null,this._authenticated=!1,this._expirePromises&&(clearInterval(this._expirePromises),this._expirePromises=null),this.#q("topic",(e,t)=>{e._resetSub()});for(let t in this._pendingPromises){const s=this._pendingPromises[t];s&&s.reject&&s.reject(e)}this._pendingPromises={},this.onDisconnect&&this.onDisconnect(e)}#O(){return this._appName+" ("+(this._browser?this._browser+"; ":"")+this._hwos+"); "+a}#U(e,t){switch(e){case"hi":return{hi:{id:this.getNextUniqueId(),ver:n,ua:this.#O(),dev:this._deviceToken,lang:this._humanLanguage,platf:this._platform}};case"acc":return{acc:{id:this.getNextUniqueId(),user:null,scheme:null,secret:null,tmpscheme:null,tmpsecret:null,login:!1,tags:null,desc:{},cred:{}}};case"login":return{login:{id:this.getNextUniqueId(),scheme:null,secret:null}};case"sub":return{sub:{id:this.getNextUniqueId(),topic:t,set:{},get:{}}};case"leave":return{leave:{id:this.getNextUniqueId(),topic:t,unsub:!1}};case"pub":return{pub:{id:this.getNextUniqueId(),topic:t,noecho:!1,head:null,content:{}}};case"get":return{get:{id:this.getNextUniqueId(),topic:t,what:null,desc:{},sub:{},data:{}}};case"set":return{set:{id:this.getNextUniqueId(),topic:t,desc:{},sub:{},tags:[],aux:{}}};case"del":return{del:{id:this.getNextUniqueId(),topic:t,what:null,delseq:null,user:null,hard:!1}};case"note":return{note:{topic:t,what:null,seq:void 0}};default:throw new Error(`Unknown packet type requested: ${e}`)}}#N(e,t,s){this._cache[e+":"+t]=s}#E(e,t){return this._cache[e+":"+t]}#j(e,t){delete this._cache[e+":"+t]}#q(e,t,s){const i=e?e+":":void 0;for(let e in this._cache)if((!i||0==e.indexOf(i))&&t.call(s,this._cache[e],e))break}#D(e){e._tinode=this,e._cacheGetUser=e=>{const t=this.#E("user",e);if(t)return{user:e,public:y({},t)}},e._cachePutUser=(e,t)=>{this.#N("user",e,y({},t.public))},e._cacheDelUser=e=>{this.#j("user",e)},e._cachePutSelf=t=>{this.#N("topic",e.name,e)},e._cacheDelSelf=t=>{this.#j("topic",e.name)}}#L(e){return e.params&&e.params.user?(this._myUID=e.params.user,this._authenticated=e&&e.code>=200&&e.code<300,e.params&&e.params.token&&e.params.expires?this._authToken={token:e.params.token,expires:e.params.expires}:this._authToken=null,this.onLogin&&this.onLogin(e.code,e.text),e):e}static credential(e,t,s,i){return"object"==typeof e&&({val:t,params:s,resp:i,meth:e}=e),e&&(t||i)?[{meth:e,val:t,resp:i,params:s}]:null}static topicType(e){return B.topicType(e)}static isMeTopicName(e){return B.isMeTopicName(e)}static isSelfTopicName(e){return B.isSelfTopicName(e)}static isGroupTopicName(e){return B.isGroupTopicName(e)}static isP2PTopicName(e){return B.isP2PTopicName(e)}static isCommTopicName(e){return B.isCommTopicName(e)}static isNewGroupTopicName(e){return B.isNewGroupTopicName(e)}static isChannelTopicName(e){return B.isChannelTopicName(e)}static getVersion(){return n}static setNetworkProviders(e,t){L=e,V=t,I.setNetworkProviders(L,V),W.setNetworkProvider(V)}static setDatabaseProvider(e){G=e,q.setDatabaseProvider(G)}static getLibrary(){return a}static isNullValue(e){return e===p}static isServerAssignedSeq(e){return e>0&&e<u}static isValidTagValue(e){return e&&"string"==typeof e&&e.length>3&&e.length<24&&/^[a-z0-9][a-z0-9_\-]{3,23}$/i.test(e)}static tagSplit(e){if(!e)return null;const t=(e=e.trim()).indexOf(":");if(t<=0)return null;const s=e.substring(t+1);return s?{prefix:e.substring(0,t),value:s}:null}static setUniqueTag(e,t){if(!e||0==e.length)return[t];const s=$.tagSplit(t);return s?((e=e.filter(e=>e&&!e.startsWith(s.prefix))).push(t),e):e}static clearTagPrefix(e,t){return e&&0!=e.length?e.filter(e=>e&&!e.startsWith(t)):[]}static tagByPrefix(e,t){if(e)return e.find(e=>e&&e.startsWith(t))}getNextUniqueId(){return 0!=this._messageId?""+this._messageId++:void 0}connect(e){return this._connection.connect(e)}reconnect(e){this._connection.reconnect(e)}disconnect(){this._connection.disconnect()}clearStorage(){return this._db.isReady()?this._db.deleteDatabase():Promise.resolve()}initStorage(){return this._db.isReady()?Promise.resolve():this._db.initDatabase()}networkProbe(){this._connection.probe()}isConnected(){return this._connection.isConnected()}isAuthenticated(){return this._authenticated}authorizeURL(e){if("string"!=typeof e)return e;if(w(e)){const t="scheme://host/",s=new URL(e,t);this._apiKey&&s.searchParams.append("apikey",this._apiKey),this._authToken&&this._authToken.token&&(s.searchParams.append("auth","token"),s.searchParams.append("secret",this._authToken.token)),e=s.toString().substring(t.length-1)}return e}account(e,t,s,i,r){const n=this.#U("acc");return n.acc.user=e,n.acc.scheme=t,n.acc.secret=s,n.acc.login=i,r&&(n.acc.desc.defacs=r.defacs,n.acc.desc.public=r.public,n.acc.desc.private=r.private,n.acc.desc.trusted=r.trusted,n.acc.tags=r.tags,n.acc.cred=r.cred,n.acc.tmpscheme=r.scheme,n.acc.tmpsecret=r.secret,Array.isArray(r.attachments)&&r.attachments.length>0&&(n.extra={attachments:r.attachments.filter(e=>w(e))})),this.#C(n,n.acc.id)}createAccount(e,t,s,i){let r=this.account("new",e,t,s,i);return s&&(r=r.then(e=>this.#L(e))),r}createAccountBasic(e,t,s){return e=e||"",t=t||"",this.createAccount("basic",Q(e+":"+t),!0,s)}updateAccountBasic(e,t,s,i){return t=t||"",s=s||"",this.account(e,"basic",Q(t+":"+s),!1,i)}hello(){const e=this.#U("hi");return this.#C(e,e.hi.id).then(e=>(this._connection.backoffReset(),e.params&&(this._serverInfo=e.params),this.onConnect&&this.onConnect(),e)).catch(e=>{this._connection.reconnect(!0),this.onDisconnect&&this.onDisconnect(e)})}setDeviceToken(e){let t=!1;return(e=e||null)!=this._deviceToken&&(this._deviceToken=e,this.isConnected()&&this.isAuthenticated()&&(this.#C({hi:{dev:e||$.DEL_CHAR}}),t=!0)),t}login(e,t,s){const i=this.#U("login");return i.login.scheme=e,i.login.secret=t,i.login.cred=s,this.#C(i,i.login.id).then(e=>this.#L(e))}loginBasic(e,t,s){return this.login("basic",Q(e+":"+t),s).then(t=>(this._login=e,t))}loginToken(e,t){return this.login("token",e,t)}requestResetAuthSecret(e,t,s){return this.login("reset",Q(e+":"+t+":"+s))}getAuthToken(){return this._authToken&&this._authToken.expires.getTime()>Date.now()?this._authToken:(this._authToken=null,null)}setAuthToken(e){this._authToken=e}subscribe(e,t,s){const i=this.#U("sub",e);if(e||(e=o),i.sub.get=t,s){if(s.sub&&(i.sub.set.sub=s.sub),s.desc){const t=s.desc;$.isNewGroupTopicName(e)?i.sub.set.desc=t:$.isP2PTopicName(e)&&t.defacs&&(i.sub.set.desc={defacs:t.defacs})}Array.isArray(s.attachments)&&s.attachments.length>0&&(i.extra={attachments:s.attachments.filter(e=>w(e))}),s.tags&&(i.sub.set.tags=s.tags),s.aux&&(i.sub.set.aux=s.aux)}return this.#C(i,i.sub.id)}leave(e,t){const s=this.#U("leave",e);return s.leave.unsub=t,this.#C(s,s.leave.id)}createMessage(e,t,s){const i=this.#U("pub",e);let r="string"==typeof t?U().parse(t):t;return r&&!U().isPlainText(r)&&(i.pub.head={mime:U().getContentType()},t=r),i.pub.noecho=s,i.pub.content=t,i.pub}publish(e,t,s){return this.publishMessage(this.createMessage(e,t,s))}publishMessage(e,t){(e=Object.assign({},e)).seq=void 0,e.from=void 0,e.ts=void 0;const s={pub:e};return t&&(s.extra={attachments:t.filter(e=>w(e))}),this.#C(s,e.id)}oobNotification(e){switch(this.logger("oob: "+(this._trimLongStrings?JSON.stringify(e,X):e)),e.what){case"msg":if(!e.seq||e.seq<1||!e.topic)break;if(!this.isConnected())break;const t=this.#E("topic",e.topic);if(!t)break;if(t.isSubscribed())break;t.maxMsgSeq()<e.seq&&(t.isChannelType()&&t._updateReceived(e.seq,"fake-uid"),e.xfrom&&!this.#E("user",e.xfrom)&&this.getMeta(e.xfrom,(new z).withDesc().build()).catch(e=>{this.logger("Failed to get the name of a new sender",e)}),t.subscribe(null).then(e=>t.getMeta(new z(t).withLaterData(24).withLaterDel(24).build())).then(e=>{t.leaveDelayed(!1,1e3)}).catch(e=>{this.logger("On push data fetch failed",e)}).finally(e=>{this.getMeTopic()._refreshContact("msg",t)}));break;case"read":this.getMeTopic()._routePres({what:"read",seq:e.seq});break;case"sub":if(!this.isMe(e.xfrom))break;const s={given:e.modeGiven,want:e.modeWant},i=new r(s),n=i.mode&&i.mode!=r._NONE?{what:"acs",src:e.topic,dacs:s}:{what:"gone",src:e.topic};this.getMeTopic()._routePres(n);break;default:this.logger("Unknown push type ignored",e.what)}}getMeta(e,t){const s=this.#U("get",e);return s.get=y(s.get,t),this.#C(s,s.get.id)}setMeta(e,t){const s=this.#U("set",e),i=[];return t&&(["desc","sub","tags","cred","aux","react"].forEach(e=>{t.hasOwnProperty(e)&&(i.push(e),s.set[e]=t[e])}),Array.isArray(t.attachments)&&t.attachments.length>0&&(s.extra={attachments:t.attachments.filter(e=>w(e))})),0==i.length?Promise.reject(new Error("Invalid {set} parameters")):this.#C(s,s.set.id)}delMessages(e,t,s){const i=this.#U("del",e);return i.del.what="msg",i.del.delseq=t,i.del.hard=s,this.#C(i,i.del.id)}delTopic(e,t){const s=this.#U("del",e);return s.del.what="topic",s.del.hard=t,this.#C(s,s.del.id)}delSubscription(e,t){const s=this.#U("del",e);return s.del.what="sub",s.del.user=t,this.#C(s,s.del.id)}delCredential(e,t){const s=this.#U("del",h);return s.del.what="cred",s.del.cred={meth:e,val:t},this.#C(s,s.del.id)}delCurrentUser(e){const t=this.#U("del",null);return t.del.what="user",t.del.hard=e,this.#C(t,t.del.id).then(e=>{this._myUID=null})}note(e,t,s){if(s<=0||s>=u)throw new Error(`Invalid message id ${s}`);const i=this.#U("note",e);i.note.what=t,i.note.seq=s,this.#C(i)}noteKeyPress(e,t){const s=this.#U("note",e);s.note.what=t||"kp",this.#C(s)}videoCall(e,t,s,i){const r=this.#U("note",e);r.note.seq=t,r.note.what="call",r.note.event=s,r.note.payload=i,this.#C(r)}react(e,t,s){const i=this.#U("note",e);i.note.seq=t,i.note.what="react",i.note.payload={emo:s},this.#C(i)}getTopic(e){let t=this.#E("topic",e);return!t&&e&&(t=e==h?new H:e==d?new K:new B(e),this.#D(t),t._cachePutSelf()),t}cacheGetTopic(e){return this.#E("topic",e)}cacheRemTopic(e){this.#j("topic",e)}mapTopics(e,t){this.#q("topic",e,t)}isTopicCached(e){return!!this.#E("topic",e)}newGroupTopicName(e){return(e?c:o)+this.getNextUniqueId()}getMeTopic(){return this.getTopic(h)}getFndTopic(){return this.getTopic(d)}getLargeFileHelper(){return new W(this,"0")}getCurrentUserID(){return this._myUID}isMe(e){return this._myUID===e}getCurrentLogin(){return this._login}getServerInfo(){return this._serverInfo}report(e,t){return this.publish("sys",U().attachJSON(null,{action:e,target:t}))}getServerParam(e,t){return this._serverInfo&&this._serverInfo[e]||t}enableLogging(e,t){this._loggingEnabled=e,this._trimLongStrings=e&&t}setHumanLanguage(e){e&&(this._humanLanguage=e)}isTopicOnline(e){const t=this.#E("topic",e);return t&&t.online}getTopicAccessMode(e){const t=this.#E("topic",e);return t?t.acs:null}wantAkn(e){this._messageId=e?Math.floor(16777215*Math.random()+16777215):0}onWebsocketOpen=void 0;onConnect=void 0;onDisconnect=void 0;onLogin=void 0;onCtrlMessage=void 0;onDataMessage=void 0;onPresMessage=void 0;onMessage=void 0;onRawMessage=void 0;onNetworkProbe=void 0;onAutoreconnectIteration=void 0}return $.MESSAGE_STATUS_NONE=0,$.MESSAGE_STATUS_QUEUED=10,$.MESSAGE_STATUS_SENDING=20,$.MESSAGE_STATUS_FAILED=30,$.MESSAGE_STATUS_FATAL=40,$.MESSAGE_STATUS_SENT=50,$.MESSAGE_STATUS_RECEIVED=60,$.MESSAGE_STATUS_READ=70,$.MESSAGE_STATUS_TO_ME=80,$.DEL_CHAR=p,$.MAX_MESSAGE_SIZE="maxMessageSize",$.MAX_SUBSCRIBER_COUNT="maxSubscriberCount",$.MIN_TAG_LENGTH="minTagLength",$.MAX_TAG_LENGTH="maxTagLength",$.MAX_TAG_COUNT="maxTagCount",$.MAX_FILE_UPLOAD_SIZE="maxFileUploadSize",$.REQ_CRED_VALIDATORS="reqCred",$.MSG_DELETE_AGE="msgDelAge",$.REACTION_LIST=m,$.MAX_REACTIONS=f,$.URI_TOPIC_ID_PREFIX="tinode:topic/",$.TAG_ALIAS=g,$.TAG_EMAIL="email:",$.TAG_PHONE="tel:",i}()});