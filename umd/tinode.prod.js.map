{"version":3,"file":"tinode.prod.js","mappings":"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","sources":["webpack://tinode/webpack/universalModuleDefinition","webpack://tinode/./src/drafty.js","webpack://tinode/webpack/bootstrap","webpack://tinode/webpack/runtime/compat get default export","webpack://tinode/webpack/runtime/define property getters","webpack://tinode/webpack/runtime/global","webpack://tinode/webpack/runtime/hasOwnProperty shorthand","webpack://tinode/webpack/runtime/make namespace object","webpack://tinode/./src/access-mode.js","webpack://tinode/./version.js","webpack://tinode/./src/config.js","webpack://tinode/./src/comm-error.js","webpack://tinode/./src/utils.js","webpack://tinode/./src/connection.js","webpack://tinode/./src/db.js","webpack://tinode/./src/large-file.js","webpack://tinode/./src/meta-builder.js","webpack://tinode/./src/cbuffer.js","webpack://tinode/./src/topic.js","webpack://tinode/./src/fnd-topic.js","webpack://tinode/./src/me-topic.js","webpack://tinode/./src/the-card.js","webpack://tinode/./src/tinode.js"],"sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine([], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"tinode\"] = factory();\n\telse\n\t\troot[\"tinode\"] = factory();\n})(this, function() {\nreturn ","/**\n * @copyright 2015-2026 Tinode LLC.\n * @summary Minimally rich text representation and formatting for Tinode.\n * @license Apache 2.0\n *\n * @file Basic parser and formatter for very simple text markup. Mostly targeted at\n * mobile use cases similar to Telegram, WhatsApp, and FB Messenger.\n *\n * <p>Supports conversion of user keyboard input to formatted text:</p>\n * <ul>\n *   <li>*abc* &rarr; <b>abc</b></li>\n *   <li>_abc_ &rarr; <i>abc</i></li>\n *   <li>~abc~ &rarr; <del>abc</del></li>\n *   <li>`abc` &rarr; <tt>abc</tt></li>\n * </ul>\n * Also supports forms and buttons.\n *\n * Nested formatting is supported, e.g. *abc _def_* -> <b>abc <i>def</i></b>\n * URLs, @mentions, and #hashtags are extracted and converted into links.\n * Forms and buttons can be added procedurally.\n * JSON data representation is inspired by Draft.js raw formatting.\n *\n *\n * @example\n * Text:\n * <pre>\n *     this is *bold*, `code` and _italic_, ~strike~\n *     combined *bold and _italic_*\n *     an url: https://www.example.com/abc#fragment and another _www.tinode.co_\n *     this is a @mention and a #hashtag in a string\n *     second #hashtag\n * </pre>\n *\n *  Sample JSON representation of the text above:\n *  {\n *     \"txt\": \"this is bold, code and italic, strike combined bold and italic an url: https://www.example.com/abc#fragment \" +\n *             \"and another www.tinode.co this is a @mention and a #hashtag in a string second #hashtag\",\n *     \"fmt\": [\n *         { \"at\":8, \"len\":4,\"tp\":\"ST\" },{ \"at\":14, \"len\":4, \"tp\":\"CO\" },{ \"at\":23, \"len\":6, \"tp\":\"EM\"},\n *         { \"at\":31, \"len\":6, \"tp\":\"DL\" },{ \"tp\":\"BR\", \"len\":1, \"at\":37 },{ \"at\":56, \"len\":6, \"tp\":\"EM\" },\n *         { \"at\":47, \"len\":15, \"tp\":\"ST\" },{ \"tp\":\"BR\", \"len\":1, \"at\":62 },{ \"at\":120, \"len\":13, \"tp\":\"EM\" },\n *         { \"at\":71, \"len\":36, \"key\":0 },{ \"at\":120, \"len\":13, \"key\":1 },{ \"tp\":\"BR\", \"len\":1, \"at\":133 },\n *         { \"at\":144, \"len\":8, \"key\":2 },{ \"at\":159, \"len\":8, \"key\":3 },{ \"tp\":\"BR\", \"len\":1, \"at\":179 },\n *         { \"at\":187, \"len\":8, \"key\":3 },{ \"tp\":\"BR\", \"len\":1, \"at\":195 }\n *     ],\n *     \"ent\": [\n *         { \"tp\":\"LN\", \"data\":{ \"url\":\"https://www.example.com/abc#fragment\" } },\n *         { \"tp\":\"LN\", \"data\":{ \"url\":\"http://www.tinode.co\" } },\n *         { \"tp\":\"MN\", \"data\":{ \"val\":\"mention\" } },\n *         { \"tp\":\"HT\", \"data\":{ \"val\":\"hashtag\" } }\n *     ]\n *  }\n */\n\n'use strict';\n\n// NOTE TO DEVELOPERS:\n// Localizable strings should be double quoted \"   \",\n// non-localizable strings should be single quoted 'non-localized'.\n\nconst MAX_FORM_ELEMENTS = 8;\nconst MAX_PREVIEW_ATTACHMENTS = 3;\nconst MAX_PREVIEW_DATA_SIZE = 64;\nconst DRAFTY_MIME_TYPE = 'text/x-drafty';\n// Drafty form-response MIME type.\nconst DRAFTY_FR_MIME_TYPE = 'text/x-drafty-fr';\n// Legacy Drafty form-response MIME type.\nconst DRAFTY_FR_MIME_TYPE_LEGACY = 'application/json'; // Remove in 2026.\nconst ALLOWED_ENT_FIELDS = ['act', 'height', 'duration', 'fn', 'incoming', 'mime', 'name',\n  'premime', 'preref', 'preview', 'ref', 'size', 'state', 'url', 'val', 'width'\n];\n\n// Intl.Segmenter is not available in Firefox 124 and earlier. FF 125 with support for Intl.Segmenter\n// was released on April 15, 2024. Polyfill is included in the top package (webapp).\nconst segmenter = new Intl.Segmenter();\n\n// Regular expressions for parsing inline formats. Javascript does not support lookbehind,\n// so it's a bit messy.\nconst INLINE_STYLES = [\n  // Strong = bold, *bold text*\n  {\n    name: 'ST',\n    start: /(?:^|[\\W_])(\\*)[^\\s*]/,\n    end: /[^\\s*](\\*)(?=$|[\\W_])/\n  },\n  // Emphesized = italic, _italic text_\n  {\n    name: 'EM',\n    start: /(?:^|\\W)(_)[^\\s_]/,\n    end: /[^\\s_](_)(?=$|\\W)/\n  },\n  // Deleted, ~strike this though~\n  {\n    name: 'DL',\n    start: /(?:^|[\\W_])(~)[^\\s~]/,\n    end: /[^\\s~](~)(?=$|[\\W_])/\n  },\n  // Code block `this is monospace`\n  {\n    name: 'CO',\n    start: /(?:^|\\W)(`)[^`]/,\n    end: /[^`](`)(?=$|\\W)/\n  }\n];\n\n// Relative weights of formatting spans. Greater index in array means greater weight.\nconst FMT_WEIGHT = ['QQ'];\n\n// RegExps for entity extraction (RF = reference)\nconst ENTITY_TYPES = [\n  // URLs\n  {\n    name: 'LN',\n    dataName: 'url',\n    pack: function(val) {\n      // Check if the protocol is specified, if not use http\n      if (!/^[a-z]+:\\/\\//i.test(val)) {\n        val = 'http://' + val;\n      }\n      return {\n        url: val\n      };\n    },\n    re: /(?:(?:https?|ftp):\\/\\/|www\\.|ftp\\.)[-A-Z0-9+&@#\\/%=~_|$?!:,.]*[A-Z0-9+&@#\\/%=~_|$]/ig\n  },\n  // Mentions @user (must be 2 or more characters)\n  {\n    name: 'MN',\n    dataName: 'val',\n    pack: function(val) {\n      return {\n        val: val.slice(1)\n      };\n    },\n    re: /\\B@([\\p{L}\\p{N}][._\\p{L}\\p{N}]*[\\p{L}\\p{N}])/ug\n  },\n  // Hashtags #hashtag, like metion 2 or more characters.\n  {\n    name: 'HT',\n    dataName: 'val',\n    pack: function(val) {\n      return {\n        val: val.slice(1)\n      };\n    },\n    re: /\\B#([\\p{L}\\p{N}][._\\p{L}\\p{N}]*[\\p{L}\\p{N}])/ug\n  }\n];\n\n// HTML tag name suggestions\nconst FORMAT_TAGS = {\n  AU: {\n    html_tag: 'audio',\n    md_tag: undefined,\n    isVoid: false\n  },\n  BN: {\n    html_tag: 'button',\n    md_tag: undefined,\n    isVoid: false\n  },\n  BR: {\n    html_tag: 'br',\n    md_tag: '\\n',\n    isVoid: true\n  },\n  CO: {\n    html_tag: 'tt',\n    md_tag: '`',\n    isVoid: false\n  },\n  DL: {\n    html_tag: 'del',\n    md_tag: '~',\n    isVoid: false\n  },\n  EM: {\n    html_tag: 'i',\n    md_tag: '_',\n    isVoid: false\n  },\n  EX: {\n    html_tag: '',\n    md_tag: undefined,\n    isVoid: true\n  },\n  FM: {\n    html_tag: 'div',\n    md_tag: undefined,\n    isVoid: false\n  },\n  HD: {\n    html_tag: '',\n    md_tag: undefined,\n    isVoid: false\n  },\n  HL: {\n    html_tag: 'span',\n    md_tag: undefined,\n    isVoid: false\n  },\n  HT: {\n    html_tag: 'a',\n    md_tag: undefined,\n    isVoid: false\n  },\n  IM: {\n    html_tag: 'img',\n    md_tag: undefined,\n    isVoid: false\n  },\n  LN: {\n    html_tag: 'a',\n    md_tag: undefined,\n    isVoid: false\n  },\n  MN: {\n    html_tag: 'a',\n    md_tag: undefined,\n    isVoid: false\n  },\n  RW: {\n    html_tag: 'div',\n    md_tag: undefined,\n    isVoid: false,\n  },\n  QQ: {\n    html_tag: 'div',\n    md_tag: undefined,\n    isVoid: false\n  },\n  ST: {\n    html_tag: 'b',\n    md_tag: '*',\n    isVoid: false\n  },\n  TC: { // TheCard\n    html_tag: 'div',\n    md_tag: undefined,\n    isVoid: false\n  },\n  VC: {\n    html_tag: 'div',\n    md_tag: undefined,\n    isVoid: false\n  },\n  VD: {\n    html_tag: 'video',\n    md_tag: undefined,\n    isVoid: false\n  }\n};\n\n// Convert base64-encoded string into Blob.\nfunction base64toObjectUrl(b64, contentType, logger) {\n  if (!b64) {\n    return null;\n  }\n\n  try {\n    const bin = atob(b64);\n    const length = bin.length;\n    const buf = new ArrayBuffer(length);\n    const arr = new Uint8Array(buf);\n    for (let i = 0; i < length; i++) {\n      arr[i] = bin.charCodeAt(i);\n    }\n\n    return URL.createObjectURL(new Blob([buf], {\n      type: contentType\n    }));\n  } catch (err) {\n    if (logger) {\n      logger(\"Drafty: failed to convert object.\", err.message);\n    }\n  }\n\n  return null;\n}\n\nfunction base64toDataUrl(b64, contentType) {\n  if (!b64) {\n    return null;\n  }\n  contentType = contentType || 'image/jpeg';\n  return 'data:' + contentType + ';base64,' + b64;\n}\n\n// Helpers for converting Drafty to HTML.\nconst DECORATORS = {\n  // Visial styles\n  ST: {\n    open: _ => '<b>',\n    close: _ => '</b>'\n  },\n  EM: {\n    open: _ => '<i>',\n    close: _ => '</i>'\n  },\n  DL: {\n    open: _ => '<del>',\n    close: _ => '</del>'\n  },\n  CO: {\n    open: _ => '<tt>',\n    close: _ => '</tt>'\n  },\n  // Line break\n  BR: {\n    open: _ => '<br/>',\n    close: _ => ''\n  },\n  // Hidden element\n  HD: {\n    open: _ => '',\n    close: _ => ''\n  },\n  // Highlighted element.\n  HL: {\n    open: _ => '<span style=\"color:teal\">',\n    close: _ => '</span>'\n  },\n  // Link (URL)\n  LN: {\n    open: (data) => {\n      return '<a href=\"' + data.url + '\">';\n    },\n    close: _ => '</a>',\n    props: (data) => {\n      return data ? {\n        href: data.url,\n        target: '_blank'\n      } : null;\n    },\n  },\n  // Mention\n  MN: {\n    open: (data) => {\n      return '<a href=\"#' + data.val + '\">';\n    },\n    close: _ => '</a>',\n    props: (data) => {\n      return data ? {\n        id: data.val\n      } : null;\n    },\n  },\n  // Hashtag\n  HT: {\n    open: (data) => {\n      return '<a href=\"#' + data.val + '\">';\n    },\n    close: _ => '</a>',\n    props: (data) => {\n      return data ? {\n        id: data.val\n      } : null;\n    },\n  },\n  // Button\n  BN: {\n    open: _ => '<button>',\n    close: _ => '</button>',\n    props: (data) => {\n      return data ? {\n        'data-act': data.act,\n        'data-val': data.val,\n        'data-name': data.name,\n        'data-ref': data.ref\n      } : null;\n    },\n  },\n  // Audio recording\n  AU: {\n    open: (data) => {\n      const url = data.ref || base64toObjectUrl(data.val, data.mime, Drafty.logger);\n      return '<audio controls src=\"' + url + '\">';\n    },\n    close: _ => '</audio>',\n    props: (data) => {\n      if (!data) return null;\n      return {\n        // Embedded data or external link.\n        src: data.ref || base64toObjectUrl(data.val, data.mime, Drafty.logger),\n        'data-preload': data.ref ? 'metadata' : 'auto',\n        'data-duration': data.duration,\n        'data-name': data.name,\n        'data-size': data.val ? ((data.val.length * 0.75) | 0) : (data.size | 0),\n        'data-mime': data.mime,\n      };\n    }\n  },\n  // Image\n  IM: {\n    open: data => {\n      // Don't use data.ref for preview: it's a security risk.\n      const tmpPreviewUrl = base64toDataUrl(data._tempPreview, data.mime);\n      const previewUrl = base64toObjectUrl(data.val, data.mime, Drafty.logger);\n      const downloadUrl = data.ref || previewUrl;\n      return (data.name ? '<a href=\"' + downloadUrl + '\" download=\"' + data.name + '\">' : '') +\n        '<img src=\"' + (tmpPreviewUrl || previewUrl) + '\"' +\n        (data.width ? ' width=\"' + data.width + '\"' : '') +\n        (data.height ? ' height=\"' + data.height + '\"' : '') + ' border=\"0\" />';\n    },\n    close: data => {\n      return (data.name ? '</a>' : '');\n    },\n    props: data => {\n      if (!data) return null;\n      return {\n        // Temporary preview, or permanent preview, or external link.\n        src: base64toDataUrl(data._tempPreview, data.mime) ||\n          data.ref || base64toObjectUrl(data.val, data.mime, Drafty.logger),\n        title: data.name,\n        alt: data.name,\n        'data-width': data.width,\n        'data-height': data.height,\n        'data-name': data.name,\n        'data-size': data.ref ? (data.size | 0) : (data.val ? ((data.val.length * 0.75) | 0) : (data.size | 0)),\n        'data-mime': data.mime,\n      };\n    },\n  },\n  // Form - structured layout of elements.\n  FM: {\n    open: _ => '<div>',\n    close: _ => '</div>'\n  },\n  // Row: logic grouping of elements\n  RW: {\n    open: _ => '<div>',\n    close: _ => '</div>'\n  },\n  // Quoted block.\n  QQ: {\n    open: _ => '<div>',\n    close: _ => '</div>',\n    props: (data) => {\n      return data ? {} : null;\n    },\n  },\n  TC: { // TheCard\n    open: _ => '<div>',\n    close: _ => '</div>',\n    props: data => {\n      if (!data) return {};\n      return {\n        'data-fn': data.fn,\n        'data-title': data.title,\n      };\n    }\n  },\n  // Video call\n  VC: {\n    open: _ => '<div>',\n    close: _ => '</div>',\n    props: data => {\n      if (!data) return {};\n      return {\n        'data-duration': data.duration,\n        'data-state': data.state,\n      };\n    }\n  },\n  // Video.\n  VD: {\n    open: data => {\n      const tmpPreviewUrl = base64toDataUrl(data._tempPreview, data.mime);\n      const previewUrl = data.ref || base64toObjectUrl(data.preview, data.premime || 'image/jpeg', Drafty.logger);\n      return '<img src=\"' + (tmpPreviewUrl || previewUrl) + '\"' +\n        (data.width ? ' width=\"' + data.width + '\"' : '') +\n        (data.height ? ' height=\"' + data.height + '\"' : '') + ' border=\"0\" />';\n    },\n    close: _ => '',\n    props: data => {\n      if (!data) return null;\n      const poster = data.preref || base64toObjectUrl(data.preview, data.premime || 'image/jpeg', Drafty.logger);\n      return {\n        // Embedded data or external link.\n        src: poster,\n        'data-src': data.ref || base64toObjectUrl(data.val, data.mime, Drafty.logger),\n        'data-width': data.width,\n        'data-height': data.height,\n        'data-preload': data.ref ? 'metadata' : 'auto',\n        'data-preview': poster,\n        'data-duration': data.duration | 0,\n        'data-name': data.name,\n        'data-size': data.ref ? (data.size | 0) : (data.val ? ((data.val.length * 0.75) | 0) : (data.size | 0)),\n        'data-mime': data.mime,\n      };\n    }\n  },\n};\n\n/**\n * The main object which performs all the formatting actions.\n * @class Drafty\n * @constructor\n */\nconst Drafty = function() {\n  this.txt = '';\n  this.fmt = [];\n  this.ent = [];\n}\n\n/**\n * Initialize Drafty document to a plain text string.\n *\n * @param {string} plainText - string to use as Drafty content.\n *\n * @returns new Drafty document or null is plainText is not a string or undefined.\n */\nDrafty.init = function(plainText) {\n  if (typeof plainText == 'undefined') {\n    plainText = '';\n  } else if (typeof plainText != 'string') {\n    return null;\n  }\n\n  return {\n    txt: plainText\n  };\n}\n\n/**\n * Parse plain text into Drafty document.\n * @memberof Drafty\n * @static\n *\n * @param {string} content - plain-text content to parse.\n * @return {Drafty} parsed document or null if the source is not plain text.\n */\nDrafty.parse = function(content) {\n  // Make sure we are parsing strings only.\n  if (typeof content != 'string') {\n    return null;\n  }\n\n  // Split text into lines. It makes further processing easier.\n  const lines = content.split(/\\r?\\n/);\n\n  // Holds entities referenced from text\n  const entityMap = [];\n  const entityIndex = {};\n\n  // Processing lines one by one, hold intermediate result in blx.\n  const blx = [];\n  lines.forEach((line) => {\n    let spans = [];\n    let entities;\n\n    // Find formatted spans in the string.\n    // Try to match each style.\n    INLINE_STYLES.forEach((tag) => {\n      // Each style could be matched multiple times.\n      spans = spans.concat(spannify(line, tag.start, tag.end, tag.name));\n    });\n\n    let block;\n    if (spans.length == 0) {\n      block = {\n        txt: line\n      };\n    } else {\n      // Sort spans by style occurence early -> late, then by length: first long then short.\n      spans.sort((a, b) => {\n        const diff = a.at - b.at;\n        return diff != 0 ? diff : b.end - a.end;\n      });\n\n      // Convert an array of possibly overlapping spans into a tree.\n      spans = toSpanTree(spans);\n\n      // Build a tree representation of the entire string, not\n      // just the formatted parts.\n      const chunks = chunkify(line, 0, line.length, spans);\n\n      const drafty = draftify(chunks, 0);\n\n      block = {\n        txt: drafty.txt,\n        fmt: drafty.fmt\n      };\n    }\n\n    // Extract entities from the cleaned up string.\n    entities = extractEntities(block.txt);\n    if (entities.length > 0) {\n      const ranges = [];\n      for (let i in entities) {\n        // {offset: match['index'], unique: match[0], len: match[0].length, data: ent.packer(), type: ent.name}\n        const entity = entities[i];\n        let index = entityIndex[entity.unique];\n        if (!index) {\n          index = entityMap.length;\n          entityIndex[entity.unique] = index;\n          entityMap.push({\n            tp: entity.type,\n            data: entity.data\n          });\n        }\n        ranges.push({\n          at: entity.offset,\n          len: entity.len,\n          key: index\n        });\n      }\n      block.ent = ranges;\n    }\n\n    blx.push(block);\n  });\n\n  const result = {\n    txt: ''\n  };\n\n  // Merge lines and save line breaks as BR inline formatting.\n  if (blx.length > 0) {\n    result.txt = blx[0].txt;\n    result.fmt = (blx[0].fmt || []).concat(blx[0].ent || []);\n\n    if (result.fmt.length) {\n      const segments = segmenter.segment(result.txt);\n      for (const ele of result.fmt) {\n        ({\n            at: ele.at,\n            len: ele.len\n          } =\n          toGraphemeValues(ele, segments, result.txt));\n      }\n    }\n\n    for (let i = 1; i < blx.length; i++) {\n      const block = blx[i];\n      const offset = stringToGraphemes(result.txt).length + 1;\n\n      result.fmt.push({\n        tp: 'BR',\n        len: 1,\n        at: offset - 1\n      });\n\n      let segments = {};\n\n      result.txt += ' ' + block.txt;\n      if (block.fmt) {\n        segments = segmenter.segment(block.txt);\n        result.fmt = result.fmt.concat(\n          block.fmt.map((s) => {\n            const {\n              at: correctAt,\n              len: correctLen\n            } =\n            toGraphemeValues(s, segments, block.txt);\n            s.at = correctAt + offset;\n            s.len = correctLen;\n            return s;\n          })\n        );\n      }\n      if (block.ent) {\n        if (isEmptyObject(segments)) {\n          segments = segmenter.segment(block.txt);\n        }\n        result.fmt = result.fmt.concat(\n          block.ent.map((s) => {\n            const {\n              at: correctAt,\n              len: correctLen\n            } =\n            toGraphemeValues(s, segments, block.txt);\n            s.at = correctAt + offset;\n            s.len = correctLen;\n            return s;\n          })\n        );\n      }\n    }\n\n    if (result.fmt.length == 0) {\n      delete result.fmt;\n    }\n\n    if (entityMap.length > 0) {\n      result.ent = entityMap;\n    }\n  }\n  return result;\n}\n\n/**\n * Append one Drafty document to another.\n *\n * @param {Drafty} first - Drafty document to append to.\n * @param {Drafty|string} second - Drafty document or string being appended.\n *\n * @return {Drafty} first document with the second appended to it.\n */\nDrafty.append = function(first, second) {\n  if (!first) {\n    return second;\n  }\n  if (!second) {\n    return first;\n  }\n\n  first.txt = first.txt || '';\n  const len = stringToGraphemes(first.txt).length;\n\n  if (typeof second == 'string') {\n    first.txt += second;\n  } else if (second.txt) {\n    first.txt += second.txt;\n  }\n\n  if (Array.isArray(second.fmt)) {\n    first.fmt = first.fmt || [];\n    if (Array.isArray(second.ent)) {\n      first.ent = first.ent || [];\n    }\n    second.fmt.forEach(src => {\n      const fmt = {\n        at: (src.at | 0) + len,\n        len: src.len | 0\n      };\n      // Special case for the outside of the normal rendering flow styles.\n      if (src.at == -1) {\n        fmt.at = -1;\n        fmt.len = 0;\n      }\n      if (src.tp) {\n        fmt.tp = src.tp;\n      } else {\n        fmt.key = first.ent.length;\n        first.ent.push(second.ent[src.key || 0]);\n      }\n      first.fmt.push(fmt);\n    });\n  }\n\n  return first;\n}\n\n/**\n * Description of an image to attach.\n * @typedef {Object} ImageDesc\n * @memberof Drafty\n *\n * @property {string} mime - mime-type of the image, e.g. \"image/png\".\n * @property {string} refurl - reference to the content. Could be null/undefined.\n * @property {string} bits - base64-encoded image content. Could be null/undefined.\n * @property {string} preview - base64-encoded thumbnail of the image.\n * @property {integer} width - width of the image.\n * @property {integer} height - height of the image.\n * @property {string} filename - file name suggestion for downloading the image.\n * @property {integer} size - size of the image in bytes. Treat is as an untrusted hint.\n * @property {string} _tempPreview - base64-encoded image preview used during upload process; not serializable.\n * @property {Promise} urlPromise - Promise which returns content URL when resolved.\n */\n\n/**\n * Insert inline image into Drafty document.\n * @memberof Drafty\n * @static\n *\n * @param {Drafty} content - document to add image to.\n * @param {integer} at - index where the object is inserted. The length of the image is always 1.\n * @param {ImageDesc} imageDesc - object with image paramenets and data.\n *\n * @return {Drafty} updated document.\n */\nDrafty.insertImage = function(content, at, imageDesc) {\n  content = content || {\n    txt: ' '\n  };\n  content.ent = content.ent || [];\n  content.fmt = content.fmt || [];\n\n  content.fmt.push({\n    at: at | 0,\n    len: 1,\n    key: content.ent.length\n  });\n\n  const ex = {\n    tp: 'IM',\n    data: {\n      mime: imageDesc.mime,\n      ref: imageDesc.refurl,\n      val: imageDesc.bits || imageDesc.preview,\n      width: imageDesc.width,\n      height: imageDesc.height,\n      name: imageDesc.filename,\n      size: imageDesc.size | 0,\n    }\n  };\n\n  if (imageDesc.urlPromise) {\n    ex.data._tempPreview = imageDesc._tempPreview;\n    ex.data._processing = true;\n    imageDesc.urlPromise.then(\n      url => {\n        ex.data.ref = url;\n        ex.data._tempPreview = undefined;\n        ex.data._processing = undefined;\n      },\n      _ => {\n        // Catch the error, otherwise it will appear in the console.\n        ex.data._processing = undefined;\n      }\n    );\n  }\n\n  content.ent.push(ex);\n\n  return content;\n}\n\n/**\n * Description of a video to attach.\n * @typedef {Object} VideoDesc\n * @memberof Drafty\n *\n * @property {string} mime - mime-type of the video, e.g. \"video/mpeg\".\n * @property {string} refurl - reference to the content. Could be null/undefined.\n * @property {string} bits - in-band base64-encoded image data. Could be null/undefined.\n * @property {string} preview - base64-encoded screencapture from the video. Could be null/undefined.\n * @property {string} preref - reference to screencapture from the video. Could be null/undefined.\n * @property {integer} width - width of the video.\n * @property {integer} height - height of the video.\n * @property {integer} duration - duration of the video.\n * @property {string} filename - file name suggestion for downloading the video.\n * @property {integer} size - size of the video in bytes. Treat is as an untrusted hint.\n * @property {string} _tempPreview - base64-encoded screencapture used during upload process; not serializable.\n * @property {Promise} urlPromise - array of two promises, which return URLs of video and preview uploads correspondingly\n *        (either could be null).\n */\n\n/**\n * Insert inline image into Drafty document.\n * @memberof Drafty\n * @static\n *\n * @param {Drafty} content - document to add video to.\n * @param {integer} at - index where the object is inserted. The length of the video is always 1.\n * @param {VideoDesc} videoDesc - object with video paramenets and data.\n *\n * @return {Drafty} updated document.\n */\nDrafty.insertVideo = function(content, at, videoDesc) {\n  content = content || {\n    txt: ' '\n  };\n  content.ent = content.ent || [];\n  content.fmt = content.fmt || [];\n\n  content.fmt.push({\n    at: at | 0,\n    len: 1,\n    key: content.ent.length\n  });\n\n  const ex = {\n    tp: 'VD',\n    data: {\n      mime: videoDesc.mime,\n      ref: videoDesc.refurl,\n      val: videoDesc.bits,\n      preref: videoDesc.preref,\n      preview: videoDesc.preview,\n      width: videoDesc.width,\n      height: videoDesc.height,\n      duration: videoDesc.duration | 0,\n      name: videoDesc.filename,\n      size: videoDesc.size | 0,\n    }\n  };\n\n  if (videoDesc.urlPromise) {\n    ex.data._tempPreview = videoDesc._tempPreview;\n    ex.data._processing = true;\n    videoDesc.urlPromise.then(\n      urls => {\n        ex.data.ref = urls[0];\n        ex.data.preref = urls[1];\n        ex.data._tempPreview = undefined;\n        ex.data._processing = undefined;\n      },\n      _ => {\n        // Catch the error, otherwise it will appear in the console.\n        ex.data._processing = undefined;\n      }\n    );\n  }\n\n  content.ent.push(ex);\n\n  return content;\n}\n\n/**\n * Description of an audio recording to attach.\n * @typedef {Object} AudioDesc\n * @memberof Drafty\n *\n * @property {string} mime - mime-type of the audio, e.g. \"audio/ogg\".\n * @property {string} refurl - reference to the content. Could be null/undefined.\n * @property {string} bits - base64-encoded audio content. Could be null/undefined.\n * @property {integer} duration - duration of the record in milliseconds.\n * @property {string} preview - base64 encoded short array of amplitude values 0..100.\n * @property {string} filename - file name suggestion for downloading the audio.\n * @property {integer} size - size of the recording in bytes. Treat is as an untrusted hint.\n * @property {Promise} urlPromise - Promise which returns content URL when resolved.\n */\n\n/**\n * Insert audio recording into Drafty document.\n * @memberof Drafty\n * @static\n *\n * @param {Drafty} content - document to add audio record to.\n * @param {integer} at - index where the object is inserted. The length of the record is always 1.\n * @param {AudioDesc} audioDesc - object with the audio paramenets and data.\n *\n * @return {Drafty} updated document.\n */\nDrafty.insertAudio = function(content, at, audioDesc) {\n  content = content || {\n    txt: ' '\n  };\n  content.ent = content.ent || [];\n  content.fmt = content.fmt || [];\n\n  content.fmt.push({\n    at: at | 0,\n    len: 1,\n    key: content.ent.length\n  });\n\n  const ex = {\n    tp: 'AU',\n    data: {\n      mime: audioDesc.mime,\n      val: audioDesc.bits,\n      duration: audioDesc.duration | 0,\n      preview: audioDesc.preview,\n      name: audioDesc.filename,\n      size: audioDesc.size | 0,\n      ref: audioDesc.refurl\n    }\n  };\n\n  if (audioDesc.urlPromise) {\n    ex.data._processing = true;\n    audioDesc.urlPromise.then(\n      url => {\n        ex.data.ref = url;\n        ex.data._processing = undefined;\n      },\n      _ => {\n        // Catch the error, otherwise it will appear in the console.\n        ex.data._processing = undefined;\n      }\n    );\n  }\n\n  content.ent.push(ex);\n\n  return content;\n}\n\n/**\n * Create a (self-contained) video call Drafty document.\n * @memberof Drafty\n * @static\n * @param {boolean} audioOnly <code>true</code> if the call is initially audio-only.\n * @returns Video Call drafty document.\n */\nDrafty.videoCall = function(audioOnly) {\n  const content = {\n    txt: ' ',\n    fmt: [{\n      at: 0,\n      len: 1,\n      key: 0\n    }],\n    ent: [{\n      tp: 'VC',\n      data: {\n        aonly: audioOnly\n      },\n    }]\n  };\n  return content;\n}\n\n/**\n * Update video call (VC) entity with the new status and duration.\n * @memberof Drafty\n * @static\n *\n * @param {Drafty} content - VC document to update.\n * @param {object} params - new video call parameters.\n * @param {string} params.state - state of video call.\n * @param {number} params.duration - duration of the video call in milliseconds.\n *\n * @returns the same document with update applied.\n */\nDrafty.updateVideoCall = function(content, params) {\n  // The video element could be just a format or a format + entity.\n  // Must ensure it's the latter first.\n  const fmt = ((content || {}).fmt || [])[0];\n  if (!fmt) {\n    // Unrecognized content.\n    return content;\n  }\n\n  let ent;\n  if (fmt.tp == 'VC') {\n    // Just a format, convert to format + entity.\n    delete fmt.tp;\n    fmt.key = 0;\n    ent = {\n      tp: 'VC'\n    };\n    content.ent = [ent];\n  } else {\n    ent = (content.ent || [])[fmt.key | 0];\n    if (!ent || ent.tp != 'VC') {\n      // Not a VC entity.\n      return content;\n    }\n  }\n  ent.data = ent.data || {};\n  Object.assign(ent.data, params);\n  return content;\n}\n\n/**\n * Create a quote to Drafty document.\n * @memberof Drafty\n * @static\n *\n * @param {string} header - Quote header (title, etc.).\n * @param {string} uid - UID of the author to mention.\n * @param {Drafty} body - Body of the quoted message.\n *\n * @returns Reply quote Drafty doc with the quote formatting.\n */\nDrafty.quote = function(header, uid, body) {\n  const quote = Drafty.append(Drafty.appendLineBreak(Drafty.mention(header, uid)), body);\n\n  // Wrap into a quote.\n  quote.fmt.push({\n    at: 0,\n    len: stringToGraphemes(quote.txt).length,\n    tp: 'QQ'\n  });\n\n  return quote;\n}\n\n/**\n * Create a Drafty document with a mention.\n *\n * @param {string} name - mentioned name.\n * @param {string} uid - mentioned user ID.\n *\n * @returns {Drafty} document with the mention.\n */\nDrafty.mention = function(name, uid) {\n  return {\n    txt: name || '',\n    fmt: [{\n      at: 0,\n      len: stringToGraphemes(name || '').length,\n      key: 0\n    }],\n    ent: [{\n      tp: 'MN',\n      data: {\n        val: uid\n      }\n    }]\n  };\n}\n\n/**\n * Append a link to a Drafty document.\n *\n * @param {Drafty} content - Drafty document to append link to.\n * @param {Object} linkData - Link info in format <code>{txt: 'ankor text', url: 'http://...'}</code>.\n *\n * @returns {Drafty} the same document as <code>content</code>.\n */\nDrafty.appendLink = function(content, linkData) {\n  content = content || {\n    txt: ''\n  };\n\n  content.ent = content.ent || [];\n  content.fmt = content.fmt || [];\n\n  content.fmt.push({\n    at: content.txt.length,\n    len: linkData.txt.length,\n    key: content.ent.length\n  });\n  content.txt += linkData.txt;\n\n  const ex = {\n    tp: 'LN',\n    data: {\n      url: linkData.url\n    }\n  }\n  content.ent.push(ex);\n\n  return content;\n}\n\n/**\n * Append image to Drafty document.\n * @memberof Drafty\n * @static\n *\n * @param {Drafty} content - document to add image to.\n * @param {ImageDesc} imageDesc - object with image paramenets.\n *\n * @return {Drafty} updated document.\n */\nDrafty.appendImage = function(content, imageDesc) {\n  content = content || {\n    txt: ''\n  };\n  content.txt += ' ';\n  return Drafty.insertImage(content, content.txt.length - 1, imageDesc);\n}\n\n/**\n * Append audio recodring to Drafty document.\n * @memberof Drafty\n * @static\n *\n * @param {Drafty} content - document to add recording to.\n * @param {AudioDesc} audioDesc - object with audio data.\n *\n * @return {Drafty} updated document.\n */\nDrafty.appendAudio = function(content, audioDesc) {\n  content = content || {\n    txt: ''\n  };\n  content.txt += ' ';\n  return Drafty.insertAudio(content, content.txt.length - 1, audioDesc);\n}\n\n/**\n * Description of a file to attach.\n * @typedef {Object} AttachmentDesc\n * @memberof Drafty\n *\n * @property {string} mime - mime-type of the attachment, e.g. \"application/octet-stream\"\n * @property {string} data - base64-encoded in-band content of small attachments. Could be null/undefined.\n * @property {string} filename - file name suggestion for downloading the attachment.\n * @property {integer} size - size of the file in bytes. Treat is as an untrusted hint.\n * @property {string} refurl - reference to the out-of-band content. Could be null/undefined.\n * @property {Promise} urlPromise - Promise which returns content URL when resolved.\n */\n\n/**\n * Attach file to Drafty content. Either as a blob or as a reference.\n * @memberof Drafty\n * @static\n *\n * @param {Drafty} content - document to attach file to.\n * @param {AttachmentDesc} object - containing attachment description and data.\n *\n * @return {Drafty} updated document.\n */\nDrafty.attachFile = function(content, attachmentDesc) {\n  content = content || {\n    txt: ''\n  };\n\n  content.ent = content.ent || [];\n  content.fmt = content.fmt || [];\n\n  content.fmt.push({\n    at: -1,\n    len: 0,\n    key: content.ent.length\n  });\n\n  const ex = {\n    tp: 'EX',\n    data: {\n      mime: attachmentDesc.mime,\n      val: attachmentDesc.data,\n      name: attachmentDesc.filename,\n      ref: attachmentDesc.refurl,\n      size: attachmentDesc.size | 0\n    }\n  }\n  if (attachmentDesc.urlPromise) {\n    ex.data._processing = true;\n    attachmentDesc.urlPromise.then(\n      url => {\n        ex.data.ref = url;\n        ex.data._processing = undefined;\n      },\n      _ => {\n        /* catch the error, otherwise it will appear in the console. */\n        ex.data._processing = undefined;\n      }\n    );\n  }\n  content.ent.push(ex);\n\n  return content;\n}\n\n/**\n * Wraps drafty document into a simple formatting style.\n * @memberof Drafty\n * @static\n *\n * @param {Drafty|string} content - document or string to wrap into a style.\n * @param {string} style - two-letter style to wrap into.\n * @param {number} at - index where the style starts, default 0.\n * @param {number} len - length of the form content, default all of it.\n *\n * @return {Drafty} updated document.\n */\nDrafty.wrapInto = function(content, style, at, len) {\n  if (typeof content == 'string') {\n    content = {\n      txt: content\n    };\n  }\n  content.fmt = content.fmt || [];\n\n  content.fmt.push({\n    at: at || 0,\n    len: len || content.txt.length,\n    tp: style,\n  });\n\n  return content;\n}\n\n/**\n * Wraps content into an interactive form.\n * @memberof Drafty\n * @static\n *\n * @param {Drafty|string} content - to wrap into a form.\n * @param {number} at - index where the forms starts.\n * @param {number} len - length of the form content.\n *\n * @return {Drafty} updated document.\n */\nDrafty.wrapAsForm = function(content, at, len) {\n  return Drafty.wrapInto(content, 'FM', at, len);\n}\n\n/**\n * Insert clickable button into Drafty document.\n * @memberof Drafty\n * @static\n *\n * @param {Drafty|string} content - Drafty document to insert button to or a string to be used as button text.\n * @param {number} at - location where the button is inserted.\n * @param {number} len - the length of the text to be used as button title.\n * @param {string} name - the button. Client should return it to the server when the button is clicked.\n * @param {string} actionType - the type of the button, one of 'url' or 'pub'.\n * @param {string} actionValue - the value to return on click:\n * @param {string} refUrl - the URL to go to when the 'url' button is clicked.\n *\n * @return {Drafty} updated document.\n */\nDrafty.insertButton = function(content, at, len, name, actionType, actionValue, refUrl) {\n  if (typeof content == 'string') {\n    content = {\n      txt: content\n    };\n  }\n\n  if (!content || !content.txt || content.txt.length < at + len) {\n    return null;\n  }\n\n  if (len <= 0 || ['url', 'pub'].indexOf(actionType) == -1) {\n    return null;\n  }\n  // Ensure refUrl is a string.\n  if (actionType == 'url' && !refUrl) {\n    return null;\n  }\n  refUrl = '' + refUrl;\n\n  content.ent = content.ent || [];\n  content.fmt = content.fmt || [];\n\n  content.fmt.push({\n    at: at | 0,\n    len: len,\n    key: content.ent.length\n  });\n  content.ent.push({\n    tp: 'BN',\n    data: {\n      act: actionType,\n      val: actionValue,\n      ref: refUrl,\n      name: name\n    }\n  });\n\n  return content;\n}\n\n/**\n * Append clickable button to Drafty document.\n * @memberof Drafty\n * @static\n *\n * @param {Drafty|string} content - Drafty document to insert button to or a string to be used as button text.\n * @param {string} title - the text to be used as button title.\n * @param {string} name - the button. Client should return it to the server when the button is clicked.\n * @param {string} actionType - the type of the button, one of 'url' or 'pub'.\n * @param {string} actionValue - the value to return on click:\n * @param {string} refUrl - the URL to go to when the 'url' button is clicked.\n *\n * @return {Drafty} updated document.\n */\nDrafty.appendButton = function(content, title, name, actionType, actionValue, refUrl) {\n  content = content || {\n    txt: ''\n  };\n  const at = content.txt.length;\n  content.txt += title;\n  return Drafty.insertButton(content, at, title.length, name, actionType, actionValue, refUrl);\n}\n\n/**\n * Attach a generic JS object. The object is attached as a json string.\n * Intended for representing a form response.\n *\n * @memberof Drafty\n * @static\n *\n * @param {Drafty} content - Drafty document to attach file to.\n * @param {Object} data - data to convert to json string and attach.\n * @returns {Drafty} the same document as <code>content</code>.\n */\nDrafty.attachJSON = function(content, data) {\n  content = content || {\n    txt: ''\n  };\n  content.ent = content.ent || [];\n  content.fmt = content.fmt || [];\n\n  content.fmt.push({\n    at: -1,\n    len: 0,\n    key: content.ent.length\n  });\n\n  content.ent.push({\n    tp: 'EX',\n    data: {\n      mime: DRAFTY_FR_MIME_TYPE,\n      val: data\n    }\n  });\n\n  return content;\n}\n/**\n * Append line break to a Drafty document.\n * @memberof Drafty\n * @static\n *\n * @param {Drafty} content - Drafty document to append linebreak to.\n * @returns {Drafty} the same document as <code>content</code>.\n */\nDrafty.appendLineBreak = function(content) {\n  content = content || {\n    txt: ''\n  };\n  content.fmt = content.fmt || [];\n  content.fmt.push({\n    at: stringToGraphemes(content.txt).length,\n    len: 1,\n    tp: 'BR'\n  });\n  content.txt += ' ';\n\n  return content;\n}\n/**\n * Append TheCard to a Drafty document.\n * @memberof Drafty\n * @static\n *\n * @param {Drafty} content - Drafty document to append TheCard to.\n * @param {Object} theCardData - TheCard data object.\n * @returns {Drafty} the same document as <code>content</code>.\n */\nDrafty.appendTheCard = function(content, theCardData) {\n  content = content || {\n    txt: ''\n  };\n  content.ent = content.ent || [];\n  content.fmt = content.fmt || [];\n\n  content.fmt.push({\n    at: stringToGraphemes(content.txt).length,\n    len: 1,\n    key: content.ent.length\n  });\n  content.txt += ' ';\n\n  // const {...object} = classInstance;\n  content.ent.push({\n    tp: 'TC',\n    data: theCardData\n  });\n\n  return content;\n}\n/**\n * Given Drafty document, convert it to HTML.\n * No attempt is made to strip pre-existing html markup.\n * This is potentially unsafe because <code>content.txt</code> may contain malicious HTML\n * markup. DO NOT use in production code.\n *\n * @memberof Tinode.Drafty\n * @static\n *\n * @param {Drafty} doc - document to convert.\n *\n * @returns {string} HTML-representation of content.\n */\nDrafty.UNSAFE_toHTML = function(doc) {\n  const tree = draftyToTree(doc);\n  const htmlFormatter = function(type, data, values) {\n    const tag = DECORATORS[type];\n    let result = values ? values.join('') : '';\n    if (tag) {\n      result = tag.open(data) + result + tag.close(data);\n    }\n    return result;\n  };\n  return treeBottomUp(tree, htmlFormatter, 0);\n}\n\n/**\n * Callback for applying custom formatting to a Drafty document.\n * Called once for each style span.\n * @memberof Drafty\n * @static\n *\n * @callback Formatter\n * @param {string} style - style code such as \"ST\" or \"IM\".\n * @param {Object} data - entity's data.\n * @param {Object} values - possibly styled subspans contained in this style span.\n * @param {number} index - index of the element guaranteed to be unique.\n */\n\n/**\n * Convert Drafty document to a representation suitable for display.\n * The <code>context</code> may expose a function <code>getFormatter(style)</code>. If it's available\n * it will call it to obtain a <code>formatter</code> for a subtree of styles under the <code>style</code>.\n * @memberof Drafty\n * @static\n *\n * @param {Drafty|Object} content - Drafty document to transform.\n * @param {Formatter} formatter - callback which formats individual elements.\n * @param {Object} context - context provided to formatter as <code>this</code>.\n *\n * @return {Object} transformed object\n */\nDrafty.format = function(original, formatter, context) {\n  return treeBottomUp(draftyToTree(original), formatter, 0, [], context);\n}\n\n/**\n * Shorten Drafty document making the drafty text no longer than the limit.\n * @memberof Drafty\n * @static\n *\n * @param {Drafty|string} original - Drafty object to shorten.\n * @param {number} limit - length in characrets to shorten to.\n * @param {boolean} light - remove heavy data from entities.\n * @returns new shortened Drafty object leaving the original intact.\n */\nDrafty.shorten = function(original, limit, light) {\n  let tree = draftyToTree(original);\n  tree = shortenTree(tree, limit, '');\n  if (tree && light) {\n    tree = lightEntity(tree);\n  }\n  return treeToDrafty({}, tree, []);\n}\n\n/**\n * Transform Drafty doc for forwarding: strip leading @mention and any leading line breaks or whitespace.\n * @memberof Drafty\n * @static\n *\n * @param {Drafty|string} original - Drafty object to shorten.\n * @returns converted Drafty object leaving the original intact.\n */\nDrafty.forwardedContent = function(original) {\n  let tree = draftyToTree(original);\n  const rmMention = function(node) {\n    if (node.type == 'MN') {\n      if (!node.parent || !node.parent.type) {\n        return null;\n      }\n    }\n    return node;\n  }\n  // Strip leading mention.\n  tree = treeTopDown(tree, rmMention);\n  // Remove leading whitespace.\n  tree = lTrim(tree);\n  // Convert back to Drafty.\n  return treeToDrafty({}, tree, []);\n}\n\n/**\n * Prepare Drafty doc for wrapping into QQ as a reply:\n *  - Replace forwarding mention with symbol '' and remove data (UID).\n *  - Remove quoted text completely.\n *  - Replace line breaks with spaces.\n *  - Strip entities of heavy content.\n *  - Move attachments to the end of the document.\n * @memberof Drafty\n * @static\n *\n * @param {Drafty|string} original - Drafty object to shorten.\n * @param {number} limit - length in characters to shorten to.\n * @returns converted Drafty object leaving the original intact.\n */\nDrafty.replyContent = function(original, limit) {\n  const convMNnQQnBR = function(node) {\n    if (node.type == 'QQ') {\n      return null;\n    } else if (node.type == 'MN') {\n      if ((!node.parent || !node.parent.type) && (node.text || '').startsWith('')) {\n        node.text = '';\n        delete node.children;\n        delete node.data;\n      }\n    } else if (node.type == 'BR') {\n      node.text = ' ';\n      delete node.type;\n      delete node.children;\n    }\n    return node;\n  }\n\n  let tree = draftyToTree(original);\n  if (!tree) {\n    return original;\n  }\n\n  // Strip leading mention.\n  tree = treeTopDown(tree, convMNnQQnBR);\n  // Move attachments to the end of the doc.\n  tree = attachmentsToEnd(tree, MAX_PREVIEW_ATTACHMENTS);\n  // Shorten the doc.\n  tree = shortenTree(tree, limit, '');\n  // Strip heavy elements except IM.data['val'] and VD.data['preview'] (have to keep them to generate previews later).\n  const filter = node => {\n    switch (node.type) {\n      case 'IM':\n        return ['val'];\n      case 'VD':\n        return ['preview'];\n    }\n    return null;\n  };\n  tree = lightEntity(tree, filter);\n  // Convert back to Drafty.\n  return treeToDrafty({}, tree, []);\n}\n\n/**\n * Generate drafty preview:\n *  - Shorten the document.\n *  - Strip all heavy entity data leaving just inline styles and entity references.\n *  - Replace line breaks with spaces.\n *  - Replace content of QQ with a space.\n *  - Replace forwarding mention with symbol ''.\n * move all attachments to the end of the document and make them visible.\n * The <code>context</code> may expose a function <code>getFormatter(style)</code>. If it's available\n * it will call it to obtain a <code>formatter</code> for a subtree of styles under the <code>style</code>.\n * @memberof Drafty\n * @static\n *\n * @param {Drafty|string} original - Drafty object to shorten.\n * @param {number} limit - length in characters to shorten to.\n * @param {boolean} forwarding - this a forwarding message preview.\n * @returns new shortened Drafty object leaving the original intact.\n */\nDrafty.preview = function(original, limit, forwarding) {\n  let tree = draftyToTree(original);\n\n  // Move attachments to the end.\n  tree = attachmentsToEnd(tree, MAX_PREVIEW_ATTACHMENTS);\n\n  // Convert leading mention to '' and replace QQ and BR with a space ' '.\n  const convMNnQQnBR = function(node) {\n    if (node.type == 'MN') {\n      if ((!node.parent || !node.parent.type) && (node.text || '').startsWith('')) {\n        node.text = '';\n        delete node.children;\n      }\n    } else if (node.type == 'QQ') {\n      node.text = ' ';\n      delete node.children;\n    } else if (node.type == 'BR') {\n      node.text = ' ';\n      delete node.children;\n      delete node.type;\n    }\n    return node;\n  }\n  tree = treeTopDown(tree, convMNnQQnBR);\n\n  tree = shortenTree(tree, limit, '');\n  if (forwarding) {\n    // Keep some IM and VD data for preview.\n    const filter = {\n      IM: ['val'],\n      VD: ['preview']\n    };\n    tree = lightEntity(tree, node => {\n      return filter[node.type];\n    });\n  } else {\n    tree = lightEntity(tree);\n  }\n\n  // Convert back to Drafty.\n  return treeToDrafty({}, tree, []);\n}\n\n/**\n * Given Drafty document, convert it to plain text.\n * @memberof Drafty\n * @static\n *\n * @param {Drafty} content - document to convert to plain text.\n * @returns {string} plain-text representation of the drafty document.\n */\nDrafty.toPlainText = function(content) {\n  return typeof content == 'string' ? content : content.txt;\n}\n\n/**\n * Check if the document has no markup and no entities.\n * @memberof Drafty\n * @static\n *\n * @param {Drafty} content - content to check for presence of markup.\n * @returns <code>true</code> is content is plain text, <code>false</code> otherwise.\n */\nDrafty.isPlainText = function(content) {\n  return typeof content == 'string' || !(content.fmt || content.ent);\n}\n\n/**\n * Convert document to plain text with markdown. All elements which cannot\n * be represented in markdown are stripped.\n * @memberof Drafty\n * @static\n *\n * @param {Drafty} content - document to convert to plain text with markdown.\n */\nDrafty.toMarkdown = function(content) {\n  let tree = draftyToTree(content);\n  const mdFormatter = function(type, _, values) {\n    const def = FORMAT_TAGS[type];\n    let result = (values ? values.join('') : '');\n    if (def) {\n      if (def.isVoid) {\n        result = def.md_tag || '';\n      } else if (def.md_tag) {\n        result = def.md_tag + result + def.md_tag;\n      }\n    }\n    return result;\n  };\n  return treeBottomUp(tree, mdFormatter, 0);\n}\n\n/**\n * Checks if the object represets is a valid Drafty document.\n * @memberof Drafty\n * @static\n *\n * @param {Drafty} content - content to check for validity.\n * @returns <code>true</code> is content is valid, <code>false</code> otherwise.\n */\nDrafty.isValid = function(content) {\n  if (!content) {\n    return false;\n  }\n\n  const {\n    txt,\n    fmt,\n    ent\n  } = content;\n\n  if (!txt && txt !== '' && !fmt && !ent) {\n    return false;\n  }\n\n  const txt_type = typeof txt;\n  if (txt_type != 'string' && txt_type != 'undefined' && txt !== null) {\n    return false;\n  }\n\n  if (typeof fmt != 'undefined' && !Array.isArray(fmt) && fmt !== null) {\n    return false;\n  }\n\n  if (typeof ent != 'undefined' && !Array.isArray(ent) && ent !== null) {\n    return false;\n  }\n  return true;\n}\n\n/**\n * Check if the drafty document has attachments: style EX and outside of normal rendering flow,\n * i.e. <code>at = -1</code>.\n * @memberof Drafty\n * @static\n *\n * @param {Drafty} content - document to check for attachments.\n * @returns <code>true</code> if there are attachments.\n */\nDrafty.hasAttachments = function(content) {\n  if (!Array.isArray(content.fmt)) {\n    return false;\n  }\n  for (let i in content.fmt) {\n    const fmt = content.fmt[i];\n    if (fmt && fmt.at < 0) {\n      const ent = content.ent[fmt.key | 0];\n      return ent && ent.tp == 'EX' && ent.data;\n    }\n  }\n  return false;\n}\n\n/**\n * Callback for enumerating entities in a Drafty document.\n * Called once for each entity.\n * @memberof Drafty\n * @static\n *\n * @callback EntityCallback\n * @param {Object} data - entity data.\n * @param {string} tp - entity type.\n * @param {number} index - entity's index in `content.ent`.\n *\n * @returns {boolean} 'true-ish' to stop processing, 'false-ish' otherwise.\n */\n\n/**\n * Enumerate attachments: style EX and outside of normal rendering flow, i.e. <code>at = -1</code>.\n * @memberof Drafty\n * @static\n *\n * @param {Drafty} content - document to process for attachments.\n * @param {EntityCallback} callback - callback to call for each attachment.\n * @param {Object} context - value of \"this\" for callback.\n */\nDrafty.attachments = function(content, callback, context) {\n  if (!Array.isArray(content.fmt)) {\n    return;\n  }\n  let count = 0;\n  for (let i in content.fmt) {\n    let fmt = content.fmt[i];\n    if (fmt && fmt.at < 0) {\n      const ent = content.ent[fmt.key | 0];\n      if (ent && ent.tp == 'EX' && ent.data) {\n        if (callback.call(context, ent.data, count++, 'EX')) {\n          break;\n        }\n      }\n    }\n  };\n}\n\n/**\n * Check if the drafty document has entities.\n * @memberof Drafty\n * @static\n *\n * @param {Drafty} content - document to check for entities.\n * @returns <code>true</code> if there are entities.\n */\nDrafty.hasEntities = function(content) {\n  return content.ent && content.ent.length > 0;\n}\n\n/**\n * Enumerate entities. Enumeration stops if callback returns 'true'.\n * @memberof Drafty\n * @static\n *\n * @param {Drafty} content - document with entities to enumerate.\n * @param {EntityCallback} callback - callback to call for each entity.\n * @param {Object} context - value of \"this\" for callback.\n *\n */\nDrafty.entities = function(content, callback, context) {\n  if (content.ent && content.ent.length > 0) {\n    for (let i in content.ent) {\n      if (content.ent[i]) {\n        if (callback.call(context, content.ent[i].data, i, content.ent[i].tp)) {\n          break;\n        }\n      }\n    }\n  }\n}\n\n/**\n * Callback for enumerating styles (inline formats) in a Drafty document.\n * Called once for each style.\n * @memberof Drafty\n * @static\n *\n * @callback StyleCallback\n * @param {string} tp - format type.\n * @param {number} at - starting position of the format in text.\n * @param {number} len - extent of the format in characters.\n * @param {number} key - index of the entity if format is a reference.\n * @param {number} index - style's index in `content.fmt`.\n *\n * @return 'true-ish' to stop processing, 'false-ish' otherwise.\n */\n\n/**\n * Enumerate styles (inline formats). Enumeration stops if callback returns 'true'.\n * @memberof Drafty\n * @static\n *\n * @param {Drafty} content - document with styles (formats) to enumerate.\n * @param {StyleCallback} callback - callback to call for each format.\n * @param {Object} context - value of \"this\" for callback.\n */\nDrafty.styles = function(content, callback, context) {\n  if (content.fmt && content.fmt.length > 0) {\n    for (let i in content.fmt) {\n      const fmt = content.fmt[i];\n      if (fmt) {\n        if (callback.call(context, fmt.tp, fmt.at, fmt.len, fmt.key, i)) {\n          break;\n        }\n      }\n    }\n  }\n}\n\n/**\n * Remove unrecognized fields from entity data\n * @memberof Drafty\n * @static\n *\n * @param {Drafty} content - document with entities to enumerate.\n * @returns content.\n */\nDrafty.sanitizeEntities = function(content) {\n  if (content && content.ent && content.ent.length > 0) {\n    for (let i in content.ent) {\n      const ent = content.ent[i];\n      if (ent && ent.data) {\n        const data = copyEntData(ent.data);\n        if (data) {\n          content.ent[i].data = data;\n        } else {\n          delete content.ent[i].data;\n        }\n      }\n    }\n  }\n  return content;\n}\n\n/**\n * Given the entity, get URL which can be used for downloading\n * entity data.\n * @memberof Drafty\n * @static\n *\n * @param {Object} entData - entity.data to get the URl from.\n * @returns {string} URL to download entity data or <code>null</code>.\n */\nDrafty.getDownloadUrl = function(entData) {\n  let url = null;\n  if (!Drafty.isFormResponseType(entData.mime) && entData.val) {\n    url = base64toObjectUrl(entData.val, entData.mime, Drafty.logger);\n  } else if (typeof entData.ref == 'string') {\n    url = entData.ref;\n  }\n  return url;\n}\n\n/**\n * Check if the entity data is not ready for sending, such as being uploaded to the server.\n * @memberof Drafty\n * @static\n *\n * @param {Object} entity.data to get the URl from.\n * @returns {boolean} true if upload is in progress, false otherwise.\n */\nDrafty.isProcessing = function(entData) {\n  return !!entData._processing;\n}\n\n/**\n * Given the entity, get URL which can be used for previewing\n * the entity.\n * @memberof Drafty\n * @static\n *\n * @param {Object} entity.data to get the URl from.\n *\n * @returns {string} url for previewing or null if no such url is available.\n */\nDrafty.getPreviewUrl = function(entData) {\n  return entData.val ? base64toObjectUrl(entData.val, entData.mime, Drafty.logger) : null;\n}\n\n/**\n * Get approximate size of the entity.\n * @memberof Drafty\n * @static\n *\n * @param {Object} entData - entity.data to get the size for.\n * @returns {number} size of entity data in bytes.\n */\nDrafty.getEntitySize = function(entData) {\n  // Either size hint or length of value. The value is base64 encoded,\n  // the actual object size is smaller than the encoded length.\n  return entData.size ? entData.size : entData.val ? (entData.val.length * 0.75) | 0 : 0;\n}\n\n/**\n * Get entity mime type.\n * @memberof Drafty\n * @static\n *\n * @param {Object} entData - entity.data to get the type for.\n * @returns {string} mime type of entity.\n */\nDrafty.getEntityMimeType = function(entData) {\n  return entData.mime || 'text/plain';\n}\n\n/**\n * Get HTML tag for a given two-letter style name.\n * @memberof Drafty\n * @static\n *\n * @param {string} style - two-letter style, like ST or LN.\n *\n * @returns {string} HTML tag name if style is found, {code: undefined} if style is falsish or not found.\n */\nDrafty.tagName = function(style) {\n  return FORMAT_TAGS[style] && FORMAT_TAGS[style].html_tag;\n}\n\n/**\n * For a given data bundle generate an object with HTML attributes,\n * for instance, given {url: \"http://www.example.com/\"} return\n * {href: \"http://www.example.com/\"}\n * @memberof Drafty\n * @static\n *\n * @param {string} style - two-letter style to generate attributes for.\n * @param {Object} data - data bundle to convert to attributes\n *\n * @returns {Object} object with HTML attributes.\n */\nDrafty.attrValue = function(style, data) {\n  if (data && DECORATORS[style] && DECORATORS[style].props) {\n    return DECORATORS[style].props(data);\n  }\n\n  return undefined;\n}\n\n/**\n * Drafty MIME type.\n * @memberof Drafty\n * @static\n *\n * @returns {string} content-Type \"text/x-drafty\".\n */\nDrafty.getContentType = function() {\n  return DRAFTY_MIME_TYPE;\n}\n\nDrafty.contentType = DRAFTY_MIME_TYPE;\n\n/**\n * Check if the given mime-type is a MIME type of drafty form response.\n * @memberof Drafty\n * @static\n *\n * @returns {boolean} <code>true</code> if given mime type is drafty form response, <code>false</code> otherwise.\n */\nDrafty.isFormResponseType = function(mimeType) {\n  return mimeType === DRAFTY_FR_MIME_TYPE ||\n    mimeType === DRAFTY_FR_MIME_TYPE_LEGACY;\n}\n\n// =================\n// Utility methods.\n// =================\n\n// Take a string and defined earlier style spans, re-compose them into a tree where each leaf is\n// a same-style (including unstyled) string. I.e. 'hello *bold _italic_* and ~more~ world' ->\n// ('hello ', (b: 'bold ', (i: 'italic')), ' and ', (s: 'more'), ' world');\n//\n// This is needed in order to clear markup, i.e. 'hello *world*' -> 'hello world' and convert\n// ranges from markup-ed offsets to plain text offsets.\nfunction chunkify(line, start, end, spans) {\n  const chunks = [];\n\n  if (spans.length == 0) {\n    return [];\n  }\n\n  for (let i in spans) {\n    // Get the next chunk from the queue\n    const span = spans[i];\n\n    // Grab the initial unstyled chunk\n    if (span.at > start) {\n      chunks.push({\n        txt: line.slice(start, span.at)\n      });\n    }\n\n    // Grab the styled chunk. It may include subchunks.\n    const chunk = {\n      tp: span.tp\n    };\n    const chld = chunkify(line, span.at + 1, span.end, span.children);\n    if (chld.length > 0) {\n      chunk.children = chld;\n    } else {\n      chunk.txt = span.txt;\n    }\n    chunks.push(chunk);\n    start = span.end + 1; // '+1' is to skip the formatting character\n  }\n\n  // Grab the remaining unstyled chunk, after the last span\n  if (start < end) {\n    chunks.push({\n      txt: line.slice(start, end)\n    });\n  }\n\n  return chunks;\n}\n\n// Detect starts and ends of formatting spans. Unformatted spans are\n// ignored at this stage.\nfunction spannify(original, re_start, re_end, type) {\n  const result = [];\n  let index = 0;\n  let line = original.slice(0); // make a copy;\n\n  while (line.length > 0) {\n    // match[0]; // match, like '*abc*'\n    // match[1]; // match captured in parenthesis, like 'abc'\n    // match['index']; // offset where the match started.\n\n    // Find the opening token.\n    const start = re_start.exec(line);\n    if (start == null) {\n      break;\n    }\n\n    // Because javascript RegExp does not support lookbehind, the actual offset may not point\n    // at the markup character. Find it in the matched string.\n    let start_offset = start['index'] + start[0].lastIndexOf(start[1]);\n    // Clip the processed part of the string.\n    line = line.slice(start_offset + 1);\n    // start_offset is an offset within the clipped string. Convert to original index.\n    start_offset += index;\n    // Index now point to the beginning of 'line' within the 'original' string.\n    index = start_offset + 1;\n\n    // Find the matching closing token.\n    const end = re_end ? re_end.exec(line) : null;\n    if (end == null) {\n      break;\n    }\n    let end_offset = end['index'] + end[0].indexOf(end[1]);\n    // Clip the processed part of the string.\n    line = line.slice(end_offset + 1);\n    // Update offsets\n    end_offset += index;\n    // Index now points to the beginning of 'line' within the 'original' string.\n    index = end_offset + 1;\n\n    result.push({\n      txt: original.slice(start_offset + 1, end_offset),\n      children: [],\n      at: start_offset,\n      end: end_offset,\n      tp: type\n    });\n  }\n\n  return result;\n}\n\n// Convert linear array or spans into a tree representation.\n// Keep standalone and nested spans, throw away partially overlapping spans.\nfunction toSpanTree(spans) {\n  if (spans.length == 0) {\n    return [];\n  }\n\n  const tree = [spans[0]];\n  let last = spans[0];\n  for (let i = 1; i < spans.length; i++) {\n    // Keep spans which start after the end of the previous span or those which\n    // are complete within the previous span.\n    if (spans[i].at > last.end) {\n      // Span is completely outside of the previous span.\n      tree.push(spans[i]);\n      last = spans[i];\n    } else if (spans[i].end <= last.end) {\n      // Span is fully inside of the previous span. Push to subnode.\n      last.children.push(spans[i]);\n    }\n    // Span could partially overlap, ignoring it as invalid.\n  }\n\n  // Recursively rearrange the subnodes.\n  for (let i in tree) {\n    tree[i].children = toSpanTree(tree[i].children);\n  }\n\n  return tree;\n}\n\n// Convert drafty document to a tree.\nfunction draftyToTree(doc) {\n  if (!doc) {\n    return null;\n  }\n\n  doc = (typeof doc == 'string') ? {\n    txt: doc\n  } : doc;\n  let {\n    txt,\n    fmt,\n    ent\n  } = doc;\n\n  txt = txt || '';\n  if (!Array.isArray(ent)) {\n    ent = [];\n  }\n\n  if (!Array.isArray(fmt) || fmt.length == 0) {\n    if (ent.length == 0) {\n      return {\n        text: txt\n      };\n    }\n\n    // Handle special case when all values in fmt are 0 and fmt therefore is skipped.\n    fmt = [{\n      at: 0,\n      len: 0,\n      key: 0\n    }];\n  }\n\n  // Sanitize spans.\n  const spans = [];\n  const attachments = [];\n  fmt.forEach((span) => {\n    if (!span || typeof span != 'object') {\n      return;\n    }\n\n    if (!['undefined', 'number'].includes(typeof span.at)) {\n      // Present, but non-numeric 'at'.\n      return;\n    }\n    if (!['undefined', 'number'].includes(typeof span.len)) {\n      // Present, but non-numeric 'len'.\n      return;\n    }\n    let at = span.at | 0;\n    let len = span.len | 0;\n    if (len < 0) {\n      // Invalid span length.\n      return;\n    }\n\n    let key = span.key || 0;\n    if (ent.length > 0 && (typeof key != 'number' || key < 0 || key >= ent.length)) {\n      // Invalid key value.\n      return;\n    }\n\n    if (at <= -1) {\n      // Attachment. Store attachments separately.\n      attachments.push({\n        start: -1,\n        end: 0,\n        key: key\n      });\n      return;\n    } else if (at + len > stringToGraphemes(txt).length) {\n      // Span is out of bounds.\n      return;\n    }\n\n    if (!span.tp) {\n      if (ent.length > 0 && (typeof ent[key] == 'object')) {\n        spans.push({\n          start: at,\n          end: at + len,\n          key: key\n        });\n      }\n    } else {\n      spans.push({\n        type: span.tp,\n        start: at,\n        end: at + len\n      });\n    }\n  });\n\n  // Sort spans first by start index (asc) then by length (desc), then by weight.\n  spans.sort((a, b) => {\n    let diff = a.start - b.start;\n    if (diff != 0) {\n      return diff;\n    }\n    diff = b.end - a.end;\n    if (diff != 0) {\n      return diff;\n    }\n    return FMT_WEIGHT.indexOf(b.type) - FMT_WEIGHT.indexOf(a.type);\n  });\n\n  // Move attachments to the end of the list.\n  if (attachments.length > 0) {\n    spans.push(...attachments);\n  }\n\n  spans.forEach((span) => {\n    if (ent.length > 0 && !span.type && ent[span.key] && typeof ent[span.key] == 'object') {\n      span.type = ent[span.key].tp;\n      span.data = ent[span.key].data;\n    }\n\n    // Is type still undefined? Hide the invalid element!\n    if (!span.type) {\n      span.type = 'HD';\n    }\n  });\n\n  const graphemes = stringToGraphemes(txt);\n  let tree = spansToTree({}, graphemes, 0, graphemes.length, spans);\n\n  // Flatten tree nodes.\n  const flatten = function(node) {\n    if (Array.isArray(node.children) && node.children.length == 1) {\n      // Unwrap.\n      const child = node.children[0];\n      if (!node.type) {\n        const parent = node.parent;\n        node = child;\n        node.parent = parent;\n      } else if (!child.type && !child.children) {\n        node.text = child.text;\n        delete node.children;\n      }\n    }\n    return node;\n  }\n  tree = treeTopDown(tree, flatten);\n\n  return tree;\n}\n\n// Add tree node to a parent tree.\nfunction addNode(parent, n) {\n  if (!n) {\n    return parent;\n  }\n\n  if (!parent.children) {\n    parent.children = [];\n  }\n\n  // If text is present, move it to a subnode.\n  if (parent.text) {\n    parent.children.push({\n      text: parent.text,\n      parent: parent\n    });\n    delete parent.text;\n  }\n\n  n.parent = parent;\n  parent.children.push(n);\n\n  return parent;\n}\n\n// Returns a tree of nodes.\nfunction spansToTree(parent, graphemes, start, end, spans) {\n  if (!spans || spans.length == 0) {\n    if (start < end) {\n      addNode(parent, {\n        text: graphemes.slice(start, end)\n          .map(segment => segment.segment)\n          .join('')\n      });\n    }\n    return parent;\n  }\n\n  // Process subspans.\n  for (let i = 0; i < spans.length; i++) {\n    const span = spans[i];\n    if (span.start < 0 && span.type == 'EX') {\n      addNode(parent, {\n        type: span.type,\n        data: span.data,\n        key: span.key,\n        att: true\n      });\n      continue;\n    }\n\n    // Add un-styled range before the styled span starts.\n    if (start < span.start) {\n      addNode(parent, {\n        text: graphemes.slice(start, span.start)\n          .map(segment => segment.segment)\n          .join('')\n      });\n      start = span.start;\n    }\n\n    // Get all spans which are within the current span.\n    const subspans = [];\n    while (i < spans.length - 1) {\n      const inner = spans[i + 1];\n      if (inner.start < 0) {\n        // Attachments are in the end. Stop.\n        break;\n      } else if (inner.start < span.end) {\n        if (inner.end <= span.end) {\n          const tag = FORMAT_TAGS[inner.tp] || {};\n          if (inner.start < inner.end || tag.isVoid) {\n            // Valid subspan: completely within the current span and\n            // either non-zero length or zero length is acceptable.\n            subspans.push(inner);\n          }\n        }\n        i++;\n        // Overlapping subspans are ignored.\n      } else {\n        // Past the end of the current span. Stop.\n        break;\n      }\n    }\n\n    addNode(parent, spansToTree({\n      type: span.type,\n      data: span.data,\n      key: span.key\n    }, graphemes, start, span.end, subspans));\n    start = span.end;\n  }\n\n  // Add the last unformatted range.\n  if (start < end) {\n    addNode(parent, {\n      text: graphemes\n        .slice(start, end)\n        .map((segment) => segment.segment)\n        .join('')\n    });\n  }\n\n  return parent;\n}\n\n// Append a tree to a Drafty doc.\nfunction treeToDrafty(doc, tree, keymap) {\n  if (!tree) {\n    return doc;\n  }\n\n  doc.txt = doc.txt || '';\n\n  // Checkpoint to measure length of the current tree node.\n  const start = stringToGraphemes(doc.txt).length;\n\n  if (tree.text) {\n    doc.txt += tree.text;\n  } else if (Array.isArray(tree.children)) {\n    tree.children.forEach((c) => {\n      treeToDrafty(doc, c, keymap);\n    });\n  }\n\n  if (tree.type) {\n    const len = stringToGraphemes(doc.txt).length - start;\n    doc.fmt = doc.fmt || [];\n    if (Object.keys(tree.data || {}).length > 0) {\n      doc.ent = doc.ent || [];\n      const newKey = (typeof keymap[tree.key] == 'undefined') ? doc.ent.length : keymap[tree.key];\n      keymap[tree.key] = newKey;\n      doc.ent[newKey] = {\n        tp: tree.type,\n        data: tree.data\n      };\n      if (tree.att) {\n        // Attachment.\n        doc.fmt.push({\n          at: -1,\n          len: 0,\n          key: newKey\n        });\n      } else {\n        doc.fmt.push({\n          at: start,\n          len: len,\n          key: newKey\n        });\n      }\n    } else {\n      doc.fmt.push({\n        tp: tree.type,\n        at: start,\n        len: len\n      });\n    }\n  }\n  return doc;\n}\n\n// Traverse the tree top down transforming the nodes: apply transformer to every tree node.\nfunction treeTopDown(src, transformer, context) {\n  if (!src) {\n    return null;\n  }\n\n  let dst = transformer.call(context, src);\n  if (!dst || !dst.children) {\n    return dst;\n  }\n\n  const children = [];\n  for (let i in dst.children) {\n    let n = dst.children[i];\n    if (n) {\n      n = treeTopDown(n, transformer, context);\n      if (n) {\n        children.push(n);\n      }\n    }\n  }\n\n  if (children.length == 0) {\n    dst.children = null;\n  } else {\n    dst.children = children;\n  }\n\n  return dst;\n}\n\n// Traverse the tree bottom-up: apply formatter to every node.\n// The formatter must maintain its state through context.\nfunction treeBottomUp(src, formatter, index, stack, context) {\n  if (!src) {\n    return null;\n  }\n\n  if (stack && src.type) {\n    stack.push(src.type);\n  }\n\n  let values = [];\n  for (let i in src.children) {\n    const n = treeBottomUp(src.children[i], formatter, i, stack, context);\n    if (n) {\n      values.push(n);\n    }\n  }\n  if (values.length == 0) {\n    if (src.text) {\n      values = [src.text];\n    } else {\n      values = null;\n    }\n  }\n\n  if (stack && src.type) {\n    stack.pop();\n  }\n\n  return formatter.call(context, src.type, src.data, values, index, stack);\n}\n\n// Clip tree to the provided limit.\nfunction shortenTree(tree, limit, tail) {\n  if (!tree) {\n    return null;\n  }\n\n  if (tail) {\n    limit -= tail.length;\n  }\n\n  const shortener = function(node) {\n    if (limit <= -1) {\n      // Limit -1 means the doc was already clipped.\n      return null;\n    }\n\n    if (node.att) {\n      // Attachments are unchanged.\n      return node;\n    }\n    if (limit == 0) {\n      node.text = tail;\n      limit = -1;\n    } else if (node.text) {\n      const graphemes = stringToGraphemes(node.text);\n      if (graphemes.length > limit) {\n        node.text = graphemes\n          .slice(0, limit)\n          .map((segment) => segment.segment)\n          .join('') + tail;\n        limit = -1;\n      } else {\n        limit -= graphemes.length;\n      }\n    }\n    return node;\n  }\n\n  return treeTopDown(tree, shortener);\n}\n\n// Strip heavy entities from a tree.\nfunction lightEntity(tree, allow) {\n  const lightCopy = node => {\n    const data = copyEntData(node.data, true, allow ? allow(node) : null);\n    if (data) {\n      node.data = data;\n    } else {\n      delete node.data;\n    }\n    return node;\n  }\n  return treeTopDown(tree, lightCopy);\n}\n\n// Remove spaces and breaks on the left.\nfunction lTrim(tree) {\n  if (tree.type == 'BR') {\n    tree = null;\n  } else if (tree.text) {\n    if (!tree.type) {\n      tree.text = tree.text.trimStart();\n      if (!tree.text) {\n        tree = null;\n      }\n    }\n  } else if (!tree.type && tree.children && tree.children.length > 0) {\n    const c = lTrim(tree.children[0]);\n    if (c) {\n      tree.children[0] = c;\n    } else {\n      tree.children.shift();\n      if (!tree.type && tree.children.length == 0) {\n        tree = null;\n      }\n    }\n  }\n  return tree;\n}\n\n// Move attachments to the end. Attachments must be at the top level, no need to traverse the tree.\nfunction attachmentsToEnd(tree, limit) {\n  if (!tree) {\n    return null;\n  }\n\n  if (tree.att) {\n    tree.text = ' ';\n    delete tree.att;\n    delete tree.children;\n  } else if (tree.children) {\n    const attachments = [];\n    const children = [];\n    for (let i in tree.children) {\n      const c = tree.children[i];\n      if (c.att) {\n        if (attachments.length == limit) {\n          // Too many attachments to preview;\n          continue;\n        }\n        if (Drafty.isFormResponseType(c.data['mime'])) {\n          // Form response attachments are not shown in preview.\n          continue;\n        }\n\n        delete c.att;\n        delete c.children;\n        c.text = ' ';\n        attachments.push(c);\n      } else {\n        children.push(c);\n      }\n    }\n    tree.children = children.concat(attachments);\n  }\n  return tree;\n}\n\n// Get a list of entities from a text.\nfunction extractEntities(line) {\n  let match;\n  let extracted = [];\n  ENTITY_TYPES.forEach((entity) => {\n    while ((match = entity.re.exec(line)) !== null) {\n      extracted.push({\n        offset: match['index'],\n        len: match[0].length,\n        unique: match[0],\n        data: entity.pack(match[0]),\n        type: entity.name\n      });\n    }\n  });\n\n  if (extracted.length == 0) {\n    return extracted;\n  }\n\n  // Remove entities detected inside other entities, like #hashtag in a URL.\n  extracted.sort((a, b) => {\n    return a.offset - b.offset;\n  });\n\n  let idx = -1;\n  extracted = extracted.filter((el) => {\n    const result = (el.offset > idx);\n    idx = el.offset + el.len;\n    return result;\n  });\n\n  return extracted;\n}\n\n// Convert the chunks into format suitable for serialization.\nfunction draftify(chunks, startAt) {\n  let plain = '';\n  let ranges = [];\n  for (let i in chunks) {\n    const chunk = chunks[i];\n    if (!chunk.txt) {\n      const drafty = draftify(chunk.children, plain.length + startAt);\n      chunk.txt = drafty.txt;\n      ranges = ranges.concat(drafty.fmt);\n    }\n\n    if (chunk.tp) {\n      ranges.push({\n        at: plain.length + startAt,\n        len: chunk.txt.length,\n        tp: chunk.tp\n      });\n    }\n\n    plain += chunk.txt;\n  }\n  return {\n    txt: plain,\n    fmt: ranges\n  };\n}\n\n// Create a copy of entity data with (light=false) or without (light=true) the large payload.\n// The array 'allow' contains a list of fields exempt from stripping.\nfunction copyEntData(data, light, allow) {\n  if (data && Object.entries(data).length > 0) {\n    allow = allow || [];\n    const dc = {};\n    ALLOWED_ENT_FIELDS.forEach(key => {\n      if (data[key]) {\n        if (light && !allow.includes(key) &&\n          (typeof data[key] == 'string' || Array.isArray(data[key])) &&\n          data[key].length > MAX_PREVIEW_DATA_SIZE) {\n          return;\n        }\n        if (typeof data[key] == 'object') {\n          return;\n        }\n        dc[key] = data[key];\n      }\n    });\n\n    if (Object.entries(dc).length != 0) {\n      return dc;\n    }\n  }\n  return null;\n}\n\n// Returns true if object is empty, if undefined returns true\nfunction isEmptyObject(obj) {\n  return Object.keys(obj ?? {}).length == 0;\n};\n\n\n// Returns an array (of length equal to the length of the original string) such that each index\n// denotes the position of char in string in a grapheme array (created from that string)\n// Eg: string: \"HiHi\" -> [0,1,2,2,2,2,3,4]\nfunction graphemeIndices(graphemes) {\n  const result = [];\n  let graphemeIndex = 0;\n  let charIndex = 0;\n\n  // Iterate over the grapheme clusters.\n  for (const {\n      segment\n    }\n    of graphemes) {\n    // Map the character indices to the grapheme index.\n    for (let i = 0; i < segment.length; i++) {\n      result[charIndex + i] = graphemeIndex;\n    }\n\n    // Increment the character index by the length of the grapheme cluster.\n    charIndex += segment.length;\n\n    // Increment the grapheme index.\n    graphemeIndex++;\n  }\n\n  return result;\n}\n\n// Convert fmt.at and fmt.len from character-expressed index and length to grapheme-expressed\n// index and length.\nfunction toGraphemeValues(fmt, segments, txt) {\n  segments = segments ?? segmenter.segment(txt);\n\n  const indices = graphemeIndices(segments);\n\n  const correctAt = indices[fmt.at];\n  const correctLen = fmt.at + fmt.len <= txt.length ?\n    indices[fmt.at + fmt.len - 1] - correctAt : fmt.len;\n\n  return {\n    at: correctAt,\n    len: correctLen + 1\n  };\n}\n\n// Convert string to graphme cluster array.\nfunction stringToGraphemes(str) {\n  return Array.from(segmenter.segment(str));\n}\n\nif (typeof module != 'undefined') {\n  module.exports = Drafty;\n}\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = function(module) {\n\tvar getter = module && module.__esModule ?\n\t\tfunction() { return module['default']; } :\n\t\tfunction() { return module; };\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = function(exports, definition) {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.g = (function() {\n\tif (typeof globalThis === 'object') return globalThis;\n\ttry {\n\t\treturn this || new Function('return this')();\n\t} catch (e) {\n\t\tif (typeof window === 'object') return window;\n\t}\n})();","__webpack_require__.o = function(obj, prop) { return Object.prototype.hasOwnProperty.call(obj, prop); }","// define __esModule on exports\n__webpack_require__.r = function(exports) {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","/**\n * @file Access control model.\n *\n * @copyright 2015-2026 Tinode LLC.\n */\n'use strict';\n\n// NOTE TO DEVELOPERS:\n// Localizable strings should be double quoted \"   \",\n// non-localizable strings should be single quoted 'non-localized'.\n\n/**\n * Helper class for handling access mode.\n *\n * @class AccessMode\n * @memberof Tinode\n *\n * @param {AccessMode|Object=} acs - AccessMode to copy or access mode object received from the server.\n */\nexport default class AccessMode {\n  constructor(acs) {\n    if (acs) {\n      this.given = typeof acs.given == 'number' ? acs.given : AccessMode.decode(acs.given);\n      this.want = typeof acs.want == 'number' ? acs.want : AccessMode.decode(acs.want);\n      this.mode = acs.mode ? (typeof acs.mode == 'number' ? acs.mode : AccessMode.decode(acs.mode)) :\n        (this.given & this.want);\n    }\n  }\n\n  static #checkFlag(val, side, flag) {\n    side = side || 'mode';\n    if (['given', 'want', 'mode'].includes(side)) {\n      return ((val[side] & flag) != 0);\n    }\n    throw new Error(`Invalid AccessMode component '${side}'`);\n  }\n  /**\n   * Parse string into an access mode value.\n   * @memberof Tinode.AccessMode\n   * @static\n   *\n   * @param {string | number} mode - either a String representation of the access mode to parse or a set of bits to assign.\n   * @returns {number} - Access mode as a numeric value.\n   */\n  static decode(str) {\n    if (!str) {\n      return null;\n    } else if (typeof str == 'number') {\n      return str & AccessMode._BITMASK;\n    } else if (str === 'N' || str === 'n') {\n      return AccessMode._NONE;\n    }\n\n    const bitmask = {\n      'J': AccessMode._JOIN,\n      'R': AccessMode._READ,\n      'W': AccessMode._WRITE,\n      'P': AccessMode._PRES,\n      'A': AccessMode._APPROVE,\n      'S': AccessMode._SHARE,\n      'D': AccessMode._DELETE,\n      'O': AccessMode._OWNER\n    };\n\n    let m0 = AccessMode._NONE;\n\n    for (let i = 0; i < str.length; i++) {\n      const bit = bitmask[str.charAt(i).toUpperCase()];\n      if (!bit) {\n        // Unrecognized bit, skip.\n        continue;\n      }\n      m0 |= bit;\n    }\n    return m0;\n  }\n  /**\n   * Convert numeric representation of the access mode into a string.\n   *\n   * @memberof Tinode.AccessMode\n   * @static\n   *\n   * @param {number} val - access mode value to convert to a string.\n   * @returns {string} - Access mode as a string.\n   */\n  static encode(val) {\n    if (val === null || val === AccessMode._INVALID) {\n      return null;\n    } else if (val === AccessMode._NONE) {\n      return 'N';\n    }\n\n    const bitmask = ['J', 'R', 'W', 'P', 'A', 'S', 'D', 'O'];\n    let res = '';\n    for (let i = 0; i < bitmask.length; i++) {\n      if ((val & (1 << i)) != 0) {\n        res = res + bitmask[i];\n      }\n    }\n    return res;\n  }\n  /**\n   * Update numeric representation of access mode with the new value. The value\n   * is one of the following:\n   *  - a string starting with <code>'+'</code> or <code>'-'</code> then the bits to add or remove, e.g. <code>'+R-W'</code> or <code>'-PS'</code>.\n   *  - a new value of access mode\n   *\n   * @memberof Tinode.AccessMode\n   * @static\n   *\n   * @param {number} val - access mode value to update.\n   * @param {string} upd - update to apply to val.\n   * @returns {number} - updated access mode.\n   */\n  static update(val, upd) {\n    if (!upd || typeof upd != 'string') {\n      return val;\n    }\n\n    let action = upd.charAt(0);\n    if (action == '+' || action == '-') {\n      let val0 = val;\n      // Split delta-string like '+ABC-DEF+Z' into an array of parts including + and -.\n      const parts = upd.split(/([-+])/);\n      // Starting iteration from 1 because String.split() creates an array with the first empty element.\n      // Iterating by 2 because we parse pairs +/- then data.\n      for (let i = 1; i < parts.length - 1; i += 2) {\n        action = parts[i];\n        const m0 = AccessMode.decode(parts[i + 1]);\n        if (m0 == AccessMode._INVALID) {\n          return val;\n        }\n        if (m0 == null) {\n          continue;\n        }\n        if (action === '+') {\n          val0 |= m0;\n        } else if (action === '-') {\n          val0 &= ~m0;\n        }\n      }\n      val = val0;\n    } else {\n      // The string is an explicit new value 'ABC' rather than delta.\n      const val0 = AccessMode.decode(upd);\n      if (val0 != AccessMode._INVALID) {\n        val = val0;\n      }\n    }\n\n    return val;\n  }\n  /**\n   * Bits present in a1 but missing in a2.\n   *\n   * @static\n   * @memberof Tinode\n   *\n   * @param {number | string} a1 - access mode to subtract from.\n   * @param {number | string} a2 - access mode to subtract.\n   * @returns {number} access mode with bits present in <code>a1</code> but missing in <code>a2</code>.\n   */\n  static diff(a1, a2) {\n    a1 = AccessMode.decode(a1);\n    a2 = AccessMode.decode(a2);\n\n    if (a1 == AccessMode._INVALID || a2 == AccessMode._INVALID) {\n      return AccessMode._INVALID;\n    }\n    return a1 & ~a2;\n  }\n  /**\n   * Custom formatter\n   */\n  toString() {\n    return '{\"mode\": \"' + AccessMode.encode(this.mode) +\n      '\", \"given\": \"' + AccessMode.encode(this.given) +\n      '\", \"want\": \"' + AccessMode.encode(this.want) + '\"}';\n  }\n  /**\n   * Converts numeric values to strings.\n   */\n  jsonHelper() {\n    return {\n      mode: AccessMode.encode(this.mode),\n      given: AccessMode.encode(this.given),\n      want: AccessMode.encode(this.want)\n    };\n  }\n  /**\n   * Assign value to 'mode'.\n   * @memberof Tinode.AccessMode\n   *\n   * @param {string | number} m - either a string representation of the access mode or a set of bits.\n   * @returns {AccessMode} - <code>this</code> AccessMode.\n   */\n  setMode(m) {\n    this.mode = AccessMode.decode(m);\n    return this;\n  }\n  /**\n   * Update <code>mode</code> value.\n   * @memberof Tinode.AccessMode\n   *\n   * @param {string} u - string representation of the changes to apply to access mode.\n   * @returns {AccessMode} - <code>this</code> AccessMode.\n   */\n  updateMode(u) {\n    this.mode = AccessMode.update(this.mode, u);\n    return this;\n  }\n  /**\n   * Get <code>mode</code> value as a string.\n   * @memberof Tinode.AccessMode\n   *\n   * @returns {string} - <code>mode</code> value.\n   */\n  getMode() {\n    return AccessMode.encode(this.mode);\n  }\n  /**\n   * Assign <code>given</code>  value.\n   * @memberof Tinode.AccessMode\n   *\n   * @param {string | number} g - either a string representation of the access mode or a set of bits.\n   * @returns {AccessMode} - <code>this</code> AccessMode.\n   */\n  setGiven(g) {\n    this.given = AccessMode.decode(g);\n    return this;\n  }\n  /**\n   * Update 'given' value.\n   * @memberof Tinode.AccessMode\n   *\n   * @param {string} u - string representation of the changes to apply to access mode.\n   * @returns {AccessMode} - <code>this</code> AccessMode.\n   */\n  updateGiven(u) {\n    this.given = AccessMode.update(this.given, u);\n    return this;\n  }\n  /**\n   * Get 'given' value as a string.\n   * @memberof Tinode.AccessMode\n   *\n   * @returns {string} - <b>given</b> value.\n   */\n  getGiven() {\n    return AccessMode.encode(this.given);\n  }\n  /**\n   * Assign 'want' value.\n   * @memberof Tinode.AccessMode\n   *\n   * @param {string | number} w - either a string representation of the access mode or a set of bits.\n   * @returns {AccessMode} - <code>this</code> AccessMode.\n   */\n  setWant(w) {\n    this.want = AccessMode.decode(w);\n    return this;\n  }\n  /**\n   * Update 'want' value.\n   * @memberof Tinode.AccessMode\n   *\n   * @param {string} u - string representation of the changes to apply to access mode.\n   * @returns {AccessMode} - <code>this</code> AccessMode.\n   */\n  updateWant(u) {\n    this.want = AccessMode.update(this.want, u);\n    return this;\n  }\n  /**\n   * Get 'want' value as a string.\n   * @memberof Tinode.AccessMode\n   *\n   * @returns {string} - <b>want</b> value.\n   */\n  getWant() {\n    return AccessMode.encode(this.want);\n  }\n  /**\n   * Get permissions present in 'want' but missing in 'given'.\n   * Inverse of {@link Tinode.AccessMode#getExcessive}\n   *\n   * @memberof Tinode.AccessMode\n   *\n   * @returns {string} permissions present in <b>want</b> but missing in <b>given</b>.\n   */\n  getMissing() {\n    return AccessMode.encode(this.want & ~this.given);\n  }\n  /**\n   * Get permissions present in 'given' but missing in 'want'.\n   * Inverse of {@link Tinode.AccessMode#getMissing}\n   * @memberof Tinode.AccessMode\n   *\n   * @returns {string} permissions present in <b>given</b> but missing in <b>want</b>.\n   */\n  getExcessive() {\n    return AccessMode.encode(this.given & ~this.want);\n  }\n  /**\n   * Update 'want', 'give', and 'mode' values.\n   * @memberof Tinode.AccessMode\n   *\n   * @param {AccessMode} val - new access mode value.\n   * @returns {AccessMode} - <code>this</code> AccessMode.\n   */\n  updateAll(val) {\n    if (val) {\n      this.updateGiven(val.given);\n      this.updateWant(val.want);\n      this.mode = this.given & this.want;\n    }\n    return this;\n  }\n  /**\n   * Check if Owner (O) flag is set.\n   * @memberof Tinode.AccessMode\n   * @param {string=} side - which permission to check: given, want, mode; default: mode.\n   * @returns {boolean} - <code>true</code> if flag is set.\n   */\n  isOwner(side) {\n    return AccessMode.#checkFlag(this, side, AccessMode._OWNER);\n  }\n  /**\n   * Check if Presence (P) flag is set.\n   * @memberof Tinode.AccessMode\n   * @param {string=} side - which permission to check: given, want, mode; default: mode.\n   * @returns {boolean} - <code>true</code> if flag is set.\n   */\n  isPresencer(side) {\n    return AccessMode.#checkFlag(this, side, AccessMode._PRES);\n  }\n  /**\n   * Check if Presence (P) flag is NOT set.\n   * @memberof Tinode.AccessMode\n   * @param {string=} side - which permission to check: given, want, mode; default: mode.\n   * @returns {boolean} - <code>true</code> if flag is set.\n   */\n  isMuted(side) {\n    return !this.isPresencer(side);\n  }\n  /**\n   * Check if Join (J) flag is set.\n   * @memberof Tinode.AccessMode\n   * @param {string=} side - which permission to check: given, want, mode; default: mode.\n   * @returns {boolean} - <code>true</code> if flag is set.\n   */\n  isJoiner(side) {\n    return AccessMode.#checkFlag(this, side, AccessMode._JOIN);\n  }\n  /**\n   * Check if Reader (R) flag is set.\n   * @memberof Tinode.AccessMode\n   * @param {string=} side - which permission to check: given, want, mode; default: mode.\n   * @returns {boolean} - <code>true</code> if flag is set.\n   */\n  isReader(side) {\n    return AccessMode.#checkFlag(this, side, AccessMode._READ);\n  }\n  /**\n   * Check if Writer (W) flag is set.\n   * @memberof Tinode.AccessMode\n   * @param {string=} side - which permission to check: given, want, mode; default: mode.\n   * @returns {boolean} - <code>true</code> if flag is set.\n   */\n  isWriter(side) {\n    return AccessMode.#checkFlag(this, side, AccessMode._WRITE);\n  }\n  /**\n   * Check if Approver (A) flag is set.\n   * @memberof Tinode.AccessMode\n   * @param {string=} side - which permission to check: given, want, mode; default: mode.\n   * @returns {boolean} - <code>true</code> if flag is set.\n   */\n  isApprover(side) {\n    return AccessMode.#checkFlag(this, side, AccessMode._APPROVE);\n  }\n  /**\n   * Check if either one of Owner (O) or Approver (A) flags is set.\n   * @memberof Tinode.AccessMode\n   * @param {string=} side - which permission to check: given, want, mode; default: mode.\n   * @returns {boolean} - <code>true</code> if flag is set.\n   */\n  isAdmin(side) {\n    return this.isOwner(side) || this.isApprover(side);\n  }\n  /**\n   * Check if either one of Owner (O), Approver (A), or Sharer (S) flags is set.\n   * @memberof Tinode.AccessMode\n   * @param {string=} side - which permission to check: given, want, mode; default: mode.\n   * @returns {boolean} - <code>true</code> if flag is set.\n   */\n  isSharer(side) {\n    return this.isAdmin(side) || AccessMode.#checkFlag(this, side, AccessMode._SHARE);\n  }\n  /**\n   * Check if Deleter (D) flag is set.\n   * @memberof Tinode.AccessMode\n   * @param {string=} side - which permission to check: given, want, mode; default: mode.\n   * @returns {boolean} - <code>true</code> if flag is set.\n   */\n  isDeleter(side) {\n    return AccessMode.#checkFlag(this, side, AccessMode._DELETE);\n  }\n}\n\nAccessMode._NONE = 0x00;\nAccessMode._JOIN = 0x01;\nAccessMode._READ = 0x02;\nAccessMode._WRITE = 0x04;\nAccessMode._PRES = 0x08;\nAccessMode._APPROVE = 0x10;\nAccessMode._SHARE = 0x20;\nAccessMode._DELETE = 0x40;\nAccessMode._OWNER = 0x80;\n\nAccessMode._BITMASK = AccessMode._JOIN | AccessMode._READ | AccessMode._WRITE | AccessMode._PRES |\n  AccessMode._APPROVE | AccessMode._SHARE | AccessMode._DELETE | AccessMode._OWNER;\nAccessMode._INVALID = 0x100000;\n","export const PACKAGE_VERSION = \"0.26.0-alpha2\";\n","/**\n * @file Global constants and configuration parameters.\n *\n * @copyright 2015-2025 Tinode LLC\n */\n'use strict';\n\nimport {\n  PACKAGE_VERSION\n} from '../version.js';\n\n// Global constants\nexport const PROTOCOL_VERSION = '0'; // Major component of the version, e.g. '0' in '0.17.1'.\nexport const VERSION = PACKAGE_VERSION || '0.25';\nexport const LIBRARY = 'tinodejs/' + VERSION;\n\n// Topic name prefixes.\nexport const TOPIC_NEW = 'new';\nexport const TOPIC_NEW_CHAN = 'nch';\nexport const TOPIC_ME = 'me';\nexport const TOPIC_FND = 'fnd';\nexport const TOPIC_SYS = 'sys';\nexport const TOPIC_SLF = 'slf';\nexport const TOPIC_CHAN = 'chn';\nexport const TOPIC_GRP = 'grp';\nexport const TOPIC_P2P = 'p2p';\nexport const USER_NEW = 'new';\n\n// Starting value of a locally-generated seqId used for pending messages.\nexport const LOCAL_SEQID = 0xFFFFFFF;\n\n// Status codes.\nexport const MESSAGE_STATUS_NONE = 0; // Status not assigned.\nexport const MESSAGE_STATUS_QUEUED = 10; // Local ID assigned, in progress to be sent.\nexport const MESSAGE_STATUS_SENDING = 20; // Transmission started.\nexport const MESSAGE_STATUS_FAILED = 30; // At least one attempt was made to send the message.\nexport const MESSAGE_STATUS_FATAL = 40; // Message sending failed and it should not be retried.\nexport const MESSAGE_STATUS_SENT = 50; // Delivered to the server.\nexport const MESSAGE_STATUS_RECEIVED = 60; // Received by the client.\nexport const MESSAGE_STATUS_READ = 70; // Read by the user.\nexport const MESSAGE_STATUS_TO_ME = 80; // The message is received from another user.\n\n// Reject unresolved futures after this many milliseconds.\nexport const EXPIRE_PROMISES_TIMEOUT = 5_000;\n// Periodicity of garbage collection of unresolved futures.\nexport const EXPIRE_PROMISES_PERIOD = 1_000;\n\n// Delay before acknowledging that a message was recived.\nexport const RECV_TIMEOUT = 100;\n\n// Default number of messages to pull into memory from persistent cache.\nexport const DEFAULT_MESSAGES_PAGE = 24;\n\n// Unicode DEL character indicating data was deleted.\nexport const DEL_CHAR = '\\u2421';\n\n// Maximum number of pinnned messages;\nexport const MAX_PINNED_COUNT = 5;\n\n// Tag prefixes for alias, email, phone.\nexport const TAG_ALIAS = 'alias:';\nexport const TAG_EMAIL = 'email:';\nexport const TAG_PHONE = 'tel:';\n\n// Parameters of exponential backoff for reconnect attempts.\n// 2000 milliseconds, minimum delay between reconnects.\nexport const BACKOFF_BASE = 2_000;\n// Maximum delay between reconnects 2^10 * 2000 ~ 34 minutes.\nexport const BACKOFF_MAX_ITER = 10;\n// Random jitter between reconnection attempts, 0.3 -> 30% jitter.\nexport const BACKOFF_JITTER = 0.3;\n\n// Names of keys to server-provided configuration limits.\nexport const MAX_MESSAGE_SIZE = 'maxMessageSize';\nexport const MAX_SUBSCRIBER_COUNT = 'maxSubscriberCount';\nexport const MIN_TAG_LENGTH = 'minTagLength';\nexport const MAX_TAG_LENGTH = 'maxTagLength';\nexport const MAX_TAG_COUNT = 'maxTagCount';\nexport const MAX_FILE_UPLOAD_SIZE = 'maxFileUploadSize';\nexport const REQ_CRED_VALIDATORS = 'reqCred';\nexport const MSG_DELETE_AGE = 'msgDelAge';\nexport const REACTION_LIST = 'reactions';\nexport const MAX_REACTIONS = 'maxReactions';\n","/**\n * @file Throwable error with numeric error code.\n *\n * @copyright 2015-2023 Tinode LLC.\n */\n'use strict';\n\nexport default class CommError extends Error {\n  constructor(message, code) {\n    super(`${message} (${code})`);\n    this.name = 'CommError';\n    this.code = code;\n  }\n}\n","/**\n * @file Utilities used in multiple places.\n *\n * @copyright 2015-2025 Tinode LLC.\n */\n'use strict';\n\nimport AccessMode from './access-mode.js';\nimport {\n  DEL_CHAR,\n  LOCAL_SEQID\n} from './config.js';\n\n// Attempt to convert date and AccessMode strings to objects.\nexport function jsonParseHelper(key, val) {\n  // Try to convert string timestamps with optional milliseconds to Date,\n  // e.g. 2015-09-02T01:45:43[.123]Z\n  if (typeof val == 'string' && val.length >= 20 && val.length <= 24 && ['ts', 'touched', 'updated', 'created', 'when', 'deleted', 'expires'].includes(key)) {\n    const date = new Date(val);\n    if (!isNaN(date)) {\n      return date;\n    }\n  } else if (key === 'acs' && typeof val === 'object') {\n    return new AccessMode(val);\n  }\n  return val;\n}\n\n// Checks if URL is a relative url, i.e. has no 'scheme://', including the case of missing scheme '//'.\n// The scheme is expected to be RFC-compliant, e.g. [a-z][a-z0-9+.-]*\n// example.html - ok\n// https:example.com - not ok.\n// http:/example.com - not ok.\n// '  https://example.com' - not ok. ( means carriage return)\nexport function isUrlRelative(url) {\n  return url && !/^\\s*([a-z][a-z0-9+.-]*:|\\/\\/)/im.test(url);\n}\n\nfunction isValidDate(d) {\n  return (d instanceof Date) && !isNaN(d) && (d.getTime() != 0);\n}\n\n// RFC3339 formater of Date\nexport function rfc3339DateString(d) {\n  if (!isValidDate(d)) {\n    return undefined;\n  }\n\n  const pad = function(val, sp) {\n    sp = sp || 2;\n    return '0'.repeat(sp - ('' + val).length) + val;\n  };\n\n  const millis = d.getUTCMilliseconds();\n  return d.getUTCFullYear() + '-' + pad(d.getUTCMonth() + 1) + '-' + pad(d.getUTCDate()) +\n    'T' + pad(d.getUTCHours()) + ':' + pad(d.getUTCMinutes()) + ':' + pad(d.getUTCSeconds()) +\n    (millis ? '.' + pad(millis, 3) : '') + 'Z';\n}\n\n// Recursively merge src's own properties to dst.\n// Array and Date objects are shallow-copied.\nexport function mergeObj(dst, src) {\n  if (typeof src != 'object') {\n    if (src === undefined) {\n      return dst;\n    }\n    if (src === DEL_CHAR) {\n      return undefined;\n    }\n    return src;\n  }\n  // JS is crazy: typeof null is 'object'.\n  if (src === null) {\n    return dst;\n  }\n\n  // Handle Date\n  if (src instanceof Date && !isNaN(src)) {\n    return (!dst || !(dst instanceof Date) || isNaN(dst) || dst < src) ? src : dst;\n  }\n\n  // Access mode\n  if (src instanceof AccessMode) {\n    return new AccessMode(src);\n  }\n\n  // Handle Array\n  if (src instanceof Array) {\n    return src;\n  }\n\n  if (!dst || dst === DEL_CHAR) {\n    dst = src.constructor();\n  }\n\n  for (let prop in src) {\n    if (src.hasOwnProperty(prop) && (prop != '_noForwarding')) {\n      try {\n        dst[prop] = mergeObj(dst[prop], src[prop]);\n      } catch (err) {\n        console.warn(\"Error merging property:\", prop, err);\n      }\n    }\n  }\n  return dst;\n}\n\n// Update object stored in a cache. Returns updated value.\nexport function mergeToCache(cache, key, newval) {\n  cache[key] = mergeObj(cache[key], newval);\n  return cache[key];\n}\n\n// Strips all values from an object of they evaluate to false or if their name starts with '_'.\n// Used on all outgoing object before serialization to string.\nexport function simplify(obj) {\n  Object.keys(obj).forEach((key) => {\n    if (key[0] == '_') {\n      // Strip fields like \"obj._key\".\n      delete obj[key];\n    } else if (!obj[key]) {\n      // Strip fields which evaluate to false.\n      delete obj[key];\n    } else if (Array.isArray(obj[key]) && obj[key].length == 0) {\n      // Strip empty arrays.\n      delete obj[key];\n    } else if (!obj[key]) {\n      // Strip fields which evaluate to false.\n      delete obj[key];\n    } else if (obj[key] instanceof Date) {\n      // Strip invalid or zero date.\n      if (!isValidDate(obj[key])) {\n        delete obj[key];\n      }\n    } else if (typeof obj[key] == 'object') {\n      simplify(obj[key]);\n      // Strip empty objects.\n      if (Object.getOwnPropertyNames(obj[key]).length == 0) {\n        delete obj[key];\n      }\n    }\n  });\n  return obj;\n};\n\n\n// Trim whitespace, convert to lowercase, strip empty, short, and duplicate elements elements.\n// If the result is an empty array, add a single element \"\\u2421\" (Unicode Del character).\nexport function normalizeArray(arr) {\n  let out = [];\n  if (Array.isArray(arr)) {\n    // Trim, throw away very short and empty tags.\n    for (let i = 0, l = arr.length; i < l; i++) {\n      let t = arr[i];\n      if (t) {\n        t = t.trim().toLowerCase();\n        if (t.length > 1) {\n          out.push(t);\n        }\n      }\n    }\n    out = out.sort().filter((item, pos, ary) => {\n      return !pos || item != ary[pos - 1];\n    });\n  }\n  if (out.length == 0) {\n    // Add single tag with a Unicode Del character, otherwise an ampty array\n    // is ambiguos. The Del tag will be stripped by the server.\n    out.push(DEL_CHAR);\n  }\n  return out;\n}\n\n// Convert input to valid ranges of IDs.\nexport function normalizeRanges(ranges, maxSeq) {\n  if (!Array.isArray(ranges)) {\n    return [];\n  }\n\n  // Sort ranges in accending order by low, then descending by hi.\n  ranges.sort((r1, r2) => {\n    if (r1.low < r2.low) {\n      return -1;\n    }\n    if (r1.low == r2.low) {\n      return (r2.hi | 0) - r1.hi;\n    }\n    return 1;\n  });\n\n  // Remove pending messages from ranges possibly clipping some ranges.\n  ranges = ranges.reduce((out, r) => {\n    if (r.low < LOCAL_SEQID && r.low > 0) {\n      if (!r.hi || r.hi < LOCAL_SEQID) {\n        out.push(r);\n      } else {\n        // Clip hi to max allowed value.\n        out.push({\n          low: r.low,\n          hi: maxSeq + 1\n        });\n      }\n    }\n    return out;\n  }, []);\n\n  // Merge overlapping ranges.\n  ranges = ranges.reduce((out, r) => {\n    if (out.length == 0) {\n      out.push(r);\n    } else {\n      let prev = out[out.length - 1];\n      if (r.low <= prev.hi) {\n        prev.hi = Math.max(prev.hi, r.hi);\n      } else {\n        out.push(r);\n      }\n    }\n    return out;\n  }, []);\n\n  return ranges;\n}\n\n// Convert array of IDs to array of ranges.\nexport function listToRanges(list) {\n  // Sort the list in ascending order\n  list.sort((a, b) => a - b);\n  // Convert the array of IDs to ranges.\n  return list.reduce((out, id) => {\n    if (out.length == 0) {\n      // First element.\n      out.push({\n        low: id\n      });\n    } else {\n      let prev = out[out.length - 1];\n      if ((!prev.hi && (id != prev.low + 1)) || (id > prev.hi)) {\n        // New range.\n        out.push({\n          low: id\n        });\n      } else {\n        // Expand existing range.\n        prev.hi = prev.hi ? Math.max(prev.hi, id + 1) : id + 1;\n      }\n    }\n    return out;\n  }, []);\n}\n\n// Cuts 'clip' range out of the 'src' range.\n// Returns an array with 0, 1 or 2 elements.\nexport function clipOutRange(src, clip) {\n  if (clip.hi <= src.low || clip.low >= src.hi) {\n    // Clip is completely outside of src, no intersection.\n    return [src];\n  }\n\n\n  if (clip.low <= src.low) {\n    if (clip.hi >= src.hi) {\n      // The source range is completely inside the clipping range.\n      return [];\n    }\n    // Partial clipping at the top.\n    return [{\n      low: clip.hi,\n      hi: src.hi\n    }];\n  }\n\n  // Range on the lower end.\n  const result = [{\n    low: src.low,\n    hi: clip.low\n  }];\n  if (clip.hi < src.hi) {\n    // Maybe a range on the higher end, if clip is completely inside the source.\n    result.push({\n      low: clip.hi,\n      hi: src.hi\n    });\n  }\n\n  return result;\n}\n\n// Cuts 'src' range to be completely within 'clip' range.\n// Returns clipped range or null if 'src' is outside of 'clip'.\nexport function clipInRange(src, clip) {\n  if (clip.hi <= src.low || clip.low >= src.hi) {\n    // The src is completely outside of the clip, no intersection.\n    return null;\n  }\n\n  if (src.low >= clip.low && src.hi <= clip.hi) {\n    // Src is completely within the clip, return the entire src.\n    return src;\n  }\n\n  // Partial overlap.\n  return {\n    low: Math.max(src.low, clip.low),\n    hi: Math.min(src.hi, clip.hi)\n  };\n\n  return result;\n}\n","/**\n * @file Abstraction layer for websocket and long polling connections.\n *\n * @copyright 2015-2026 Tinode LLC.\n */\n'use strict';\n\nimport CommError from './comm-error.js';\nimport {\n  BACKOFF_BASE,\n  BACKOFF_MAX_ITER,\n  BACKOFF_JITTER\n} from './config.js';\nimport {\n  jsonParseHelper\n} from './utils.js';\n\n\nlet WebSocketProvider;\nlet XHRProvider;\n\n// Error code to return in case of a network problem.\nconst NETWORK_ERROR = 503;\nconst NETWORK_ERROR_TEXT = \"Connection failed\";\n\n// Error code to return when user disconnected from server.\nconst NETWORK_USER = 418;\nconst NETWORK_USER_TEXT = \"Disconnected by client\";\n\n// Helper function for creating an endpoint URL.\nfunction makeBaseUrl(host, protocol, version, apiKey) {\n  let url = null;\n\n  if (['http', 'https', 'ws', 'wss'].includes(protocol)) {\n    url = `${protocol}://${host}`;\n    if (url.charAt(url.length - 1) !== '/') {\n      url += '/';\n    }\n    url += 'v' + version + '/channels';\n    if (['http', 'https'].includes(protocol)) {\n      // Long polling endpoint ends with \"lp\", i.e.\n      // '/v0/channels/lp' vs just '/v0/channels' for ws\n      url += '/lp';\n    }\n    url += '?apikey=' + apiKey;\n  }\n  return url;\n}\n\n/**\n * An abstraction for a websocket or a long polling connection.\n *\n * @class Connection\n * @memberof Tinode\n\n * @param {Object} config - configuration parameters.\n * @param {string} config.host - Host name and optional port number to connect to.\n * @param {string} config.apiKey - API key generated by <code>keygen</code>.\n * @param {string} config.transport - Network transport to use, either <code>\"ws\"<code>/<code>\"wss\"</code> for websocket or\n *      <code>lp</code> for long polling.\n * @param {boolean} config.secure - Use Secure WebSocket if <code>true</code>.\n * @param {string} version_ - Major value of the protocol version, e.g. '0' in '0.17.1'.\n * @param {boolean} autoreconnect_ - If connection is lost, try to reconnect automatically.\n */\nexport default class Connection {\n  // Logger, does nothing by default.\n  static #log = _ => {};\n\n  #boffTimer = null;\n  #boffIteration = 0;\n  #boffClosed = false; // Indicator if the socket was manually closed - don't autoreconnect if true.\n\n  // Websocket.\n  #socket = null;\n\n  host;\n  secure;\n  apiKey;\n\n  version;\n  autoreconnect;\n\n  initialized;\n\n  // (config.host, config.apiKey, config.transport, config.secure), PROTOCOL_VERSION, true\n  constructor(config, version_, autoreconnect_) {\n    this.host = config.host;\n    this.secure = config.secure;\n    this.apiKey = config.apiKey;\n\n    this.version = version_;\n    this.autoreconnect = autoreconnect_;\n\n    if (config.transport === 'lp') {\n      // explicit request to use long polling\n      this.#init_lp();\n      this.initialized = 'lp';\n    } else if (config.transport === 'ws') {\n      // explicit request to use web socket\n      // if websockets are not available, horrible things will happen\n      this.#init_ws();\n      this.initialized = 'ws';\n    }\n\n    if (!this.initialized) {\n      // Invalid or undefined network transport.\n      Connection.#log(\"Unknown or invalid network transport. Running under Node? Call 'Tinode.setNetworkProviders()'.\");\n      throw new Error(\"Unknown or invalid network transport. Running under Node? Call 'Tinode.setNetworkProviders()'.\");\n    }\n  }\n\n  /**\n   * To use Connection in a non browser context, supply WebSocket and XMLHttpRequest providers.\n   * @static\n   * @memberof Connection\n   * @param {Object} wsProvider - WebSocket provider, e.g. for nodeJS, <code>require('ws')</code>.\n   * @param {Object} xhrProvider - XMLHttpRequest provider, e.g. for node <code>require('xhr')</code>.\n   */\n  static setNetworkProviders(wsProvider, xhrProvider) {\n    WebSocketProvider = wsProvider;\n    XHRProvider = xhrProvider;\n  }\n\n  /**\n   * Assign a non-default logger.\n   * @static\n   * @memberof Connection\n   * @param {Function} l - variadic logging function.\n   */\n  static set logger(l) {\n    Connection.#log = l;\n  }\n\n  /**\n   * Initiate a new connection\n   * @memberof Tinode.Connection#\n   * @param {string} host_ - Host name to connect to; if <code>null</code> the old host name will be used.\n   * @param {boolean} force - Force new connection even if one already exists.\n   * @returns {Promise} Promise resolved/rejected when the connection call completes, resolution is called without\n   *  parameters, rejection passes the {Error} as parameter.\n   */\n  connect(host_, force) {\n    return Promise.reject(null);\n  }\n\n  /**\n   * Try to restore a network connection, also reset backoff.\n   * @memberof Tinode.Connection#\n   *\n   * @param {boolean} force - reconnect even if there is a live connection already.\n   */\n  reconnect(force) {}\n\n  /**\n   * Terminate the network connection\n   * @memberof Tinode.Connection#\n   */\n  disconnect() {}\n\n  /**\n   * Send a string to the server.\n   * @memberof Tinode.Connection#\n   *\n   * @param {string} msg - String to send.\n   * @throws Throws an exception if the underlying connection is not live.\n   */\n  sendText(msg) {}\n\n  /**\n   * Check if connection is alive.\n   * @memberof Tinode.Connection#\n   * @returns {boolean} <code>true</code> if connection is live, <code>false</code> otherwise.\n   */\n  isConnected() {\n    return false;\n  }\n\n  /**\n   * Get the name of the current network transport.\n   * @memberof Tinode.Connection#\n   * @returns {string} name of the transport such as <code>\"ws\"</code> or <code>\"lp\"</code>.\n   */\n  transport() {\n    return this.initialized;\n  }\n\n  /**\n   * Send network probe to check if connection is indeed live.\n   * @memberof Tinode.Connection#\n   */\n  probe() {\n    this.sendText('1');\n  }\n\n  /**\n   * Reset autoreconnect counter to zero.\n   * @memberof Tinode.Connection#\n   */\n  backoffReset() {\n    this.#boffReset();\n  }\n\n  // Backoff implementation - reconnect after a timeout.\n  #boffReconnect() {\n    // Clear timer\n    clearTimeout(this.#boffTimer);\n    // Calculate when to fire the reconnect attempt\n    const timeout = BACKOFF_BASE * (Math.pow(2, this.#boffIteration) * (1.0 + BACKOFF_JITTER * Math.random()));\n    // Update iteration counter for future use\n    this.#boffIteration = (this.#boffIteration >= BACKOFF_MAX_ITER ? this.#boffIteration : this.#boffIteration + 1);\n    if (this.onAutoreconnectIteration) {\n      this.onAutoreconnectIteration(timeout);\n    }\n\n    this.#boffTimer = setTimeout(_ => {\n      Connection.#log(`Reconnecting, iter=${this.#boffIteration}, timeout=${timeout}`);\n      // Maybe the socket was closed while we waited for the timer?\n      if (!this.#boffClosed) {\n        const prom = this.connect();\n        if (this.onAutoreconnectIteration) {\n          this.onAutoreconnectIteration(0, prom);\n        } else {\n          // Suppress error if it's not used.\n          prom.catch(_ => {\n            /* do nothing */\n          });\n        }\n      } else if (this.onAutoreconnectIteration) {\n        this.onAutoreconnectIteration(-1);\n      }\n    }, timeout);\n  }\n\n  // Terminate auto-reconnect process.\n  #boffStop() {\n    clearTimeout(this.#boffTimer);\n    this.#boffTimer = null;\n  }\n\n  // Reset auto-reconnect iteration counter.\n  #boffReset() {\n    this.#boffIteration = 0;\n  }\n\n  // Initialization for long polling.\n  #init_lp() {\n    const XDR_UNSENT = 0; // Client has been created. open() not called yet.\n    const XDR_OPENED = 1; // open() has been called.\n    const XDR_HEADERS_RECEIVED = 2; // send() has been called, and headers and status are available.\n    const XDR_LOADING = 3; // Downloading; responseText holds partial data.\n    const XDR_DONE = 4; // The operation is complete.\n\n    // Fully composed endpoint URL, with API key & SID\n    let _lpURL = null;\n\n    let _poller = null;\n    let _sender = null;\n\n    let lp_sender = (url_) => {\n      const sender = new XHRProvider();\n      sender.onreadystatechange = (evt) => {\n        if (sender.readyState == XDR_DONE && sender.status >= 400) {\n          // Some sort of error response\n          throw new CommError(\"LP sender failed\", sender.status);\n        }\n      };\n\n      sender.open('POST', url_, true);\n      return sender;\n    }\n\n    let lp_poller = (url_, resolve, reject) => {\n      let poller = new XHRProvider();\n      let promiseCompleted = false;\n\n      poller.onreadystatechange = evt => {\n        if (poller.readyState == XDR_DONE) {\n          if (poller.status == 201) { // 201 == HTTP.Created, get SID\n            let pkt = JSON.parse(poller.responseText, jsonParseHelper);\n            _lpURL = url_ + '&sid=' + pkt.ctrl.params.sid;\n            poller = lp_poller(_lpURL);\n            poller.send(null);\n            if (this.onOpen) {\n              this.onOpen();\n            }\n\n            if (resolve) {\n              promiseCompleted = true;\n              resolve();\n            }\n\n            if (this.autoreconnect) {\n              this.#boffStop();\n            }\n          } else if (poller.status > 0 && poller.status < 400) { // 0 = network error; 400 = HTTP.BadRequest\n            if (this.onMessage) {\n              this.onMessage(poller.responseText);\n            }\n            poller = lp_poller(_lpURL);\n            poller.send(null);\n          } else {\n            // Don't throw an error here, gracefully handle server errors\n            if (reject && !promiseCompleted) {\n              promiseCompleted = true;\n              reject(poller.responseText);\n            }\n            if (this.onMessage && poller.responseText) {\n              this.onMessage(poller.responseText);\n            }\n            if (this.onDisconnect) {\n              const code = poller.status || (this.#boffClosed ? NETWORK_USER : NETWORK_ERROR);\n              const text = poller.responseText || (this.#boffClosed ? NETWORK_USER_TEXT : NETWORK_ERROR_TEXT);\n              this.onDisconnect(new CommError(text, code), code);\n            }\n\n            // Polling has stopped. Indicate it by setting poller to null.\n            poller = null;\n            if (!this.#boffClosed && this.autoreconnect) {\n              this.#boffReconnect();\n            }\n          }\n        }\n      };\n      // Using POST to avoid caching response by service worker.\n      poller.open('POST', url_, true);\n      return poller;\n    }\n\n    this.connect = (host_, force) => {\n      this.#boffClosed = false;\n\n      if (_poller) {\n        if (!force) {\n          return Promise.resolve();\n        }\n        _poller.onreadystatechange = undefined;\n        _poller.abort();\n        _poller = null;\n      }\n\n      if (host_) {\n        this.host = host_;\n      }\n\n      return new Promise((resolve, reject) => {\n        const url = makeBaseUrl(this.host, this.secure ? 'https' : 'http', this.version, this.apiKey);\n        Connection.#log(\"LP connecting to:\", url);\n        _poller = lp_poller(url, resolve, reject);\n        _poller.send(null);\n      }).catch(err => {\n        Connection.#log(\"LP connection failed:\", err);\n      });\n    };\n\n    this.reconnect = force => {\n      this.#boffStop();\n      this.connect(null, force);\n    };\n\n    this.disconnect = _ => {\n      this.#boffClosed = true;\n      this.#boffStop();\n\n      if (_sender) {\n        _sender.onreadystatechange = undefined;\n        _sender.abort();\n        _sender = null;\n      }\n      if (_poller) {\n        _poller.onreadystatechange = undefined;\n        _poller.abort();\n        _poller = null;\n      }\n\n      if (this.onDisconnect) {\n        this.onDisconnect(new CommError(NETWORK_USER_TEXT, NETWORK_USER), NETWORK_USER);\n      }\n      // Ensure it's reconstructed\n      _lpURL = null;\n    };\n\n    this.sendText = (msg) => {\n      _sender = lp_sender(_lpURL);\n      if (_sender && (_sender.readyState == XDR_OPENED)) {\n        _sender.send(msg);\n      } else {\n        throw new Error(\"Long poller failed to connect\");\n      }\n    };\n\n    this.isConnected = _ => {\n      return (_poller && true);\n    };\n  }\n\n  // Initialization for Websocket\n  #init_ws() {\n    this.connect = (host_, force) => {\n      this.#boffClosed = false;\n\n      if (this.#socket) {\n        if (!force && this.#socket.readyState == this.#socket.OPEN) {\n          // Issue a probe request to be sure the connection is live.\n          // This is a non-blocking call.\n          this.probe();\n          return Promise.resolve();\n        }\n        this.#socket.close();\n        this.#socket = null;\n      }\n\n      if (host_) {\n        this.host = host_;\n      }\n\n      return new Promise((resolve, reject) => {\n        const url = makeBaseUrl(this.host, this.secure ? 'wss' : 'ws', this.version, this.apiKey);\n\n        Connection.#log(\"WS connecting to: \", url);\n\n        // It throws when the server is not accessible but the exception cannot be caught:\n        // https://stackoverflow.com/questions/31002592/javascript-doesnt-catch-error-in-websocket-instantiation/31003057\n        const conn = new WebSocketProvider(url);\n\n        conn.onerror = err => {\n          reject(err);\n        };\n\n        conn.onopen = _ => {\n          if (this.autoreconnect) {\n            this.#boffStop();\n          }\n\n          if (this.onOpen) {\n            this.onOpen();\n          }\n\n          resolve();\n        };\n\n        conn.onclose = _ => {\n          this.#socket = null;\n\n          if (this.onDisconnect) {\n            const code = this.#boffClosed ? NETWORK_USER : NETWORK_ERROR;\n            this.onDisconnect(new CommError(this.#boffClosed ? NETWORK_USER_TEXT : NETWORK_ERROR_TEXT, code), code);\n          }\n\n          if (!this.#boffClosed && this.autoreconnect) {\n            this.#boffReconnect();\n          }\n        };\n\n        conn.onmessage = evt => {\n          if (this.onMessage) {\n            this.onMessage(evt.data);\n          }\n        };\n\n        this.#socket = conn;\n      });\n    }\n\n    this.reconnect = force => {\n      this.#boffStop();\n      this.connect(null, force);\n    };\n\n    this.disconnect = _ => {\n      this.#boffClosed = true;\n      this.#boffStop();\n\n      if (!this.#socket) {\n        return;\n      }\n      this.#socket.close();\n      this.#socket = null;\n    };\n\n    this.sendText = msg => {\n      if (this.#socket && (this.#socket.readyState == this.#socket.OPEN)) {\n        this.#socket.send(msg);\n      } else {\n        throw new Error(\"Websocket is not connected\");\n      }\n    };\n\n    this.isConnected = _ => {\n      return (this.#socket && (this.#socket.readyState == this.#socket.OPEN));\n    };\n  }\n\n  // Callbacks:\n\n  /**\n   * A callback to pass incoming messages to. See {@link Tinode.Connection#onMessage}.\n   * @callback Tinode.Connection.OnMessage\n   * @memberof Tinode.Connection\n   * @param {string} message - Message to process.\n   */\n  onMessage = undefined;\n\n  /**\n   * A callback for reporting a dropped connection.\n   * @type {function}\n   * @memberof Tinode.Connection#\n   */\n  onDisconnect = undefined;\n\n  /**\n   * A callback called when the connection is ready to be used for sending. For websockets it's socket open,\n   * for long polling it's <code>readyState=1</code> (OPENED)\n   * @type {function}\n   * @memberof Tinode.Connection#\n   */\n  onOpen = undefined;\n\n  /**\n   * A callback to notify of reconnection attempts. See {@link Tinode.Connection#onAutoreconnectIteration}.\n   * @memberof Tinode.Connection\n   * @callback AutoreconnectIterationType\n   * @param {string} timeout - time till the next reconnect attempt in milliseconds. <code>-1</code> means reconnect was skipped.\n   * @param {Promise} promise - promise resolved or rejected when the reconnect attempt completes.\n   *\n   */\n  /**\n   * A callback to inform when the next attempt to reconnect will happen and to receive connection promise.\n   * @memberof Tinode.Connection#\n   * @type {Tinode.Connection.AutoreconnectIterationType}\n   */\n  onAutoreconnectIteration = undefined;\n}\n\nConnection.NETWORK_ERROR = NETWORK_ERROR;\nConnection.NETWORK_ERROR_TEXT = NETWORK_ERROR_TEXT;\nConnection.NETWORK_USER = NETWORK_USER;\nConnection.NETWORK_USER_TEXT = NETWORK_USER_TEXT;\n","/**\n * @file Helper methods for dealing with IndexedDB cache of messages, users, and topics.\n *\n * @copyright 2015-2026 Tinode LLC.\n */\n'use strict';\n\n// NOTE TO DEVELOPERS:\n// Localizable strings should be double quoted \"   \",\n// non-localizable strings should be single quoted 'non-localized'.\n\nconst DB_VERSION = 3;\nconst DB_NAME = 'tinode-web';\n\nlet IDBProvider;\n\nexport default class DB {\n  #onError = _ => {};\n  #logger = _ => {};\n\n  // Instance of IndexDB.\n  db = null;\n  // Indicator that the cache is disabled.\n  disabled = true;\n\n  constructor(onError, logger) {\n    this.#onError = onError || this.#onError;\n    this.#logger = logger || this.#logger;\n  }\n\n  #mapObjects(source, callback, context) {\n    if (!this.db) {\n      return disabled ?\n        Promise.resolve([]) :\n        Promise.reject(new Error(\"not initialized\"));\n    }\n\n    return new Promise((resolve, reject) => {\n      const trx = this.db.transaction([source]);\n      trx.onerror = event => {\n        this.#logger('PCache', 'mapObjects', source, event.target.error);\n        reject(event.target.error);\n      };\n      trx.objectStore(source).getAll().onsuccess = event => {\n        if (callback) {\n          event.target.result.forEach(topic => {\n            callback.call(context, topic);\n          });\n        }\n        resolve(event.target.result);\n      };\n    });\n  }\n\n  /**\n   * Initialize persistent cache: open or create/upgrade if needed.\n   * @returns {Promise} promise to be resolved/rejected when the DB is initialized.\n   */\n  initDatabase() {\n    return new Promise((resolve, reject) => {\n      // Open the database and initialize callbacks.\n      const req = IDBProvider.open(DB_NAME, DB_VERSION);\n      req.onsuccess = event => {\n        this.db = event.target.result;\n        this.disabled = false;\n\n        // This handler is called when a different tab tries to upgrade the database.\n        this.db.onversionchange = _ => {\n          this.#logger('PCache', \"another tab tries to upgrade DB, shutting down\");\n          this.db.close();\n          this.db = null;\n          this.disabled = true;\n        };\n\n        resolve(this.db);\n      };\n      req.onerror = event => {\n        this.#logger('PCache', \"failed to initialize\", event);\n        reject(event.target.error);\n        this.#onError(event.target.error);\n      };\n      req.onupgradeneeded = event => {\n        this.db = event.target.result;\n\n        this.db.onerror = event => {\n          this.#logger('PCache', \"failed to create storage\", event);\n          this.#onError(event.target.error);\n        };\n\n        // Individual object stores.\n\n        // Alternatively could use event.oldVersion and event.newVersion\n        // to determine which object stores to create or upgrade.\n\n        if (!this.db.objectStoreNames.contains('topic')) {\n          // Object store (table) for topics. The primary key is the topic name.\n          this.db.createObjectStore('topic', {\n            keyPath: 'name'\n          });\n        }\n\n        if (!this.db.objectStoreNames.contains('user')) {\n          // Users object store. UID is the primary key.\n          this.db.createObjectStore('user', {\n            keyPath: 'uid'\n          });\n        }\n\n        if (!this.db.objectStoreNames.contains('subscription')) {\n          // Subscriptions object store topic <-> user. Topic name + UID is the primary key.\n          this.db.createObjectStore('subscription', {\n            keyPath: ['topic', 'uid']\n          });\n        }\n\n        if (!this.db.objectStoreNames.contains('message')) {\n          // Messages object store. The primary key is topic name + seq.\n          this.db.createObjectStore('message', {\n            keyPath: ['topic', 'seq']\n          });\n        }\n\n        if (!this.db.objectStoreNames.contains('dellog')) {\n          // Records of deleted message ranges. The primary key is topic name + low seq.\n          const dellog = this.db.createObjectStore('dellog', {\n            keyPath: ['topic', 'low', 'hi']\n          });\n          if (!dellog.indexNames.contains('topic_clear')) {\n            dellog.createIndex('topic_clear', ['topic', 'clear'], {\n              unique: false\n            });\n          }\n        }\n      }\n    });\n  }\n\n  /**\n   * Delete persistent cache.\n   */\n  deleteDatabase() {\n    // Close connection, otherwise operations will fail with 'onblocked'.\n    if (this.db) {\n      this.db.close();\n      this.db = null;\n    }\n    return new Promise((resolve, reject) => {\n      const req = IDBProvider.deleteDatabase(DB_NAME);\n      req.onblocked = _ => {\n        if (this.db) {\n          this.db.close();\n        }\n        const err = new Error(\"blocked\");\n        this.#logger('PCache', 'deleteDatabase', err);\n        reject(err);\n      };\n      req.onsuccess = _ => {\n        this.db = null;\n        this.disabled = true;\n        resolve(true);\n      };\n      req.onerror = event => {\n        this.#logger('PCache', 'deleteDatabase', event.target.error);\n        reject(event.target.error);\n      };\n    });\n  }\n\n  /**\n   * Check if persistent cache is ready for use.\n   * @memberOf DB\n   * @returns {boolean} <code>true</code> if cache is ready, <code>false</code> otherwise.\n   */\n  isReady() {\n    return !!this.db;\n  }\n\n  // Topics.\n\n  /**\n   * Save to cache or update topic in persistent cache.\n   * @memberOf DB\n   * @param {Topic} topic - topic to be added or updated.\n   * @returns {Promise} promise resolved/rejected on operation completion.\n   */\n  updTopic(topic) {\n    if (!this.isReady()) {\n      return this.disabled ?\n        Promise.resolve() :\n        Promise.reject(new Error(\"not initialized\"));\n    }\n    return new Promise((resolve, reject) => {\n      const trx = this.db.transaction(['topic'], 'readwrite');\n      trx.oncomplete = event => {\n        resolve(event.target.result);\n      };\n      trx.onerror = event => {\n        this.#logger('PCache', 'updTopic', event.target.error);\n        reject(event.target.error);\n      };\n      const req = trx.objectStore('topic').get(topic.name);\n      req.onsuccess = _ => {\n        trx.objectStore('topic').put(DB.#serializeTopic(req.result, topic));\n        trx.commit();\n      };\n    });\n  }\n\n  /**\n   * Mark or unmark topic as deleted.\n   * @memberOf DB\n   * @param {string} name - name of the topic to mark or unmark.\n   * @param {boolean} deleted - status\n   * @return {Promise} promise resolved/rejected on operation completion.\n   */\n  markTopicAsDeleted(name, deleted) {\n    if (!this.isReady()) {\n      return this.disabled ?\n        Promise.resolve() :\n        Promise.reject(new Error(\"not initialized\"));\n    }\n    return new Promise((resolve, reject) => {\n      const trx = this.db.transaction(['topic'], 'readwrite');\n      trx.oncomplete = event => {\n        resolve(event.target.result);\n      };\n      trx.onerror = event => {\n        this.#logger('PCache', 'markTopicAsDeleted', event.target.error);\n        reject(event.target.error);\n      };\n      const req = trx.objectStore('topic').get(name);\n      req.onsuccess = event => {\n        const topic = event.target.result;\n        if (topic && topic._deleted != deleted) {\n          topic._deleted = deleted;\n          trx.objectStore('topic').put(topic);\n        }\n        trx.commit();\n      };\n    });\n  }\n\n  /**\n   * Remove topic from persistent cache.\n   * @memberOf DB\n   * @param {string} name - name of the topic to remove from database.\n   * @return {Promise} promise resolved/rejected on operation completion.\n   */\n  remTopic(name) {\n    if (!this.isReady()) {\n      return this.disabled ?\n        Promise.resolve() :\n        Promise.reject(new Error(\"not initialized\"));\n    }\n    return new Promise((resolve, reject) => {\n      const trx = this.db.transaction(['topic', 'subscription', 'message'], 'readwrite');\n      trx.oncomplete = event => {\n        resolve(event.target.result);\n      };\n      trx.onerror = event => {\n        this.#logger('PCache', 'remTopic', event.target.error);\n        reject(event.target.error);\n      };\n      trx.objectStore('topic').delete(IDBKeyRange.only(name));\n      trx.objectStore('subscription').delete(IDBKeyRange.bound([name, '-'], [name, '~']));\n      trx.objectStore('message').delete(IDBKeyRange.bound([name, 0], [name, Number.MAX_SAFE_INTEGER]));\n      trx.commit();\n    });\n  }\n\n  /**\n   * Execute a callback for each stored topic.\n   * @memberOf DB\n   * @param {function} callback - function to call for each topic.\n   * @param {Object} context - the value or <code>this</code> inside the callback.\n   * @return {Promise} promise resolved/rejected on operation completion.\n   */\n  mapTopics(callback, context) {\n    return this.#mapObjects('topic', callback, context);\n  }\n\n  /**\n   * Copy data from serialized object to topic.\n   * @memberOf DB\n   * @param {Topic} topic - target to deserialize to.\n   * @param {Object} src - serialized data to copy from.\n   */\n  deserializeTopic(topic, src) {\n    DB.#deserializeTopic(topic, src);\n  }\n\n  // Users.\n  /**\n   * Add or update user object in the persistent cache.\n   * @memberOf DB\n   * @param {string} uid - ID of the user to save or update.\n   * @param {Object} pub - user's <code>public</code> information.\n   * @returns {Promise} promise resolved/rejected on operation completion.\n   */\n  updUser(uid, pub) {\n    if (arguments.length < 2 || pub === undefined) {\n      // No point in updating user with invalid data.\n      return;\n    }\n    if (!this.isReady()) {\n      return this.disabled ?\n        Promise.resolve() :\n        Promise.reject(new Error(\"not initialized\"));\n    }\n    return new Promise((resolve, reject) => {\n      const trx = this.db.transaction(['user'], 'readwrite');\n      trx.oncomplete = event => {\n        resolve(event.target.result);\n      };\n      trx.onerror = event => {\n        this.#logger('PCache', 'updUser', event.target.error);\n        reject(event.target.error);\n      };\n      trx.objectStore('user').put({\n        uid: uid,\n        public: pub\n      });\n      trx.commit();\n    });\n  }\n\n  /**\n   * Remove user from persistent cache.\n   * @memberOf DB\n   * @param {string} uid - ID of the user to remove from the cache.\n   * @return {Promise} promise resolved/rejected on operation completion.\n   */\n  remUser(uid) {\n    if (!this.isReady()) {\n      return this.disabled ?\n        Promise.resolve() :\n        Promise.reject(new Error(\"not initialized\"));\n    }\n    return new Promise((resolve, reject) => {\n      const trx = this.db.transaction(['user'], 'readwrite');\n      trx.oncomplete = event => {\n        resolve(event.target.result);\n      };\n      trx.onerror = event => {\n        this.#logger('PCache', 'remUser', event.target.error);\n        reject(event.target.error);\n      };\n      trx.objectStore('user').delete(IDBKeyRange.only(uid));\n      trx.commit();\n    });\n  }\n\n  /**\n   * Execute a callback for each stored user.\n   * @memberOf DB\n   * @param {function} callback - function to call for each topic.\n   * @param {Object} context - the value or <code>this</code> inside the callback.\n   * @return {Promise} promise resolved/rejected on operation completion.\n   */\n  mapUsers(callback, context) {\n    return this.#mapObjects('user', callback, context);\n  }\n\n  /**\n   * Read a single user from persistent cache.\n   * @memberOf DB\n   * @param {string} uid - ID of the user to fetch from cache.\n   * @return {Promise} promise resolved/rejected on operation completion.\n   */\n  getUser(uid) {\n    if (!this.isReady()) {\n      return this.disabled ?\n        Promise.resolve() :\n        Promise.reject(new Error(\"not initialized\"));\n    }\n    return new Promise((resolve, reject) => {\n      const trx = this.db.transaction(['user']);\n      trx.oncomplete = event => {\n        const user = event.target.result;\n        resolve({\n          user: user.uid,\n          public: user.public\n        });\n      };\n      trx.onerror = event => {\n        this.#logger('PCache', 'getUser', event.target.error);\n        reject(event.target.error);\n      };\n      trx.objectStore('user').get(uid);\n    });\n  }\n\n  // Subscriptions.\n  /**\n   * Add or update subscription in persistent cache.\n   * @memberOf DB\n   * @param {string} topicName - name of the topic which owns the message.\n   * @param {string} uid - ID of the subscribed user.\n   * @param {Object} sub - subscription to save.\n   * @return {Promise} promise resolved/rejected on operation completion.\n   */\n  updSubscription(topicName, uid, sub) {\n    if (!this.isReady()) {\n      return this.disabled ?\n        Promise.resolve() :\n        Promise.reject(new Error(\"not initialized\"));\n    }\n    return new Promise((resolve, reject) => {\n      const trx = this.db.transaction(['subscription'], 'readwrite');\n      trx.oncomplete = event => {\n        resolve(event.target.result);\n      };\n      trx.onerror = event => {\n        this.#logger('PCache', 'updSubscription', event.target.error);\n        reject(event.target.error);\n      };\n      trx.objectStore('subscription').get([topicName, uid]).onsuccess = (event) => {\n        trx.objectStore('subscription').put(DB.#serializeSubscription(event.target.result, topicName, uid, sub));\n        trx.commit();\n      };\n    });\n  }\n\n  /**\n   * Execute a callback for each cached subscription in a given topic.\n   * @memberOf DB\n   * @param {string} topicName - name of the topic which owns the subscriptions.\n   * @param {function} callback - function to call for each subscription.\n   * @param {Object} context - the value or <code>this</code> inside the callback.\n   * @return {Promise} promise resolved/rejected on operation completion.\n   */\n  mapSubscriptions(topicName, callback, context) {\n    if (!this.isReady()) {\n      return this.disabled ?\n        Promise.resolve([]) :\n        Promise.reject(new Error(\"not initialized\"));\n    }\n    return new Promise((resolve, reject) => {\n      const trx = this.db.transaction(['subscription']);\n      trx.onerror = (event) => {\n        this.#logger('PCache', 'mapSubscriptions', event.target.error);\n        reject(event.target.error);\n      };\n      trx.objectStore('subscription').getAll(IDBKeyRange.bound([topicName, '-'], [topicName, '~'])).onsuccess = (event) => {\n        if (callback) {\n          event.target.result.forEach((topic) => {\n            callback.call(context, topic);\n          });\n        }\n        resolve(event.target.result);\n      };\n    });\n  }\n\n  // Messages.\n\n  /**\n   * Save message to persistent cache.\n   * @memberOf DB\n   * @param {Object} msg - message to save.\n   * @return {Promise} promise resolved/rejected on operation completion.\n   */\n  addMessage(msg) {\n    if (!this.isReady()) {\n      return this.disabled ?\n        Promise.resolve() :\n        Promise.reject(new Error(\"not initialized\"));\n    }\n    return new Promise((resolve, reject) => {\n      const trx = this.db.transaction(['message'], 'readwrite');\n      trx.onsuccess = event => {\n        resolve(event.target.result);\n      };\n      trx.onerror = event => {\n        this.#logger('PCache', 'addMessage', event.target.error);\n        reject(event.target.error);\n      };\n      trx.objectStore('message').add(DB.#serializeMessage(null, msg));\n      trx.commit();\n    });\n  }\n\n  /**\n   * Update delivery status of a message stored in persistent cache.\n   * @memberOf DB\n   * @param {string} topicName - name of the topic which owns the message.\n   * @param {number} seq - ID of the message to update\n   * @param {number} status - new delivery status of the message.\n   * @return {Promise} promise resolved/rejected on operation completion.\n   */\n  updMessageStatus(topicName, seq, status) {\n    if (!this.isReady()) {\n      return this.disabled ?\n        Promise.resolve() :\n        Promise.reject(new Error(\"not initialized\"));\n    }\n    return new Promise((resolve, reject) => {\n      const trx = this.db.transaction(['message'], 'readwrite');\n      trx.onsuccess = event => {\n        resolve(event.target.result);\n      };\n      trx.onerror = event => {\n        this.#logger('PCache', 'updMessageStatus', event.target.error);\n        reject(event.target.error);\n      };\n      const req = trx.objectStore('message').get(IDBKeyRange.only([topicName, seq]));\n      req.onsuccess = event => {\n        const src = req.result || event.target.result;\n        if (src && src._status != status) {\n          trx.objectStore('message').put(DB.#serializeMessage(src, {\n            topic: topicName,\n            seq: seq,\n            _status: status\n          }));\n        }\n        trx.commit();\n      };\n    });\n  }\n\n  /**\n   * Update reactions to a message.\n   * @memberOf DB\n   * @param {string} topicName - name of the topic which owns the message.\n   * @param {number} seq - ID of the message to update.\n   * @param {Array} react - updated reactions.\n   * @return {Promise} promise resolved/rejected on operation completion.\n   */\n  updMessageReact(topicName, seq, react) {\n    if (!this.isReady()) {\n      return this.disabled ?\n        Promise.resolve() :\n        Promise.reject(new Error(\"not initialized\"));\n    }\n    return new Promise((resolve, reject) => {\n      const trx = this.db.transaction(['message'], 'readwrite');\n      trx.onsuccess = event => {\n        resolve(event.target.result);\n      };\n      trx.onerror = event => {\n        this.#logger('PCache', 'updMessageReact', event.target.error);\n        reject(event.target.error);\n      };\n      const req = trx.objectStore('message').get(IDBKeyRange.only([topicName, seq]));\n      req.onsuccess = event => {\n        const src = req.result || event.target.result;\n        if (src && src.react !== react) {\n          trx.objectStore('message').put(DB.#serializeMessage(src, {\n            topic: topicName,\n            seq: seq,\n            react: react\n          }));\n        }\n        trx.commit();\n      };\n    });\n  }\n\n  /**\n   * Remove one or more messages from persistent cache.\n   * @memberOf DB\n   * @param {string} topicName - name of the topic which owns the message.\n   * @param {number} from - id of the message to remove or lower boundary when removing range (inclusive).\n   * @param {number=} to - upper boundary (exclusive) when removing a range of messages.\n   * @return {Promise} promise resolved/rejected on operation completion.\n   */\n  remMessages(topicName, from, to) {\n    if (!this.isReady()) {\n      return this.disabled ?\n        Promise.resolve() :\n        Promise.reject(new Error(\"not initialized\"));\n    }\n    return new Promise((resolve, reject) => {\n      if (!from && !to) {\n        from = 0;\n        to = Number.MAX_SAFE_INTEGER;\n      }\n      const range = to > 0 ? IDBKeyRange.bound([topicName, from], [topicName, to], false, true) :\n        IDBKeyRange.only([topicName, from]);\n      const trx = this.db.transaction(['message'], 'readwrite');\n      trx.onsuccess = event => {\n        resolve(event.target.result);\n      };\n      trx.onerror = event => {\n        this.#logger('PCache', 'remMessages', event.target.error);\n        reject(event.target.error);\n      };\n      trx.objectStore('message').delete(range);\n      trx.commit();\n    });\n  }\n\n  /**\n   * Retrieve messages from persistent store.\n   * @memberOf DB\n   * @param {string} topicName - name of the topic to retrieve messages from.\n   * @param {function} callback to call for each retrieved message.\n   * @param {GetDataType} query - parameters of the message range to retrieve.\n   *\n   * @return {Promise} promise resolved/rejected on operation completion.\n   */\n  readMessages(topicName, query, callback, context) {\n    query = query || {};\n\n    if (!this.isReady()) {\n      return this.disabled ?\n        Promise.resolve([]) :\n        Promise.reject(new Error(\"not initialized\"));\n    }\n\n    const trx = this.db.transaction(['message']);\n    let result = [];\n\n    // Handle individual message ranges.\n    if (Array.isArray(query.ranges)) {\n      return new Promise((resolve, reject) => {\n        trx.onerror = event => {\n          this.#logger('PCache', 'readMessages', event.target.error);\n          reject(event.target.error);\n        };\n\n        let count = 0;\n        query.ranges.forEach(range => {\n          const key = range.hi ? IDBKeyRange.bound([topicName, range.low], [topicName, range.hi], false, true) :\n            IDBKeyRange.only([topicName, range.low]);\n          trx.objectStore('message').getAll(key).onsuccess = event => {\n            const msgs = event.target.result;\n            if (msgs) {\n              if (callback) {\n                callback.call(context, msgs);\n              }\n              if (Array.isArray(msgs)) {\n                result = result.concat(msgs);\n              } else {\n                result.push(msgs);\n              }\n            }\n            count++;\n            if (count == query.ranges.length) {\n              resolve(result);\n            }\n          };\n        });\n      });\n    }\n\n    // Handle single range.\n    return new Promise((resolve, reject) => {\n      const since = query.since > 0 ? query.since : 0;\n      const before = query.before > 0 ? query.before : Number.MAX_SAFE_INTEGER;\n      const limit = query.limit | 0;\n\n      trx.onerror = event => {\n        this.#logger('PCache', 'readMessages', event.target.error);\n        reject(event.target.error);\n      };\n\n      const range = IDBKeyRange.bound([topicName, since], [topicName, before], false, true);\n      // Iterate in descending order.\n      trx.objectStore('message').openCursor(range, 'prev')\n        .onsuccess = event => {\n          const cursor = event.target.result;\n          if (cursor) {\n            if (callback) {\n              callback.call(context, cursor.value);\n            }\n            result.push(cursor.value);\n            if (limit <= 0 || result.length < limit) {\n              cursor.continue();\n            } else {\n              resolve(result);\n            }\n          } else {\n            resolve(result);\n          }\n        };\n    });\n  }\n\n  // Delete log\n\n  /**\n   * Add records of deleted messages.\n   * @memberOf DB\n   * @param {string} topicName - name of the topic which owns the message.\n   * @param {number} delId - id of the deletion transaction.\n   * @param {Array.<IdRange>} ranges - message to save.\n   * @return {Promise} promise resolved/rejected on operation completion.\n   */\n  addDelLog(topicName, delId, ranges) {\n    if (!this.isReady()) {\n      return this.disabled ?\n        Promise.resolve() :\n        Promise.reject(new Error(\"not initialized\"));\n    }\n    return new Promise((resolve, reject) => {\n      const trx = this.db.transaction(['dellog'], 'readwrite');\n      trx.onsuccess = event => {\n        resolve(event.target.result);\n      };\n      trx.onerror = event => {\n        this.#logger('PCache', 'addDelLog', event.target.error);\n        reject(event.target.error);\n      };\n      ranges.forEach(r => trx.objectStore('dellog').add({\n        topic: topicName,\n        clear: delId,\n        low: r.low,\n        hi: r.hi || (r.low + 1)\n      }));\n      trx.commit();\n    });\n  }\n\n  /**\n   * Retrieve deleted message records from persistent store.\n   * @memberOf DB\n   * @param {string} topicName - name of the topic to retrieve records for.\n   * @param {GetDataType} query - parameters of the message range to retrieve.\n   * @return {Promise} promise resolved/rejected on operation completion.\n   */\n  readDelLog(topicName, query) {\n    query = query || {};\n\n    if (!this.isReady()) {\n      return this.disabled ?\n        Promise.resolve([]) :\n        Promise.reject(new Error(\"not initialized\"));\n    }\n\n    const trx = this.db.transaction(['dellog']);\n    let result = [];\n\n    // Handle individual message ranges.\n    if (Array.isArray(query.ranges)) {\n      return new Promise((resolve, reject) => {\n        trx.onerror = event => {\n          this.#logger('PCache', 'readDelLog', event.target.error);\n          reject(event.target.error);\n        };\n\n        let count = 0;\n        query.ranges.forEach(range => {\n          const hi = range.hi || (range.low + 1);\n          const key = IDBKeyRange.bound([topicName, 0, range.low], [topicName, hi, Number.MAX_SAFE_INTEGER], false, true);\n          trx.objectStore('dellog').getAll(key).onsuccess = event => {\n            const entries = event.target.result;\n            if (entries) {\n              if (Array.isArray(entries)) {\n                result = result.concat(entries.map(entry => {\n                  return {\n                    low: entry.low,\n                    hi: entry.hi\n                  };\n                }));\n              } else {\n                result.push({\n                  low: entries.low,\n                  hi: entries.hi\n                });\n              }\n            }\n            count++;\n            if (count == query.ranges.length) {\n              resolve(result);\n            }\n          };\n        });\n      });\n    }\n\n    return new Promise((resolve, reject) => {\n      const since = query.since > 0 ? query.since : 0;\n      const before = query.before > 0 ? query.before : Number.MAX_SAFE_INTEGER;\n      const limit = query.limit | 0;\n\n      trx.onerror = event => {\n        this.#logger('PCache', 'readDelLog', event.target.error);\n        reject(event.target.error);\n      };\n\n      let count = 0;\n      const result = [];\n      const range = IDBKeyRange.bound([topicName, 0, since], [topicName, before, Number.MAX_SAFE_INTEGER], false, true);\n      trx.objectStore('dellog').openCursor(range, 'prev')\n        .onsuccess = event => {\n          const cursor = event.target.result;\n          if (cursor) {\n            result.push({\n              low: cursor.value.low,\n              hi: cursor.value.hi\n            });\n            count += cursor.value.hi - cursor.value.low;\n            if (limit <= 0 || count < limit) {\n              cursor.continue();\n            } else {\n              resolve(result);\n            }\n          } else {\n            resolve(result);\n          }\n        };\n    });\n  }\n\n  /**\n   * Retrieve the latest 'clear' ID for the given topic.\n   * @param {string} topicName\n   * @return {Promise} promise resolved/rejected on operation completion.\n   */\n  maxDelId(topicName) {\n    if (!this.isReady()) {\n      return this.disabled ?\n        Promise.resolve(0) :\n        Promise.reject(new Error(\"not initialized\"));\n    }\n\n    return new Promise((resolve, reject) => {\n      const trx = this.db.transaction(['dellog']);\n      trx.onerror = event => {\n        this.#logger('PCache', 'maxDelId', event.target.error);\n        reject(event.target.error);\n      };\n\n      const index = trx.objectStore('dellog').index('topic_clear');\n      index.openCursor(IDBKeyRange.bound([topicName, 0], [topicName, Number.MAX_SAFE_INTEGER]), 'prev')\n        .onsuccess = event => {\n          if (event.target.result) {\n            resolve(event.target.result.value);\n          }\n        };\n    });\n  }\n\n  // Private methods.\n\n  // Serializable topic fields.\n  static #topic_fields = ['created', 'updated', 'deleted', 'touched', 'read', 'recv', 'seq',\n    'clear', 'mrrid', 'defacs', 'creds', 'public', 'trusted', 'private', '_aux', '_deleted',\n    '_mrrSeen'\n  ];\n\n  // Copy data from src to Topic object.\n  static #deserializeTopic(topic, src) {\n    DB.#topic_fields.forEach((f) => {\n      if (src.hasOwnProperty(f)) {\n        topic[f] = src[f];\n      }\n    });\n    if (Array.isArray(src.tags)) {\n      topic._tags = src.tags;\n    }\n    if (src.acs) {\n      topic.setAccessMode(src.acs);\n    }\n    topic.seq |= 0;\n    topic.read |= 0;\n    topic.unread = Math.max(0, topic.seq - topic.read);\n  }\n\n  // Copy values from 'src' to 'dst'. Allocate dst if it's null or undefined.\n  static #serializeTopic(dst, src) {\n    const res = dst || {\n      name: src.name\n    };\n    DB.#topic_fields.forEach(f => {\n      if (src.hasOwnProperty(f)) {\n        res[f] = src[f];\n      }\n    });\n    if (Array.isArray(src._tags)) {\n      res.tags = src._tags;\n    }\n    if (src.acs) {\n      res.acs = src.getAccessMode().jsonHelper();\n    }\n    return res;\n  }\n\n  static #serializeSubscription(dst, topicName, uid, sub) {\n    const fields = ['updated', 'mode', 'read', 'recv', 'clear', 'lastSeen', 'userAgent'];\n    const res = dst || {\n      topic: topicName,\n      uid: uid\n    };\n\n    fields.forEach((f) => {\n      if (sub.hasOwnProperty(f)) {\n        res[f] = sub[f];\n      }\n    });\n\n    return res;\n  }\n\n  static #serializeMessage(dst, msg) {\n    // Serializable fields.\n    const fields = ['topic', 'seq', 'ts', '_status', 'from', 'head', 'content', 'react'];\n    const res = dst || {};\n    fields.forEach((f) => {\n      if (msg.hasOwnProperty(f)) {\n        res[f] = msg[f];\n      }\n    });\n    return res;\n  }\n\n  /**\n   * To use DB in a non browser context, supply indexedDB provider.\n   * @static\n   * @memberof DB\n   * @param idbProvider indexedDB provider, e.g. for node <code>require('fake-indexeddb')</code>.\n   */\n  static setDatabaseProvider(idbProvider) {\n    IDBProvider = idbProvider;\n  }\n}\n","/**\n * @file Utilities for uploading and downloading files.\n *\n * @copyright 2015-2026 Tinode LLC.\n */\n'use strict';\n\nimport CommError from './comm-error.js';\nimport {\n  isUrlRelative,\n  jsonParseHelper\n} from './utils.js';\n\nlet XHRProvider;\n\nfunction addURLParam(relUrl, key, value) {\n  const url = new URL(relUrl, window.location.origin);\n  url.searchParams.append(key, value);\n  return url.toString().substring(window.location.origin.length);\n}\n\n/**\n * @class LargeFileHelper - utilities for uploading and downloading files out of band.\n * Don't instantiate this class directly. Use {Tinode.getLargeFileHelper} instead.\n * @memberof Tinode\n *\n * @param {Tinode} tinode - the main Tinode object.\n * @param {string} version - protocol version, i.e. '0'.\n */\nexport default class LargeFileHelper {\n  constructor(tinode, version) {\n    this._tinode = tinode;\n    this._version = version;\n\n    this._apiKey = tinode._apiKey;\n    this._authToken = tinode.getAuthToken();\n\n    // Ongoing requests.\n    this.xhr = [];\n  }\n\n  /**\n   * Start uploading the file to an endpoint at baseUrl.\n   *\n   * @memberof Tinode.LargeFileHelper#\n   *\n   * @param {string} baseUrl - base URL of upload server.\n   * @param {File|Blob} data - data to upload.\n   * @param {string} avatarFor - topic name if the upload represents an avatar.\n   * @param {Function} onProgress - callback. Takes one {number} parameter 0..1\n   * @param {Function} onSuccess - callback. Called when the file is successfully uploaded.\n   * @param {Function} onFailure - callback. Called in case of a failure.\n   *\n   * @returns {Promise} resolved/rejected when the upload is completed/failed.\n   */\n  uploadWithBaseUrl(baseUrl, data, avatarFor, onProgress, onSuccess, onFailure) {\n    let url = `/v${this._version}/file/u/`;\n    if (baseUrl) {\n      let base = baseUrl;\n      if (base.endsWith('/')) {\n        // Removing trailing slash.\n        base = base.slice(0, -1);\n      }\n      if (base.startsWith('http://') || base.startsWith('https://')) {\n        url = base + url;\n      } else {\n        throw new Error(`Invalid base URL '${baseUrl}'`);\n      }\n    }\n\n    const instance = this;\n    const xhr = new XHRProvider();\n    this.xhr.push(xhr);\n\n    xhr.open('POST', url, true);\n    xhr.setRequestHeader('X-Tinode-APIKey', this._apiKey);\n    if (this._authToken) {\n      xhr.setRequestHeader('X-Tinode-Auth', `Token ${this._authToken.token}`);\n    }\n\n    let toResolve = null;\n    let toReject = null;\n\n    const result = new Promise((resolve, reject) => {\n      toResolve = resolve;\n      toReject = reject;\n    });\n\n    xhr.upload.onprogress = e => {\n      if (e.lengthComputable) {\n        if (onProgress) {\n          onProgress(e.loaded / e.total);\n        }\n        if (this.onProgress) {\n          this.onProgress(e.loaded / e.total);\n        }\n      }\n    };\n\n    xhr.onload = function() {\n      let pkt;\n      try {\n        pkt = JSON.parse(this.response, jsonParseHelper);\n      } catch (err) {\n        instance._tinode.logger(\"ERROR: Invalid server response in LargeFileHelper\", this.response);\n        pkt = {\n          ctrl: {\n            code: this.status,\n            text: this.statusText\n          }\n        };\n      }\n\n      if (this.status >= 200 && this.status < 300) {\n        if (toResolve) {\n          toResolve(pkt.ctrl.params.url);\n        }\n        if (onSuccess) {\n          onSuccess(pkt.ctrl);\n        }\n      } else if (this.status >= 400) {\n        if (toReject) {\n          toReject(new CommError(pkt.ctrl.text, pkt.ctrl.code));\n        }\n        if (onFailure) {\n          onFailure(pkt.ctrl);\n        }\n      } else {\n        instance._tinode.logger(\"ERROR: Unexpected server response status\", this.status, this.response);\n      }\n    };\n\n    xhr.onerror = function(e) {\n      if (toReject) {\n        toReject(e || new Error(\"failed\"));\n      }\n      if (onFailure) {\n        onFailure(null);\n      }\n    };\n\n    xhr.onabort = function(e) {\n      if (toReject) {\n        toReject(new Error(\"upload cancelled by user\"));\n      }\n      if (onFailure) {\n        onFailure(null);\n      }\n    };\n\n    try {\n      const form = new FormData();\n      form.append('file', data);\n      form.set('id', this._tinode.getNextUniqueId());\n      if (avatarFor) {\n        form.set('topic', avatarFor);\n      }\n      xhr.send(form);\n    } catch (err) {\n      if (toReject) {\n        toReject(err);\n      }\n      if (onFailure) {\n        onFailure(null);\n      }\n    }\n\n    return result;\n  }\n  /**\n   * Start uploading the file to default endpoint.\n   *\n   * @memberof Tinode.LargeFileHelper#\n   *\n   * @param {File|Blob} data - data to upload.\n   * @param {string} avatarFor - topic name if the upload represents an avatar.\n   * @param {Function} onProgress - callback. Takes one {number} parameter 0..1\n   * @param {Function} onSuccess - callback. Called when the file is successfully uploaded.\n   * @param {Function} onFailure - callback. Called in case of a failure.\n   *\n   * @returns {Promise} resolved/rejected when the upload is completed/failed.\n   */\n  upload(data, avatarFor, onProgress, onSuccess, onFailure) {\n    const baseUrl = (this._tinode._secure ? 'https://' : 'http://') + this._tinode._host;\n    return this.uploadWithBaseUrl(baseUrl, data, avatarFor, onProgress, onSuccess, onFailure);\n  }\n  /**\n   * Download the file from a given URL using GET request. This method works with the Tinode server only.\n   *\n   * @memberof Tinode.LargeFileHelper#\n   *\n   * @param {string} relativeUrl - URL to download the file from. Must be relative url, i.e. must not contain the host.\n   * @param {string=} filename - file name to use for the downloaded file.\n   *\n   * @returns {Promise} resolved/rejected when the download is completed/failed.\n   */\n  download(relativeUrl, filename, mimetype, onProgress, onError) {\n    if (!isUrlRelative(relativeUrl)) {\n      // As a security measure refuse to download from an absolute URL.\n      if (onError) {\n        onError(`The URL '${relativeUrl}' must be relative, not absolute`);\n      }\n      return;\n    }\n    if (!this._authToken) {\n      if (onError) {\n        onError(\"Must authenticate first\");\n      }\n      return;\n    }\n    const instance = this;\n\n    const xhr = new XHRProvider();\n    this.xhr.push(xhr);\n\n    // Add '&asatt=1' to URL to request 'Content-Disposition: attachment' response header.\n    relativeUrl = addURLParam(relativeUrl, 'asatt', '1');\n\n    // Get data as blob (stored by the browser as a temporary file).\n    xhr.open('GET', relativeUrl, true);\n    xhr.setRequestHeader('X-Tinode-APIKey', this._apiKey);\n    xhr.setRequestHeader('X-Tinode-Auth', 'Token ' + this._authToken.token);\n    xhr.responseType = 'blob';\n\n    xhr.onprogress = function(e) {\n      if (onProgress) {\n        // Passing e.loaded instead of e.loaded/e.total because e.total\n        // is always 0 with gzip compression enabled by the server.\n        onProgress(e.loaded);\n      }\n    };\n\n    let toResolve = null;\n    let toReject = null;\n\n    const result = new Promise((resolve, reject) => {\n      toResolve = resolve;\n      toReject = reject;\n    });\n\n    // The blob needs to be saved as file. There is no known way to\n    // save the blob as file other than to fake a click on an <a href... download=...>.\n    xhr.onload = function() {\n      if (this.status == 200) {\n        const link = document.createElement('a');\n        // URL.createObjectURL is not available in non-browser environment. This call will fail.\n        link.href = window.URL.createObjectURL(new Blob([this.response], {\n          type: mimetype\n        }));\n        link.style.display = 'none';\n        link.setAttribute('download', filename);\n        document.body.appendChild(link);\n        link.click();\n        document.body.removeChild(link);\n        window.URL.revokeObjectURL(link.href);\n        if (toResolve) {\n          toResolve();\n        }\n      } else if (this.status >= 400 && toReject) {\n        // The this.responseText is undefined, must use this.response which is a blob.\n        // Need to convert this.response to JSON. The blob can only be accessed by the\n        // FileReader.\n        const reader = new FileReader();\n        reader.onload = function() {\n          try {\n            const pkt = JSON.parse(this.result, jsonParseHelper);\n            toReject(new CommError(pkt.ctrl.text, pkt.ctrl.code));\n          } catch (err) {\n            instance._tinode.logger(\"ERROR: Invalid server response in LargeFileHelper\", this.result);\n            toReject(err);\n          }\n        };\n        reader.readAsText(this.response);\n      }\n    };\n\n    xhr.onerror = function(e) {\n      if (toReject) {\n        toReject(new Error(\"failed\"));\n      }\n      if (onError) {\n        onError(e);\n      }\n    };\n\n    xhr.onabort = function() {\n      if (toReject) {\n        toReject(null);\n      }\n    };\n\n    try {\n      xhr.send();\n    } catch (err) {\n      if (toReject) {\n        toReject(err);\n      }\n      if (onError) {\n        onError(err);\n      }\n    }\n\n    return result;\n  }\n  /**\n   * Try to cancel all ongoing uploads or downloads.\n   * @memberof Tinode.LargeFileHelper#\n   */\n  cancel() {\n    this.xhr.forEach(req => {\n      if (req.readyState < 4) {\n        req.abort();\n      }\n    });\n  }\n  /**\n   * To use LargeFileHelper in a non browser context, supply XMLHttpRequest provider.\n   * @static\n   * @memberof LargeFileHelper\n   * @param {Object} xhrProvider - XMLHttpRequest provider, e.g. for node <code>require('xhr')</code>.\n   */\n  static setNetworkProvider(xhrProvider) {\n    XHRProvider = xhrProvider;\n  }\n}\n","/**\n * @file Helper class for constructing {@link Tinode.GetQuery}.\n *\n * @copyright 2015-2023 Tinode LLC.\n */\n'use strict';\n\nimport {\n  listToRanges,\n  normalizeRanges\n} from './utils';\n\n/**\n * Helper class for constructing {@link Tinode.GetQuery}.\n *\n * @class MetaGetBuilder\n * @memberof Tinode\n *\n * @param {Tinode.Topic} parent topic which instantiated this builder.\n */\nexport default class MetaGetBuilder {\n  constructor(parent) {\n    this.topic = parent;\n    this.what = {};\n  }\n\n  // Get timestamp of the most recent desc update.\n  #get_desc_ims() {\n    return this.topic._deleted ? undefined : this.topic.updated;\n  }\n\n  // Get timestamp of the most recent subs update.\n  #get_subs_ims() {\n    if (this.topic.isP2PType()) {\n      return this.#get_desc_ims();\n    }\n    return this.topic._deleted ? undefined : this.topic._lastSubsUpdate;\n  }\n  /**\n   * Add query parameters to fetch messages within explicit limits.\n   * @memberof Tinode.MetaGetBuilder#\n   *\n   * @param {number=} since - messages newer than this (inclusive);\n   * @param {number=} before - older than this (exclusive)\n   * @param {number=} limit - number of messages to fetch\n   * @returns {Tinode.MetaGetBuilder} <code>this</code> object.\n   */\n  withData(since, before, limit) {\n    this.what['data'] = {\n      since: since,\n      before: before,\n      limit: limit\n    };\n    return this;\n  }\n  /**\n   * Add query parameters to fetch messages newer than the latest saved message.\n   * @memberof Tinode.MetaGetBuilder#\n   *\n   * @param {number=} limit - number of messages to fetch\n   *\n   * @returns {Tinode.MetaGetBuilder} <code>this</code> object.\n   */\n  withLaterData(limit) {\n    return this.withData(this.topic._maxSeq > 0 ? this.topic._maxSeq + 1 : undefined, undefined, limit);\n  }\n  /**\n   * Add query parameters to fetch messages within ID ranges.\n   * @memberof Tinode.MetaGetBuilder#\n   *\n   * @param {Array.<SeqRange>} ranges - ranges of seq IDs to fetch.\n   * @param {number=} limit - maximum number of messages to fetch.\n   * @returns {Tinode.MetaGetBuilder} <code>this</code> object.\n   */\n  withDataRanges(ranges, limit) {\n    this.what['data'] = {\n      ranges: normalizeRanges(ranges, this.topic._maxSeq),\n      limit: limit\n    };\n    return this;\n  }\n  /**\n   * Add query parameters to fetch messages by an array of IDs.\n   * @memberof Tinode.MetaGetBuilder#\n   *\n   * @param {number[]} list - array of seq IDs to fetch.\n   * @returns {Tinode.MetaGetBuilder} <code>this</code> object.\n   */\n  withDataList(list) {\n    return this.withDataRanges(listToRanges(list));\n  }\n  /**\n   * Add query parameters to fetch messages older than the earliest saved message.\n   * @memberof Tinode.MetaGetBuilder#\n   *\n   * @param {number=} limit - maximum number of messages to fetch.\n   *\n   * @returns {Tinode.MetaGetBuilder} <code>this</code> object.\n   */\n  withEarlierData(limit) {\n    return this.withData(undefined, this.topic._minSeq > 0 ? this.topic._minSeq : undefined, limit);\n  }\n  /**\n   * Add query parameters to fetch topic description if it's newer than the given timestamp.\n   * @memberof Tinode.MetaGetBuilder#\n   *\n   * @param {Date=} ims - fetch messages newer than this timestamp.\n   *\n   * @returns {Tinode.MetaGetBuilder} <code>this</code> object.\n   */\n  withDesc(ims) {\n    this.what['desc'] = {\n      ims: ims\n    };\n    return this;\n  }\n  /**\n   * Add query parameters to fetch topic description if it's newer than the last update.\n   * @memberof Tinode.MetaGetBuilder#\n   *\n   * @returns {Tinode.MetaGetBuilder} <code>this</code> object.\n   */\n  withLaterDesc() {\n    return this.withDesc(this.#get_desc_ims());\n  }\n  /**\n   * Add query parameters to fetch subscriptions.\n   * @memberof Tinode.MetaGetBuilder#\n   *\n   * @param {Date=} ims - fetch subscriptions modified more recently than this timestamp\n   * @param {number=} limit - maximum number of subscriptions to fetch.\n   * @param {string=} userOrTopic - user ID or topic name to fetch for fetching one subscription.\n   *\n   * @returns {Tinode.MetaGetBuilder} <code>this</code> object.\n   */\n  withSub(ims, limit, userOrTopic) {\n    const opts = {\n      ims: ims,\n      limit: limit\n    };\n    if (this.topic.getType() == 'me') {\n      opts.topic = userOrTopic;\n    } else {\n      opts.user = userOrTopic;\n    }\n    this.what['sub'] = opts;\n    return this;\n  }\n  /**\n   * Add query parameters to fetch a single subscription.\n   * @memberof Tinode.MetaGetBuilder#\n   *\n   * @param {Date=} ims - fetch subscriptions modified more recently than this timestamp\n   * @param {string=} userOrTopic - user ID or topic name to fetch for fetching one subscription.\n   *\n   * @returns {Tinode.MetaGetBuilder} <code>this</code> object.\n   */\n  withOneSub(ims, userOrTopic) {\n    return this.withSub(ims, undefined, userOrTopic);\n  }\n  /**\n   * Add query parameters to fetch a single subscription if it's been updated since the last update.\n   * @memberof Tinode.MetaGetBuilder#\n   *\n   * @param {string=} userOrTopic - user ID or topic name to fetch for fetching one subscription.\n   *\n   * @returns {Tinode.MetaGetBuilder} <code>this</code> object.\n   */\n  withLaterOneSub(userOrTopic) {\n    return this.withOneSub(this.topic._lastSubsUpdate, userOrTopic);\n  }\n  /**\n   * Add query parameters to fetch subscriptions updated since the last update.\n   * @memberof Tinode.MetaGetBuilder#\n   *\n   * @param {number=} limit - maximum number of subscriptions to fetch.\n   *\n   * @returns {Tinode.MetaGetBuilder} <code>this</code> object.\n   */\n  withLaterSub(limit) {\n    return this.withSub(this.#get_subs_ims(), limit);\n  }\n  /**\n   * Add query parameters to fetch topic tags.\n   * @memberof Tinode.MetaGetBuilder#\n   *\n   * @returns {Tinode.MetaGetBuilder} <code>this</code> object.\n   */\n  withTags() {\n    this.what['tags'] = true;\n    return this;\n  }\n  /**\n   * Add query parameters to fetch user's credentials. <code>'me'</code> topic only.\n   * @memberof Tinode.MetaGetBuilder#\n   *\n   * @returns {Tinode.MetaGetBuilder} <code>this</code> object.\n   */\n  withCred() {\n    if (this.topic.getType() == 'me') {\n      this.what['cred'] = true;\n    } else {\n      this.topic._tinode.logger(\"ERROR: Invalid topic type for MetaGetBuilder:withCreds\", this.topic.getType());\n    }\n    return this;\n  }\n  /**\n   * Add query parameters to fetch topic tags.\n   * @memberof Tinode.MetaGetBuilder#\n   *\n   * @returns {Tinode.MetaGetBuilder} <code>this</code> object.\n   */\n  withAux() {\n    this.what['aux'] = true;\n    return this;\n  }\n  /**\n   * Add query parameters to fetch deleted messages within explicit limits. Any/all parameters can be null.\n   * @memberof Tinode.MetaGetBuilder#\n   *\n   * @param {number=} since - ids of messages deleted since this 'del' id (inclusive)\n   * @param {number=} limit - number of deleted message ids to fetch\n   *\n   * @returns {Tinode.MetaGetBuilder} <code>this</code> object.\n   */\n  withDel(since, limit) {\n    if (since || limit) {\n      this.what['del'] = {\n        since: since,\n        limit: limit\n      };\n    }\n    return this;\n  }\n  /**\n   * Add query parameters to fetch messages deleted after the saved <code>'del'</code> id.\n   * @memberof Tinode.MetaGetBuilder#\n   *\n   * @param {number=} limit - number of deleted message ids to fetch\n   *\n   * @returns {Tinode.MetaGetBuilder} <code>this</code> object.\n   */\n  withLaterDel(limit) {\n    // Specify 'since' only if we have already received some messages. If\n    // we have no locally cached messages then we don't care if any messages were deleted.\n    return this.withDel(this.topic._maxSeq > 0 ? this.topic._maxDel + 1 : undefined, limit);\n  }\n\n  /**\n   * Extract subquery: get an object that contains specified subquery.\n   * @memberof Tinode.MetaGetBuilder#\n   * @param {string} what - subquery to return: one of 'data', 'sub', 'desc', 'tags', 'cred', 'del'.\n   * @returns {Object} requested subquery or <code>undefined</code>.\n   */\n  extract(what) {\n    return this.what[what];\n  }\n\n  /**\n   * Construct parameters.\n   * @memberof Tinode.MetaGetBuilder#\n   *\n   * @returns {Tinode.GetQuery} Get query\n   */\n  build() {\n    const what = [];\n    let params = {};\n    ['data', 'sub', 'desc', 'tags', 'cred', 'aux', 'del'].forEach((key) => {\n      if (this.what.hasOwnProperty(key)) {\n        what.push(key);\n        if (Object.getOwnPropertyNames(this.what[key]).length > 0) {\n          params[key] = this.what[key];\n        }\n      }\n    });\n    if (what.length > 0) {\n      params.what = what.join(' ');\n    } else {\n      params = undefined;\n    }\n    return params;\n  }\n}\n","/**\n * @file In-memory sorted cache of objects.\n *\n * @copyright 2015-2025 Tinode LLC.\n */\n'use strict';\n\n/**\n * Callback for iterating contents of buffer. See {@link Tinode.CBuffer#forEach}.\n * @callback Tinode.ForEachCallbackType\n * @param {Object} elem - Current element of the buffer.\n * @param {Object} prev - Previous element of the buffer.\n * @param {Object} next - Next element of the buffer.\n * @param {number} index - Index of the current element.\n */\n\n/**\n * Callback for filtering the buffer. See {@link Tinode.CBuffer#filter}.\n * @callback Tinode.FilterCallbackType\n * @param {Object} elem - Current element of the buffer.\n * @param {number} index - Index of the current element.\n * @returns {boolean} <code>true</code> to keep the element, <code>false</code> to remove.\n */\n\n/**\n * In-memory sorted cache of objects.\n *\n * @class CBuffer\n * @memberof Tinode\n * @protected\n *\n * @param {Function} compare - custom comparator of objects. Takes two parameters <code>a</code> and <code>b</code>;\n *    returns <code>-1</code> if <code>a < b</code>, <code>0</code> if <code>a == b</code>, <code>1</code> otherwise.\n * @param {boolean} unique - enforce element uniqueness: when <code>true</code> replace existing element with a new\n *    one on conflict; when <code>false</code> keep both elements.\n */\nexport default class CBuffer {\n  #comparator = undefined;\n  #unique = false;\n  buffer = [];\n\n  constructor(compare_, unique_) {\n    this.#comparator = compare_ || ((a, b) => {\n      return a === b ? 0 : a < b ? -1 : 1;\n    });\n    this.#unique = unique_;\n  }\n\n  #findNearest(elem, arr, exact) {\n    let start = 0;\n    let end = arr.length - 1;\n    let pivot = 0;\n    let diff = 0;\n    let found = false;\n\n    while (start <= end) {\n      pivot = (start + end) / 2 | 0;\n      diff = this.#comparator(arr[pivot], elem);\n      if (diff < 0) {\n        start = pivot + 1;\n      } else if (diff > 0) {\n        end = pivot - 1;\n      } else {\n        found = true;\n        break;\n      }\n    }\n    if (found) {\n      return {\n        idx: pivot,\n        exact: true\n      };\n    }\n    if (exact) {\n      return {\n        idx: -1\n      };\n    }\n    // Not exact - insertion point\n    return {\n      idx: diff < 0 ? pivot + 1 : pivot\n    };\n  }\n\n  // Insert element into a sorted array.\n  #insertSorted(elem, arr) {\n    const found = this.#findNearest(elem, arr, false);\n    const count = (found.exact && this.#unique) ? 1 : 0;\n    arr.splice(found.idx, count, elem);\n    return arr;\n  }\n\n  /**\n   * Get an element at the given position.\n   * @memberof Tinode.CBuffer#\n   * @param {number} at - Position to fetch from.\n   * @returns {Object} Element at the given position or <code>undefined</code>.\n   */\n  getAt(at) {\n    return this.buffer[at];\n  }\n\n  /**\n   * Convenience method for getting the last element from the buffer.\n   * @memberof Tinode.CBuffer#\n   * @param {function} filter - optional filter to apply to elements. If filter is provided, the search\n   *   for the last element starts from the end of the buffer and goes backwards until the filter returns true.\n   * @returns {Object} The last element in the buffer or <code>undefined</code> if buffer is empty.\n   */\n  getLast(filter) {\n    return filter ?\n      this.buffer.findLast(filter) :\n      this.buffer[this.buffer.length - 1];\n  }\n\n  /**\n   * Insert new element(s) to the buffer at the correct position according to the sort method.\n   * Variadic: takes one or more arguments. If an array is passed as a single argument, its\n   * elements are inserted individually.\n   * @memberof Tinode.CBuffer#\n   *\n   * @param {...Object|Array} - One or more objects to insert.\n   */\n  put() {\n    let insert;\n    // inspect arguments: if array, insert its elements, if one or more non-array arguments, insert them one by one\n    if (arguments.length == 1 && Array.isArray(arguments[0])) {\n      insert = arguments[0];\n    } else {\n      insert = arguments;\n    }\n    for (let idx in insert) {\n      this.#insertSorted(insert[idx], this.buffer);\n    }\n  }\n\n  /**\n   * Remove element at the given position.\n   * @memberof Tinode.CBuffer#\n   * @param {number} at - Position to delete at.\n   * @returns {Object} Element at the given position or <code>undefined</code>.\n   */\n  delAt(at) {\n    at |= 0;\n    let r = this.buffer.splice(at, 1);\n    if (r && r.length > 0) {\n      return r[0];\n    }\n    return undefined;\n  }\n\n  /**\n   * Remove elements between two positions.\n   * @memberof Tinode.CBuffer#\n   * @param {number} since - Position to delete from (inclusive).\n   * @param {number} before - Position to delete to (exclusive).\n   *\n   * @returns {Array} array of removed elements (could be zero length).\n   */\n  delRange(since, before) {\n    return this.buffer.splice(since, before - since);\n  }\n\n  /**\n   * Return the number of elements the buffer holds.\n   * @memberof Tinode.CBuffer#\n   * @return {number} Number of elements in the buffer.\n   */\n  length() {\n    return this.buffer.length;\n  }\n\n  /**\n   * Reset the buffer discarding all elements\n   * @memberof Tinode.CBuffer#\n   */\n  reset() {\n    this.buffer = [];\n  }\n\n  /**\n   * Apply given <code>callback</code> to all elements of the buffer.\n   * @memberof Tinode.CBuffer#\n   *\n   * @param {Tinode.ForEachCallbackType} callback - Function to call for each element.\n   * @param {number} startIdx - Optional index to start iterating from (inclusive), default: 0.\n   * @param {number} beforeIdx - Optional index to stop iterating before (exclusive), default: length of the buffer.\n   * @param {Object} context - calling context (i.e. value of <code>this</code> in callback)\n   */\n  forEach(callback, startIdx, beforeIdx, context) {\n    startIdx = Math.max(0, startIdx | 0);\n    beforeIdx = Math.min(beforeIdx || this.buffer.length, this.buffer.length);\n\n    for (let i = startIdx; i < beforeIdx; i++) {\n      callback.call(context, this.buffer[i],\n        (i > startIdx ? this.buffer[i - 1] : undefined),\n        (i < beforeIdx - 1 ? this.buffer[i + 1] : undefined), i);\n    }\n  }\n\n  /**\n   * Find element in buffer using buffer's comparison function.\n   * @memberof Tinode.CBuffer#\n   *\n   * @param {Object} elem - element to find.\n   * @param {boolean=} nearest - when true and exact match is not found, return the nearest element (insertion point).\n   * @returns {number} index of the element in the buffer or -1.\n   */\n  find(elem, nearest) {\n    const {\n      idx\n    } = this.#findNearest(elem, this.buffer, !nearest);\n    return idx;\n  }\n\n  /**\n   * Remove all elements that do not pass the test implemented by the provided callback function.\n   * @memberof Tinode.CBuffer#\n   *\n   * @param {Tinode.FilterCallbackType} callback - Function to call for each element.\n   * @param {Object} context - calling context (i.e. value of <code>this</code> in the callback)\n   */\n  filter(callback, context) {\n    let count = 0;\n    for (let i = 0; i < this.buffer.length; i++) {\n      if (callback.call(context, this.buffer[i], i)) {\n        this.buffer[count] = this.buffer[i];\n        count++;\n      }\n    }\n\n    this.buffer.splice(count);\n  }\n\n  /**\n   * Check if buffer is empty.\n   * @returns {boolean} <code>true</code> if the buffer is empty, <code>false</code> otherwise.\n   */\n  isEmpty() {\n    return this.buffer.length == 0;\n  }\n}\n","/**\n * @file Topic management.\n *\n * @copyright 2015-2026 Tinode LLC.\n */\n'use strict';\n\nimport AccessMode from './access-mode.js';\nimport CBuffer from './cbuffer.js';\nimport CommError from './comm-error.js';\nimport * as Const from './config.js';\nimport Drafty from './drafty.js';\nimport MetaGetBuilder from './meta-builder.js';\nimport {\n  listToRanges,\n  mergeObj,\n  mergeToCache,\n  normalizeArray,\n  normalizeRanges\n} from './utils.js';\n\n/**\n * Topic is a class representing a logical communication channel.\n */\nexport default class Topic {\n  /**\n   * Create topic.\n   * @param {string} name - Name of the topic to create.\n   * @param {Object=} callbacks - Object with various event callbacks.\n   * @param {Function} callbacks.onData - Callback which receives a <code>{data}</code> message.\n   * @param {Function} callbacks.onMeta - Callback which receives a <code>{meta}</code> message.\n   * @param {Function} callbacks.onPres - Callback which receives a <code>{pres}</code> message.\n   * @param {Function} callbacks.onInfo - Callback which receives an <code>{info}</code> message.\n   * @param {Function} callbacks.onMetaDesc - Callback which receives changes to topic desctioption {@link desc}.\n   * @param {Function} callbacks.onMetaSub - Called for a single subscription record change.\n   * @param {Function} callbacks.onSubsUpdated - Called after a batch of subscription changes have been recieved and cached.\n   * @param {Function} callbacks.onDeleteTopic - Called after the topic is deleted.\n   * @param {Function} callbacks.onTagsUpdated - Called after user discovery tags are updated.\n   * @param {Function} callbacks.onCredsUpdated - Called after credentials are updated.\n   * @param {Function} callbacks.onAuxUpdated - Called after auxiliary data is updated.\n   * @param {Function} callbacks.onReact - Called after message reactions are updated.\n   * @param {Function} callbacks.onAllMessagesReceived - Called when all requested <code>{data}</code> messages have been recived.\n   */\n  constructor(name, callbacks) {\n    // Parent Tinode object.\n    this._tinode = null;\n\n    // Server-provided data, locally immutable.\n    // topic name\n    this.name = name;\n    // Timestamp when the topic was created.\n    this.created = null;\n    // Timestamp when the topic was last updated.\n    this.updated = null;\n    // Timestamp of the last messages\n    this.touched = new Date(0);\n    // Access mode, see AccessMode\n    this.acs = new AccessMode(null);\n    // Per-topic private data (accessible by current user only).\n    this.private = null;\n    // Per-topic public data (accessible by all users).\n    this.public = null;\n    // Per-topic system-provided data (accessible by all users).\n    this.trusted = null;\n    // Last known messge sequence number.\n    this.seq = 0;\n    // Last known read message ID.\n    this.read = 0;\n    // Last known received message ID.\n    this.recv = 0;\n    // Last known deleted message ID.\n    this.clear = 0;\n    // Last known reaction ID.\n    this.mrrid = 0;\n\n    // Locally cached data\n    // Subscribed users, for tracking read/recv/msg notifications.\n    this._users = {};\n\n    // Current value of locally issued seqId, used for pending messages.\n    this._queuedSeqId = Const.LOCAL_SEQID;\n\n    // The maximum known {data.seq} value.\n    this._maxSeq = 0;\n    // The minimum known {data.seq} value.\n    this._minSeq = 0;\n    // Indicator that the last request for earlier messages returned 0.\n    this._noEarlierMsgs = false;\n    // The maximum known deletion ID.\n    this._maxDel = 0;\n    // The maximum seen reaction ID, same logic as read.\n    this._mrrSeen = 0;\n    // Timer object used to send 'recv' notifications.\n    this._recvNotificationTimer = null;\n\n    // User discovery tags\n    this._tags = [];\n    // Credentials such as email or phone number.\n    this._credentials = [];\n    // Auxiliary data\n    this._aux = {};\n\n    // Message versions cache (e.g. for edited messages).\n    // Keys: original message seq ID.\n    // Values: CBuffers containing newer versions of the original message\n    // ordered by seq id.\n    this._messageVersions = {};\n    // Message cache, sorted by message seq values, from old to new.\n    this._messages = new CBuffer((a, b) => {\n      return a.seq - b.seq;\n    }, true);\n    // Boolean, true if the topic is currently live\n    this._attached = false;\n    // Timestap of the most recently updated subscription.\n    this._lastSubsUpdate = new Date(0);\n    // Topic created but not yet synced with the server. Used only during initialization.\n    this._new = true;\n    // The topic is deleted at the server, this is a local copy.\n    this._deleted = false;\n\n    // Timer used to trigger {leave} request after a delay.\n    this._delayedLeaveTimer = null;\n\n    // Callbacks\n    if (callbacks) {\n      this.onData = callbacks.onData;\n      this.onMeta = callbacks.onMeta;\n      this.onPres = callbacks.onPres;\n      this.onInfo = callbacks.onInfo;\n      // A single desc update;\n      this.onMetaDesc = callbacks.onMetaDesc;\n      // A single subscription record;\n      this.onMetaSub = callbacks.onMetaSub;\n      // All subscription records received;\n      this.onSubsUpdated = callbacks.onSubsUpdated;\n      this.onTagsUpdated = callbacks.onTagsUpdated;\n      this.onCredsUpdated = callbacks.onCredsUpdated;\n      this.onAuxUpdated = callbacks.onAuxUpdated;\n      this.onReact = callbacks.onReact;\n      this.onDeleteTopic = callbacks.onDeleteTopic;\n      this.onAllMessagesReceived = callbacks.onAllMessagesReceived;\n    }\n  }\n\n  // Static methods.\n\n  /**\n   * Determine topic type from topic's name: grp, p2p, me, fnd, sys.\n   *\n   * @param {string} name - Name of the topic to test.\n   * @returns {string} One of <code>\"me\"</code>, <code>\"fnd\"</code>, <code>\"sys\"</code>, <code>\"grp\"</code>,\n   *    <code>\"p2p\"</code> or <code>undefined</code>.\n   */\n  static topicType(name) {\n    const types = {\n      'me': Const.TOPIC_ME,\n      'fnd': Const.TOPIC_FND,\n      'grp': Const.TOPIC_GRP,\n      'new': Const.TOPIC_GRP,\n      'nch': Const.TOPIC_GRP,\n      'chn': Const.TOPIC_GRP,\n      'usr': Const.TOPIC_P2P,\n      'sys': Const.TOPIC_SYS,\n      'slf': Const.TOPIC_SLF\n    };\n    return types[(typeof name == 'string') ? name.substring(0, 3) : 'xxx'];\n  }\n\n  /**\n   * Check if the given topic name is a name of a 'me' topic.\n   *\n   * @param {string} name - Name of the topic to test.\n   * @returns {boolean} <code>true</code> if the name is a name of a 'me' topic, <code>false</code> otherwise.\n   */\n  static isMeTopicName(name) {\n    return Topic.topicType(name) == Const.TOPIC_ME;\n  }\n\n  /**\n   * Check if the given topic name is a name of a 'slf' topic.\n   *\n   * @param {string} name - Name of the topic to test.\n   * @returns {boolean} <code>true</code> if the name is a name of a 'slf' topic, <code>false</code> otherwise.\n   */\n  static isSelfTopicName(name) {\n    return Topic.topicType(name) == Const.TOPIC_SLF;\n  }\n\n  /**\n   * Check if the given topic name is a name of a group topic.\n   * @static\n   *\n   * @param {string} name - Name of the topic to test.\n   * @returns {boolean} <code>true</code> if the name is a name of a group topic, <code>false</code> otherwise.\n   */\n  static isGroupTopicName(name) {\n    return Topic.topicType(name) == Const.TOPIC_GRP;\n  }\n\n  /**\n   * Check if the given topic name is a name of a p2p topic.\n   * @static\n   *\n   * @param {string} name - Name of the topic to test.\n   * @returns {boolean} <code>true</code> if the name is a name of a p2p topic, <code>false</code> otherwise.\n   */\n  static isP2PTopicName(name) {\n    return Topic.topicType(name) == Const.TOPIC_P2P;\n  }\n\n  /**\n   * Check if the given topic name is a name of a communication topic, i.e. P2P or group.\n   * @static\n   *\n   * @param {string} name - Name of the topic to test.\n   * @returns {boolean} <code>true</code> if the name is a name of a p2p or group topic, <code>false</code> otherwise.\n   */\n  static isCommTopicName(name) {\n    return Topic.isP2PTopicName(name) || Topic.isGroupTopicName(name) || Topic.isSelfTopicName(name);\n  }\n\n  /**\n   * Check if the topic name is a name of a new topic.\n   * @static\n   *\n   * @param {string} name - topic name to check.\n   * @returns {boolean} <code>true</code> if the name is a name of a new topic, <code>false</code> otherwise.\n   */\n  static isNewGroupTopicName(name) {\n    return (typeof name == 'string') &&\n      (name.substring(0, 3) == Const.TOPIC_NEW || name.substring(0, 3) == Const.TOPIC_NEW_CHAN);\n  }\n\n  /**\n   * Check if the topic name is a name of a channel.\n   * @static\n   *\n   * @param {string} name - topic name to check.\n   * @returns {boolean} <code>true</code> if the name is a name of a channel, <code>false</code> otherwise.\n   */\n  static isChannelTopicName(name) {\n    return (typeof name == 'string') &&\n      (name.substring(0, 3) == Const.TOPIC_CHAN || name.substring(0, 3) == Const.TOPIC_NEW_CHAN);\n  }\n\n  // Returns true if pub is meant to replace another message (e.g. original message was edited).\n  static #isReplacementMsg(pub) {\n    return pub.head && pub.head.replace;\n  }\n\n  /**\n   * Check if the topic is subscribed.\n   * @returns {boolean} True is topic is attached/subscribed, false otherwise.\n   */\n  isSubscribed() {\n    return this._attached;\n  }\n\n  /**\n   * Request topic to subscribe. Wrapper for {@link Tinode#subscribe}.\n   *\n   * @param {Tinode.GetQuery=} getParams - get query parameters.\n   * @param {Tinode.SetParams=} setParams - set parameters.\n   * @returns {Promise} Promise to be resolved/rejected when the server responds to the request.\n   */\n  subscribe(getParams, setParams) {\n    // Clear request to leave topic.\n    clearTimeout(this._delayedLeaveTimer);\n    this._delayedLeaveTimer = null;\n\n    // If the topic is already subscribed, return resolved promise\n    if (this._attached) {\n      return Promise.resolve(this);\n    }\n\n    // Send subscribe message, handle async response.\n    // If topic name is explicitly provided, use it. If no name, then it's a new group topic,\n    // use \"new\".\n    return this._tinode.subscribe(this.name || Const.TOPIC_NEW, getParams, setParams).then(ctrl => {\n      if (ctrl.code >= 300) {\n        // Do nothing if subscription status has not changed.\n        return ctrl;\n      }\n\n      this._attached = true;\n      this._deleted = false;\n      this.acs = (ctrl.params && ctrl.params.acs) ? ctrl.params.acs : this.acs;\n\n      // Set topic name for new topics and add it to cache.\n      if (this._new) {\n        delete this._new;\n\n        if (this.name != ctrl.topic) {\n          // Name may change new123456 -> grpAbCdEf. Remove from cache under the old name.\n          this._cacheDelSelf();\n          this.name = ctrl.topic;\n        }\n        this._cachePutSelf();\n\n        this.created = ctrl.ts;\n        this.updated = ctrl.ts;\n\n        if (this.name != Const.TOPIC_ME && this.name != Const.TOPIC_FND) {\n          // Add the new topic to the list of contacts maintained by the 'me' topic.\n          const me = this._tinode.getMeTopic();\n          if (me.onMetaSub) {\n            me.onMetaSub(this);\n          }\n          if (me.onSubsUpdated) {\n            me.onSubsUpdated([this.name], 1);\n          }\n        }\n\n        if (setParams && setParams.desc) {\n          setParams.desc._noForwarding = true;\n          this._processMetaDesc(setParams.desc);\n        }\n      }\n      return ctrl;\n    });\n  }\n\n  /**\n   * Create a draft of a message without sending it to the server.\n   * @memberof Tinode.Topic#\n   *\n   * @param {string | Object} data - Content to wrap in a draft.\n   * @param {boolean=} noEcho - If <code>true</code> server will not echo message back to originating\n   * session. Otherwise the server will send a copy of the message to sender.\n   *\n   * @returns {Object} message draft.\n   */\n  createMessage(data, noEcho) {\n    return this._tinode.createMessage(this.name, data, noEcho);\n  }\n\n  /**\n   * Immediately publish data to topic. Wrapper for {@link Tinode#publish}.\n   * @memberof Tinode.Topic#\n   *\n   * @param {string | Object} data - Message to publish, either plain string or a Drafty object.\n   * @param {boolean=} noEcho - If <code>true</code> server will not echo message back to originating\n   * @returns {Promise} Promise to be resolved/rejected when the server responds to the request.\n   */\n  publish(data, noEcho) {\n    return this.publishMessage(this.createMessage(data, noEcho));\n  }\n\n  /**\n   * Publish message created by {@link Tinode.Topic#createMessage}.\n   * @memberof Tinode.Topic#\n   *\n   * @param {Object} pub - {data} object to publish. Must be created by {@link Tinode.Topic#createMessage}\n   *\n   * @returns {Promise} Promise to be resolved/rejected when the server responds to the request.\n   */\n  publishMessage(pub) {\n    if (!this._attached) {\n      return Promise.reject(new Error(\"Cannot publish on inactive topic\"));\n    }\n    if (this._sending) {\n      return Promise.reject(new Error(\"The message is already being sent\"));\n    }\n\n    // Send data.\n    pub._sending = true;\n    pub._failed = false;\n\n    // Extract refereces to attachments and out of band image records.\n    let attachments = null;\n    if (Drafty.hasEntities(pub.content)) {\n      attachments = [];\n      Drafty.entities(pub.content, data => {\n        if (data) {\n          if (data.ref) {\n            attachments.push(data.ref);\n          }\n          if (data.preref) {\n            attachments.push(data.preref);\n          }\n        }\n      });\n      if (attachments.length == 0) {\n        attachments = null;\n      }\n    }\n\n    return this._tinode.publishMessage(pub, attachments).then(ctrl => {\n      pub._sending = false;\n      pub.ts = ctrl.ts;\n      this.swapMessageId(pub, ctrl.params.seq);\n      this._maybeUpdateMessageVersionsCache(pub);\n      this._routeData(pub);\n      return ctrl;\n    }).catch(err => {\n      this._tinode.logger(\"WARNING: Message rejected by the server\", err);\n      pub._sending = false;\n      pub._failed = true;\n      if (this.onData) {\n        this.onData();\n      }\n    });\n  }\n\n  /**\n   * Add message to local message cache, send to the server when the promise is resolved.\n   * If promise is null or undefined, the message will be sent immediately.\n   * The message is sent when the\n   * The message should be created by {@link Tinode.Topic#createMessage}.\n   * This is probably not the final API.\n   * @memberof Tinode.Topic#\n   *\n   * @param {Object} pub - Message to use as a draft.\n   * @param {Promise} prom - Message will be sent when this promise is resolved, discarded if rejected.\n   *\n   * @returns {Promise} derived promise.\n   */\n  publishDraft(pub, prom) {\n    const seq = pub.seq || this._getQueuedSeqId();\n    if (!pub._noForwarding) {\n      // The 'seq', 'ts', and 'from' are added to mimic {data}. They are removed later\n      // before the message is sent.\n      pub._noForwarding = true;\n      pub.seq = seq;\n      pub.ts = new Date();\n      pub.from = this._tinode.getCurrentUserID();\n\n      // Don't need an echo message because the message is added to local cache right away.\n      pub.noecho = true;\n      // Add to cache.\n      this._messages.put(pub);\n      this._tinode._db.addMessage(pub);\n\n      if (this.onData) {\n        this.onData(pub);\n      }\n    }\n    // If promise is provided, send the queued message when it's resolved.\n    // If no promise is provided, create a resolved one and send immediately.\n    return (prom || Promise.resolve())\n      .then(_ => {\n        if (pub._cancelled) {\n          return {\n            code: 300,\n            text: \"cancelled\"\n          };\n        }\n        return this.publishMessage(pub);\n      }).catch(err => {\n        this._tinode.logger(\"WARNING: Message draft rejected\", err);\n        pub._sending = false;\n        pub._failed = true;\n        pub._fatal = err instanceof CommError ? (err.code >= 400 && err.code < 500) : false;\n        if (this.onData) {\n          this.onData();\n        }\n        // Rethrow to let caller know that the operation failed.\n        throw err;\n      });\n  }\n\n  /**\n   * Leave the topic, optionally unsibscribe. Leaving the topic means the topic will stop\n   * receiving updates from the server. Unsubscribing will terminate user's relationship with the topic.\n   * Wrapper for {@link Tinode#leave}.\n   * @memberof Tinode.Topic#\n   *\n   * @param {boolean=} unsub - If true, unsubscribe, otherwise just leave.\n   * @returns {Promise} Promise to be resolved/rejected when the server responds to the request.\n   */\n  leave(unsub) {\n    // It's possible to unsubscribe (unsub==true) from inactive topic.\n    if (!this._attached && !unsub) {\n      return Promise.reject(new Error(\"Cannot leave inactive topic\"));\n    }\n\n    // Send a 'leave' message, handle async response\n    return this._tinode.leave(this.name, unsub).then(ctrl => {\n      this._resetSub();\n      if (unsub) {\n        this._gone();\n      }\n      return ctrl;\n    });\n  }\n\n  /**\n   * Leave the topic, optionally unsibscribe after a delay. Leaving the topic means the topic will stop\n   * receiving updates from the server. Unsubscribing will terminate user's relationship with the topic.\n   * Wrapper for {@link Tinode#leave}.\n   * @memberof Tinode.Topic#\n   *\n   * @param {boolean} unsub - If true, unsubscribe, otherwise just leave.\n   * @param {number} delay - time in milliseconds to delay leave request.\n   */\n  leaveDelayed(unsub, delay) {\n    clearTimeout(this._delayedLeaveTimer);\n    this._delayedLeaveTimer = setTimeout(_ => {\n      this._delayedLeaveTimer = null;\n      this.leave(unsub)\n    }, delay);\n  }\n\n  /**\n   * Request topic metadata from the local cache or from the server.\n   * @memberof Tinode.Topic#\n   *\n   * @param {Tinode.GetQuery} params - request parameters\n   *\n   * @returns {Promise} Promise to be resolved/rejected when the server responds to request.\n   */\n  getMeta(params) {\n    // Send {get} message, return promise.\n    return this._tinode.getMeta(this.name, params);\n  }\n\n  /**\n   * Request more messages from the server. The goal is to load continous range of messages\n   * covering at least between 'min' and 'max' + one full page forward (newer = true) or backwards\n   * (newer=false).\n   * @memberof Tinode.Topic#\n   *\n   * @param {number} limit - number of messages to get.\n   * @param {Array.<Range>} gaps - ranges of messages to load.\n   * @param {number} min - if non-negative, request newer messages with seq >= min.\n   * @param {number} max - if positive, request older messages with seq < max.\n   * @param {boolean} newer - if true, fetch newer messages; if false, fetch older messages.\n   * @returns {Promise} Promise to be resolved/rejected when the server responds to request.\n   */\n  getMessagesPage(limit, gaps, min, max, newer) {\n    let query = gaps ?\n      this.startMetaQuery().withDataRanges(gaps, limit) :\n      newer ?\n      this.startMetaQuery().withData(min, undefined, limit) :\n      this.startMetaQuery().withData(undefined, max, limit);\n    // First try fetching from DB, then from the server.\n    return this._loadMessages(this._tinode._db, query.extract('data'))\n      .then(count => {\n        // Recalculate missing ranges.\n        gaps = this.msgHasMoreMessages(min, max, newer);\n        if (gaps.length == 0) {\n          // All messages loaded.\n          return Promise.resolve({\n            topic: this.name,\n            code: 200,\n            params: {\n              count: count\n            }\n          });\n        }\n\n        // Reduce the count of requested messages.\n        limit -= count;\n        // Update query with new values loaded from DB.\n        query = this.startMetaQuery().withDataRanges(gaps, limit);\n        return this.getMeta(query.build());\n      });\n  }\n\n  /**\n   * Request to get pinned messages from the local cache or from the server.\n   * @memberof Tinode.Topic#\n   * @returns {Promise} Promise to be resolved/rejected when the server responds to request.\n   */\n  getPinnedMessages() {\n    const pins = this.aux('pins');\n    if (!Array.isArray(pins)) {\n      return Promise.resolve(0);\n    }\n\n    const loaded = [];\n    let remains = pins;\n    // First try fetching from DB, then check deleted log, then ask the server.\n    return this._tinode._db.readMessages(this.name, {\n        ranges: listToRanges(remains)\n      })\n      .then(msgs => {\n        msgs.forEach(data => {\n          // The 'data' could be undefined.\n          if (data) {\n            loaded.push(data.seq);\n            this._messages.put(data);\n            this._maybeUpdateMessageVersionsCache(data);\n          }\n        });\n        if (loaded.length < pins.length) {\n          // Some messages are missing, try dellog.\n          remains = pins.filter(seq => !loaded.includes(seq));\n          return this._tinode._db.readMessages(this.name, {\n            ranges: listToRanges(remains)\n          });\n        }\n        return null;\n      })\n      .then(ranges => {\n        if (ranges) {\n          // Found some deleted ranges in dellog.\n          remains.forEach(seq => {\n            if (ranges.find(r => r.low <= seq && r.hi > seq)) {\n              loaded.push(seq);\n            }\n          });\n        }\n        if (loaded.length == pins.length) {\n          // Got all pinned messages from the local cache.\n          return Promise.resolve({\n            topic: this.name,\n            code: 200,\n            params: {\n              count: loaded.length\n            }\n          });\n        }\n\n        remains = pins.filter(seq => !loaded.includes(seq));\n        return this.getMeta(this.startMetaQuery().withDataList(remains).build());\n      });\n  }\n\n  /**\n   * Update topic metadata.\n   * @memberof Tinode.Topic#\n   *\n   * @param {Tinode.SetParams} params - parameters to update.\n   * @returns {Promise} Promise to be resolved/rejected when the server responds to request.\n   */\n  setMeta(params) {\n    if (params.tags) {\n      params.tags = normalizeArray(params.tags);\n    }\n    // Send Set message, handle async response.\n    return this._tinode.setMeta(this.name, params)\n      .then(ctrl => {\n        if (ctrl && ctrl.code >= 300) {\n          // Not modified\n          return ctrl;\n        }\n\n        if (params.sub) {\n          params.sub.topic = this.name;\n          if (ctrl.params && ctrl.params.acs) {\n            params.sub.acs = ctrl.params.acs;\n            params.sub.updated = ctrl.ts;\n          }\n          if (!params.sub.user) {\n            // This is a subscription update of the current user.\n            // Assign user ID otherwise the update will be ignored by _processMetaSubs.\n            params.sub.user = this._tinode.getCurrentUserID();\n            if (!params.desc) {\n              // Force update to topic's asc.\n              params.desc = {};\n            }\n          }\n          params.sub._noForwarding = true;\n          this._processMetaSubs([params.sub]);\n        }\n\n        if (params.desc) {\n          if (ctrl.params && ctrl.params.acs) {\n            params.desc.acs = ctrl.params.acs;\n            params.desc.updated = ctrl.ts;\n          }\n          this._processMetaDesc(params.desc);\n        }\n\n        if (params.tags) {\n          this._processMetaTags(params.tags);\n        }\n        if (params.cred) {\n          this._processMetaCreds([params.cred], true);\n        }\n        if (params.aux) {\n          this._processMetaAux(params.aux);\n        }\n        if (params.react) {\n          params.react.mrrid = ctrl.params?.mrrid | 0;\n          this._processMetaReact(undefined, params.react);\n        }\n\n        return ctrl;\n      });\n  }\n  /**\n   * Update access mode of the current user or of another topic subscriber.\n   * @memberof Tinode.Topic#\n   *\n   * @param {string} uid - UID of the user to update or null to update current user.\n   * @param {string} update - the update value, full or delta.\n   * @returns {Promise} Promise to be resolved/rejected when the server responds to request.\n   */\n  updateMode(uid, update) {\n    const user = uid ? this.subscriber(uid) : null;\n    const am = user ?\n      user.acs.updateGiven(update).getGiven() :\n      this.getAccessMode().updateWant(update).getWant();\n\n    return this.setMeta({\n      sub: {\n        user: uid,\n        mode: am\n      }\n    });\n  }\n  /**\n   * Create new topic subscription. Wrapper for {@link Tinode#setMeta}.\n   * @memberof Tinode.Topic#\n   *\n   * @param {string} uid - ID of the user to invite\n   * @param {string=} mode - Access mode. <code>null</code> means to use default.\n   *\n   * @returns {Promise} Promise to be resolved/rejected when the server responds to request.\n   */\n  invite(uid, mode) {\n    return this.setMeta({\n      sub: {\n        user: uid,\n        mode: mode\n      }\n    });\n  }\n  /**\n   * Archive or un-archive the topic. Wrapper for {@link Tinode#setMeta}.\n   * @memberof Tinode.Topic#\n   *\n   * @param {boolean} arch - true to archive the topic, false otherwise.\n   *\n   * @returns {Promise} Promise to be resolved/rejected when the server responds to request.\n   */\n  archive(arch) {\n    if (this.private && (!this.private.arch == !arch)) {\n      return Promise.resolve(arch);\n    }\n    return this.setMeta({\n      desc: {\n        private: {\n          arch: arch ? true : Const.DEL_CHAR\n        }\n      }\n    });\n  }\n  /**\n   * Set message as pinned or unpinned by adding it to aux.pins array. Wrapper for {@link Tinode#setMeta}.\n   * @memberof Tinode.Topic#\n   *\n   * @param {number} seq - seq ID of the message to pin or un-pin.\n   * @param {boolean} pin - true to pin the message, false to un-pin.\n   *\n   * @returns {Promise} Promise to be resolved/rejected when the server responds to request.\n   */\n  pinMessage(seq, pin) {\n    let pinned = this.aux('pins');\n    if (!Array.isArray(pinned)) {\n      pinned = [];\n    }\n    let changed = false;\n    if (pin) {\n      if (!pinned.includes(seq)) {\n        changed = true;\n        if (pinned.length == Const.MAX_PINNED_COUNT) {\n          pinned.shift();\n        }\n        pinned.push(seq);\n      }\n    } else {\n      if (pinned.includes(seq)) {\n        changed = true;\n        pinned = pinned.filter(id => id != seq);\n        if (pinned.length == 0) {\n          pinned = Const.DEL_CHAR;\n        }\n      }\n    }\n    if (changed) {\n      return this.setMeta({\n        aux: {\n          pins: pinned\n        }\n      });\n    }\n    return Promise.resolve();\n  }\n\n  /**\n   * Pin topic to the top of the contact list.\n   * @memberof Tinode.Topic#\n   *\n   * @param {string} topic - Name of the topic to pin.\n   * @param {boolean} [pin=false] - If true, pin the topic, otherwise unpin.\n   *\n   * @returns {Promise} Promise to be resolved/rejected when the server responds to request.\n   */\n  pinTopic(topic, pin) {\n    // Unsupported operation for non-me topics.\n    return Promise.reject(new Error(\"Pinning topics is not supported here\"));\n  }\n\n  /**\n   * Get the rank of the pinned topic.\n   * @memberof Tinode.Topic#\n   * @param {string} topic - Name of the topic to check.\n   *\n   * @returns {number} numeric rank of the pinned topic in the range 1..N (N being the top,\n   *      N - the number of pinned topics) or 0 if not pinned.\n   */\n  pinnedTopicRank(topic) {\n    // Unsupported for non-me topics.\n    return 0;\n  }\n\n  /**\n   * Send or remove a reaction for a message in this topic.\n   * If the same reaction from the current user is already present, remove it.\n   *\n   * @param {int} seq - ID of the message to react to.\n   * @param {string} emo - Emoji string to add as reaction, or Tinode.DEL_CHAR to remove reaction.\n   */\n  react(seq, emo) {\n    if (!seq || !emo) {\n      return Promise.reject(new Error(\"Invalid parameters\"));\n    }\n    const curr = this.msgMyReaction(seq);\n    if (curr == emo) {\n      // Treat the same value as toggle.\n      emo = Const.DEL_CHAR;\n    }\n    this.setMeta({\n      react: {\n        seq: seq,\n        val: emo\n      }\n    });\n  }\n\n  /**\n   * Get a list of allowed reactions for this topic.\n   * @memberof Tinode.Topic#\n   *\n   * @returns {Array.<string>} Array of allowed reaction strings.\n   */\n  reactions() {\n    const react = this.aux('react');\n    if (react) {\n      return react.vals;\n    }\n    return this._tinode.getServerParam(Const.REACTION_LIST);\n  }\n\n  /**\n   * Get maximum number of allowed reaction types per message for this topic.\n   * @memberof Tinode.Topic#\n   *\n   * @returns {number} maxumum number of allowed reaction types per message.\n   */\n  maxReactions() {\n    const react = this.aux('react');\n    if (react) {\n      return react.max;\n    }\n    return this._tinode.getServerParam(Const.MAX_REACTIONS, 0);\n  }\n\n  /**\n   * Mark all known reactions as seen.\n   * @memberof Tinode.Topic#\n   */\n  markReactionsSeen() {\n    if (this._mrrSeen != this.mrrid) {\n      this._mrrSeen = this.mrrid;\n      // Sent a notification to 'me' listeners.\n      this._tinode.getMeTopic()._refreshContact('react', this);\n    }\n  }\n\n  /**\n   * Delete messages. Hard-deleting messages requires Deleter (D) permission.\n   * Wrapper for {@link Tinode#delMessages}.\n   * @memberof Tinode.Topic#\n   *\n   * @param {Array.<Tinode.SeqRange>} ranges - Ranges of message IDs to delete.\n   * @param {boolean=} hard - Hard or soft delete\n   * @returns {Promise} Promise to be resolved/rejected when the server responds to request.\n   */\n  delMessages(ranges, hard) {\n    if (!this._attached) {\n      return Promise.reject(new Error(\"Cannot delete messages in inactive topic\"));\n    }\n\n    const tosend = normalizeRanges(ranges, this._maxSeq)\n\n    // Send {del} message, return promise\n    let result;\n    if (tosend.length > 0) {\n      result = this._tinode.delMessages(this.name, tosend, hard);\n    } else {\n      result = Promise.resolve({\n        params: {\n          del: 0\n        }\n      });\n    }\n    // Update local cache.\n    return result.then(ctrl => {\n      if (ctrl.params.del > this._maxDel) {\n        this._maxDel = Math.max(ctrl.params.del, this._maxDel);\n        this.clear = Math.max(ctrl.params.del, this.clear);\n      }\n\n      ranges.forEach(rec => {\n        if (rec.hi) {\n          this.flushMessageRange(rec.low, rec.hi);\n        } else {\n          this.flushMessage(rec.low);\n        }\n        this._messages.put({\n          seq: rec.low,\n          low: rec.low,\n          hi: rec.hi,\n          _deleted: true\n        });\n      });\n\n      // Make a record.\n      this._tinode._db.addDelLog(this.name, ctrl.params.del, ranges);\n\n      if (this.onData) {\n        // Calling with no parameters to indicate the messages were deleted.\n        this.onData();\n      }\n      return ctrl;\n    });\n  }\n  /**\n   * Delete all messages. Hard-deleting messages requires Deleter permission.\n   * @memberof Tinode.Topic#\n   *\n   * @param {boolean} hardDel - true if messages should be hard-deleted.\n   *\n   * @returns {Promise} Promise to be resolved/rejected when the server responds to request.\n   */\n  delMessagesAll(hardDel) {\n    if (!this._maxSeq || this._maxSeq <= 0) {\n      // There are no messages to delete.\n      return Promise.resolve();\n    }\n    return this.delMessages([{\n      low: 1,\n      hi: this._maxSeq + 1,\n      _all: true\n    }], hardDel);\n  }\n\n  /**\n   * Delete multiple messages defined by their IDs. Hard-deleting messages requires Deleter permission.\n   * @memberof Tinode.Topic#\n   *\n   * @param {Array.<number>} list - list of seq IDs to delete.\n   * @param {boolean=} hardDel - true if messages should be hard-deleted.\n   *\n   * @returns {Promise} Promise to be resolved/rejected when the server responds to request.\n   */\n  delMessagesList(list, hardDel) {\n    // Send {del} message, return promise\n    return this.delMessages(listToRanges(list), hardDel);\n  }\n\n  /**\n   * Delete original message and edited variants. Hard-deleting messages requires Deleter permission.\n   * @memberof Tinode.Topic#\n   *\n   * @param {number} seq - original seq ID of the message to delete.\n   * @param {boolean=} hardDel - true if messages should be hard-deleted.\n   *\n   * @returns {Promise} Promise to be resolved/rejected when the server responds to the request.\n   */\n  delMessagesEdits(seq, hardDel) {\n    const list = [seq];\n    this.messageVersions(seq, msg => list.push(msg.seq));\n    // Send {del} message, return promise\n    return this.delMessagesList(list, hardDel);\n  }\n\n  /**\n   * Delete topic. Requires Owner permission. Wrapper for {@link Tinode#delTopic}.\n   * @memberof Tinode.Topic#\n   *\n   * @param {boolean} hard - hard-delete topic.\n   * @returns {Promise} Promise to be resolved/rejected when the server responds to the request.\n   */\n  delTopic(hard) {\n    if (this._deleted) {\n      // The topic is already deleted at the server, just remove from DB.\n      this._gone();\n      return Promise.resolve(null);\n    }\n\n    return this._tinode.delTopic(this.name, hard).then(ctrl => {\n      this._deleted = true;\n      this._resetSub();\n      this._gone();\n      return ctrl;\n    });\n  }\n  /**\n   * Delete subscription. Requires Share permission. Wrapper for {@link Tinode#delSubscription}.\n   * @memberof Tinode.Topic#\n   *\n   * @param {string} user - ID of the user to remove subscription for.\n   * @returns {Promise} Promise to be resolved/rejected when the server responds to request.\n   */\n  delSubscription(user) {\n    if (!this._attached) {\n      return Promise.reject(new Error(\"Cannot delete subscription in inactive topic\"));\n    }\n    // Send {del} message, return promise\n    return this._tinode.delSubscription(this.name, user).then(ctrl => {\n      // Remove the object from the subscription cache;\n      delete this._users[user];\n      // Notify listeners\n      if (this.onSubsUpdated) {\n        this.onSubsUpdated(Object.keys(this._users));\n      }\n      return ctrl;\n    });\n  }\n  /**\n   * Send a read/recv notification.\n   * @memberof Tinode.Topic#\n   *\n   * @param {string} what - what notification to send: <code>recv</code>, <code>read</code>.\n   * @param {number} seq - ID or the message read or received.\n   */\n  note(what, seq) {\n    if (!this._attached) {\n      // Cannot sending {note} on an inactive topic\".\n      return;\n    }\n\n    // Update local cache with the new count.\n    const user = this._users[this._tinode.getCurrentUserID()];\n    let update = false;\n    if (user) {\n      // Self-subscription is found.\n      if (!user[what] || user[what] < seq) {\n        user[what] = seq;\n        update = true;\n      }\n    } else {\n      // Self-subscription is not found.\n      update = (this[what] | 0) < seq;\n    }\n\n    if (update) {\n      // Send notification to the server.\n      this._tinode.note(this.name, what, seq);\n      // Update locally cached contact with the new count.\n      this._updateMyReadRecv(what, seq);\n\n      if (this.acs != null && !this.acs.isMuted()) {\n        const me = this._tinode.getMeTopic();\n        // Sent a notification to 'me' listeners.\n        me._refreshContact(what, this);\n      }\n    }\n  }\n\n  /**\n   * Send a 'recv' receipt. Wrapper for {@link Tinode#noteRecv}.\n   * @memberof Tinode.Topic#\n   *\n   * @param {number} seq - ID of the message to acknowledge.\n   */\n  noteRecv(seq) {\n    this.note('recv', seq);\n  }\n  /**\n   * Send a 'read' receipt. Wrapper for {@link Tinode#noteRead}.\n   * @memberof Tinode.Topic#\n   *\n   * @param {number} seq - ID of the message to acknowledge or 0/undefined to acknowledge the latest messages.\n   */\n  noteRead(seq) {\n    seq = seq || this._maxSeq;\n    if (seq > 0) {\n      this.note('read', seq);\n    }\n  }\n  /**\n   * Send a key-press notification. Wrapper for {@link Tinode#noteKeyPress}.\n   * @memberof Tinode.Topic#\n   */\n  noteKeyPress() {\n    if (this._attached) {\n      this._tinode.noteKeyPress(this.name);\n    } else {\n      this._tinode.logger(\"INFO: Cannot send notification in inactive topic\");\n    }\n  }\n  /**\n   * Send a notification that a video or audio message is being recorded. Wrapper for {@link Tinode#noteKeyPress}.\n   * @memberof Tinode.Topic#\n   * @param {boolean} audioOnly - true if the recording is audio-only, false if it's a video recording.\n   */\n  noteRecording(audioOnly) {\n    if (this._attached) {\n      this._tinode.noteKeyPress(this.name, audioOnly ? 'kpa' : 'kpv');\n    } else {\n      this._tinode.logger(\"INFO: Cannot send notification in inactive topic\");\n    }\n  }\n\n  /**\n   * Send a {note what='call'}. Wrapper for {@link Tinode#videoCall}.\n   * @memberof Tinode#\n   *\n   * @param {string} evt - Call event.\n   * @param {number} seq - ID of the call message the event pertains to.\n   * @param {string} payload - Payload associated with this event (e.g. SDP string).\n   */\n  videoCall(evt, seq, payload) {\n    if (!this._attached && !['ringing', 'hang-up'].includes(evt)) {\n      // Cannot {call} on an inactive topic\".\n      return;\n    }\n    this._tinode.videoCall(this.name, seq, evt, payload);\n  }\n\n  // Update cached read/recv/unread counts for the current user.\n  _updateMyReadRecv(what, seq, ts) {\n    let oldVal, doUpdate = false;\n\n    seq = seq | 0;\n    this.seq = this.seq | 0;\n    this.read = this.read | 0;\n    this.recv = this.recv | 0;\n    switch (what) {\n      case 'recv':\n        oldVal = this.recv;\n        this.recv = Math.max(this.recv, seq);\n        doUpdate = (oldVal != this.recv);\n        break;\n      case 'read':\n        oldVal = this.read;\n        this.read = Math.max(this.read, seq);\n        doUpdate = (oldVal != this.read);\n        break;\n      case 'msg':\n        oldVal = this.seq;\n        this.seq = Math.max(this.seq, seq);\n        if (!this.touched || this.touched < ts) {\n          this.touched = ts;\n        }\n        doUpdate = (oldVal != this.seq);\n        break;\n    }\n\n    // Sanity checks.\n    if (this.recv < this.read) {\n      this.recv = this.read;\n      doUpdate = true;\n    }\n    if (this.seq < this.recv) {\n      this.seq = this.recv;\n      if (!this.touched || this.touched < ts) {\n        this.touched = ts;\n      }\n      doUpdate = true;\n    }\n    this.unread = this.seq - this.read;\n    return doUpdate;\n  }\n  /**\n   * Get user description from global cache. The user does not need to be a\n   * subscriber of this topic.\n   * @memberof Tinode.Topic#\n   *\n   * @param {string} uid - ID of the user to fetch.\n   * @return {Object} user description or undefined.\n   */\n  userDesc(uid) {\n    // TODO: handle asynchronous requests\n    const user = this._cacheGetUser(uid);\n    if (user) {\n      return user; // Promise.resolve(user)\n    }\n  }\n  /**\n   * Get description of the p2p peer from subscription cache.\n   * @memberof Tinode.Topic#\n   *\n   * @return {Object} peer's description or undefined.\n   */\n  p2pPeerDesc() {\n    if (!this.isP2PType()) {\n      return undefined;\n    }\n    return this._users[this.name];\n  }\n  /**\n   * Iterate over cached subscribers. If callback is undefined, use this.onMetaSub.\n   * @memberof Tinode.Topic#\n   *\n   * @param {function} callback - Callback which will receive subscribers one by one.\n   * @param {Object=} context - Value of `this` inside the `callback`.\n   */\n  subscribers(callback, context) {\n    const cb = (callback || this.onMetaSub);\n    if (cb) {\n      for (let idx in this._users) {\n        cb.call(context, this._users[idx], idx, this._users);\n      }\n    }\n  }\n  /**\n   * Get a copy of cached tags.\n   * @memberof Tinode.Topic#\n   *\n   * @return {Array.<string>} a copy of tags\n   */\n  tags() {\n    // Return a copy.\n    return this._tags.slice(0);\n  }\n  /**\n   * Get auxiliary entry by key.\n   * @memberof Tinode.Topic#\n   * @param {string} key - auxiliary data key to retrieve.\n   * @return {Object} value for the <code>key</code> or <code>undefined</code>.\n   */\n  aux(key) {\n    return this._aux[key];\n  }\n  /**\n   * Get alias value (unique tag with alias: prefix), if present.\n   * The prefix is stripped off.\n   * @memberof Tinode.Topic#\n   * @return {string} alias or <code>undefined</code>.\n   */\n  alias() {\n    const alias = this._tags && this._tags.find(t => t.startsWith(Const.TAG_ALIAS));\n    if (!alias) {\n      return undefined;\n    }\n    // Remove 'alias:' prefix.\n    return alias.substring(Const.TAG_ALIAS.length);\n  }\n\n  /**\n   * Get cached subscription for the given user ID.\n   * @memberof Tinode.Topic#\n   *\n   * @param {string} uid - id of the user to query for\n   * @return user description or undefined.\n   */\n  subscriber(uid) {\n    return this._users[uid];\n  }\n  /**\n   * Iterate over versions of a message: call <code>callback</code> for each version (excluding original).\n   * If <code>callback</code> is undefined, does nothing.\n   * @memberof Tinode.Topic#\n   *\n   * @param {number} origSeq - seq ID of the original message.\n   * @param {Tinode.ForEachCallbackType} callback - Callback which will receive messages one by one. See {@link Tinode.CBuffer#forEach}\n   * @param {Object} context - Value of `this` inside the `callback`.\n   */\n  messageVersions(origSeq, callback, context) {\n    if (!callback) {\n      // No callback? We are done then.\n      return;\n    }\n    const versions = this._messageVersions[origSeq];\n    if (!versions) {\n      return;\n    }\n    versions.forEach(callback, undefined, undefined, context);\n  }\n  /**\n   * Iterate over cached messages: call <code>callback</code> for each message in the range [sinceIdx, beforeIdx).\n   * If <code>callback</code> is undefined, use <code>this.onData</code>.\n   * @memberof Tinode.Topic#\n   *\n   * @param {Tinode.ForEachCallbackType} callback - Callback which will receive messages one by one. See {@link Tinode.CBuffer#forEach}\n   * @param {number} sinceId - Optional seqId to start iterating from (inclusive).\n   * @param {number} beforeId - Optional seqId to stop iterating before it is reached (exclusive).\n   * @param {Object} context - Value of `this` inside the `callback`.\n   */\n  messages(callback, sinceId, beforeId, context) {\n    const cb = (callback || this.onData);\n    if (cb) {\n      const startIdx = typeof sinceId == 'number' ? this._messages.find({\n        seq: sinceId\n      }, true) : undefined;\n      const beforeIdx = typeof beforeId == 'number' ? this._messages.find({\n        seq: beforeId\n      }, true) : undefined;\n      if (startIdx != -1 && beforeIdx != -1) {\n        // Step 1. Filter out all replacement messages and\n        // save displayable messages in a temporary buffer.\n        let msgs = [];\n        this._messages.forEach((msg, unused1, unused2, i) => {\n          if (Topic.#isReplacementMsg(msg)) {\n            // Skip replacements.\n            return;\n          }\n          if (msg._deleted) {\n            // Skip deleted ranges.\n            return;\n          }\n          // In case the massage was edited, replace timestamp of the version with the original's timestamp.\n          const latest = this.latestMsgVersion(msg.seq) || msg;\n          if (!latest._origTs) {\n            latest._origTs = latest.ts;\n            latest._origSeq = latest.seq;\n            latest.ts = msg.ts;\n            latest.seq = msg.seq;\n          }\n          msgs.push({\n            data: latest,\n            idx: i\n          });\n        }, startIdx, beforeIdx, {});\n        // Step 2. Loop over displayble messages invoking cb on each of them.\n        msgs.forEach((val, i) => {\n          cb.call(context, val.data,\n            (i > 0 ? msgs[i - 1].data : undefined),\n            (i < msgs.length - 1 ? msgs[i + 1].data : undefined), val.idx);\n        });\n      }\n    }\n  }\n  /**\n   * Get the message from cache by literal <code>seq</code> (does not resolve message edits).\n   * @memberof Tinode.Topic#\n   *\n   * @param {number} seq - message seqId to search for.\n   * @returns {Object} the message with the given <code>seq</code> or <code>undefined</code>, if no such message is found.\n   */\n  findMessage(seq) {\n    const idx = this._messages.find({\n      seq: seq\n    });\n    if (idx >= 0) {\n      return this._messages.getAt(idx);\n    }\n    return undefined;\n  }\n  /**\n   * Get the most recent non-deleted message from cache.\n   * @memberof Tinode.Topic#\n   *\n   * @returns {Object} the most recent cached message or <code>undefined</code>, if no messages are cached.\n   */\n  latestMessage() {\n    return this._messages.getLast(msg => !msg._deleted);\n  }\n  /**\n   * Get the latest version for message.\n   * @memberof Tinode.Topic#\n   *\n   * @param {number} seq - original seq ID of the message.\n   * @returns {Object} the latest version of the message or null if message not found.\n   */\n  latestMsgVersion(seq) {\n    const versions = this._messageVersions[seq];\n    return versions ? versions.getLast() : null;\n  }\n  /**\n   * Get the maximum cached seq ID.\n   * @memberof Tinode.Topic#\n   *\n   * @returns {number} the greatest seq ID in cache.\n   */\n  maxMsgSeq() {\n    return this._maxSeq;\n  }\n  /**\n   * Get the minimum cached seq ID.\n   * @memberof Tinode.Topic#\n   *\n   * @returns {number} the smallest seq ID in cache or 0.\n   */\n  minMsgSeq() {\n    return this._minSeq;\n  }\n  /**\n   * Get the maximum deletion ID.\n   * @memberof Tinode.Topic#\n   *\n   * @returns {number} the greatest deletion ID.\n   */\n  maxClearId() {\n    return this._maxDel;\n  }\n  /**\n   * Get the number of messages in the cache.\n   * @memberof Tinode.Topic#\n   *\n   * @returns {number} count of cached messages.\n   */\n  messageCount() {\n    return this._messages.length();\n  }\n  /**\n   * Iterate over cached unsent messages. Wraps {@link Tinode.Topic#messages}.\n   * @memberof Tinode.Topic#\n   *\n   * @param {function} callback - Callback which will receive messages one by one. See {@link Tinode.CBuffer#forEach}\n   * @param {Object} context - Value of <code>this</code> inside the <code>callback</code>.\n   */\n  queuedMessages(callback, context) {\n    if (!callback) {\n      throw new Error(\"Callback must be provided\");\n    }\n    this.messages(callback, Const.LOCAL_SEQID, undefined, context);\n  }\n  /**\n   * Get the number of topic subscribers who marked this message as either recv or read\n   * Current user is excluded from the count.\n   * @memberof Tinode.Topic#\n   *\n   * @param {string} what - what action to consider: received <code>\"recv\"</code> or read <code>\"read\"</code>.\n   * @param {number} seq - ID or the message read or received.\n   *\n   * @returns {number} the number of subscribers who marked the message with the given ID as read or received.\n   */\n  msgReceiptCount(what, seq) {\n    let count = 0;\n    if (seq > 0) {\n      const me = this._tinode.getCurrentUserID();\n      for (let idx in this._users) {\n        const user = this._users[idx];\n        if (user.user !== me && user[what] >= seq) {\n          count++;\n        }\n      }\n    }\n    return count;\n  }\n  /**\n   * Get the number of topic subscribers who marked this message (and all older messages) as read.\n   * The current user is excluded from the count.\n   * @memberof Tinode.Topic#\n   *\n   * @param {number} seq - message id to check.\n   * @returns {number} number of subscribers who claim to have received the message.\n   */\n  msgReadCount(seq) {\n    return this.msgReceiptCount('read', seq);\n  }\n  /**\n   * Get the number of topic subscribers who marked this message (and all older messages) as received.\n   * The current user is excluded from the count.\n   * @memberof Tinode.Topic#\n   *\n   * @param {number} seq - Message id to check.\n   * @returns {number} Number of subscribers who claim to have received the message.\n   */\n  msgRecvCount(seq) {\n    return this.msgReceiptCount('recv', seq);\n  }\n\n  /**\n   * Return reactions for the message with the given seq id if present.\n   * @memberof Tinode.Topic#\n   * @param {number} seq - message seq id.\n   * @returns {Array} array of reaction objects or empty array.\n   */\n  msgReactions(seq) {\n    const msg = this.findMessage(seq);\n    if (!msg) {\n      return [];\n    }\n    return msg.react || [];\n  }\n\n  /**\n   * Return current user's reaction value for the given message.\n   * @memberof Tinode.Topic#\n   * @param {number} seq - message seq id.\n   * @returns {string|null} current user's reaction value or null.\n   */\n  msgMyReaction(seq) {\n    const reactions = this.msgReactions(seq);\n    const me = this._tinode.getCurrentUserID();\n    for (let i = 0; i < reactions.length; i++) {\n      if ((reactions[i].users || []).includes(me)) {\n        return reactions[i].val;\n      }\n    }\n    return null;\n  }\n\n  /**\n   * Check if topic has unseen reactions.\n   * @memberof Tinode.Topic#\n   *\n   * @returns {boolean} true if there are unseen reactions, false otherwise.\n   */\n  hasUnseenReactions() {\n    return this.mrrid > this._mrrSeen;\n  }\n\n  /**\n   * Check if cached message IDs indicate that the server may have more messages.\n   * @memberof Tinode.Topic#\n   *\n   * @param {number} min - smallest seq ID loaded range.\n   * @param {number} max - greatest seq ID in loaded range.\n   * @param {boolean} newer - if <code>true</code>, check for newer messages only.\n   * @returns {Array.<Range>} - missing ranges in the selected direction.\n   */\n  msgHasMoreMessages(min, max, newer) {\n    // Find gaps in cached messages.\n    const gaps = [];\n    if (min >= max) {\n      return gaps;\n    }\n    let maxSeq = 0;\n    let gap;\n    this._messages.forEach((msg, prev) => {\n      const p = prev || {\n        seq: 0\n      };\n      const expected = p._deleted ? p.hi : p.seq + 1;\n      if (msg.seq > expected) {\n        gap = {\n          low: expected,\n          hi: msg.seq\n        };\n      } else {\n        gap = null;\n      }\n      // If newer: collect all gaps from min to infinity.\n      // If older: collect all gaps from max to zero.\n      if (gap && (newer ? gap.hi >= min : gap.low < max)) {\n        gaps.push(gap);\n      }\n      maxSeq = expected;\n    });\n\n    if (maxSeq < this.seq) {\n      gap = {\n        low: maxSeq + 1,\n        hi: this.seq + 1\n      };\n      if (newer ? gap.hi >= min : gap.low < max) {\n        gaps.push(gap);\n      }\n    }\n    return gaps;\n  }\n  /**\n   * Check if the given seq Id is id of the most recent message.\n   * @memberof Tinode.Topic#\n   *\n   * @param {number} seqId id of the message to check\n   */\n  isNewMessage(seqId) {\n    return this._maxSeq <= seqId;\n  }\n  /**\n   * Remove one message from local cache.\n   * @memberof Tinode.Topic#\n   *\n   * @param {number} seqId id of the message to remove from cache.\n   * @returns {Message} removed message or undefined if such message was not found.\n   */\n  flushMessage(seqId) {\n    const idx = this._messages.find({\n      seq: seqId\n    });\n    delete this._messageVersions[seqId];\n    if (idx >= 0) {\n      this._tinode._db.remMessages(this.name, seqId);\n      return this._messages.delAt(idx);\n    }\n    return undefined;\n  }\n  /**\n   * Remove a range of messages from the local cache.\n   * @memberof Tinode.Topic#\n   *\n   * @param {number} fromId seq ID of the first message to remove (inclusive).\n   * @param {number} untilId seqID of the last message to remove (exclusive).\n   *\n   * @returns {Message[]} array of removed messages (could be empty).\n   */\n  flushMessageRange(fromId, untilId) {\n    // Remove range from persistent cache.\n    this._tinode._db.remMessages(this.name, fromId, untilId);\n\n    // Remove all versions keyed by IDs in the range.\n    for (let i = fromId; i < untilId; i++) {\n      delete this._messageVersions[i];\n    }\n\n    // start, end: find insertion points (nearest == true).\n    const since = this._messages.find({\n      seq: fromId\n    }, true);\n    return since >= 0 ? this._messages.delRange(since, this._messages.find({\n      seq: untilId\n    }, true)) : [];\n  }\n  /**\n   * Update message's seqId.\n   * @memberof Tinode.Topic#\n   *\n   * @param {Object} pub message object.\n   * @param {number} newSeqId new seq id for pub.\n   */\n  swapMessageId(pub, newSeqId) {\n    const idx = this._messages.find(pub);\n    const numMessages = this._messages.length();\n    if (0 <= idx && idx < numMessages) {\n      // Remove message with the old seq ID.\n      this._messages.delAt(idx);\n      this._tinode._db.remMessages(this.name, pub.seq);\n      // Add message with the new seq ID.\n      pub.seq = newSeqId;\n      this._messages.put(pub);\n      this._tinode._db.addMessage(pub);\n    }\n  }\n  /**\n   * Attempt to stop message from being sent.\n   * @memberof Tinode.Topic#\n   *\n   * @param {number} seqId id of the message to stop sending and remove from cache.\n   *\n   * @returns {boolean} <code>true</code> if message was cancelled, <code>false</code> otherwise.\n   */\n  cancelSend(seqId) {\n    const idx = this._messages.find({\n      seq: seqId\n    });\n    if (idx >= 0) {\n      const msg = this._messages.getAt(idx);\n      const status = this.msgStatus(msg);\n      if (status == Const.MESSAGE_STATUS_QUEUED ||\n        status == Const.MESSAGE_STATUS_FAILED ||\n        status == Const.MESSAGE_STATUS_FATAL) {\n        this._tinode._db.remMessages(this.name, seqId);\n        msg._cancelled = true;\n        this._messages.delAt(idx);\n        if (this.onData) {\n          // Calling with no parameters to indicate the message was deleted.\n          this.onData();\n        }\n        return true;\n      }\n    }\n    return false;\n  }\n  /**\n   * Get type of the topic: me, p2p, grp, fnd...\n   * @memberof Tinode.Topic#\n   *\n   * @returns {string} One of 'me', 'p2p', 'grp', 'fnd', 'sys' or <code>undefined</code>.\n   */\n  getType() {\n    return Topic.topicType(this.name);\n  }\n  /**\n   * Get current user's access mode of the topic.\n   * @memberof Tinode.Topic#\n   *\n   * @returns {Tinode.AccessMode} - user's access mode\n   */\n  getAccessMode() {\n    return this.acs;\n  }\n  /**\n   * Set current user's access mode of the topic.\n   * @memberof Tinode.Topic#\n   *\n   * @param {AccessMode | Object} acs - access mode to set.\n   */\n  setAccessMode(acs) {\n    return this.acs = new AccessMode(acs);\n  }\n  /**\n   * Get topic's default access mode.\n   * @memberof Tinode.Topic#\n   *\n   * @returns {Tinode.DefAcs} - access mode, such as {auth: `RWP`, anon: `N`}.\n   */\n  getDefaultAccess() {\n    return this.defacs;\n  }\n  /**\n   * Initialize new meta {@link Tinode.GetQuery} builder. The query is attched to the current topic.\n   * It will not work correctly if used with a different topic.\n   * @memberof Tinode.Topic#\n   *\n   * @returns {Tinode.MetaGetBuilder} query attached to the current topic.\n   */\n  startMetaQuery() {\n    return new MetaGetBuilder(this);\n  }\n  /**\n   * Check if topic is archived, i.e. private.arch == true.\n   * @memberof Tinode.Topic#\n   *\n   * @returns {boolean} - <code>true</code> if topic is archived, <code>false</code> otherwise.\n   */\n  isArchived() {\n    return this.private && !!this.private.arch;\n  }\n  /**\n   * Check if topic is a 'me' topic.\n   * @memberof Tinode.Topic#\n   *\n   * @returns {boolean} - <code>true</code> if topic is a 'me' topic, <code>false</code> otherwise.\n   */\n  isMeType() {\n    return Topic.isMeTopicName(this.name);\n  }\n  /**\n   * Check if topic is a 'slf' topic.\n   * @memberof Tinode.Topic#\n   *\n   * @returns {boolean} - <code>true</code> if topic is a 'slf' topic, <code>false</code> otherwise.\n   */\n  isSelfType() {\n    return Topic.isSelfTopicName(this.name);\n  }\n  /**\n   * Check if topic is a channel.\n   * @memberof Tinode.Topic#\n   *\n   * @returns {boolean} - <code>true</code> if topic is a channel, <code>false</code> otherwise.\n   */\n  isChannelType() {\n    return Topic.isChannelTopicName(this.name);\n  }\n  /**\n   * Check if topic is a group topic.\n   * @memberof Tinode.Topic#\n   *\n   * @returns {boolean} - <code>true</code> if topic is a group, <code>false</code> otherwise.\n   */\n  isGroupType() {\n    return Topic.isGroupTopicName(this.name);\n  }\n  /**\n   * Check if topic is a p2p topic.\n   * @memberof Tinode.Topic#\n   *\n   * @returns {boolean} - <code>true</code> if topic is a p2p topic, <code>false</code> otherwise.\n   */\n  isP2PType() {\n    return Topic.isP2PTopicName(this.name);\n  }\n  /**\n   * Check if topic is a communication topic, i.e. a group or p2p topic.\n   * @memberof Tinode.Topic#\n   *\n   * @returns {boolean} - <code>true</code> if topic is a p2p or group topic, <code>false</code> otherwise.\n   */\n  isCommType() {\n    return Topic.isCommTopicName(this.name);\n  }\n  /**\n   * Get status (queued, sent, received etc) of a given message in the context\n   * of this topic.\n   * @memberof Tinode.Topic#\n   *\n   * @param {Message} msg - message to check for status.\n   * @param {boolean} upd - update chached message status.\n   *\n   * @returns message status constant.\n   */\n  msgStatus(msg, upd) {\n    let status = Const.MESSAGE_STATUS_NONE;\n    if (this._tinode.isMe(msg.from)) {\n      if (msg._sending) {\n        status = Const.MESSAGE_STATUS_SENDING;\n      } else if (msg._fatal || msg._cancelled) {\n        status = Const.MESSAGE_STATUS_FATAL;\n      } else if (msg._failed) {\n        status = Const.MESSAGE_STATUS_FAILED;\n      } else if (msg.seq >= Const.LOCAL_SEQID) {\n        status = Const.MESSAGE_STATUS_QUEUED;\n      } else if (this.msgReadCount(msg.seq) > 0) {\n        status = Const.MESSAGE_STATUS_READ;\n      } else if (this.msgRecvCount(msg.seq) > 0) {\n        status = Const.MESSAGE_STATUS_RECEIVED;\n      } else if (msg.seq > 0) {\n        status = Const.MESSAGE_STATUS_SENT;\n      }\n    } else {\n      status = Const.MESSAGE_STATUS_TO_ME;\n    }\n\n    if (upd && msg._status != status) {\n      msg._status = status;\n      this._tinode._db.updMessageStatus(this.name, msg.seq, status);\n    }\n\n    return status;\n  }\n\n  // If msg is a replacement for another message, save the msg in the message versions cache\n  // as a newer version for the message it's supposed to replace.\n  _maybeUpdateMessageVersionsCache(msg) {\n    if (!Topic.#isReplacementMsg(msg)) {\n      // Check if this message is the original in the chain of edits and if so\n      // ensure all version have the same sender.\n      if (this._messageVersions[msg.seq]) {\n        // Remove versions with different 'from'.\n        this._messageVersions[msg.seq].filter(version => version.from == msg.from);\n        if (this._messageVersions[msg.seq].isEmpty()) {\n          delete this._messageVersions[msg.seq];\n        }\n      }\n      return;\n    }\n\n    const targetSeq = parseInt(msg.head.replace.split(':')[1]);\n    if (targetSeq > msg.seq) {\n      // Substitutes are supposed to have higher seq ids.\n      return;\n    }\n    const targetMsg = this.findMessage(targetSeq);\n    if (targetMsg && targetMsg.from != msg.from) {\n      // Substitute cannot change the sender.\n      return;\n    }\n    const versions = this._messageVersions[targetSeq] || new CBuffer((a, b) => {\n      return a.seq - b.seq;\n    }, true);\n    versions.put(msg);\n    this._messageVersions[targetSeq] = versions;\n  }\n\n  // Process data message\n  _routeData(data) {\n    if (data.content) {\n      if (!this.touched || this.touched < data.ts) {\n        this.touched = data.ts;\n        this._tinode._db.updTopic(this);\n      }\n    }\n\n    if (data.seq > this._maxSeq) {\n      this._maxSeq = data.seq;\n      this.msgStatus(data, true);\n      // Ackn receiving the message.\n      clearTimeout(this._recvNotificationTimer);\n      this._recvNotificationTimer = setTimeout(_ => {\n        this._recvNotificationTimer = null;\n        this.noteRecv(this._maxSeq);\n      }, Const.RECV_TIMEOUT);\n    }\n\n    if (data.seq < this._minSeq || this._minSeq == 0) {\n      this._minSeq = data.seq;\n    }\n\n    const outgoing = ((!this.isChannelType() && !data.from) || this._tinode.isMe(data.from));\n\n    if (data.head && data.head.webrtc && data.head.mime == Drafty.getContentType() && data.content) {\n      // Rewrite VC body with info from the headers.\n      const upd = {\n        state: data.head.webrtc,\n        duration: data.head['webrtc-duration'],\n        incoming: !outgoing,\n      };\n      if (data.head.vc) {\n        upd.vc = true;\n      }\n      data.content = Drafty.updateVideoCall(data.content, upd);\n    }\n\n    // Normalize reactions payload if present: server uses 'react' field with array of\n    // {value, count, users}.\n    if (data.react) {\n      let maxReact = 0;\n      data.react = (data.react || []).map(r => {\n        maxReact = Math.max(maxReact, r.mrrid);\n        return {\n          mrrid: r.mrrid,\n          val: r.val,\n          count: r.count | 0,\n          users: Array.isArray(r.users) ? r.users.slice() : []\n        };\n      });\n      if (this.mrrid < maxReact) {\n        this.mrrid = maxReact;\n      }\n    }\n\n    if (!data._noForwarding) {\n      this._messages.put(data);\n      this._tinode._db.addMessage(data);\n      this._maybeUpdateMessageVersionsCache(data);\n    }\n\n    if (this.onData) {\n      this.onData(data);\n    }\n\n    // Update locally cached contact with the new message count.\n    const what = outgoing ? 'read' : 'msg';\n    this._updateMyReadRecv(what, data.seq, data.ts);\n\n    if (!outgoing && data.from) {\n      // Mark messages as read by the sender.\n      this._routeInfo({\n        what: 'read',\n        from: data.from,\n        seq: data.seq,\n        _noForwarding: true\n      });\n    }\n\n    // Notify 'me' listeners of the change.\n    this._tinode.getMeTopic()._refreshContact(what, this);\n  }\n\n  // Process metadata message\n  _routeMeta(meta) {\n    if (meta.desc) {\n      this._processMetaDesc(meta.desc);\n    }\n    if (meta.sub && meta.sub.length > 0) {\n      this._processMetaSubs(meta.sub);\n    }\n    if (meta.del) {\n      this._processDelMessages(meta.del.clear, meta.del.delseq);\n    }\n    if (meta.tags) {\n      this._processMetaTags(meta.tags);\n    }\n    if (meta.cred) {\n      this._processMetaCreds(meta.cred);\n    }\n    if (meta.aux) {\n      this._processMetaAux(meta.aux);\n    }\n    if (meta.react) {\n      this._processMetaReact(meta.react);\n    }\n\n    if (this.onMeta) {\n      this.onMeta(meta);\n    }\n  }\n  // Process presence change message\n  _routePres(pres) {\n    let user, uid;\n    switch (pres.what) {\n      case 'del':\n        // Delete cached messages.\n        this._processDelMessages(pres.clear, pres.delseq);\n        break;\n      case 'on':\n      case 'off':\n        // Update online status of a subscription.\n        user = this._users[pres.src];\n        if (user) {\n          user.online = pres.what == 'on';\n        } else {\n          this._tinode.logger(\"WARNING: Presence update for an unknown user\", this.name, pres.src);\n        }\n        break;\n      case 'term':\n        // Attachment to topic is terminated probably due to cluster rehashing.\n        this._resetSub();\n        break;\n      case 'upd':\n        // A topic subscriber has updated his description.\n        // Issue {get sub} only if the current user has no p2p topics with the updated user (p2p name is not in cache).\n        // Otherwise 'me' will issue a {get desc} request.\n        if (pres.src && !this._tinode.isTopicCached(pres.src)) {\n          this.getMeta(this.startMetaQuery().withOneSub(undefined, pres.src).build());\n        }\n        break;\n      case 'aux':\n        // Auxiliary data updated.\n        this.getMeta(this.startMetaQuery().withAux().build());\n        break;\n      case 'react':\n        // Reaction to message.\n        this._processMetaReact(undefined, {\n          mrrid: pres.id2 | 0,\n          seq: pres.seq | 0,\n          user: pres.act,\n          val: pres.val,\n        });\n        break;\n      case 'acs':\n        uid = pres.src || this._tinode.getCurrentUserID();\n        user = this._users[uid];\n        if (!user) {\n          // Update for an unknown user: notification of a new subscription.\n          const acs = new AccessMode().updateAll(pres.dacs);\n          if (acs && acs.mode != AccessMode._NONE) {\n            user = this._cacheGetUser(uid);\n            if (!user) {\n              user = {\n                user: uid,\n                acs: acs\n              };\n              this.getMeta(this.startMetaQuery().withOneSub(undefined, uid).build());\n            } else {\n              user.acs = acs;\n            }\n            user.updated = new Date();\n            this._processMetaSubs([user]);\n          }\n        } else {\n          // Known user\n          user.acs.updateAll(pres.dacs);\n          // Update user's access mode.\n          this._processMetaSubs([{\n            user: uid,\n            updated: new Date(),\n            acs: user.acs\n          }]);\n        }\n        break;\n      default:\n        this._tinode.logger(\"INFO: Ignored presence update\", pres.what);\n    }\n\n    if (this.onPres) {\n      this.onPres(pres);\n    }\n  }\n\n  // Process {info} message\n  _routeInfo(info) {\n    switch (info.what) {\n      case 'recv':\n      case 'read':\n        const user = this._users[info.from];\n        if (user) {\n          user[info.what] = info.seq;\n          if (user.recv < user.read) {\n            user.recv = user.read;\n          }\n        }\n        const msg = this.latestMessage();\n        if (msg) {\n          this.msgStatus(msg, true);\n        }\n\n        // If this is an update from the current user, update the cache with the new count.\n        if (this._tinode.isMe(info.from) && !info._noForwarding) {\n          this._updateMyReadRecv(info.what, info.seq);\n        }\n\n        // Notify 'me' listener of the status change.\n        this._tinode.getMeTopic()._refreshContact(info.what, this);\n        break;\n      case 'kp':\n      case 'kpa':\n      case 'kpv':\n        // Typing or audio/video recording notification. Do nothing.\n        break;\n      case 'call':\n        // Do nothing here.\n        break;\n      default:\n        this._tinode.logger(\"INFO: Ignored info update\", info.what);\n    }\n\n    if (this.onInfo) {\n      this.onInfo(info);\n    }\n  }\n  // Called by Tinode when meta.desc packet is received.\n  // Called by 'me' topic on contact update (desc._noForwarding is true).\n  _processMetaDesc(desc) {\n    if (this.isP2PType()) {\n      // Synthetic desc may include defacs for p2p topics which is useless.\n      // Remove it.\n      delete desc.defacs;\n\n      // Update to p2p desc is the same as user update. Update cached user.\n      this._tinode._db.updUser(this.name, desc.public);\n    }\n\n    // Copy parameters from desc object to this topic.\n    mergeObj(this, desc);\n    // Update persistent cache.\n    this._tinode._db.updTopic(this);\n\n    // Notify 'me' listener, if available:\n    if (this.name !== Const.TOPIC_ME && !desc._noForwarding) {\n      const me = this._tinode.getMeTopic();\n      if (me.onMetaSub) {\n        me.onMetaSub(this);\n      }\n      if (me.onSubsUpdated) {\n        me.onSubsUpdated([this.name], 1);\n      }\n    }\n\n    if (this.onMetaDesc) {\n      this.onMetaDesc(this);\n    }\n  }\n  // Called by Tinode when meta.sub is received, in response to received\n  // {ctrl} after setMeta-sub, or as a handler for {pres what=sub}.\n  _processMetaSubs(subs) {\n    for (let idx in subs) {\n      const sub = subs[idx];\n\n      // Fill defaults.\n      sub.online = !!sub.online;\n      // Update timestamp of the most recent subscription update.\n      this._lastSubsUpdate = new Date(Math.max(this._lastSubsUpdate, sub.updated));\n\n      let user = null;\n      if (!sub.deleted) {\n        // If this is a change to user's own permissions, update them in topic too.\n        // Desc will update 'me' topic.\n        if (this._tinode.isMe(sub.user) && sub.acs) {\n          this._processMetaDesc({\n            updated: sub.updated,\n            touched: sub.touched,\n            acs: sub.acs\n          });\n        }\n        if (!this._users[sub.user]) {\n          // New subscription.\n          this.subcnt++;\n        }\n        user = this._updateCachedUser(sub.user, sub);\n      } else {\n        // Subscription is deleted, remove it from topic (but leave in Users cache)\n        delete this._users[sub.user];\n        user = sub;\n        this.subcnt--;\n      }\n\n      if (this.onMetaSub) {\n        this.onMetaSub(user);\n      }\n    }\n\n    if (this.onSubsUpdated) {\n      this.onSubsUpdated(Object.keys(this._users));\n    }\n  }\n  // Called by Tinode when meta.tags is received.\n  _processMetaTags(tags) {\n    if (tags == Const.DEL_CHAR || (tags.length == 1 && tags[0] == Const.DEL_CHAR)) {\n      tags = [];\n    }\n    this._tags = tags;\n    this._tinode._db.updTopic(this);\n    if (this.onTagsUpdated) {\n      this.onTagsUpdated(tags);\n    }\n  }\n  // Do nothing for topics other than 'me'\n  _processMetaCreds(creds) {}\n\n  // Called by Tinode when meta.aux is received.\n  _processMetaAux(aux) {\n    aux = (!aux || aux == Const.DEL_CHAR) ? {} : aux;\n    this._aux = mergeObj(this._aux, aux);\n    this._tinode._db.updTopic(this);\n    if (this.onAuxUpdated) {\n      this.onAuxUpdated(this._aux);\n    }\n  }\n\n  // Handle an incremental reaction update for a message.\n  // delta: {val, users: [user]}\n  // The users could be empty or contain exactly one user.\n  // 1. If user has already reacted with the same emoji, remove the reaction.\n  // 2. If user has already reacted with a different emoji, change the reaction.\n  // 3. If user has not reacted yet, add the reaction to the same emoji, if present.\n  // 4. If user has not reacted yet, and no one reacted that way, create a new reaction.\n  _handleReactionDiff(msg, delta) {\n    const reacts = [...(msg.react || [])];\n    // Find if the given user has already reacted.\n    const user = delta.users[0];\n    const found = user ? reacts.findIndex(r => r.users.includes(user)) : -1;\n    if (found >= 0) {\n      const existing = reacts[found];\n      if (delta.val == Const.DEL_CHAR || existing.val == delta.val) {\n        // Remove existing reaction.\n        existing.count--;\n        existing.mrrid = Math.max(existing.mrrid, delta.mrrid);\n        if (existing.count <= 0) {\n          reacts.splice(found, 1);\n        } else {\n          const userIdx = existing.users.indexOf(user);\n          existing.users.splice(userIdx, 1);\n        }\n      } else {\n        // User changed reaction.\n        const userIdx = existing.users.indexOf(user);\n        existing.users.splice(userIdx, 1);\n        existing.count--;\n        if (existing.count <= 0) {\n          reacts.splice(found, 1);\n        }\n        // Add user reaction as a different emoji.\n        const emoIndex = reacts.findIndex(r => r.val == delta.val);\n        if (emoIndex >= 0) {\n          // Add to existing reaction.\n          reacts[emoIndex].users.push(user);\n          reacts[emoIndex].count++;\n          reacts[emoIndex].mrrid = Math.max(reacts[emoIndex].mrrid, delta.mrrid);\n        } else {\n          // Create new reaction.\n          reacts.push({\n            mrrid: delta.mrrid,\n            users: [user],\n            count: 1,\n            val: delta.val\n          });\n        }\n      }\n    } else if (delta.val != Const.DEL_CHAR) {\n      // Existing user has not reacted yet.\n      // Find reaction of the same type.\n      const emoIndex = reacts.findIndex(r => r.val == delta.val);\n      if (emoIndex >= 0) {\n        // Add to existing reaction.\n        if (user) {\n          reacts[emoIndex].users.push(user);\n        }\n        reacts[emoIndex].count++;\n        reacts[emoIndex].mrrid = Math.max(reacts[emoIndex].mrrid, delta.mrrid);\n      } else {\n        // Create new reaction.\n        reacts.push({\n          mrrid: delta.mrrid,\n          users: user ? [user] : [],\n          count: 1,\n          val: delta.val\n        });\n      }\n    }\n    return reacts;\n  }\n\n  // Called by Tinode when meta.aux is recived.\n  _processMetaReact(reacts, oneReaction) {\n    if (!Array.isArray(reacts)) {\n      if (!oneReaction.seq || !oneReaction.val) {\n        this._tinode.logger(\"WARNING: invalid reaction\");\n        return;\n      }\n      reacts = [{\n        _diff: true, // Indicate that this is a delta update.\n        seq: oneReaction.seq,\n        data: [{\n          mrrid: oneReaction.mrrid,\n          val: oneReaction.val,\n          count: 1,\n          users: [oneReaction.user || this._tinode.getCurrentUserID()]\n        }]\n      }];\n    }\n    // Process reactions metadata. meta.react is an array of {seq, data: [{val, count, users}]}\n    const seqIds = [];\n    reacts.forEach(mr => {\n      const msg = this.findMessage(mr.seq);\n      seqIds.push(mr.seq);\n      if (msg) {\n        let upd;\n        if (mr._diff) {\n          // Single incremental update.\n          upd = this._handleReactionDiff(msg, mr.data[0]);\n        } else {\n          upd = (mr.data || []).map(r => ({\n            mrrid: r.mrrid,\n            val: r.val,\n            count: r.count | 0,\n            users: Array.isArray(r.users) ? r.users.slice() : []\n          }));\n        }\n        msg.react = upd;\n        const maxReact = upd.reduce((max, r) => Math.max(max, r.mrrid), 0);\n        if (this.mrrid < maxReact) {\n          this.mrrid = maxReact;\n        }\n        this._tinode._db.updMessageReact(this.name, mr.seq, msg.react);\n      }\n    });\n    // Notify UI listeners of changes.\n    if (this.onReact) {\n      this.onReact(seqIds);\n    }\n  }\n\n  // Delete cached messages and update cached transaction IDs\n  _processDelMessages(clear, delseq) {\n    this._maxDel = Math.max(clear, this._maxDel);\n    this.clear = Math.max(clear, this.clear);\n    let count = 0;\n    if (Array.isArray(delseq)) {\n      delseq.forEach(rec => {\n        if (!rec.hi) {\n          count++;\n          this.flushMessage(rec.low);\n        } else {\n          count += rec.hi - rec.low;\n          this.flushMessageRange(rec.low, rec.hi);\n        }\n        this._messages.put({\n          seq: rec.low,\n          low: rec.low,\n          hi: rec.hi,\n          _deleted: true\n        });\n      });\n\n      this._tinode._db.addDelLog(this.name, clear, delseq);\n    }\n\n    if (count > 0) {\n      if (this.onData) {\n        this.onData();\n      }\n    }\n  }\n  // Topic is informed that the entire response to {get what=data} has been received.\n  _allMessagesReceived(count) {\n\n    if (this.onAllMessagesReceived) {\n      this.onAllMessagesReceived(count);\n    }\n  }\n  // Reset subscribed state\n  _resetSub() {\n    this._attached = false;\n  }\n  // This topic is either deleted or unsubscribed from.\n  _gone() {\n    this._messages.reset();\n    this._tinode._db.remMessages(this.name);\n    this._users = {};\n    this.acs = new AccessMode(null);\n    this.private = null;\n    this.public = null;\n    this.trusted = null;\n    this._maxSeq = 0;\n    this._minSeq = 0;\n    this._maxDel = 0;\n    this._maxReact = 0;\n    this._attached = false;\n\n    const me = this._tinode.getMeTopic();\n    if (me) {\n      me._routePres({\n        _noForwarding: true,\n        what: 'gone',\n        topic: Const.TOPIC_ME,\n        src: this.name\n      });\n    }\n    if (this.onDeleteTopic) {\n      this.onDeleteTopic();\n    }\n  }\n  // Update global user cache and local subscribers cache.\n  // Don't call this method for non-subscribers.\n  _updateCachedUser(uid, obj) {\n    // Fetch user object from the global cache.\n    // This is a clone of the stored object\n    let cached = this._cacheGetUser(uid);\n    cached = mergeObj(cached || {}, obj);\n    // Save to global cache\n    this._cachePutUser(uid, cached);\n    // Save to the list of topic subscribers.\n    return mergeToCache(this._users, uid, cached);\n  }\n  // Get local seqId for a queued message.\n  _getQueuedSeqId() {\n    return this._queuedSeqId++;\n  }\n\n  // Load most recent messages from persistent cache.\n  _loadMessages(db, query) {\n    query = query || {};\n    query.limit = query.limit || Const.DEFAULT_MESSAGES_PAGE;\n\n    // Count of message loaded from DB.\n    let count = 0;\n    return db.readMessages(this.name, query)\n      .then(msgs => {\n        msgs.forEach(data => {\n          if (data.seq > this._maxSeq) {\n            this._maxSeq = data.seq;\n          }\n          if (data.seq < this._minSeq || this._minSeq == 0) {\n            this._minSeq = data.seq;\n          }\n          this._messages.put(data);\n          this._maybeUpdateMessageVersionsCache(data);\n        });\n        count = msgs.length;\n      })\n      .then(_ => db.readDelLog(this.name, query))\n      .then(dellog => {\n        return dellog.forEach(rec => {\n          this._messages.put({\n            seq: rec.low,\n            low: rec.low,\n            hi: rec.hi,\n            _deleted: true\n          });\n        });\n      })\n      .then(_ => {\n        // DEBUG\n        return count;\n      });\n  }\n\n  // Push or {pres}: message received.\n  _updateReceived(seq, act) {\n    this.touched = new Date();\n    this.seq = seq | 0;\n    // Check if message is sent by the current user. If so it's been read already.\n    if (!act || this._tinode.isMe(act)) {\n      this.read = this.read ? Math.max(this.read, this.seq) : this.seq;\n      this.recv = this.recv ? Math.max(this.read, this.recv) : this.read;\n    }\n    this.unread = this.seq - (this.read | 0);\n    this._tinode._db.updTopic(this);\n  }\n}\n","/**\n * @file Definition of 'fnd' topic.\n *\n * @copyright 2015-2026 Tinode LLC.\n */\n'use strict';\n\nimport * as Const from './config.js';\nimport Topic from './topic.js';\nimport {\n  mergeToCache\n} from './utils.js';\n\n\n/**\n * Special case of {@link Tinode.Topic} for searching for contacts and group topics\n * @extends Tinode.Topic\n *\n */\nexport default class TopicFnd extends Topic {\n  // List of users and topics uid or topic_name -> Contact object)\n  _contacts = {};\n\n  /**\n   * Create TopicFnd.\n   *\n   * @param {TopicFnd.Callbacks} callbacks - Callbacks to receive various events.\n   */\n  constructor(callbacks) {\n    super(Const.TOPIC_FND, callbacks);\n  }\n\n  // Override the original Topic._processMetaSubs\n  _processMetaSubs(subs) {\n    let updateCount = Object.getOwnPropertyNames(this._contacts).length;\n    // Reset contact list.\n    this._contacts = {};\n    for (let idx in subs) {\n      let sub = subs[idx];\n      const indexBy = sub.topic ? sub.topic : sub.user;\n\n      sub = mergeToCache(this._contacts, indexBy, sub);\n      updateCount++;\n\n      if (this.onMetaSub) {\n        this.onMetaSub(sub);\n      }\n    }\n\n    if (updateCount > 0 && this.onSubsUpdated) {\n      this.onSubsUpdated(Object.keys(this._contacts));\n    }\n  }\n\n  /**\n   * Publishing to TopicFnd is not supported. {@link Topic#publish} is overriden and thows an {Error} if called.\n   * @memberof Tinode.TopicFnd#\n   * @throws {Error} Always throws an error.\n   */\n  publish() {\n    return Promise.reject(new Error(\"Publishing to 'fnd' is not supported\"));\n  }\n\n  /**\n   * setMeta to TopicFnd resets contact list in addition to sending the message.\n   * @memberof Tinode.TopicFnd#\n   * @param {Tinode.SetParams} params - parameters to update.\n   * @returns {Promise} Promise to be resolved/rejected when the server responds to request.\n   */\n  setMeta(params) {\n    return Object.getPrototypeOf(TopicFnd.prototype).setMeta.call(this, params).then(_ => {\n      if (Object.keys(this._contacts).length > 0) {\n        this._contacts = {};\n        if (this.onSubsUpdated) {\n          this.onSubsUpdated([]);\n        }\n      }\n    });\n  }\n\n  /**\n   * Check if the given tag is unique by asking the server.\n   * @param {string} tag - tag to check.\n   * @param {string} caller - identifier of the caller.\n   * @returns {Promise} promise to be resolved with true if the tag is unique, false otherwise.\n   */\n  checkTagUniqueness(tag, caller) {\n    return new Promise((resolve, reject) => {\n      this.subscribe()\n        .then(_ => this.setMeta({\n          desc: {\n            public: tag\n          }\n        }))\n        .then(_ => this.getMeta(this.startMetaQuery().withTags().build()))\n        .then(meta => {\n          if (!meta || !Array.isArray(meta.tags) || meta.tags.length == 0) {\n            resolve(true);\n          }\n          const tags = meta.tags.filter(t => t !== caller);\n          resolve(tags.length == 0);\n        })\n        .catch(err => {\n          reject(err);\n        });\n    });\n  }\n\n  /**\n   * Iterate over found contacts. If callback is undefined, use {@link this.onMetaSub}.\n   * @function\n   * @memberof Tinode.TopicFnd#\n   * @param {TopicFnd.ContactCallback} callback - Callback to call for each contact.\n   * @param {Object} context - Context to use for calling the `callback`, i.e. the value of `this` inside the callback.\n   */\n  contacts(callback, context) {\n    const cb = (callback || this.onMetaSub);\n    if (cb) {\n      for (let idx in this._contacts) {\n        cb.call(context, this._contacts[idx], idx, this._contacts);\n      }\n    }\n  }\n}\n","/**\n * @file Definition of 'me' topic.\n *\n * @copyright 2015-2026 Tinode LLC.\n */\n'use strict';\n\nimport AccessMode from './access-mode.js';\nimport * as Const from './config.js';\nimport Topic from './topic.js';\nimport {\n  mergeObj\n} from './utils.js';\n\n/**\n * @class TopicMe - special case of {@link Tinode.Topic} for\n * managing data of the current user, including contact list.\n * @extends Tinode.Topic\n * @memberof Tinode\n *\n * @param {TopicMe.Callbacks} callbacks - Callbacks to receive various events.\n */\nexport default class TopicMe extends Topic {\n  onContactUpdate;\n\n  constructor(callbacks) {\n    super(Const.TOPIC_ME, callbacks);\n\n    // me-specific callbacks\n    if (callbacks) {\n      this.onContactUpdate = callbacks.onContactUpdate;\n    }\n  }\n\n  // Override the original Topic._processMetaDesc.\n  _processMetaDesc(desc) {\n    // Check if online contacts need to be turned off because P permission was removed.\n    const turnOff = (desc.acs && !desc.acs.isPresencer()) && (this.acs && this.acs.isPresencer());\n\n    // Copy parameters from desc object to this topic.\n    mergeObj(this, desc);\n    this._tinode._db.updTopic(this);\n    // Update current user's record in the global cache.\n    this._updateCachedUser(this._tinode._myUID, desc);\n\n    // 'P' permission was removed. All topics are offline now.\n    if (turnOff) {\n      this._tinode.mapTopics((cont) => {\n        if (cont.online) {\n          cont.online = false;\n          cont.seen = Object.assign(cont.seen || {}, {\n            when: new Date()\n          });\n          this._refreshContact('off', cont);\n        }\n      });\n    }\n\n    if (this.onMetaDesc) {\n      this.onMetaDesc(this);\n    }\n  }\n\n  // Override the original Topic._processMetaSubs\n  _processMetaSubs(subs) {\n    let updateCount = 0;\n    subs.forEach((sub) => {\n      const topicName = sub.topic;\n      // Don't show 'me' and 'fnd' topics in the list of contacts.\n      if (topicName == Const.TOPIC_FND || topicName == Const.TOPIC_ME) {\n        return;\n      }\n      sub.online = !!sub.online;\n\n      let cont = null;\n      if (sub.deleted) {\n        cont = sub;\n        this._tinode.cacheRemTopic(topicName);\n        this._tinode._db.remTopic(topicName);\n      } else {\n        // Ensure the values are defined and are integers.\n        if (typeof sub.seq != 'undefined') {\n          sub.seq = sub.seq | 0;\n          sub.recv = sub.recv | 0;\n          sub.read = sub.read | 0;\n          sub.unread = sub.seq - sub.read;\n        }\n\n        const topic = this._tinode.getTopic(topicName);\n        if (topic._new) {\n          delete topic._new;\n        }\n\n        cont = mergeObj(topic, sub);\n        this._tinode._db.updTopic(cont);\n\n        if (Topic.isP2PTopicName(topicName)) {\n          this._cachePutUser(topicName, cont);\n          this._tinode._db.updUser(topicName, cont.public);\n        }\n        // Notify topic of the update if it's an external update.\n        if (!sub._noForwarding && topic) {\n          sub._noForwarding = true;\n          topic._processMetaDesc(sub);\n        }\n      }\n\n      updateCount++;\n\n      if (this.onMetaSub) {\n        this.onMetaSub(cont);\n      }\n    });\n\n    if (this.onSubsUpdated && updateCount > 0) {\n      const keys = [];\n      subs.forEach((s) => {\n        keys.push(s.topic);\n      });\n      this.onSubsUpdated(keys, updateCount);\n    }\n  }\n\n  // Called by Tinode when meta.sub is received.\n  _processMetaCreds(creds, upd) {\n    if (creds.length == 1 && creds[0] == Const.DEL_CHAR) {\n      creds = [];\n    }\n    if (upd) {\n      creds.forEach((cr) => {\n        if (cr.val) {\n          // Adding a credential.\n          let idx = this._credentials.findIndex((el) => {\n            return el.meth == cr.meth && el.val == cr.val;\n          });\n          if (idx < 0) {\n            // Not found.\n            if (!cr.done) {\n              // Unconfirmed credential replaces previous unconfirmed credential of the same method.\n              idx = this._credentials.findIndex((el) => {\n                return el.meth == cr.meth && !el.done;\n              });\n              if (idx >= 0) {\n                // Remove previous unconfirmed credential.\n                this._credentials.splice(idx, 1);\n              }\n            }\n            this._credentials.push(cr);\n          } else {\n            // Found. Maybe change 'done' status.\n            this._credentials[idx].done = cr.done;\n          }\n        } else if (cr.resp) {\n          // Handle credential confirmation.\n          const idx = this._credentials.findIndex((el) => {\n            return el.meth == cr.meth && !el.done;\n          });\n          if (idx >= 0) {\n            this._credentials[idx].done = true;\n          }\n        }\n      });\n    } else {\n      this._credentials = creds;\n    }\n    if (this.onCredsUpdated) {\n      this.onCredsUpdated(this._credentials);\n    }\n  }\n\n  // Process presence change message\n  _routePres(pres) {\n    if (pres.what == 'term') {\n      // The 'me' topic itself is detached. Mark as unsubscribed.\n      this._resetSub();\n      return;\n    }\n\n    if (pres.what == 'upd' && pres.src == Const.TOPIC_ME) {\n      // Update to me's description. Request updated value.\n      this.getMeta(this.startMetaQuery().withDesc().build());\n      return;\n    }\n\n    const cont = this._tinode.cacheGetTopic(pres.src);\n    if (cont) {\n      switch (pres.what) {\n        case 'on': // topic came online\n          cont.online = true;\n          break;\n        case 'off': // topic went offline\n          if (cont.online) {\n            cont.online = false;\n            cont.seen = Object.assign(cont.seen || {}, {\n              when: new Date()\n            });\n          }\n          break;\n        case 'msg': // new message received\n          cont._updateReceived(pres.seq, pres.act);\n          break;\n        case 'upd': // desc updated\n          // Request updated subscription.\n          this.getMeta(this.startMetaQuery().withLaterOneSub(pres.src).build());\n          break;\n        case 'acs': // access mode changed\n          // If 'tgt' is not set then this is an update to the permissions of the current user.\n          // Otherwise it's an update to group topic subscriber permissions while the topic is offline.\n          // Just ignore it then.\n          if (!pres.tgt) {\n            if (cont.acs) {\n              cont.acs.updateAll(pres.dacs);\n            } else {\n              cont.acs = new AccessMode().updateAll(pres.dacs);\n            }\n            cont.touched = new Date();\n          }\n          break;\n        case 'ua':\n          // user agent changed.\n          cont.seen = {\n            when: new Date(),\n            ua: pres.val\n          };\n          break;\n        case 'recv':\n          // user's other session marked some messges as received.\n          pres.seq = pres.seq | 0;\n          cont.recv = cont.recv ? Math.max(cont.recv, pres.seq) : pres.seq;\n          break;\n        case 'read':\n          // user's other session marked some messages as read.\n          pres.seq = pres.seq | 0;\n          cont.read = cont.read ? Math.max(cont.read, pres.seq) : pres.seq;\n          cont.recv = cont.recv ? Math.max(cont.read, cont.recv) : cont.recv;\n          cont.unread = cont.seq - cont.read;\n          break;\n        case 'gone':\n          // topic deleted or unsubscribed from.\n          this._tinode.cacheRemTopic(pres.src);\n          if (!cont._deleted) {\n            cont._deleted = true;\n            cont._attached = false;\n            this._tinode._db.markTopicAsDeleted(pres.src, true);\n          } else {\n            this._tinode._db.remTopic(pres.src);\n          }\n          break;\n        case 'del':\n          // Update topic.del value.\n          break;\n        case 'react':\n          // Reaction to message.\n          cont._processMetaReact(undefined, {\n            mrrid: pres.id2 | 0,\n            seq: pres.seq,\n            user: pres.actor,\n            val: pres.val\n          });\n          break;\n        default:\n          this._tinode.logger(\"INFO: Unsupported presence update in 'me'\", pres.what);\n      }\n\n      this._refreshContact(pres.what, cont);\n    } else {\n      if (pres.what == 'acs') {\n        // New subscriptions and deleted/banned subscriptions have full\n        // access mode (no + or - in the dacs string). Changes to known subscriptions are sent as\n        // deltas, but they should not happen here.\n        const acs = new AccessMode(pres.dacs);\n        if (!acs || acs.mode == AccessMode._INVALID) {\n          this._tinode.logger(\"ERROR: Invalid access mode update\", pres.src, pres.dacs);\n          return;\n        } else if (acs.mode == AccessMode._NONE) {\n          this._tinode.logger(\"WARNING: Removing non-existent subscription\", pres.src, pres.dacs);\n          return;\n        } else {\n          // New subscription. Send request for the full description.\n          // Using .withOneSub (not .withLaterOneSub) to make sure IfModifiedSince is not set.\n          this.getMeta(this.startMetaQuery().withOneSub(undefined, pres.src).build());\n          // Create a dummy entry to catch online status update.\n          const dummy = this._tinode.getTopic(pres.src);\n          dummy.topic = pres.src;\n          dummy.online = false;\n          dummy.acs = acs;\n          this._tinode._db.updTopic(dummy);\n        }\n      } else if (pres.what == 'tags') {\n        this.getMeta(this.startMetaQuery().withTags().build());\n      } else if (pres.what == 'msg') {\n        // Message received for un unknown (previously deleted) topic.\n        this.getMeta(this.startMetaQuery().withOneSub(undefined, pres.src).build());\n        // Create an entry to catch updates and messages.\n        const dummy = this._tinode.getTopic(pres.src);\n        dummy._deleted = false;\n        this._tinode._db.updTopic(dummy);\n      }\n\n      this._refreshContact(pres.what, cont);\n    }\n\n    if (this.onPres) {\n      this.onPres(pres);\n    }\n  }\n\n  // Contact is updated, execute callbacks.\n  _refreshContact(what, cont) {\n    if (this.onContactUpdate) {\n      this.onContactUpdate(what, cont);\n    }\n  }\n\n  /**\n   * Publishing to TopicMe is not supported. {@link Topic#publish} is overridden and throws an {Error} if called.\n   * @memberof Tinode.TopicMe#\n   * @throws {Error} Always throws an error.\n   */\n  publish() {\n    return Promise.reject(new Error(\"Publishing to 'me' is not supported\"));\n  }\n\n  /**\n   * Delete validation credential.\n   * @memberof Tinode.TopicMe#\n   *\n   * @param {string} method - Validation method such as 'email' or 'tel'.\n   * @param {string} value - Credential value to delete.\n   * @returns {Promise} Promise which will be resolved/rejected on receiving server reply.\n   */\n  delCredential(method, value) {\n    if (!this._attached) {\n      return Promise.reject(new Error(\"Cannot delete credential in inactive 'me' topic\"));\n    }\n    // Send {del} message, return promise\n    return this._tinode.delCredential(method, value).then(ctrl => {\n      // Remove deleted credential from the cache.\n      const index = this._credentials.findIndex((el) => {\n        return el.meth == method && el.val == value;\n      });\n      if (index > -1) {\n        this._credentials.splice(index, 1);\n      }\n      // Notify listeners\n      if (this.onCredsUpdated) {\n        this.onCredsUpdated(this._credentials);\n      }\n      return ctrl;\n    });\n  }\n\n  /**\n   * @callback contactFilter\n   * @param {Object} contact - contact to check for inclusion.\n   * @returns {boolean} <code>true</code> if contact should be processed, <code>false</code> to exclude it.\n   */\n  /**\n   * Iterate over cached contacts.\n   *\n   * @function\n   * @memberof Tinode.TopicMe#\n   * @param {TopicMe.ContactCallback} callback - Callback to call for each contact.\n   * @param {contactFilter=} filter - Optionally filter contacts; include all if filter is false-ish, otherwise\n   *      include those for which filter returns true-ish.\n   * @param {Object=} context - Context to use for calling the `callback`, i.e. the value of `this` inside the callback.\n   */\n  contacts(callback, filter, context) {\n    this._tinode.mapTopics((c, idx) => {\n      if (c.isCommType() && (!filter || filter(c))) {\n        callback.call(context, c, idx);\n      }\n    });\n  }\n\n  /**\n   * Get a contact from cache.\n   * @memberof Tinode.TopicMe#\n   *\n   * @param {string} name - Name of the contact to get, either a UID (for p2p topics) or a topic name.\n   * @returns {Tinode.Contact} - Contact or `undefined`.\n   */\n  getContact(name) {\n    return this._tinode.cacheGetTopic(name);\n  }\n\n  /**\n   * Get access mode of a given contact from cache.\n   * @memberof Tinode.TopicMe#\n   *\n   * @param {string} name - Name of the contact to get access mode for, either a UID (for p2p topics)\n   *        or a topic name; if missing, access mode for the 'me' topic itself.\n   * @returns {string} - access mode, such as `RWP`.\n   */\n  getAccessMode(name) {\n    if (name) {\n      const cont = this._tinode.cacheGetTopic(name);\n      return cont ? cont.acs : null;\n    }\n    return this.acs;\n  }\n\n  /**\n   * Check if contact is archived, i.e. contact.private.arch == true.\n   * @memberof Tinode.TopicMe#\n   *\n   * @param {string} name - Name of the contact to check archived status, either a UID (for p2p topics) or a topic name.\n   * @returns {boolean} - true if contact is archived, false otherwise.\n   */\n  isArchived(name) {\n    const cont = this._tinode.cacheGetTopic(name);\n    return cont && cont.private && !!cont.private.arch;\n  }\n\n  /**\n   * @typedef Tinode.Credential\n   * @memberof Tinode\n   * @type Object\n   * @property {string} meth - validation method such as 'email' or 'tel'.\n   * @property {string} val - credential value, i.e. 'jdoe@example.com' or '+17025551234'\n   * @property {boolean} done - true if credential is validated.\n   */\n  /**\n   * Get the user's credentials: email, phone, etc.\n   * @memberof Tinode.TopicMe#\n   *\n   * @returns {Tinode.Credential[]} - array of credentials.\n   */\n  getCredentials() {\n    return this._credentials;\n  }\n\n  /**\n   * Pin topic to the top of the contact list.\n   * @memberof Tinode.TopicMe#\n   *\n   * @param {string} topic - Name of the topic to pin.\n   * @param {boolean} [pin=false] - If true, pin the topic, otherwise unpin.\n   *\n   * @returns {Promise} Promise to be resolved/rejected when the server responds to request.\n   */\n  pinTopic(topic, pin) {\n    if (!this._attached) {\n      return Promise.reject(new Error(\"Cannot pin topic in inactive 'me' topic\"));\n    }\n    if (!Topic.isCommTopicName(topic)) {\n      return Promise.reject(new Error(\"Invalid topic to pin\"));\n    }\n\n    const tpin = Array.isArray(this.private && this.private.tpin) ? this.private.tpin : [];\n    const found = tpin.includes(topic);\n    if ((pin && found) || (!pin && !found)) {\n      // Nothing to do.\n      return Promise.resolve(tpin);\n    }\n\n    if (pin) {\n      // Add topic to the top of the pinned list.\n      tpin.unshift(topic);\n    } else {\n      // Remove topic from the pinned list.\n      tpin.splice(tpin.indexOf(topic), 1);\n    }\n\n    return this.setMeta({\n      desc: {\n        private: {\n          tpin: tpin.length > 0 ? tpin : Const.DEL_CHAR\n        }\n      }\n    });\n  }\n\n  /**\n   * Get the rank of the pinned topic.\n   * @memberof Tinode.TopicMe#\n   * @param {string} topic - Name of the topic to check.\n   *\n   * @returns {number} numeric rank of the pinned topic in the range 1..N (N being the top,\n   *      N - the number of pinned topics) or 0 if not pinned.\n   */\n  pinnedTopicRank(topic) {\n    if (!this.private || !this.private.tpin) {\n      return 0;\n    }\n    const idx = this.private.tpin.indexOf(topic);\n    return idx < 0 ? 0 : this.private.tpin.length - idx;\n  }\n}\n","/**\n * @file Definition of a contact card, similar to vCard.\n *\n * @copyright 2025-2026 Tinode LLC.\n *\n * TheCard class represents a contact card with various fields such as full name,\n * photo, organization, communication methods, and birthday.\n */\n\n'use strict';\n\nimport {\n  DEL_CHAR\n} from './config.js';\n\nconst THE_CARD_MIME_TYPE = 'text/x-the-card';\n\nexport default class TheCard {\n  /**\n   * Create a new contact card.\n   * @param {string} fn - Full name.\n   * @param {string} imageUrl - Avatar URL or data URL.\n   * @param {string} imageMimeType - MIME type of the avatar image.\n   * @param {string} note - Notes or comments about the contact.\n   */\n  constructor(fn, imageUrl, imageMimeType, note) {\n    Object.assign(this, theCard(fn, imageUrl, imageMimeType, note) || {});\n  }\n\n  /**\n   * Merge another card into this one.\n   * @param {Object} that - Card object to merge.\n   */\n  merge(that) {\n    Object.assign(this, that);\n  }\n\n  /**\n   * Get the MIME type of the card.\n   * @returns {string} The MIME type.\n   */\n  get contentType() {\n    return THE_CARD_MIME_TYPE;\n  }\n\n  /**\n   * Get the size of the card in bytes when serialized as JSON.\n   * @returns {number} Size in bytes.\n   */\n  get size() {\n    return JSON.stringify(this).length;\n  }\n}\n\nTheCard.contentType = THE_CARD_MIME_TYPE;\n\n/**\n * Set the full name on a card.\n * @param {Object} card - The card object.\n * @param {string} fn - Full name to set.\n * @returns {Object} The updated card.\n */\nTheCard.setFn = function(card, fn) {\n  fn = fn && fn.trim();\n  card = card || {};\n  card.fn = fn || undefined;\n  return card;\n}\n\n/**\n * Get the full name from a card.\n * @param {Object} card - The card object.\n * @returns {string|null} The full name or null if not set.\n */\nTheCard.getFn = function(card) {\n  if (card && card.fn) {\n    return card.fn;\n  }\n  return null;\n}\n\n/**\n * Set notes on a card.\n * @param {Object} card - The card object.\n * @param {string} note - Notes to set.\n * @returns {Object} The updated card.\n */\nTheCard.setNote = function(card, note) {\n  note = note && note.trim();\n  card = card || {};\n  card.note = note ? note : DEL_CHAR;\n  return card;\n}\n\n/**\n * Set photo/avatar on a card.\n * @param {Object} card - The card object.\n * @param {string} imageUrl - Image URL or data URL.\n * @param {string} imageMimeType - MIME type of the image.\n * @returns {Object} The updated card.\n */\nTheCard.setPhoto = function(card, imageUrl, imageMimeType) {\n  if (imageUrl) {\n    card = card || {};\n    let mimeType = imageMimeType;\n    // Is this a data URL \"data:[<mediatype>][;base64],<data>\"?\n    const matches = /^data:(image\\/[-a-z0-9+.]+)?(;base64)?,/i.exec(imageUrl);\n    if (matches) {\n      mimeType = matches[1];\n      card.photo = {\n        data: imageUrl.substring(imageUrl.indexOf(',') + 1),\n        ref: DEL_CHAR\n      };\n    } else {\n      card.photo = {\n        data: DEL_CHAR,\n        ref: imageUrl\n      };\n      // Get mime type from URL, if not provided.\n      if (!mimeType) {\n        const ext = /\\.([a-z0-9]+)$/i.exec(imageUrl);\n        if (ext) {\n          const extLower = ext[1].toLowerCase();\n          const mimeMap = {\n            'jpg': 'image/jpeg',\n            'jpeg': 'image/jpeg',\n            'png': 'image/png',\n            'gif': 'image/gif',\n            'bmp': 'image/bmp',\n            'webp': 'image/webp',\n            'svg': 'image/svg+xml'\n          };\n          mimeType = mimeMap[extLower] || null;\n        }\n      }\n    }\n    card.photo.type = (mimeType || 'image/jpeg').substring('image/'.length);\n  } else {\n    card = card || {};\n    card.photo = DEL_CHAR;\n  }\n  return card;\n}\n\n/**\n * Get photo URL from a card.\n * @param {Object} card - The card object.\n * @returns {string|null} Photo URL or data URL, or null if not set.\n */\nTheCard.getPhotoUrl = function(card) {\n  if (card && card.photo) {\n    if (card.photo.ref && card.photo.ref != DEL_CHAR) {\n      return card.photo.ref;\n    } else if (card.photo.data && card.photo.data != DEL_CHAR) {\n      return 'data:image/' + (card.photo.type || 'jpeg') + ';base64,' + card.photo.data;\n    }\n  }\n  return null;\n}\n\n/**\n * Get organization name from a card.\n * @param {Object} card - The card object.\n * @returns {string|null} Organization name or null if not set.\n */\nTheCard.getOrg = function(card) {\n  if (card && card.org) {\n    return card.org.fn || null;\n  }\n  return null;\n}\n\n/**\n * Set a phone number on a card, replacing any existing phone with the same type.\n * @param {Object} card - The card object.\n * @param {string} phone - Phone number.\n * @param {string} [type='voice'] - Type of phone number (e.g., 'voice', 'mobile', 'work').\n * @returns {Object} The updated card.\n */\nTheCard.setPhone = function(card, phone, type = 'voice') {\n  return addOrSetComm(card, 'tel', phone, type, true);\n}\n\n/**\n * Set an email address on a card, replacing any existing email with the same type.\n * @param {Object} card - The card object.\n * @param {string} email - Email address.\n * @param {string} [type='home'] - Type of email (e.g., 'home', 'work').\n * @returns {Object} The updated card.\n */\nTheCard.setEmail = function(card, email, type = 'home') {\n  return addOrSetComm(card, 'email', email, type, true);\n}\n\n/**\n * Set a Tinode ID on a card, replacing any existing ID with the same type.\n * @param {Object} card - The card object.\n * @param {string} tinodeID - Tinode user ID.\n * @param {string} [type='home'] - Type of ID.\n * @returns {Object} The updated card.\n */\nTheCard.setTinodeID = function(card, tinodeID, type = 'home') {\n  return addOrSetComm(card, 'tinode', tinodeID, type, true);\n}\n\n/**\n * Add a phone number to a card without replacing existing ones.\n * @param {Object} card - The card object.\n * @param {string} phone - Phone number.\n * @param {string} [type='voice'] - Type of phone number.\n * @returns {Object} The updated card.\n */\nTheCard.addPhone = function(card, phone, type = 'voice') {\n  return addOrSetComm(card, 'tel', phone, type, false);\n}\n\n/**\n * Add an email address to a card without replacing existing ones.\n * @param {Object} card - The card object.\n * @param {string} email - Email address.\n * @param {string} [type='home'] - Type of email.\n * @returns {Object} The updated card.\n */\nTheCard.addEmail = function(card, email, type = 'home') {\n  return addOrSetComm(card, 'email', email, type, false);\n}\n\n/**\n * Add a Tinode ID to a card without replacing existing ones.\n * @param {Object} card - The card object.\n * @param {string} tinodeID - Tinode user ID.\n * @param {string} [type='home'] - Type of ID.\n * @returns {Object} The updated card.\n */\nTheCard.addTinodeID = function(card, tinodeID, type = 'home') {\n  return addOrSetComm(card, 'tinode', tinodeID, type, false);\n}\n\n/**\n * Remove phone number(s) from a card.\n * @param {Object} card - The card object.\n * @param {string} phone - Phone number to remove (optional).\n * @param {string} type - Type of phone to remove (optional).\n * @returns {Object} The updated card.\n */\nTheCard.clearPhone = function(card, phone, type) {\n  return clearComm(card, 'tel', phone, type);\n}\n\n/**\n * Remove email address(es) from a card.\n * @param {Object} card - The card object.\n * @param {string} email - Email to remove (optional).\n * @param {string} type - Type of email to remove (optional).\n * @returns {Object} The updated card.\n */\nTheCard.clearEmail = function(card, email, type) {\n  return clearComm(card, 'email', email, type);\n}\n\n/**\n * Remove Tinode ID(s) from a card.\n * @param {Object} card - The card object.\n * @param {string} tinodeID - Tinode ID to remove (optional).\n * @param {string} type - Type of ID to remove (optional).\n * @returns {Object} The updated card.\n */\nTheCard.clearTinodeID = function(card, tinodeID, type) {\n  return clearComm(card, 'tinode', tinodeID, type);\n}\n\n/**\n * Get all communication methods of a specific protocol from a card.\n * @param {Object} card - The card object.\n * @param {string} proto - Protocol ('tel', 'email', 'tinode', 'http').\n * @returns {Array} Array of communication entries matching the protocol.\n */\nTheCard.getComm = function(card, proto) {\n  if (card && Array.isArray(card.comm)) {\n    return card.comm.filter(c => c.proto == proto);\n  }\n  return [];\n}\n\n/**\n * Get all email addresses from a card.\n * @param {Object} card - The card object.\n * @returns {Array<string>} Array of email addresses.\n */\nTheCard.getEmails = function(card) {\n  return TheCard.getComm(card, 'email').map(c => c.value);\n}\n\n/**\n * Get all phone numbers from a card.\n * @param {Object} card - The card object.\n * @returns {Array<string>} Array of phone numbers.\n */\nTheCard.getPhones = function(card) {\n  return TheCard.getComm(card, 'tel').map(c => c.value);\n}\n\n/**\n * Get the first Tinode ID from a card.\n * @param {Object} card - The card object.\n * @returns {string|null} The first Tinode ID or null if none.\n */\nTheCard.getFirstTinodeID = function(card) {\n  const comms = TheCard.getComm(card, 'tinode');\n  if (comms.length > 0) {\n    return comms[0].value;\n  }\n  return null;\n}\n\n/**\n * Export a card as vCard 3.0 format string.\n * @param {Object} card - The card object to export.\n * @returns {string|null} vCard formatted string or null if card is empty.\n */\nTheCard.exportVCard = function(card) {\n  if (!card) {\n    return null;\n  }\n\n  let vcard = 'BEGIN:VCARD\\r\\nVERSION:3.0\\r\\n';\n\n  if (card.fn) {\n    vcard += `FN:${card.fn}\\r\\n`;\n  }\n\n  if (card.n) {\n    vcard += `N:${card.n.surname || ''};${card.n.given || ''};${card.n.additional || ''};${card.n.prefix || ''};${card.n.suffix || ''}\\r\\n`;\n  }\n\n  if (card.org) {\n    if (card.org.fn) {\n      vcard += `ORG:${card.org.fn}\\r\\n`;\n    }\n    if (card.org.title) {\n      vcard += `TITLE:${card.org.title}\\r\\n`;\n    }\n  }\n\n  if (card.note && card.note != DEL_CHAR) {\n    vcard += `NOTE:${card.note}\\r\\n`;\n  }\n\n  if (card.bday && card.bday.m && card.bday.d) {\n    // Format as YYYY-MM-DD or --MM-DD if no year\n    const year = card.bday.y ? String(card.bday.y).padStart(4, '0') : '--';\n    const month = String(card.bday.m).padStart(2, '0');\n    const day = String(card.bday.d).padStart(2, '0');\n    vcard += `BDAY:${year}-${month}-${day}\\r\\n`;\n  }\n\n  if (card.photo) {\n    if (card.photo.ref && card.photo.ref != DEL_CHAR) {\n      vcard += `PHOTO;VALUE=URI:${card.photo.ref}\\r\\n`;\n    } else if (card.photo.data && card.photo.data != DEL_CHAR) {\n      vcard += `PHOTO;TYPE=${card.photo.type.toUpperCase()};ENCODING=b:${card.photo.data}\\r\\n`;\n    }\n  }\n\n  if (Array.isArray(card.comm)) {\n    card.comm.forEach(comm => {\n      const types = comm.des.join(',').toUpperCase();\n      if (comm.proto === 'tel') {\n        vcard += `TEL;TYPE=${types}:${comm.value}\\r\\n`;\n      } else if (comm.proto === 'email') {\n        vcard += `EMAIL;TYPE=${types}:${comm.value}\\r\\n`;\n      } else if (comm.proto === 'tinode') {\n        vcard += `IMPP;TYPE=${types};tinode:${comm.value}\\r\\n`;\n      } else if (comm.proto === 'http') {\n        vcard += `URL;TYPE=${types}:${comm.value}\\r\\n`;\n      }\n    });\n  }\n\n  vcard += 'END:VCARD\\r\\n';\n  return vcard;\n}\n\n/**\n * Import a vCard formatted string and convert it to a card object.\n * Supports vCard 2.1 and 3.0 formats with various field encodings.\n * @param {string} vcardStr - vCard formatted string.\n * @returns {Object|null} Parsed card object or null if invalid.\n */\nTheCard.importVCard = function(vcardStr) {\n  if (!vcardStr || typeof vcardStr !== 'string') {\n    return null;\n  }\n\n  // Handle line folding: lines starting with space or tab are continuations\n  // Also handle Quoted-Printable soft line breaks (line ending with =)\n  const rawLines = vcardStr.split(/\\r\\n|\\n/);\n  const lines = [];\n  let currentLine = '';\n\n  for (let i = 0; i < rawLines.length; i++) {\n    const line = rawLines[i];\n    if (line.startsWith(' ') || line.startsWith('\\t')) {\n      // This is a vCard continuation of the previous line\n      currentLine += line.substring(1);\n    } else if (currentLine.endsWith('=')) {\n      // This is a Quoted-Printable soft line break\n      // Remove the trailing = and append the next line directly\n      currentLine = currentLine.substring(0, currentLine.length - 1) + line;\n    } else {\n      if (currentLine) {\n        lines.push(currentLine);\n      }\n      currentLine = line;\n    }\n  }\n  if (currentLine) {\n    lines.push(currentLine);\n  }\n\n  let card = {};\n  // Temporary map to collect and dedupe comm entries\n  const commMap = new Map(); // key: \"proto:value\", value: Set of types\n\n  // Helper to unescape vCard text values (unescape \\, \\; \\\\ \\n)\n  const unescapeValue = (val) => {\n    return val.replace(/\\\\([,;\\\\n])/g, (match, char) => {\n      if (char === 'n') return '\\n';\n      return char;\n    });\n  };\n\n  // Helper to decode Quoted-Printable encoding\n  const decodeQuotedPrintable = (val) => {\n    // Decode =XX sequences to bytes, then decode as UTF-8\n    // First collect all bytes\n    const bytes = [];\n    let i = 0;\n    while (i < val.length) {\n      if (val[i] === '=' && i + 2 < val.length) {\n        const hex = val.substring(i + 1, i + 3);\n        if (/^[0-9A-F]{2}$/i.test(hex)) {\n          bytes.push(parseInt(hex, 16));\n          i += 3;\n        } else {\n          // Not a valid hex sequence, keep the character as-is\n          bytes.push(val.charCodeAt(i));\n          i++;\n        }\n      } else {\n        bytes.push(val.charCodeAt(i));\n        i++;\n      }\n    }\n\n    // Decode UTF-8 bytes to string\n    try {\n      const uint8Array = new Uint8Array(bytes);\n      return new TextDecoder('utf-8').decode(uint8Array);\n    } catch (e) {\n      // Fallback if TextDecoder is not available\n      return val.replace(/=([0-9A-F]{2})/gi, (match, hex) => {\n        return String.fromCharCode(parseInt(hex, 16));\n      });\n    }\n  };\n\n  lines.forEach(line => {\n    const [keyPart, ...valueParts] = line.split(':');\n    if (!keyPart || valueParts.length === 0) {\n      return;\n    }\n    const value = valueParts.join(':');\n\n    const keyParams = keyPart.split(';');\n    const key = keyParams[0].trim().toUpperCase();\n\n    // Check if QUOTED-PRINTABLE encoding is specified\n    const isQuotedPrintable = keyParams.some(param =>\n      param.trim().toUpperCase() === 'QUOTED-PRINTABLE' ||\n      param.trim().toUpperCase() === 'ENCODING=QUOTED-PRINTABLE'\n    );\n\n    if (key === 'FN') {\n      let processedValue = value;\n      if (isQuotedPrintable) {\n        processedValue = decodeQuotedPrintable(processedValue);\n      }\n      card.fn = unescapeValue(processedValue);\n    } else if (key === 'N') {\n      let processedValue = value;\n      if (isQuotedPrintable) {\n        processedValue = decodeQuotedPrintable(processedValue);\n      }\n      const parts = processedValue.split(';');\n      card.n = {\n        surname: parts[0] ? unescapeValue(parts[0]) : undefined,\n        given: parts[1] ? unescapeValue(parts[1]) : undefined,\n        additional: parts[2] ? unescapeValue(parts[2]) : undefined,\n        prefix: parts[3] ? unescapeValue(parts[3]) : undefined,\n        suffix: parts[4] ? unescapeValue(parts[4]) : undefined,\n      };\n      // Clean up undefined properties.\n      Object.keys(card.n).forEach(key => card.n[key] === undefined && delete card.n[key]);\n      if (Object.keys(card.n).length === 0) {\n        delete card.n;\n      }\n    } else if (key === 'ORG') {\n      // Multiple values are separated by semicolon. We only use the first one as distinct name.\n      // The second one is usually the department, which we skip.\n      let processedValue = value;\n      if (isQuotedPrintable) {\n        processedValue = decodeQuotedPrintable(processedValue);\n      }\n      const parts = processedValue.split(';');\n      card.org = card.org || {};\n      card.org.fn = parts[0] ? unescapeValue(parts[0]) : undefined;\n      if (!card.org.fn) delete card.org.fn;\n    } else if (key === 'TITLE') {\n      let processedValue = value;\n      if (isQuotedPrintable) {\n        processedValue = decodeQuotedPrintable(processedValue);\n      }\n      card.org = card.org || {};\n      card.org.title = processedValue ? unescapeValue(processedValue) : undefined;\n      if (!card.org.title) delete card.org.title;\n    } else if (key === 'NOTE') {\n      let processedValue = value;\n      if (isQuotedPrintable) {\n        processedValue = decodeQuotedPrintable(processedValue);\n      }\n      card.note = unescapeValue(processedValue);\n    } else if (key === 'BDAY') {\n      // Parse birthday in various formats\n      // Strip time if present (anything after T or space)\n      let dateStr = value.split(/[T ]/)[0].trim();\n\n      let year = null;\n      let month = null;\n      let day = null;\n\n      // Remove hyphens for easier parsing\n      const noHyphens = dateStr.replace(/-/g, '');\n\n      if (noHyphens.length === 6 && /^\\d{6}$/.test(noHyphens)) {\n        // YYMMDD format\n        const yy = parseInt(noHyphens.substring(0, 2), 10);\n        month = parseInt(noHyphens.substring(2, 4), 10);\n        day = parseInt(noHyphens.substring(4, 6), 10);\n        // If YY >= 35, it's 19XX, otherwise 20XX\n        year = yy >= 35 ? 1900 + yy : 2000 + yy;\n      } else if (dateStr.startsWith('--') || dateStr.startsWith('----')) {\n        // --MMDD or ----MMDD format (no year)\n        const cleaned = dateStr.replace(/^-+/, '');\n        if (cleaned.length === 4 && /^\\d{4}$/.test(cleaned)) {\n          month = parseInt(cleaned.substring(0, 2), 10);\n          day = parseInt(cleaned.substring(2, 4), 10);\n        } else if (cleaned.includes('-')) {\n          const parts = cleaned.split('-');\n          if (parts.length >= 2) {\n            month = parseInt(parts[0], 10);\n            day = parseInt(parts[1], 10);\n          }\n        }\n      } else if (noHyphens.length === 8 && /^\\d{8}$/.test(noHyphens)) {\n        // YYYYMMDD format\n        year = parseInt(noHyphens.substring(0, 4), 10);\n        month = parseInt(noHyphens.substring(4, 6), 10);\n        day = parseInt(noHyphens.substring(6, 8), 10);\n      } else if (dateStr.includes('-')) {\n        // YYYY-MM-DD format\n        const parts = dateStr.split('-');\n        if (parts[0] && parts[0] !== '' && !/^-+$/.test(parts[0])) {\n          year = parseInt(parts[0], 10);\n        }\n        if (parts.length >= 2) {\n          month = parseInt(parts[1], 10);\n        }\n        if (parts.length >= 3) {\n          day = parseInt(parts[2], 10);\n        }\n      }\n\n      // Basic validation\n      const isValidMonth = month && month >= 1 && month <= 12;\n      const isValidDay = day && day >= 1 && day <= 31;\n      const isValidYear = !year || (year >= 1800 && year <= 2200);\n\n      if (isValidMonth && isValidDay && isValidYear) {\n        card.bday = {\n          m: month,\n          d: day\n        };\n        if (year) {\n          card.bday.y = year;\n        }\n      }\n    } else if (key === 'PHOTO') {\n      const params = keyPart.split(';').slice(1);\n      let type = 'jpeg';\n      let encoding = null;\n      params.forEach(param => {\n        const [pKey, pValue] = param.split('=');\n        if (pKey && pKey.trim().toUpperCase() === 'TYPE') {\n          type = pValue ? pValue.trim().toLowerCase() : 'jpeg';\n        } else if (pKey && pKey.trim().toUpperCase() === 'ENCODING') {\n          encoding = pValue ? pValue.trim().toLowerCase() : null;\n        }\n      });\n      if (encoding === 'b') {\n        card.photo = {\n          type: type,\n          data: value,\n          ref: DEL_CHAR\n        };\n      } else {\n        card.photo = {\n          type: type,\n          data: DEL_CHAR,\n          ref: value\n        };\n      }\n    } else if (key === 'TEL') {\n      // Extract all TYPE values (can be comma-separated or multiple TYPE= params)\n      const typeParams = keyPart.split(';').filter(param => param.trim().toUpperCase().startsWith('TYPE='));\n      const types = typeParams.flatMap(param => {\n        // Split by first '=' only to get the value part\n        const equalIndex = param.indexOf('=');\n        const valuesPart = param.substring(equalIndex + 1);\n        // Split by comma and clean up any 'TYPE=' prefix\n        return valuesPart.split(',').map(t => {\n          const cleaned = t.trim().toLowerCase();\n          return cleaned.startsWith('type=') ? cleaned.substring(5) : cleaned;\n        });\n      }).filter(t => t !== 'internet'); // Skip 'internet' type\n\n      const mapKey = `tel|${value}`;\n      if (!commMap.has(mapKey)) {\n        commMap.set(mapKey, new Set());\n      }\n      types.forEach(t => commMap.get(mapKey).add(t));\n    } else if (key === 'EMAIL') {\n      // Extract all TYPE values (can be comma-separated or multiple TYPE= params)\n      const typeParams = keyPart.split(';').filter(param => param.trim().toUpperCase().startsWith('TYPE='));\n      const types = typeParams.flatMap(param => {\n        // Split by first '=' only to get the value part\n        const equalIndex = param.indexOf('=');\n        const valuesPart = param.substring(equalIndex + 1);\n        // Split by comma and clean up any 'TYPE=' prefix\n        return valuesPart.split(',').map(t => {\n          const cleaned = t.trim().toLowerCase();\n          return cleaned.startsWith('type=') ? cleaned.substring(5) : cleaned;\n        });\n      }).filter(t => t !== 'internet'); // Skip 'internet' type\n\n      const mapKey = `email|${value}`;\n      if (!commMap.has(mapKey)) {\n        commMap.set(mapKey, new Set());\n      }\n      types.forEach(t => commMap.get(mapKey).add(t));\n    } else if (key === 'IMPP') {\n      // Extract all TYPE values (can be comma-separated or multiple TYPE= params)\n      const typeParams = keyPart.split(';').filter(param => param.trim().toUpperCase().startsWith('TYPE='));\n      const types = typeParams.flatMap(param => {\n        // Split by first '=' only to get the value part\n        const equalIndex = param.indexOf('=');\n        const valuesPart = param.substring(equalIndex + 1);\n        // Split by comma and clean up any 'TYPE=' prefix\n        return valuesPart.split(',').map(t => {\n          const cleaned = t.trim().toLowerCase();\n          return cleaned.startsWith('type=') ? cleaned.substring(5) : cleaned;\n        });\n      }).filter(t => t !== 'internet'); // Skip 'internet' type\n\n      const tinodeID = value.replace(/^tinode:/, '');\n      const mapKey = `tinode|${tinodeID}`;\n      if (!commMap.has(mapKey)) {\n        commMap.set(mapKey, new Set());\n      }\n      types.forEach(t => commMap.get(mapKey).add(t));\n    } else if (key === 'URL') {\n      // Extract all TYPE values (can be comma-separated or multiple TYPE= params)\n      const typeParams = keyPart.split(';').filter(param => param.trim().toUpperCase().startsWith('TYPE='));\n      const types = typeParams.flatMap(param => {\n        // Split by first '=' only to get the value part\n        const equalIndex = param.indexOf('=');\n        const valuesPart = param.substring(equalIndex + 1);\n        // Split by comma and clean up any 'TYPE=' prefix\n        return valuesPart.split(',').map(t => {\n          const cleaned = t.trim().toLowerCase();\n          return cleaned.startsWith('type=') ? cleaned.substring(5) : cleaned;\n        });\n      }).filter(t => t !== 'internet'); // Skip 'internet' type\n\n      const mapKey = `http|${value}`;\n      if (!commMap.has(mapKey)) {\n        commMap.set(mapKey, new Set());\n      }\n      types.forEach(t => commMap.get(mapKey).add(t));\n    }\n  });\n\n  // Convert commMap to comm array\n  if (commMap.size > 0) {\n    card.comm = [];\n    commMap.forEach((types, key) => {\n      const [proto, value] = key.split('|', 2);\n      card.comm.push({\n        proto: proto,\n        des: Array.from(types),\n        value: value\n      });\n    });\n  }\n\n  return card;\n}\n\n/**\n * Check if a file type or name is a supported vCard format.\n * @param {string} type - MIME type of the file.\n * @param {string} name - File name.\n * @returns {boolean} True if the file is a vCard format.\n */\nTheCard.isFileSupported = function(type, name) {\n  return type == 'text/vcard' ||\n    (name || '').endsWith('.vcf') ||\n    (name || '').endsWith('.vcard');\n}\n\nfunction theCard(fn, imageUrl, imageMimeType, note) {\n  let card = null;\n  fn = fn && fn.trim();\n  note = note && note.trim();\n\n  if (fn) {\n    card = {\n      fn: fn\n    };\n  }\n\n  if (typeof note == 'string') {\n    card = card || {};\n    card.note = note ? note : DEL_CHAR;\n  }\n\n  if (imageUrl) {\n    card = card || {};\n    let mimeType = imageMimeType;\n    // Is this a data URL \"data:[<mediatype>][;base64],<data>\"?\n    const matches = /^data:(image\\/[-a-z0-9+.]+)?(;base64)?,/i.exec(imageUrl);\n    if (matches) {\n      mimeType = matches[1];\n      card.photo = {\n        data: imageUrl.substring(imageUrl.indexOf(',') + 1),\n        ref: DEL_CHAR\n      };\n    } else {\n      card.photo = {\n        data: DEL_CHAR,\n        ref: imageUrl\n      };\n    }\n    card.photo.type = (mimeType || 'image/jpeg').substring('image/'.length);\n  }\n\n  return card;\n}\n\nfunction addOrSetComm(card, proto, value, type, setOnly) {\n  proto = proto && proto.trim();\n  value = value && value.trim();\n  if (proto && value) {\n    card = card || {};\n    card.comm = card.comm || [];\n    if (setOnly) {\n      // Remove existing entries with the same proto and type.\n      card.comm = card.comm.filter(c => {\n        if (c.proto != proto) return true;\n        return !c.des.includes(type);\n      });\n    }\n    card.comm.push({\n      proto: proto,\n      des: [type], // Always use array\n      value: value\n    });\n  }\n  return card;\n}\n\nfunction clearComm(card, proto, value, type) {\n  if (card && Array.isArray(card.comm)) {\n    card.comm = card.comm.filter(c => {\n      if (c.proto != proto) return true;\n      if (value && c.value != value) return true;\n      if (type) {\n        return !c.des.includes(type);\n      }\n      return false;\n    });\n  }\n  return card;\n}\n","/**\n * @module tinode-sdk\n *\n * @copyright 2015-2026 Tinode LLC.\n * @summary Javascript bindings for Tinode.\n * @license Apache 2.0\n * @version 0.25\n *\n * See <a href=\"https://github.com/tinode/webapp\">https://github.com/tinode/webapp</a> for real-life usage.\n *\n * @example\n * <head>\n * <script src=\".../tinode.js\"></script>\n * </head>\n *\n * <body>\n *  ...\n * <script>\n *  // Instantiate tinode.\n *  const tinode = new Tinode(config, _ => {\n *    // Called on init completion.\n *  });\n *  tinode.enableLogging(true);\n *  tinode.onDisconnect = err => {\n *    // Handle disconnect.\n *  };\n *  // Connect to the server.\n *  tinode.connect('https://example.com/').then(_ => {\n *    // Connected. Login now.\n *    return tinode.loginBasic(login, password);\n *  }).then(ctrl => {\n *    // Logged in fine, attach callbacks, subscribe to 'me'.\n *    const me = tinode.getMeTopic();\n *    me.onMetaDesc = function(meta) { ... };\n *    // Subscribe, fetch topic description and the list of contacts.\n *    me.subscribe({get: {desc: {}, sub: {}}});\n *  }).catch(err => {\n *    // Login or subscription failed, do something.\n *    ...\n *  });\n *  ...\n * </script>\n * </body>\n */\n'use strict';\n\n// NOTE TO DEVELOPERS:\n// Localizable strings should be double quoted \"   \",\n// non-localizable strings should be single quoted 'non-localized'.\n\nimport AccessMode from './access-mode.js';\nimport * as Const from './config.js';\nimport CommError from './comm-error.js';\nimport Connection from './connection.js';\nimport DBCache from './db.js';\nimport Drafty from './drafty.js';\nimport LargeFileHelper from './large-file.js';\nimport MetaGetBuilder from './meta-builder.js';\nimport Topic from './topic.js';\nimport TopicFnd from './fnd-topic.js';\nimport TopicMe from './me-topic.js';\n\nimport TheCard from './the-card.js';\nimport {\n  isUrlRelative,\n  jsonParseHelper,\n  mergeObj,\n  rfc3339DateString,\n  simplify\n} from './utils.js';\n\n// Re-export AccessMode\nexport {\n  AccessMode\n};\n\n// Re-export TheCard\nexport {\n  TheCard\n};\n\nlet WebSocketProvider;\nif (typeof WebSocket != 'undefined') {\n  WebSocketProvider = WebSocket;\n}\n\nlet XHRProvider;\nif (typeof XMLHttpRequest != 'undefined') {\n  XHRProvider = XMLHttpRequest;\n}\n\nlet IndexedDBProvider;\nif (typeof indexedDB != 'undefined') {\n  IndexedDBProvider = indexedDB;\n}\n\n// Re-export Drafty.\nexport {\n  Drafty\n}\n\ninitForNonBrowserApp();\n\n// Utility functions\n\n// Polyfill for non-browser context, e.g. NodeJs.\nfunction initForNonBrowserApp() {\n  // Tinode requirement in native mode because react native doesn't provide Base64 method\n  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=';\n\n  if (typeof btoa == 'undefined') {\n    global.btoa = function(input = '') {\n      let str = input;\n      let output = '';\n\n      for (let block = 0, charCode, i = 0, map = chars; str.charAt(i | 0) || (map = '=', i % 1); output += map.charAt(63 & block >> 8 - i % 1 * 8)) {\n\n        charCode = str.charCodeAt(i += 3 / 4);\n\n        if (charCode > 0xFF) {\n          throw new Error(\"'btoa' failed: The string to be encoded contains characters outside of the Latin1 range.\");\n        }\n        block = block << 8 | charCode;\n      }\n\n      return output;\n    };\n  }\n\n  if (typeof atob == 'undefined') {\n    global.atob = function(input = '') {\n      let str = input.replace(/=+$/, '');\n      let output = '';\n\n      if (str.length % 4 == 1) {\n        throw new Error(\"'atob' failed: The string to be decoded is not correctly encoded.\");\n      }\n      for (let bc = 0, bs = 0, buffer, i = 0; buffer = str.charAt(i++);\n\n        ~buffer && (bs = bc % 4 ? bs * 64 + buffer : buffer,\n          bc++ % 4) ? output += String.fromCharCode(255 & bs >> (-2 * bc & 6)) : 0\n      ) {\n        buffer = chars.indexOf(buffer);\n      }\n\n      return output;\n    };\n  }\n\n  if (typeof window == 'undefined') {\n    global.window = {\n      WebSocket: WebSocketProvider,\n      XMLHttpRequest: XHRProvider,\n      indexedDB: IndexedDBProvider,\n      URL: {\n        createObjectURL: function() {\n          throw new Error(\"Unable to use URL.createObjectURL in a non-browser application\");\n        }\n      }\n    }\n  }\n\n  Connection.setNetworkProviders(WebSocketProvider, XHRProvider);\n  LargeFileHelper.setNetworkProvider(XHRProvider);\n  DBCache.setDatabaseProvider(IndexedDBProvider);\n}\n\n// Detect find most useful network transport.\nfunction detectTransport() {\n  if (typeof window == 'object') {\n    if (window['WebSocket']) {\n      return 'ws';\n    } else if (window['XMLHttpRequest']) {\n      // The browser or node has no websockets, using long polling.\n      return 'lp';\n    }\n  }\n  return null;\n}\n\n// btoa replacement. Stock btoa fails on on non-Latin1 strings.\nfunction b64EncodeUnicode(str) {\n  // The encodeURIComponent percent-encodes UTF-8 string,\n  // then the percent encoding is converted into raw bytes which\n  // can be fed into btoa.\n  return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,\n    function toSolidBytes(match, p1) {\n      return String.fromCharCode('0x' + p1);\n    }));\n}\n\n// JSON stringify helper - pre-processor for JSON.stringify\nfunction jsonBuildHelper(key, val) {\n  if (val instanceof Date) {\n    // Convert javascript Date objects to rfc3339 strings\n    val = rfc3339DateString(val);\n  } else if (val instanceof AccessMode) {\n    val = val.jsonHelper();\n  } else if (val === undefined || val === null || val === false ||\n    (Array.isArray(val) && val.length == 0) ||\n    ((typeof val == 'object') && (Object.keys(val).length == 0))) {\n    // strip out empty elements while serializing objects to JSON\n    return undefined;\n  }\n\n  return val;\n};\n\n// Trims very long strings (encoded images) to make logged packets more readable.\nfunction jsonLoggerHelper(key, val) {\n  if (typeof val == 'string' && val.length > 128) {\n    return '<' + val.length + ', bytes: ' + val.substring(0, 12) + '...' + val.substring(val.length - 12) + '>';\n  }\n  return jsonBuildHelper(key, val);\n};\n\n// Parse browser user agent to extract browser name and version.\nfunction getBrowserInfo(ua, product) {\n  ua = ua || '';\n  let reactnative = '';\n  // Check if this is a ReactNative app.\n  if (/reactnative/i.test(product)) {\n    reactnative = 'ReactNative; ';\n  }\n  let result;\n  // Remove useless string.\n  ua = ua.replace(' (KHTML, like Gecko)', '');\n  // Test for WebKit-based browser.\n  let m = ua.match(/(AppleWebKit\\/[.\\d]+)/i);\n  if (m) {\n    // List of common strings, from more useful to less useful.\n    // All unknown strings get the highest (-1) priority.\n    const priority = ['edg', 'chrome', 'safari', 'mobile', 'version'];\n    let tmp = ua.substr(m.index + m[0].length).split(' ');\n    let tokens = [];\n    let version; // 1.0 in Version/1.0 or undefined;\n    // Split string like 'Name/0.0.0' into ['Name', '0.0.0', 3] where the last element is the priority.\n    for (let i = 0; i < tmp.length; i++) {\n      let m2 = /([\\w.]+)[\\/]([\\.\\d]+)/.exec(tmp[i]);\n      if (m2) {\n        // Unknown values are highest priority (-1).\n        tokens.push([m2[1], m2[2], priority.findIndex((e) => {\n          return m2[1].toLowerCase().startsWith(e);\n        })]);\n        if (m2[1] == 'Version') {\n          version = m2[2];\n        }\n      }\n    }\n    // Sort by priority: more interesting is earlier than less interesting.\n    tokens.sort((a, b) => {\n      return a[2] - b[2];\n    });\n    if (tokens.length > 0) {\n      // Return the least common browser string and version.\n      if (tokens[0][0].toLowerCase().startsWith('edg')) {\n        tokens[0][0] = 'Edge';\n      } else if (tokens[0][0] == 'OPR') {\n        tokens[0][0] = 'Opera';\n      } else if (tokens[0][0] == 'Safari' && version) {\n        tokens[0][1] = version;\n      }\n      result = tokens[0][0] + '/' + tokens[0][1];\n    } else {\n      // Failed to ID the browser. Return the webkit version.\n      result = m[1];\n    }\n  } else if (/firefox/i.test(ua)) {\n    m = /Firefox\\/([.\\d]+)/g.exec(ua);\n    if (m) {\n      result = 'Firefox/' + m[1];\n    } else {\n      result = 'Firefox/?';\n    }\n  } else {\n    // Neither AppleWebKit nor Firefox. Try the last resort.\n    m = /([\\w.]+)\\/([.\\d]+)/.exec(ua);\n    if (m) {\n      result = m[1] + '/' + m[2];\n    } else {\n      m = ua.split(' ');\n      result = m[0];\n    }\n  }\n\n  // Shorten the version to one dot 'a.bb.ccc.d -> a.bb' at most.\n  m = result.split('/');\n  if (m.length > 1) {\n    const v = m[1].split('.');\n    const minor = v[1] ? '.' + v[1].substr(0, 2) : '';\n    result = `${m[0]}/${v[0]}${minor}`;\n  }\n  return reactnative + result;\n}\n\n/**\n * The main class for interacting with Tinode server.\n */\nexport class Tinode {\n  _host;\n  _secure;\n\n  _appName;\n\n  // API Key.\n  _apiKey;\n\n  // Name and version of the browser.\n  _browser = '';\n  _platform;\n  // Hardware\n  _hwos = 'undefined';\n  _humanLanguage = 'xx';\n\n  // Logging to console enabled\n  _loggingEnabled = false;\n  // When logging, trip long strings (base64-encoded images) for readability\n  _trimLongStrings = false;\n  // UID of the currently authenticated user.\n  _myUID = null;\n  // Status of connection: authenticated or not.\n  _authenticated = false;\n  // Login used in the last successful basic authentication\n  _login = null;\n  // Token which can be used for login instead of login/password.\n  _authToken = null;\n  // Counter of received packets\n  _inPacketCount = 0;\n  // Counter for generating unique message IDs\n  _messageId = Math.floor((Math.random() * 0xFFFF) + 0xFFFF);\n  // Information about the server, if connected\n  _serverInfo = null;\n  // Push notification token. Called deviceToken for consistency with the Android SDK.\n  _deviceToken = null;\n\n  // Cache of pending promises by message id.\n  _pendingPromises = {};\n  // The Timeout object returned by the reject expired promises setInterval.\n  _expirePromises = null;\n\n  // Websocket or long polling connection.\n  _connection = null;\n\n  // Use indexDB for caching topics and messages.\n  _persist = false;\n  // IndexedDB wrapper object.\n  _db = null;\n\n  // Tinode's cache of objects\n  _cache = {};\n\n  /**\n   * Create Tinode object.\n   *\n   * @param {Object} config - configuration parameters.\n   * @param {string} config.appName - Name of the calling application to be reported in the User Agent.\n   * @param {string} config.host - Host name and optional port number to connect to.\n   * @param {string} config.apiKey - API key generated by <code>keygen</code>.\n   * @param {string} config.transport - See {@link Tinode.Connection#transport}.\n   * @param {boolean} config.secure - Use Secure WebSocket if <code>true</code>.\n   * @param {string} config.platform - Optional platform identifier, one of <code>\"ios\"</code>, <code>\"web\"</code>, <code>\"android\"</code>.\n   * @param {boolean} config.persist - Use IndexedDB persistent storage.\n   * @param {function} onComplete - callback to call when initialization is completed.\n   */\n  constructor(config, onComplete) {\n    this._host = config.host;\n    this._secure = config.secure;\n\n    // Client-provided application name, format <Name>/<version number>\n    this._appName = config.appName || \"Undefined\";\n\n    // API Key.\n    this._apiKey = config.apiKey;\n\n    // Name and version of the browser.\n    this._platform = config.platform || 'web';\n    // Underlying OS.\n    if (typeof navigator != 'undefined') {\n      this._browser = getBrowserInfo(navigator.userAgent, navigator.product);\n      this._hwos = navigator.platform;\n      // This is the default language. It could be changed by client.\n      this._humanLanguage = navigator.language || 'en-US';\n    }\n\n    Connection.logger = this.logger;\n    Drafty.logger = this.logger;\n\n    // WebSocket or long polling network connection.\n    if (config.transport != 'lp' && config.transport != 'ws') {\n      config.transport = detectTransport();\n    }\n    this._connection = new Connection(config, Const.PROTOCOL_VERSION, /* autoreconnect */ true);\n    this._connection.onMessage = (data) => {\n      // Call the main message dispatcher.\n      this.#dispatchMessage(data);\n    }\n\n    // Ready to start sending.\n    this._connection.onOpen = _ => this.#connectionOpen();\n    this._connection.onDisconnect = (err, code) => this.#disconnected(err, code);\n\n    // Wrapper for the reconnect iterator callback.\n    this._connection.onAutoreconnectIteration = (timeout, promise) => {\n      if (this.onAutoreconnectIteration) {\n        this.onAutoreconnectIteration(timeout, promise);\n      }\n    }\n\n    this._persist = config.persist;\n    // Initialize object regardless. It simplifies the code.\n    this._db = new DBCache(this.logger, this.logger);\n\n    if (this._persist) {\n      // Create the persistent cache.\n      // Store promises to be resolved when messages load into memory.\n      const prom = [];\n      this._db.initDatabase().then(_ => {\n        // First load topics into memory.\n        return this._db.mapTopics(data => {\n          let topic = this.#cacheGet('topic', data.name);\n          if (topic) {\n            return;\n          }\n          if (data.name == Const.TOPIC_ME) {\n            topic = new TopicMe();\n          } else if (data.name == Const.TOPIC_FND) {\n            topic = new TopicFnd();\n          } else {\n            topic = new Topic(data.name);\n          }\n          this._db.deserializeTopic(topic, data);\n          this.#attachCacheToTopic(topic);\n          topic._cachePutSelf();\n          this._db.maxDelId(topic.name).then(clear => {\n            topic._maxDel = Math.max(topic._maxDel, clear || 0);\n          });\n          // Topic loaded from DB is not new.\n          delete topic._new;\n          // Request to load messages and save the promise.\n          prom.push(topic._loadMessages(this._db));\n        });\n      }).then(_ => {\n        // Then load users.\n        return this._db.mapUsers((data) => {\n          this.#cachePut('user', data.uid, mergeObj({}, data.public));\n        });\n      }).then(_ => {\n        // Now wait for all messages to finish loading.\n        return Promise.all(prom);\n      }).then(_ => {\n        if (onComplete) {\n          onComplete();\n        }\n        this.logger(\"Persistent cache initialized.\");\n      }).catch(err => {\n        if (onComplete) {\n          onComplete(err);\n        }\n        this.logger(\"Failed to initialize persistent cache:\", err);\n      });\n    } else {\n      this._db.deleteDatabase().then(_ => {\n        if (onComplete) {\n          onComplete();\n        }\n      });\n    }\n  }\n\n  // Private methods.\n\n  // Console logger. Babel somehow fails to parse '...rest' parameter.\n  logger(str, ...args) {\n    if (this._loggingEnabled) {\n      const d = new Date();\n      const dateString = ('0' + d.getUTCHours()).slice(-2) + ':' +\n        ('0' + d.getUTCMinutes()).slice(-2) + ':' +\n        ('0' + d.getUTCSeconds()).slice(-2) + '.' +\n        ('00' + d.getUTCMilliseconds()).slice(-3);\n\n      console.log('[' + dateString + ']', str, args.join(' '));\n    }\n  }\n\n  // Generator of default promises for sent packets.\n  #makePromise(id) {\n    let promise = null;\n    if (id) {\n      promise = new Promise((resolve, reject) => {\n        // Stored callbacks will be called when the response packet with this Id arrives\n        this._pendingPromises[id] = {\n          'resolve': resolve,\n          'reject': reject,\n          'ts': new Date()\n        };\n      });\n    }\n    return promise;\n  };\n\n  // Resolve or reject a pending promise.\n  // Unresolved promises are stored in _pendingPromises.\n  #execPromise(id, code, onOK, errorText) {\n    const callbacks = this._pendingPromises[id];\n    if (callbacks) {\n      delete this._pendingPromises[id];\n      if (code >= 200 && code < 400) {\n        if (callbacks.resolve) {\n          callbacks.resolve(onOK);\n        }\n      } else if (callbacks.reject) {\n        callbacks.reject(new CommError(errorText, code));\n      }\n    }\n  }\n\n  // Send a packet. If packet id is provided return a promise.\n  #send(pkt, id) {\n    let promise;\n    if (id) {\n      promise = this.#makePromise(id);\n    }\n    pkt = simplify(pkt);\n    let msg = JSON.stringify(pkt);\n    this.logger(\"out: \" + (this._trimLongStrings ? JSON.stringify(pkt, jsonLoggerHelper) : msg));\n    try {\n      this._connection.sendText(msg);\n    } catch (err) {\n      // If sendText throws, wrap the error in a promise or rethrow.\n      if (id) {\n        this.#execPromise(id, Connection.NETWORK_ERROR, null, err.message);\n      } else {\n        throw err;\n      }\n    }\n    return promise;\n  }\n\n  // The main message dispatcher.\n  #dispatchMessage(data) {\n    // Skip empty response. This happens when LP times out.\n    if (!data)\n      return;\n\n    this._inPacketCount++;\n\n    // Send raw message to listener\n    if (this.onRawMessage) {\n      this.onRawMessage(data);\n    }\n\n    if (data === '0') {\n      // Server response to a network probe.\n      if (this.onNetworkProbe) {\n        this.onNetworkProbe();\n      }\n      // No processing is necessary.\n      return;\n    }\n\n    let pkt = JSON.parse(data, jsonParseHelper);\n    if (!pkt) {\n      this.logger(\"in: \" + data);\n      this.logger(\"ERROR: failed to parse data\");\n    } else {\n      this.logger(\"in: \" + (this._trimLongStrings ? JSON.stringify(pkt, jsonLoggerHelper) : data));\n\n      // Send complete packet to listener\n      if (this.onMessage) {\n        this.onMessage(pkt);\n      }\n\n      if (pkt.ctrl) {\n        // Handling {ctrl} message\n        if (this.onCtrlMessage) {\n          this.onCtrlMessage(pkt.ctrl);\n        }\n\n        // Resolve or reject a pending promise, if any\n        if (pkt.ctrl.id) {\n          this.#execPromise(pkt.ctrl.id, pkt.ctrl.code, pkt.ctrl, pkt.ctrl.text);\n        }\n        setTimeout(_ => {\n          if (pkt.ctrl.code == 205 && pkt.ctrl.text == 'evicted') {\n            // User evicted from topic.\n            const topic = this.#cacheGet('topic', pkt.ctrl.topic);\n            if (topic) {\n              topic._resetSub();\n              if (pkt.ctrl.params && pkt.ctrl.params.unsub) {\n                topic._gone();\n              }\n            }\n          } else if (pkt.ctrl.code < 300 && pkt.ctrl.params) {\n            if (pkt.ctrl.params.what == 'data') {\n              // code=208, all messages received: \"params\":{\"count\":11,\"what\":\"data\"},\n              const topic = this.#cacheGet('topic', pkt.ctrl.topic);\n              if (topic) {\n                topic._allMessagesReceived(pkt.ctrl.params.count);\n              }\n            } else if (pkt.ctrl.params.what == 'sub') {\n              // code=204, the topic has no (refreshed) subscriptions.\n              const topic = this.#cacheGet('topic', pkt.ctrl.topic);\n              if (topic) {\n                // Trigger topic.onSubsUpdated.\n                topic._processMetaSubs([]);\n              }\n            }\n          }\n        }, 0);\n      } else {\n        setTimeout(_ => {\n          if (pkt.meta) {\n            // Handling a {meta} message.\n            // Preferred API: Route meta to topic, if one is registered\n            const topic = this.#cacheGet('topic', pkt.meta.topic);\n            if (topic) {\n              topic._routeMeta(pkt.meta);\n            }\n\n            if (pkt.meta.id) {\n              this.#execPromise(pkt.meta.id, 200, pkt.meta, 'META');\n            }\n\n            // Secondary API: callback\n            if (this.onMetaMessage) {\n              this.onMetaMessage(pkt.meta);\n            }\n          } else if (pkt.data) {\n            // Handling {data} message\n            // Preferred API: Route data to topic, if one is registered\n            const topic = this.#cacheGet('topic', pkt.data.topic);\n            if (topic) {\n              topic._routeData(pkt.data);\n            }\n\n            // Secondary API: Call callback\n            if (this.onDataMessage) {\n              this.onDataMessage(pkt.data);\n            }\n          } else if (pkt.pres) {\n            // Handling {pres} message\n            // Preferred API: Route presence to topic, if one is registered\n            const topic = this.#cacheGet('topic', pkt.pres.topic);\n            if (topic) {\n              topic._routePres(pkt.pres);\n            }\n\n            // Secondary API - callback\n            if (this.onPresMessage) {\n              this.onPresMessage(pkt.pres);\n            }\n          } else if (pkt.info) {\n            // {info} message - read/received notifications and key presses\n            // Preferred API: Route {info}} to topic, if one is registered\n            const topic = this.#cacheGet('topic', pkt.info.topic);\n            if (topic) {\n              topic._routeInfo(pkt.info);\n            }\n\n            // Secondary API - callback\n            if (this.onInfoMessage) {\n              this.onInfoMessage(pkt.info);\n            }\n          } else {\n            this.logger(\"ERROR: Unknown packet received.\");\n          }\n        }, 0);\n      }\n    }\n  }\n\n  // Connection open, ready to start sending.\n  #connectionOpen() {\n    if (!this._expirePromises) {\n      // Reject promises which have not been resolved for too long.\n      this._expirePromises = setInterval(_ => {\n        const err = new CommError(\"timeout\", 504);\n        const expires = new Date(new Date().getTime() - Const.EXPIRE_PROMISES_TIMEOUT);\n        for (let id in this._pendingPromises) {\n          let callbacks = this._pendingPromises[id];\n          if (callbacks && callbacks.ts < expires) {\n            this.logger(\"Promise expired\", id);\n            delete this._pendingPromises[id];\n            if (callbacks.reject) {\n              callbacks.reject(err);\n            }\n          }\n        }\n      }, Const.EXPIRE_PROMISES_PERIOD);\n    }\n    this.hello();\n  }\n\n  #disconnected(err, code) {\n    this._inPacketCount = 0;\n    this._serverInfo = null;\n    this._authenticated = false;\n\n    if (this._expirePromises) {\n      clearInterval(this._expirePromises);\n      this._expirePromises = null;\n    }\n\n    // Mark all topics as unsubscribed\n    this.#cacheMap('topic', (topic, key) => {\n      topic._resetSub();\n    });\n\n    // Reject all pending promises\n    for (let key in this._pendingPromises) {\n      const callbacks = this._pendingPromises[key];\n      if (callbacks && callbacks.reject) {\n        callbacks.reject(err);\n      }\n    }\n    this._pendingPromises = {};\n\n    if (this.onDisconnect) {\n      this.onDisconnect(err);\n    }\n  }\n\n  // Get User Agent string\n  #getUserAgent() {\n    return this._appName + ' (' + (this._browser ? this._browser + '; ' : '') + this._hwos + '); ' + Const.LIBRARY;\n  }\n\n  // Generator of packets stubs\n  #initPacket(type, topic) {\n    switch (type) {\n      case 'hi':\n        return {\n          'hi': {\n            'id': this.getNextUniqueId(),\n            'ver': Const.VERSION,\n            'ua': this.#getUserAgent(),\n            'dev': this._deviceToken,\n            'lang': this._humanLanguage,\n            'platf': this._platform\n          }\n        };\n\n      case 'acc':\n        return {\n          'acc': {\n            'id': this.getNextUniqueId(),\n            'user': null,\n            'scheme': null,\n            'secret': null,\n            'tmpscheme': null,\n            'tmpsecret': null,\n            'login': false,\n            'tags': null,\n            'desc': {},\n            'cred': {}\n          }\n        };\n\n      case 'login':\n        return {\n          'login': {\n            'id': this.getNextUniqueId(),\n            'scheme': null,\n            'secret': null\n          }\n        };\n\n      case 'sub':\n        return {\n          'sub': {\n            'id': this.getNextUniqueId(),\n            'topic': topic,\n            'set': {},\n            'get': {}\n          }\n        };\n\n      case 'leave':\n        return {\n          'leave': {\n            'id': this.getNextUniqueId(),\n            'topic': topic,\n            'unsub': false\n          }\n        };\n\n      case 'pub':\n        return {\n          'pub': {\n            'id': this.getNextUniqueId(),\n            'topic': topic,\n            'noecho': false,\n            'head': null,\n            'content': {}\n          }\n        };\n\n      case 'get':\n        return {\n          'get': {\n            'id': this.getNextUniqueId(),\n            'topic': topic,\n            'what': null,\n            'desc': {},\n            'sub': {},\n            'data': {}\n          }\n        };\n\n      case 'set':\n        return {\n          'set': {\n            'id': this.getNextUniqueId(),\n            'topic': topic,\n            'desc': {},\n            'sub': {},\n            'tags': [],\n            'aux': {}\n          }\n        };\n\n      case 'del':\n        return {\n          'del': {\n            'id': this.getNextUniqueId(),\n            'topic': topic,\n            'what': null,\n            'delseq': null,\n            'user': null,\n            'hard': false\n          }\n        };\n\n      case 'note':\n        return {\n          'note': {\n            // no id by design (except calls).\n            'topic': topic,\n            'what': null, // one of \"recv\", \"read\", \"kp\", \"call\"\n            'seq': undefined // the server-side message id acknowledged as received or read.\n          }\n        };\n\n      default:\n        throw new Error(`Unknown packet type requested: ${type}`);\n    }\n  }\n\n  // Cache management\n  #cachePut(type, name, obj) {\n    this._cache[type + ':' + name] = obj;\n  }\n  #cacheGet(type, name) {\n    return this._cache[type + ':' + name];\n  }\n  #cacheDel(type, name) {\n    delete this._cache[type + ':' + name];\n  }\n\n  // Enumerate all items in cache, call func for each item.\n  // Enumeration stops if func returns true.\n  #cacheMap(type, func, context) {\n    const key = type ? type + ':' : undefined;\n    for (let idx in this._cache) {\n      if (!key || idx.indexOf(key) == 0) {\n        if (func.call(context, this._cache[idx], idx)) {\n          break;\n        }\n      }\n    }\n  }\n\n  // Make limited cache management available to topic.\n  // Caching user.public only. Everything else is per-topic.\n  #attachCacheToTopic(topic) {\n    topic._tinode = this;\n\n    topic._cacheGetUser = (uid) => {\n      const pub = this.#cacheGet('user', uid);\n      if (pub) {\n        return {\n          user: uid,\n          public: mergeObj({}, pub)\n        };\n      }\n      return undefined;\n    };\n    topic._cachePutUser = (uid, user) => {\n      this.#cachePut('user', uid, mergeObj({}, user.public));\n    };\n    topic._cacheDelUser = (uid) => {\n      this.#cacheDel('user', uid);\n    };\n    topic._cachePutSelf = _ => {\n      this.#cachePut('topic', topic.name, topic);\n    };\n    topic._cacheDelSelf = _ => {\n      this.#cacheDel('topic', topic.name);\n    };\n  }\n\n  // On successful login save server-provided data.\n  #loginSuccessful(ctrl) {\n    if (!ctrl.params || !ctrl.params.user) {\n      return ctrl;\n    }\n    // This is a response to a successful login,\n    // extract UID and security token, save it in Tinode module\n    this._myUID = ctrl.params.user;\n    this._authenticated = (ctrl && ctrl.code >= 200 && ctrl.code < 300);\n    if (ctrl.params && ctrl.params.token && ctrl.params.expires) {\n      this._authToken = {\n        token: ctrl.params.token,\n        expires: ctrl.params.expires\n      };\n    } else {\n      this._authToken = null;\n    }\n\n    if (this.onLogin) {\n      this.onLogin(ctrl.code, ctrl.text);\n    }\n\n    return ctrl;\n  }\n\n  // Static methods.\n  /**\n   * Helper method to package account credential.\n   *\n   * @param {string | Credential} meth - validation method or object with validation data.\n   * @param {string=} val - validation value (e.g. email or phone number).\n   * @param {Object=} params - validation parameters.\n   * @param {string=} resp - validation response.\n   *\n   * @returns {Array.<Credential>} array with a single credential or <code>null</code> if no valid credentials were given.\n   */\n  static credential(meth, val, params, resp) {\n    if (typeof meth == 'object') {\n      ({\n        val,\n        params,\n        resp,\n        meth\n      } = meth);\n    }\n    if (meth && (val || resp)) {\n      return [{\n        'meth': meth,\n        'val': val,\n        'resp': resp,\n        'params': params\n      }];\n    }\n    return null;\n  }\n\n  /**\n   * Determine topic type from topic's name: grp, p2p, me, fnd, sys.\n   * @param {string} name - Name of the topic to test.\n   * @returns {string} One of <code>\"me\"</code>, <code>\"fnd\"</code>, <code>\"sys\"</code>, <code>\"grp\"</code>,\n   *    <code>\"p2p\"</code> or <code>undefined</code>.\n   */\n  static topicType(name) {\n    return Topic.topicType(name);\n  }\n\n  /**\n   * Check if the given topic name is a name of a 'me' topic.\n   * @param {string} name - Name of the topic to test.\n   * @returns {boolean} <code>true</code> if the name is a name of a 'me' topic, <code>false</code> otherwise.\n   */\n  static isMeTopicName(name) {\n    return Topic.isMeTopicName(name);\n  }\n  /**\n   * Check if the given topic name is a name of a 'slf' topic.\n   * @param {string} name - Name of the topic to test.\n   * @returns {boolean} <code>true</code> if the name is a name of a 'slf' topic, <code>false</code> otherwise.\n   */\n  static isSelfTopicName(name) {\n    return Topic.isSelfTopicName(name);\n  }\n  /**\n   * Check if the given topic name is a name of a group topic.\n   * @param {string} name - Name of the topic to test.\n   * @returns {boolean} <code>true</code> if the name is a name of a group topic, <code>false</code> otherwise.\n   */\n  static isGroupTopicName(name) {\n    return Topic.isGroupTopicName(name);\n  }\n  /**\n   * Check if the given topic name is a name of a p2p topic.\n   * @param {string} name - Name of the topic to test.\n   * @returns {boolean} <code>true</code> if the name is a name of a p2p topic, <code>false</code> otherwise.\n   */\n  static isP2PTopicName(name) {\n    return Topic.isP2PTopicName(name);\n  }\n  /**\n   * Check if the given topic name is a name of a communication topic, i.e. P2P or group.\n   * @param {string} name - Name of the topic to test.\n   * @returns {boolean} <code>true</code> if the name is a name of a p2p or group topic, <code>false</code> otherwise.\n   */\n  static isCommTopicName(name) {\n    return Topic.isCommTopicName(name);\n  }\n  /**\n   * Check if the topic name is a name of a new topic.\n   * @param {string} name - topic name to check.\n   * @returns {boolean} <code>true</code> if the name is a name of a new topic, <code>false</code> otherwise.\n   */\n  static isNewGroupTopicName(name) {\n    return Topic.isNewGroupTopicName(name);\n  }\n  /**\n   * Check if the topic name is a name of a channel.\n   * @param {string} name - topic name to check.\n   * @returns {boolean} <code>true</code> if the name is a name of a channel, <code>false</code> otherwise.\n   */\n  static isChannelTopicName(name) {\n    return Topic.isChannelTopicName(name);\n  }\n  /**\n   * Get information about the current version of this Tinode client library.\n   * @returns {string} semantic version of the library, e.g. <code>\"0.15.5-rc1\"</code>.\n   */\n  static getVersion() {\n    return Const.VERSION;\n  }\n  /**\n   * To use Tinode in a non browser context, supply WebSocket and XMLHttpRequest providers.\n   * @static\n   *\n   * @param {Object} wsProvider - <code>WebSocket</code> provider, e.g. for nodeJS, <code>require('ws')</code>.\n   * @param {Object} xhrProvider - <code>XMLHttpRequest</code> provider, e.g. for node <code>require('xhr')</code>.\n   */\n  static setNetworkProviders(wsProvider, xhrProvider) {\n    WebSocketProvider = wsProvider;\n    XHRProvider = xhrProvider;\n\n    Connection.setNetworkProviders(WebSocketProvider, XHRProvider);\n    LargeFileHelper.setNetworkProvider(XHRProvider);\n  }\n  /**\n   * To use Tinode in a non browser context, supply <code>indexedDB</code> provider.\n   * @static\n   *\n   * @param {Object} idbProvider - <code>indexedDB</code> provider, e.g. for nodeJS, <code>require('fake-indexeddb')</code>.\n   */\n  static setDatabaseProvider(idbProvider) {\n    IndexedDBProvider = idbProvider;\n\n    DBCache.setDatabaseProvider(IndexedDBProvider);\n  }\n  /**\n   * Return information about the current name and version of this Tinode library.\n   * @static\n   *\n   * @returns {string} the name of the library and its version.\n   */\n  static getLibrary() {\n    return Const.LIBRARY;\n  }\n  /**\n   * Check if the given string represents <code>NULL</code> value as defined by Tinode (<code>'\\u2421'</code>).\n   * @param {string} str - string to check for <code>NULL</code> value.\n   * @returns {boolean} <code>true</code> if string represents <code>NULL</code> value, <code>false</code> otherwise.\n   */\n  static isNullValue(str) {\n    return str === Const.DEL_CHAR;\n  }\n  /**\n   * Check if the given seq ID is likely to be issued by the server as opposite to being temporary locally assigned ID.\n   * @param {number} seq - seq ID to check.\n   * @returns {boolean} <code>true</code> if seq is likely server-issued, <code>false</code> otherwise.\n   */\n  static isServerAssignedSeq(seq) {\n    return seq > 0 && seq < Const.LOCAL_SEQID;\n  }\n\n  /**\n   * Check if the given string is a valid tag value.\n   * @param {string} tag - string to check.\n   * @returns {boolean} <code>true</code> if the string is a valid tag value, <code>false</code> otherwise.\n   */\n  static isValidTagValue(tag) {\n    // 4-24 characters, starting with letter or digit, then letters, digits, hyphen, underscore.\n    const ALIAS_REGEX = /^[a-z0-9][a-z0-9_\\-]{3,23}$/i;\n    return tag && typeof tag == 'string' && tag.length > 3 && tag.length < 24 && ALIAS_REGEX.test(tag);\n  }\n\n  /**\n   * Split fully-qualified tag into prefix and value.\n   */\n  static tagSplit(tag) {\n    if (!tag) {\n      return null;\n    }\n\n    tag = tag.trim();\n\n    const splitAt = tag.indexOf(':');\n    if (splitAt <= 0) {\n      // Invalid syntax.\n      return null;\n    }\n\n    const value = tag.substring(splitAt + 1);\n    if (!value) {\n      return null;\n    }\n    return {\n      prefix: tag.substring(0, splitAt),\n      value: value\n    };\n  }\n\n  /**\n   * Set a unique namespace tag.\n   * If the tag with this namespace is already present then it's replaced with the new tag.\n   * @param {Array.<string>} tags - array of tags to modify.\n   * @param {string} uniqueTag - tag to add, must be fully-qualified; if null or empty, no action is taken.\n   * @returns {Array.<string>} modified array of tags.\n   */\n  static setUniqueTag(tags, uniqueTag) {\n    if (!tags || tags.length == 0) {\n      // No tags, just add the new one.\n      return [uniqueTag];\n    }\n\n    const parts = Tinode.tagSplit(uniqueTag)\n    if (!parts) {\n      // Invalid tag.\n      return tags;\n    }\n\n    // Remove the old tag with the same prefix.\n    tags = tags.filter(tag => tag && !tag.startsWith(parts.prefix));\n    // Add the new tag.\n    tags.push(uniqueTag);\n    return tags;\n  }\n\n  /**\n   * Remove a unique tag with the given prefix.\n   * @param {Array.<string>} tags - array of tags to modify.\n   * @param {string} prefix - prefix to remove.\n   * @returns {Array.<string>} array of tags without the ones with the given prefix.\n   */\n  static clearTagPrefix(tags, prefix) {\n    if (!tags || tags.length == 0) {\n      return [];\n    }\n    return tags.filter(tag => tag && !tag.startsWith(prefix));\n  }\n\n  /**\n   * Find the first tag with the given prefix.\n   * @param {Array.<string>} tags - array of tags to search.\n   * @param {string} prefix - prefix to search for.\n   * @returns {string} the first tag with the given prefix if found or <code>undefined</code>.\n   */\n  static tagByPrefix(tags, prefix) {\n    if (!tags) {\n      return undefined;\n    }\n\n    return tags.find(tag => tag && tag.startsWith(prefix));\n  }\n\n  // Instance methods.\n\n  /** Generates unique message IDs */\n  getNextUniqueId() {\n    return (this._messageId != 0) ? '' + this._messageId++ : undefined;\n  };\n\n  /**\n   * Connect to the server.\n   *\n   * @param {string} host_ - name of the host to connect to.\n   * @return {Promise} Promise resolved/rejected when the connection call completes:\n   *    <code>resolve()</code> is called without parameters, <code>reject()</code> receives the\n   *    <code>Error</code> as a single parameter.\n   */\n  connect(host_) {\n    return this._connection.connect(host_);\n  }\n\n  /**\n   * Attempt to reconnect to the server immediately.\n   *\n   * @param {string} force - if <code>true</code>, reconnect even if there is a connection already.\n   */\n  reconnect(force) {\n    this._connection.reconnect(force);\n  }\n\n  /**\n   * Disconnect from the server.\n   */\n  disconnect() {\n    this._connection.disconnect();\n  }\n\n  /**\n   * Clear persistent cache: remove IndexedDB.\n   *\n   * @return {Promise} Promise resolved/rejected when the operation is completed.\n   */\n  clearStorage() {\n    if (this._db.isReady()) {\n      return this._db.deleteDatabase();\n    }\n    return Promise.resolve();\n  }\n\n  /**\n   * Initialize persistent cache: create IndexedDB cache.\n   *\n   * @return {Promise} Promise resolved/rejected when the operation is completed.\n   */\n  initStorage() {\n    if (!this._db.isReady()) {\n      return this._db.initDatabase();\n    }\n    return Promise.resolve();\n  }\n\n  /**\n   * Send a network probe message to make sure the connection is alive.\n   */\n  networkProbe() {\n    this._connection.probe();\n  }\n\n  /**\n   * Check for live connection to server.\n   *\n   * @returns {boolean} <code>true</code> if there is a live connection, <code>false</code> otherwise.\n   */\n  isConnected() {\n    return this._connection.isConnected();\n  }\n\n  /**\n   * Check if connection is authenticated (last login was successful).\n   *\n   * @returns {boolean} <code>true</code> if authenticated, <code>false</code> otherwise.\n   */\n  isAuthenticated() {\n    return this._authenticated;\n  }\n\n  /**\n   * Add API key and auth token to the relative URL making it usable for getting data\n   * from the server in a simple <code>HTTP GET</code> request.\n   *\n   * @param {string} URL - URL to wrap.\n   * @returns {string} URL with appended API key and token, if valid token is present.\n   */\n  authorizeURL(url) {\n    if (typeof url != 'string') {\n      return url;\n    }\n\n    if (isUrlRelative(url)) {\n      // Fake base to make the relative URL parseable.\n      const base = 'scheme://host/';\n      const parsed = new URL(url, base);\n      if (this._apiKey) {\n        parsed.searchParams.append('apikey', this._apiKey);\n      }\n      if (this._authToken && this._authToken.token) {\n        parsed.searchParams.append('auth', 'token');\n        parsed.searchParams.append('secret', this._authToken.token);\n      }\n      // Convert back to string and strip fake base URL except for the root slash.\n      url = parsed.toString().substring(base.length - 1);\n    }\n    return url;\n  }\n\n  /**\n   * @typedef AccountParams\n   * @type {Object}\n   * @property {DefAcs=} defacs - Default access parameters for user's <code>me</code> topic.\n   * @property {Object=} public - Public application-defined data exposed on <code>me</code> topic.\n   * @property {Object=} private - Private application-defined data accessible on <code>me</code> topic.\n   * @property {Object=} trusted - Trusted user data which can be set by a root user only.\n   * @property {Array.<string>} tags - array of string tags for user discovery.\n   * @property {string} scheme - Temporary authentication scheme for password reset.\n   * @property {string} secret - Temporary authentication secret for password reset.\n   * @property {Array.<string>=} attachments - Array of references to out of band attachments used in account description.\n   */\n  /**\n   * @typedef DefAcs\n   * @type {Object}\n   * @property {string=} auth - Access mode for <code>me</code> for authenticated users.\n   * @property {string=} anon - Access mode for <code>me</code> for anonymous users.\n   */\n\n  /**\n   * Create or update an account.\n   *\n   * @param {string} uid - User id to update\n   * @param {string} scheme - Authentication scheme; <code>\"basic\"</code> and <code>\"anonymous\"</code> are the currently supported schemes.\n   * @param {string} secret - Authentication secret, assumed to be already base64 encoded.\n   * @param {boolean=} login - Use new account to authenticate current session\n   * @param {AccountParams=} params - User data to pass to the server.\n   *\n   * @returns {Promise} Promise which will be resolved/rejected when server reply is received.\n   */\n  account(uid, scheme, secret, login, params) {\n    const pkt = this.#initPacket('acc');\n    pkt.acc.user = uid;\n    pkt.acc.scheme = scheme;\n    pkt.acc.secret = secret;\n    // Log in to the new account using selected scheme\n    pkt.acc.login = login;\n\n    if (params) {\n      pkt.acc.desc.defacs = params.defacs;\n      pkt.acc.desc.public = params.public;\n      pkt.acc.desc.private = params.private;\n      pkt.acc.desc.trusted = params.trusted;\n\n      pkt.acc.tags = params.tags;\n      pkt.acc.cred = params.cred;\n\n      pkt.acc.tmpscheme = params.scheme;\n      pkt.acc.tmpsecret = params.secret;\n\n      if (Array.isArray(params.attachments) && params.attachments.length > 0) {\n        pkt.extra = {\n          attachments: params.attachments.filter(ref => isUrlRelative(ref))\n        };\n      }\n    }\n\n    return this.#send(pkt, pkt.acc.id);\n  }\n\n  /**\n   * Create a new user. Wrapper for {@link Tinode#account}.\n   *\n   * @param {string} scheme - Authentication scheme; <code>\"basic\"</code> is the only currently supported scheme.\n   * @param {string} secret - Authentication.\n   * @param {boolean=} login - Use new account to authenticate current session\n   * @param {AccountParams=} params - User data to pass to the server.\n   *\n   * @returns {Promise} Promise which will be resolved/rejected when server reply is received.\n   */\n  createAccount(scheme, secret, login, params) {\n    let promise = this.account(Const.USER_NEW, scheme, secret, login, params);\n    if (login) {\n      promise = promise.then(ctrl => this.#loginSuccessful(ctrl));\n    }\n    return promise;\n  }\n\n  /**\n   * Create user with <code>'basic'</code> authentication scheme and immediately\n   * use it for authentication. Wrapper for {@link Tinode#account}.\n   *\n   * @param {string} username - Login to use for the new account.\n   * @param {string} password - User's password.\n   * @param {AccountParams=} params - User data to pass to the server.\n   *\n   * @returns {Promise} Promise which will be resolved/rejected when server reply is received.\n   */\n  createAccountBasic(username, password, params) {\n    // Make sure we are not using 'null' or 'undefined';\n    username = username || '';\n    password = password || '';\n    return this.createAccount('basic',\n      b64EncodeUnicode(username + ':' + password), true, params);\n  }\n\n  /**\n   * Update user's credentials for <code>'basic'</code> authentication scheme. Wrapper for {@link Tinode#account}.\n   *\n   * @param {string} uid - User ID to update.\n   * @param {string} username - Login to use for the new account.\n   * @param {string} password - User's password.\n   * @param {AccountParams=} params - data to pass to the server.\n   *\n   * @returns {Promise} Promise which will be resolved/rejected when server reply is received.\n   */\n  updateAccountBasic(uid, username, password, params) {\n    // Make sure we are not using 'null' or 'undefined';\n    username = username || '';\n    password = password || '';\n    return this.account(uid, 'basic',\n      b64EncodeUnicode(username + ':' + password), false, params);\n  }\n\n  /**\n   * Send handshake to the server.\n   *\n   * @returns {Promise} Promise which will be resolved/rejected when server reply is received.\n   */\n  hello() {\n    const pkt = this.#initPacket('hi');\n\n    return this.#send(pkt, pkt.hi.id)\n      .then(ctrl => {\n        // Reset backoff counter on successful connection.\n        this._connection.backoffReset();\n\n        // Server response contains server protocol version, build, constraints,\n        // session ID for long polling. Save them.\n        if (ctrl.params) {\n          this._serverInfo = ctrl.params;\n        }\n\n        if (this.onConnect) {\n          this.onConnect();\n        }\n\n        return ctrl;\n      }).catch(err => {\n        this._connection.reconnect(true);\n\n        if (this.onDisconnect) {\n          this.onDisconnect(err);\n        }\n      });\n  }\n\n  /**\n   * Set or refresh the push notifications/device token. If the client is connected,\n   * the deviceToken can be sent to the server.\n   *\n   * @param {string} dt - token obtained from the provider or <code>false</code>,\n   *    <code>null</code> or <code>undefined</code> to clear the token.\n   *\n   * @returns <code>true</code> if attempt was made to send the update to the server.\n   */\n  setDeviceToken(dt) {\n    let sent = false;\n    // Convert any falsish value to null.\n    dt = dt || null;\n    if (dt != this._deviceToken) {\n      this._deviceToken = dt;\n      if (this.isConnected() && this.isAuthenticated()) {\n        this.#send({\n          'hi': {\n            'dev': dt || Tinode.DEL_CHAR\n          }\n        });\n        sent = true;\n      }\n    }\n    return sent;\n  }\n\n  /**\n   * @typedef Credential\n   * @type {Object}\n   * @property {string} meth - validation method.\n   * @property {string} val - value to validate (e.g. email or phone number).\n   * @property {string} resp - validation response.\n   * @property {Object} params - validation parameters.\n   */\n  /**\n   * Authenticate current session.\n   *\n   * @param {string} scheme - Authentication scheme; <code>\"basic\"</code> is the only currently supported scheme.\n   * @param {string} secret - Authentication secret, assumed to be already base64 encoded.\n   * @param {Credential=} cred - credential confirmation, if required.\n   *\n   * @returns {Promise} Promise which will be resolved/rejected when server reply is received.\n   */\n  login(scheme, secret, cred) {\n    const pkt = this.#initPacket('login');\n    pkt.login.scheme = scheme;\n    pkt.login.secret = secret;\n    pkt.login.cred = cred;\n\n    return this.#send(pkt, pkt.login.id)\n      .then(ctrl => this.#loginSuccessful(ctrl));\n  }\n\n  /**\n   * Wrapper for {@link Tinode#login} with basic authentication\n   *\n   * @param {string} uname - User name.\n   * @param {string} password  - Password.\n   * @param {Credential=} cred - credential confirmation, if required.\n   *\n   * @returns {Promise} Promise which will be resolved/rejected on receiving server reply.\n   */\n  loginBasic(uname, password, cred) {\n    return this.login('basic', b64EncodeUnicode(uname + ':' + password), cred)\n      .then(ctrl => {\n        this._login = uname;\n        return ctrl;\n      });\n  }\n\n  /**\n   * Wrapper for {@link Tinode#login} with token authentication\n   *\n   * @param {string} token - Token received in response to earlier login.\n   * @param {Credential=} cred - credential confirmation, if required.\n   *\n   * @returns {Promise} Promise which will be resolved/rejected on receiving server reply.\n   */\n  loginToken(token, cred) {\n    return this.login('token', token, cred);\n  }\n\n  /**\n   * Send a request for resetting an authentication secret.\n   *\n   * @param {string} scheme - authentication scheme to reset.\n   * @param {string} method - method to use for resetting the secret, such as \"email\" or \"tel\".\n   * @param {string} value - value of the credential to use, a specific email address or a phone number.\n   *\n   * @returns {Promise} Promise which will be resolved/rejected on receiving the server reply.\n   */\n  requestResetAuthSecret(scheme, method, value) {\n    return this.login('reset', b64EncodeUnicode(scheme + ':' + method + ':' + value));\n  }\n\n  /**\n   * @typedef AuthToken\n   * @type {Object}\n   * @property {string} token - Token value.\n   * @property {Date} expires - Token expiration time.\n   */\n  /**\n   * Get stored authentication token.\n   *\n   * @returns {AuthToken} authentication token.\n   */\n  getAuthToken() {\n    if (this._authToken && (this._authToken.expires.getTime() > Date.now())) {\n      return this._authToken;\n    } else {\n      this._authToken = null;\n    }\n    return null;\n  }\n\n  /**\n   * Application may provide a saved authentication token.\n   *\n   * @param {AuthToken} token - authentication token.\n   */\n  setAuthToken(token) {\n    this._authToken = token;\n  }\n\n  /**\n   * @typedef SetParams\n   * @type {Object}\n   * @property {SetDesc=} desc - Topic initialization parameters when creating a new topic or a new subscription.\n   * @property {SetSub=} sub - Subscription initialization parameters.\n   * @property {Array.<string>=} tags - Search tags.\n   * @property {Object} aux - Auxiliary topic data.\n   * @property {Array.<string>=} attachments - URLs of out of band attachments used in parameters.\n   */\n  /**\n   * @typedef SetDesc\n   * @type {Object}\n   * @property {DefAcs=} defacs - Default access mode.\n   * @property {Object=} public - Free-form topic description, publically accessible.\n   * @property {Object=} private - Free-form topic description accessible only to the owner.\n   * @property {Object=} trusted - Trusted user data which can be set by a root user only.\n   */\n  /**\n   * @typedef SetSub\n   * @type {Object}\n   * @property {string=} user - UID of the user affected by the request. Default (empty) - current user.\n   * @property {string=} mode - User access mode, either requested or assigned dependent on context.\n   */\n  /**\n   * Send a topic subscription request.\n   *\n   * @param {string} topic - Name of the topic to subscribe to.\n   * @param {GetQuery=} getParams - Optional subscription metadata query\n   * @param {SetParams=} setParams - Optional initialization parameters\n   *\n   * @returns {Promise} Promise which will be resolved/rejected on receiving server reply.\n   */\n  subscribe(topicName, getParams, setParams) {\n    const pkt = this.#initPacket('sub', topicName)\n    if (!topicName) {\n      topicName = Const.TOPIC_NEW;\n    }\n\n    pkt.sub.get = getParams;\n\n    if (setParams) {\n      if (setParams.sub) {\n        pkt.sub.set.sub = setParams.sub;\n      }\n\n      if (setParams.desc) {\n        const desc = setParams.desc;\n        if (Tinode.isNewGroupTopicName(topicName)) {\n          // Full set.desc params are used for new topics only\n          pkt.sub.set.desc = desc;\n        } else if (Tinode.isP2PTopicName(topicName) && desc.defacs) {\n          // Use optional default permissions only.\n          pkt.sub.set.desc = {\n            defacs: desc.defacs\n          };\n        }\n      }\n\n      // See if external objects were used in topic description.\n      if (Array.isArray(setParams.attachments) && setParams.attachments.length > 0) {\n        pkt.extra = {\n          attachments: setParams.attachments.filter(ref => isUrlRelative(ref))\n        };\n      }\n\n      if (setParams.tags) {\n        pkt.sub.set.tags = setParams.tags;\n      }\n      if (setParams.aux) {\n        pkt.sub.set.aux = setParams.aux;\n      }\n    }\n    return this.#send(pkt, pkt.sub.id);\n  }\n\n  /**\n   * Detach and optionally unsubscribe from the topic\n   *\n   * @param {string} topic - Topic to detach from.\n   * @param {boolean} unsub - If <code>true</code>, detach and unsubscribe, otherwise just detach.\n   *\n   * @returns {Promise} Promise which will be resolved/rejected on receiving server reply.\n   */\n  leave(topic, unsub) {\n    const pkt = this.#initPacket('leave', topic);\n    pkt.leave.unsub = unsub;\n\n    return this.#send(pkt, pkt.leave.id);\n  }\n\n  /**\n   * Create message draft without sending it to the server.\n   *\n   * @param {string} topic - Name of the topic to publish to.\n   * @param {Object} content - Payload to publish.\n   * @param {boolean=} noEcho - If <code>true</code>, tell the server not to echo the message to the original session.\n   *\n   * @returns {Object} new message which can be sent to the server or otherwise used.\n   */\n  createMessage(topic, content, noEcho) {\n    const pkt = this.#initPacket('pub', topic);\n\n    let dft = typeof content == 'string' ? Drafty.parse(content) : content;\n    if (dft && !Drafty.isPlainText(dft)) {\n      pkt.pub.head = {\n        mime: Drafty.getContentType()\n      };\n      content = dft;\n    }\n    pkt.pub.noecho = noEcho;\n    pkt.pub.content = content;\n    return pkt.pub;\n  }\n\n  /**\n   * Publish {data} message to topic.\n   *\n   * @param {string} topicName - Name of the topic to publish to.\n   * @param {Object} content - Payload to publish.\n   * @param {boolean=} noEcho - If <code>true</code>, tell the server not to echo the message to the original session.\n   *\n   * @returns {Promise} Promise which will be resolved/rejected on receiving server reply.\n   */\n  publish(topicName, content, noEcho) {\n    return this.publishMessage(\n      this.createMessage(topicName, content, noEcho)\n    );\n  }\n\n  /**\n   * Publish message to topic. The message should be created by {@link Tinode#createMessage}.\n   *\n   * @param {Object} pub - Message to publish.\n   * @param {Array.<string>=} attachments - array of URLs with attachments.\n   *\n   * @returns {Promise} Promise which will be resolved/rejected on receiving server reply.\n   */\n  publishMessage(pub, attachments) {\n    // Make a shallow copy. Needed in order to clear locally-assigned temp values;\n    pub = Object.assign({}, pub);\n    pub.seq = undefined;\n    pub.from = undefined;\n    pub.ts = undefined;\n    const msg = {\n      pub: pub,\n    };\n    if (attachments) {\n      msg.extra = {\n        attachments: attachments.filter(ref => isUrlRelative(ref))\n      };\n    }\n    return this.#send(msg, pub.id);\n  }\n\n  /**\n   * Out of band notification: notify topic that an external (push) notification was recived by the client.\n   *\n   * @param {object} data - notification payload.\n   * @param {string} data.what - notification type, 'msg', 'read', 'sub'.\n   * @param {string} data.topic - name of the updated topic.\n   * @param {number=} data.seq - seq ID of the affected message.\n   * @param {string=} data.xfrom - UID of the sender.\n   * @param {object=} data.given - new subscription 'given', e.g. 'ASWP...'.\n   * @param {object=} data.want - new subscription 'want', e.g. 'RWJ...'.\n   */\n  oobNotification(data) {\n    this.logger('oob: ' + (this._trimLongStrings ? JSON.stringify(data, jsonLoggerHelper) : data));\n\n    switch (data.what) {\n      case 'msg':\n        if (!data.seq || data.seq < 1 || !data.topic) {\n          // Server sent invalid data.\n          break;\n        }\n\n        if (!this.isConnected()) {\n          // Let's ignore the message if there is no connection: no connection means there are no open\n          // tabs with Tinode.\n          break;\n        }\n\n        const topic = this.#cacheGet('topic', data.topic);\n        if (!topic) {\n          // TODO: check if there is a case when a message can arrive from an unknown topic.\n          break;\n        }\n\n        if (topic.isSubscribed()) {\n          // No need to fetch: topic is already subscribed and got data through normal channel.\n          break;\n        }\n\n        if (topic.maxMsgSeq() < data.seq) {\n          if (topic.isChannelType()) {\n            topic._updateReceived(data.seq, 'fake-uid');\n          }\n\n          // New message.\n          if (data.xfrom && !this.#cacheGet('user', data.xfrom)) {\n            // Message from unknown sender, fetch description from the server.\n            // Sending asynchronously without a subscription.\n            this.getMeta(data.xfrom, new MetaGetBuilder().withDesc().build()).catch(err => {\n              this.logger(\"Failed to get the name of a new sender\", err);\n            });\n          }\n\n          topic.subscribe(null).then(_ => {\n            return topic.getMeta(new MetaGetBuilder(topic).withLaterData(24).withLaterDel(24).build());\n          }).then(_ => {\n            // Allow data fetch to complete and get processed successfully.\n            topic.leaveDelayed(false, 1000);\n          }).catch(err => {\n            this.logger(\"On push data fetch failed\", err);\n          }).finally(_ => {\n            this.getMeTopic()._refreshContact('msg', topic);\n          });\n        }\n        break;\n\n      case 'read':\n        this.getMeTopic()._routePres({\n          what: 'read',\n          seq: data.seq\n        });\n        break;\n\n      case 'sub':\n        if (!this.isMe(data.xfrom)) {\n          // TODO: handle updates from other users.\n          break;\n        }\n\n        const mode = {\n          given: data.modeGiven,\n          want: data.modeWant\n        };\n        const acs = new AccessMode(mode);\n        const pres = (!acs.mode || acs.mode == AccessMode._NONE) ?\n          // Subscription deleted.\n          {\n            what: 'gone',\n            src: data.topic\n          } :\n          // New subscription or subscription updated.\n          {\n            what: 'acs',\n            src: data.topic,\n            dacs: mode\n          };\n        this.getMeTopic()._routePres(pres);\n        break;\n\n      default:\n        this.logger(\"Unknown push type ignored\", data.what);\n    }\n  }\n\n  /**\n   * @typedef GetOptsType\n   * @type {Object}\n   * @property {Date=} ims - \"If modified since\", fetch data only it was was modified since stated date.\n   * @property {number=} limit - Maximum number of results to return. Ignored when querying topic description.\n   */\n\n  /**\n   * @typedef GetDataType\n   * @type {Object}\n   * @property {number=} since - Load messages with seq ID equal or greater than this value.\n   * @property {number=} before - Load messages with seq ID lower than this number.\n   * @property {number=} limit - Maximum number of results to return.\n   * @property {Array.<SeqRange>=} range - Ranges of seq IDs to fetch.\n   */\n\n  /**\n   * @typedef GetQuery\n   * @type {Object}\n   * @property {GetOptsType=} desc - If provided (even if empty), fetch topic description.\n   * @property {GetOptsType=} sub - If provided (even if empty), fetch topic subscriptions.\n   * @property {GetDataType=} data - If provided (even if empty), get messages.\n   */\n\n  /**\n   * Request topic metadata\n   *\n   * @param {string} topic - Name of the topic to query.\n   * @param {GetQuery} params - Parameters of the query. Use {@link Tinode.MetaGetBuilder} to generate.\n   *\n   * @returns {Promise} Promise which will be resolved/rejected on receiving server reply.\n   */\n  getMeta(topic, params) {\n    const pkt = this.#initPacket('get', topic);\n\n    pkt.get = mergeObj(pkt.get, params);\n\n    return this.#send(pkt, pkt.get.id);\n  }\n\n  /**\n   * Update topic's metadata: description, subscribtions.\n   *\n   * @param {string} topic - Topic to update.\n   * @param {SetParams} params - topic metadata to update.\n   * @returns {Promise} Promise which will be resolved/rejected on receiving server reply.\n   */\n  setMeta(topic, params) {\n    const pkt = this.#initPacket('set', topic);\n    const what = [];\n\n    if (params) {\n      ['desc', 'sub', 'tags', 'cred', 'aux', 'react'].forEach(key => {\n        if (params.hasOwnProperty(key)) {\n          what.push(key);\n          pkt.set[key] = params[key];\n        }\n      });\n\n      if (Array.isArray(params.attachments) && params.attachments.length > 0) {\n        pkt.extra = {\n          attachments: params.attachments.filter(ref => isUrlRelative(ref))\n        };\n      }\n    }\n\n    if (what.length == 0) {\n      return Promise.reject(new Error(\"Invalid {set} parameters\"));\n    }\n\n    return this.#send(pkt, pkt.set.id);\n  }\n\n  /**\n   * Range of message IDs.\n   *\n   * @typedef SeqRange\n   * @type {Object}\n   * @property {number} low - low end of the range, inclusive (closed).\n   * @property {number=} hi - high end of the range, exclusive (open).\n   */\n  /**\n   * Delete some or all messages in a topic.\n   *\n   * @param {string} topic - Topic name to delete messages from.\n   * @param {Array.<SeqRange>} list - Ranges of message IDs to delete.\n   * @param {boolean=} hard - Hard or soft delete\n   *\n   * @returns {Promise} Promise which will be resolved/rejected on receiving server reply.\n   */\n  delMessages(topic, ranges, hard) {\n    const pkt = this.#initPacket('del', topic);\n\n    pkt.del.what = 'msg';\n    pkt.del.delseq = ranges;\n    pkt.del.hard = hard;\n\n    return this.#send(pkt, pkt.del.id);\n  }\n\n  /**\n   * Delete the topic alltogether. Requires Owner permission.\n   *\n   * @param {string} topicName - Name of the topic to delete\n   * @param {boolean} hard - hard-delete topic.\n   * @returns {Promise} Promise which will be resolved/rejected on receiving server reply.\n   */\n  delTopic(topicName, hard) {\n    const pkt = this.#initPacket('del', topicName);\n    pkt.del.what = 'topic';\n    pkt.del.hard = hard;\n\n    return this.#send(pkt, pkt.del.id);\n  }\n\n  /**\n   * Delete subscription. Requires Share permission.\n   *\n   * @param {string} topicName - Name of the topic to delete\n   * @param {string} user - User ID to remove.\n   * @returns {Promise} Promise which will be resolved/rejected on receiving server reply.\n   */\n  delSubscription(topicName, user) {\n    const pkt = this.#initPacket('del', topicName);\n    pkt.del.what = 'sub';\n    pkt.del.user = user;\n\n    return this.#send(pkt, pkt.del.id);\n  }\n\n  /**\n   * Delete credential. Always sent on <code>'me'</code> topic.\n   *\n   * @param {string} method - validation method such as <code>'email'</code> or <code>'tel'</code>.\n   * @param {string} value - validation value, i.e. <code>'alice@example.com'</code>.\n   * @returns {Promise} Promise which will be resolved/rejected on receiving server reply.\n   */\n  delCredential(method, value) {\n    const pkt = this.#initPacket('del', Const.TOPIC_ME);\n    pkt.del.what = 'cred';\n    pkt.del.cred = {\n      meth: method,\n      val: value\n    };\n\n    return this.#send(pkt, pkt.del.id);\n  }\n\n  /**\n   * Request to delete account of the current user.\n   *\n   * @param {boolean} hard - hard-delete user.\n   * @returns {Promise} Promise which will be resolved/rejected on receiving server reply.\n   */\n  delCurrentUser(hard) {\n    const pkt = this.#initPacket('del', null);\n    pkt.del.what = 'user';\n    pkt.del.hard = hard;\n\n    return this.#send(pkt, pkt.del.id).then(_ => {\n      this._myUID = null;\n    });\n  }\n\n  /**\n   * Notify server that a message or messages were read or received. Does NOT return promise.\n   *\n   * @param {string} topicName - Name of the topic where the mesage is being aknowledged.\n   * @param {string} what - Action being aknowledged, either <code>\"read\"</code> or <code>\"recv\"</code>.\n   * @param {number} seq - Maximum id of the message being acknowledged.\n   * @throws {Error} if <code>seq</code> is invalid.\n   */\n  note(topicName, what, seq) {\n    if (seq <= 0 || seq >= Const.LOCAL_SEQID) {\n      throw new Error(`Invalid message id ${seq}`);\n    }\n\n    const pkt = this.#initPacket('note', topicName);\n    pkt.note.what = what;\n    pkt.note.seq = seq;\n    this.#send(pkt);\n  }\n\n  /**\n   * Broadcast a key-press notification to topic subscribers. Used to show\n   * typing notifications \"user X is typing...\".\n   *\n   * @param {string} topicName - Name of the topic to broadcast to.\n   * @param {string=} type - notification to send, default is 'kp'.\n   */\n  noteKeyPress(topicName, type) {\n    const pkt = this.#initPacket('note', topicName);\n    pkt.note.what = type || 'kp';\n    this.#send(pkt);\n  }\n\n  /**\n   * Send a video call notification to topic subscribers (including dialing,\n   * hangup, etc.).\n   *\n   * @param {string} topicName - Name of the topic to broadcast to.\n   * @param {number} seq - ID of the call message the event pertains to.\n   * @param {string} evt - Call event.\n   * @param {string} payload - Payload associated with this event (e.g. SDP string).\n   */\n  videoCall(topicName, seq, evt, payload) {\n    const pkt = this.#initPacket('note', topicName);\n    pkt.note.seq = seq;\n    pkt.note.what = 'call';\n    pkt.note.event = evt;\n    pkt.note.payload = payload;\n    this.#send(pkt);\n  }\n\n  /**\n   * Send a 'react' note to indicate the user reacted to (or removed reaction from) a message.\n   *\n   * @param {string} topicName - Name of the topic where the message to react to was posted.\n   * @param {int} seq - ID of the message to react to.\n   * @param {string} emo - Emoji string to add as reaction, or Tinode.DEL_CHAR to remove reaction.\n   */\n  react(topicName, seq, emo) {\n    const pkt = this.#initPacket('note', topicName);\n    pkt.note.seq = seq;\n    pkt.note.what = 'react';\n    pkt.note.payload = {\n      emo\n    };\n    this.#send(pkt);\n  }\n\n  /**\n   * Get a named topic, either pull it from cache or create a new instance.\n   * There is a single instance of topic for each name.\n   *\n   * @param {string} topicName - Name of the topic to get.\n   *\n   * @returns {Topic} Requested or newly created topic or <code>undefined</code> if topic name is invalid.\n   */\n  getTopic(topicName) {\n    let topic = this.#cacheGet('topic', topicName);\n    if (!topic && topicName) {\n      if (topicName == Const.TOPIC_ME) {\n        topic = new TopicMe();\n      } else if (topicName == Const.TOPIC_FND) {\n        topic = new TopicFnd();\n      } else {\n        topic = new Topic(topicName);\n      }\n      // Cache management.\n      this.#attachCacheToTopic(topic);\n      topic._cachePutSelf();\n      // Don't save to DB here: a record will be added when the topic is subscribed.\n    }\n    return topic;\n  }\n\n  /**\n   * Get a named topic from cache.\n   *\n   * @param {string} topicName - Name of the topic to get.\n   *\n   * @returns {Topic} Requested topic or <code>undefined</code> if topic is not found in cache.\n   */\n  cacheGetTopic(topicName) {\n    return this.#cacheGet('topic', topicName);\n  }\n\n  /**\n   * Remove named topic from cache.\n   *\n   * @param {string} topicName - Name of the topic to remove from cache.\n   */\n  cacheRemTopic(topicName) {\n    this.#cacheDel('topic', topicName);\n  }\n\n  /**\n   * Iterate over cached topics.\n   *\n   * @param {Function} func - callback to call for each topic.\n   * @param {Object} context - 'this' inside the 'func'.\n   */\n  mapTopics(func, context) {\n    this.#cacheMap('topic', func, context);\n  }\n\n  /**\n   * Check if named topic is already present in cache.\n   *\n   * @param {string} topicName - Name of the topic to check.\n   * @returns {boolean} true if topic is found in cache, false otherwise.\n   */\n  isTopicCached(topicName) {\n    return !!this.#cacheGet('topic', topicName);\n  }\n\n  /**\n   * Generate unique name like <code>'new123456'</code> suitable for creating a new group topic.\n   *\n   * @param {boolean} isChan - if the topic is channel-enabled.\n   * @returns {string} name which can be used for creating a new group topic.\n   */\n  newGroupTopicName(isChan) {\n    return (isChan ? Const.TOPIC_NEW_CHAN : Const.TOPIC_NEW) + this.getNextUniqueId();\n  }\n\n  /**\n   * Instantiate <code>'me'</code> topic or get it from cache.\n   *\n   * @returns {TopicMe} Instance of <code>'me'</code> topic.\n   */\n  getMeTopic() {\n    return this.getTopic(Const.TOPIC_ME);\n  }\n\n  /**\n   * Instantiate <code>'fnd'</code> (find) topic or get it from cache.\n   *\n   * @returns {Topic} Instance of <code>'fnd'</code> topic.\n   */\n  getFndTopic() {\n    return this.getTopic(Const.TOPIC_FND);\n  }\n\n  /**\n   * Create a new {@link LargeFileHelper} instance\n   *\n   * @returns {LargeFileHelper} instance of a {@link Tinode.LargeFileHelper}.\n   */\n  getLargeFileHelper() {\n    return new LargeFileHelper(this, Const.PROTOCOL_VERSION);\n  }\n\n  /**\n   * Get the UID of the the current authenticated user.\n   *\n   * @returns {string} UID of the current user or <code>undefined</code> if the session is not yet\n   * authenticated or if there is no session.\n   */\n  getCurrentUserID() {\n    return this._myUID;\n  }\n\n  /**\n   * Check if the given user ID is equal to the current user's UID.\n   *\n   * @param {string} uid - UID to check.\n   *\n   * @returns {boolean} true if the given UID belongs to the current logged in user.\n   */\n  isMe(uid) {\n    return this._myUID === uid;\n  }\n\n  /**\n   * Get login used for last successful authentication.\n   *\n   * @returns {string} login last used successfully or <code>undefined</code>.\n   */\n  getCurrentLogin() {\n    return this._login;\n  }\n\n  /**\n   * Return information about the server: protocol version and build timestamp.\n   *\n   * @returns {Object} build and version of the server or <code>null</code> if there is no connection or\n   * if the first server response has not been received yet.\n   */\n  getServerInfo() {\n    return this._serverInfo;\n  }\n\n  /**\n   * Report a topic for abuse. Wrapper for {@link Tinode#publish}.\n   *\n   * @param {string} action - the only supported action is 'report'.\n   * @param {string} target - name of the topic being reported.\n   *\n   * @returns {Promise} Promise to be resolved/rejected when the server responds to request.\n   */\n  report(action, target) {\n    return this.publish(Const.TOPIC_SYS, Drafty.attachJSON(null, {\n      'action': action,\n      'target': target\n    }));\n  }\n\n  /**\n   * Return server-provided configuration value.\n   *\n   * @param {string} name - name of the value to return.\n   * @param {Object} defaultValue - value to return in case the parameter is not set or not found.\n   *\n   * @returns {Object} named value.\n   */\n  getServerParam(name, defaultValue) {\n    return this._serverInfo && this._serverInfo[name] || defaultValue;\n  }\n\n  /**\n   * Toggle console logging. Logging is off by default.\n   *\n   * @param {boolean} enabled - Set to <code>true</code> to enable logging to console.\n   * @param {boolean} trimLongStrings - Set to <code>true</code> to trim long strings.\n   */\n  enableLogging(enabled, trimLongStrings) {\n    this._loggingEnabled = enabled;\n    this._trimLongStrings = enabled && trimLongStrings;\n  }\n\n  /**\n   * Set UI language to report to the server. Must be called before <code>'hi'</code> is sent, otherwise it will not be used.\n   *\n   * @param {string} hl - human (UI) language, like <code>\"en_US\"</code> or <code>\"zh-Hans\"</code>.\n   */\n  setHumanLanguage(hl) {\n    if (hl) {\n      this._humanLanguage = hl;\n    }\n  }\n\n  /**\n   * Check if given topic is online.\n   *\n   * @param {string} name - name of the topic to test.\n   * @returns {boolean} true if topic is online, false otherwise.\n   */\n  isTopicOnline(name) {\n    const topic = this.#cacheGet('topic', name);\n    return topic && topic.online;\n  }\n\n  /**\n   * Get access mode for the given contact.\n   *\n   * @param {string} name - name of the topic to query.\n   * @returns {AccessMode} access mode if topic is found, null otherwise.\n   */\n  getTopicAccessMode(name) {\n    const topic = this.#cacheGet('topic', name);\n    return topic ? topic.acs : null;\n  }\n\n  /**\n   * Include message ID into all subsequent messages to server instructing it to send acknowledgements.\n   * Required for promises to function. Default is <code>\"on\"</code>.\n   *\n   * @param {boolean} status - Turn acknowledgements on or off.\n   * @deprecated\n   */\n  wantAkn(status) {\n    if (status) {\n      this._messageId = Math.floor((Math.random() * 0xFFFFFF) + 0xFFFFFF);\n    } else {\n      this._messageId = 0;\n    }\n  }\n\n  // Callbacks:\n  /**\n   * Callback to report when the websocket is opened. The callback has no parameters.\n   *\n   * @type {onWebsocketOpen}\n   */\n  onWebsocketOpen = undefined;\n\n  /**\n   * @typedef ServerParams\n   *\n   * @type {Object}\n   * @property {string} ver - Server version\n   * @property {string} build - Server build\n   * @property {string=} sid - Session ID, long polling connections only.\n   */\n\n  /**\n   * @callback onConnect\n   * @param {number} code - Result code\n   * @param {string} text - Text epxplaining the completion, i.e \"OK\" or an error message.\n   * @param {ServerParams} params - Parameters returned by the server.\n   */\n  /**\n   * Callback to report when connection with Tinode server is established.\n   * @type {onConnect}\n   */\n  onConnect = undefined;\n\n  /**\n   * Callback to report when connection is lost. The callback has no parameters.\n   * @type {onDisconnect}\n   */\n  onDisconnect = undefined;\n\n  /**\n   * @callback onLogin\n   * @param {number} code - NUmeric completion code, same as HTTP status codes.\n   * @param {string} text - Explanation of the completion code.\n   */\n  /**\n   * Callback to report login completion.\n   * @type {onLogin}\n   */\n  onLogin = undefined;\n\n  /**\n   * Callback to receive <code>{ctrl}</code> (control) messages.\n   * @type {onCtrlMessage}\n   */\n  onCtrlMessage = undefined;\n\n  /**\n   * Callback to recieve <code>{data}</code> (content) messages.\n   * @type {onDataMessage}\n   */\n  onDataMessage = undefined;\n\n  /**\n   * Callback to receive <code>{pres}</code> (presence) messages.\n   * @type {onPresMessage}\n   */\n  onPresMessage = undefined;\n\n  /**\n   * Callback to receive all messages as objects.\n   * @type {onMessage}\n   */\n  onMessage = undefined;\n\n  /**\n   * Callback to receive all messages as unparsed text.\n   * @type {onRawMessage}\n   */\n  onRawMessage = undefined;\n\n  /**\n   * Callback to receive server responses to network probes. See {@link Tinode#networkProbe}\n   * @type {onNetworkProbe}\n   */\n  onNetworkProbe = undefined;\n\n  /**\n   * Callback to be notified when exponential backoff is iterating.\n   * @type {onAutoreconnectIteration}\n   */\n  onAutoreconnectIteration = undefined;\n};\n\n// Exported constants\nTinode.MESSAGE_STATUS_NONE = Const.MESSAGE_STATUS_NONE;\nTinode.MESSAGE_STATUS_QUEUED = Const.MESSAGE_STATUS_QUEUED;\nTinode.MESSAGE_STATUS_SENDING = Const.MESSAGE_STATUS_SENDING;\nTinode.MESSAGE_STATUS_FAILED = Const.MESSAGE_STATUS_FAILED;\nTinode.MESSAGE_STATUS_FATAL = Const.MESSAGE_STATUS_FATAL;\nTinode.MESSAGE_STATUS_SENT = Const.MESSAGE_STATUS_SENT;\nTinode.MESSAGE_STATUS_RECEIVED = Const.MESSAGE_STATUS_RECEIVED;\nTinode.MESSAGE_STATUS_READ = Const.MESSAGE_STATUS_READ;\nTinode.MESSAGE_STATUS_TO_ME = Const.MESSAGE_STATUS_TO_ME;\n\n// Unicode [del] symbol.\nTinode.DEL_CHAR = Const.DEL_CHAR;\n\n// Names of keys to server-provided configuration limits.\nTinode.MAX_MESSAGE_SIZE = Const.MAX_MESSAGE_SIZE;\nTinode.MAX_SUBSCRIBER_COUNT = Const.MAX_SUBSCRIBER_COUNT;\nTinode.MIN_TAG_LENGTH = Const.MIN_TAG_LENGTH;\nTinode.MAX_TAG_LENGTH = Const.MAX_TAG_LENGTH;\nTinode.MAX_TAG_COUNT = Const.MAX_TAG_COUNT;\nTinode.MAX_FILE_UPLOAD_SIZE = Const.MAX_FILE_UPLOAD_SIZE;\nTinode.REQ_CRED_VALIDATORS = Const.REQ_CRED_VALIDATORS;\nTinode.MSG_DELETE_AGE = Const.MSG_DELETE_AGE;\nTinode.REACTION_LIST = Const.REACTION_LIST;\nTinode.MAX_REACTIONS = Const.MAX_REACTIONS;\n\n// Tinode URI topic ID prefix, 'scheme:path/'.\nTinode.URI_TOPIC_ID_PREFIX = 'tinode:topic/';\nTinode.URI_TOPIC_ALIAS_PREFIX = 'tinode:alias/';\n\n// Tag prefixes for alias, email, phone.\nTinode.TAG_ALIAS = Const.TAG_ALIAS;\nTinode.TAG_EMAIL = Const.TAG_EMAIL;\nTinode.TAG_PHONE = Const.TAG_PHONE;\n"],"names":["root","factory","exports","module","define","amd","this","DRAFTY_MIME_TYPE","DRAFTY_FR_MIME_TYPE","ALLOWED_ENT_FIELDS","segmenter","Intl","Segmenter","INLINE_STYLES","name","start","end","FMT_WEIGHT","ENTITY_TYPES","dataName","pack","val","test","url","re","slice","FORMAT_TAGS","AU","html_tag","md_tag","undefined","isVoid","BN","BR","CO","DL","EM","EX","FM","HD","HL","HT","IM","LN","MN","RW","QQ","ST","TC","VC","VD","base64toObjectUrl","b64","contentType","logger","bin","atob","length","buf","ArrayBuffer","arr","Uint8Array","i","charCodeAt","URL","createObjectURL","Blob","type","err","message","base64toDataUrl","DECORATORS","open","_","close","data","props","href","target","id","act","ref","mime","Drafty","src","duration","size","tmpPreviewUrl","_tempPreview","previewUrl","downloadUrl","width","height","title","alt","fn","state","preview","premime","poster","preref","txt","fmt","ent","chunkify","line","spans","chunks","span","at","push","chunk","tp","chld","children","toSpanTree","tree","last","draftyToTree","doc","Array","isArray","text","len","key","attachments","forEach","includes","stringToGraphemes","sort","a","b","diff","indexOf","graphemes","spansToTree","treeTopDown","node","child","parent","addNode","n","map","segment","join","att","subspans","inner","tag","treeToDrafty","keymap","c","Object","keys","newKey","transformer","context","dst","call","treeBottomUp","formatter","index","stack","values","pop","shortenTree","limit","tail","lightEntity","allow","copyEntData","lTrim","trimStart","shift","attachmentsToEnd","isFormResponseType","concat","draftify","startAt","plain","ranges","drafty","light","entries","dc","isEmptyObject","obj","toGraphemeValues","segments","indices","result","graphemeIndex","charIndex","graphemeIndices","correctAt","str","from","init","plainText","parse","content","lines","split","entityMap","entityIndex","blx","entities","block","original","re_start","re_end","exec","start_offset","lastIndexOf","end_offset","spannify","match","extracted","entity","offset","unique","idx","filter","el","extractEntities","ele","s","correctLen","append","first","second","insertImage","imageDesc","ex","refurl","bits","filename","urlPromise","_processing","then","insertVideo","videoDesc","urls","insertAudio","audioDesc","videoCall","audioOnly","aonly","updateVideoCall","params","assign","quote","header","uid","body","appendLineBreak","mention","appendLink","linkData","appendImage","appendAudio","attachFile","attachmentDesc","wrapInto","style","wrapAsForm","insertButton","actionType","actionValue","refUrl","appendButton","attachJSON","appendTheCard","theCardData","UNSAFE_toHTML","format","shorten","forwardedContent","replyContent","startsWith","forwarding","toPlainText","isPlainText","toMarkdown","def","isValid","txt_type","hasAttachments","callback","count","hasEntities","styles","sanitizeEntities","getDownloadUrl","entData","isProcessing","getPreviewUrl","getEntitySize","getEntityMimeType","tagName","attrValue","getContentType","mimeType","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","__webpack_modules__","getter","__esModule","d","definition","o","defineProperty","enumerable","get","g","globalThis","Function","e","window","prop","prototype","hasOwnProperty","r","Symbol","toStringTag","value","AccessMode","constructor","acs","given","decode","want","mode","side","flag","Error","_BITMASK","_NONE","bitmask","_JOIN","_READ","_WRITE","_PRES","_APPROVE","_SHARE","_DELETE","_OWNER","m0","bit","charAt","toUpperCase","encode","_INVALID","res","update","upd","action","val0","parts","a1","a2","toString","jsonHelper","setMode","m","updateMode","u","getMode","setGiven","updateGiven","getGiven","setWant","w","updateWant","getWant","getMissing","getExcessive","updateAll","isOwner","isPresencer","isMuted","isJoiner","isReader","isWriter","isApprover","isAdmin","isSharer","isDeleter","VERSION","LIBRARY","TOPIC_NEW","TOPIC_NEW_CHAN","TOPIC_ME","TOPIC_FND","TOPIC_GRP","LOCAL_SEQID","DEL_CHAR","TAG_ALIAS","REACTION_LIST","MAX_REACTIONS","CommError","code","super","jsonParseHelper","date","Date","isNaN","isUrlRelative","isValidDate","getTime","mergeObj","console","warn","mergeToCache","cache","newval","simplify","getOwnPropertyNames","normalizeRanges","maxSeq","r1","r2","low","hi","reduce","out","prev","Math","max","listToRanges","list","WebSocketProvider","XHRProvider","NETWORK_ERROR_TEXT","NETWORK_USER","NETWORK_USER_TEXT","makeBaseUrl","host","protocol","version","apiKey","Connection","static","secure","autoreconnect","initialized","config","version_","autoreconnect_","transport","setNetworkProviders","wsProvider","xhrProvider","l","connect","host_","force","Promise","reject","reconnect","disconnect","sendText","msg","isConnected","probe","backoffReset","clearTimeout","timeout","pow","random","onAutoreconnectIteration","setTimeout","prom","catch","_lpURL","_poller","_sender","lp_poller","url_","resolve","poller","promiseCompleted","onreadystatechange","evt","readyState","status","pkt","JSON","responseText","ctrl","sid","send","onOpen","onMessage","onDisconnect","abort","sender","lp_sender","OPEN","conn","onerror","onopen","onclose","onmessage","NETWORK_ERROR","DB_NAME","IDBProvider","DB","db","disabled","onError","source","trx","transaction","event","error","objectStore","getAll","onsuccess","topic","initDatabase","req","onversionchange","onupgradeneeded","objectStoreNames","contains","createObjectStore","keyPath","dellog","indexNames","createIndex","deleteDatabase","onblocked","isReady","updTopic","oncomplete","put","commit","markTopicAsDeleted","deleted","_deleted","remTopic","delete","IDBKeyRange","only","bound","Number","MAX_SAFE_INTEGER","mapTopics","deserializeTopic","updUser","pub","arguments","public","remUser","mapUsers","getUser","user","updSubscription","topicName","sub","mapSubscriptions","addMessage","add","updMessageStatus","seq","_status","updMessageReact","react","remMessages","to","range","readMessages","query","msgs","since","before","openCursor","cursor","continue","addDelLog","delId","clear","readDelLog","entry","maxDelId","f","tags","_tags","setAccessMode","read","unread","getAccessMode","setDatabaseProvider","idbProvider","LargeFileHelper","tinode","_tinode","_version","_apiKey","_authToken","getAuthToken","xhr","uploadWithBaseUrl","baseUrl","avatarFor","onProgress","onSuccess","onFailure","base","endsWith","instance","setRequestHeader","token","toResolve","toReject","upload","onprogress","lengthComputable","loaded","total","onload","response","statusText","onabort","form","FormData","set","getNextUniqueId","_secure","_host","download","relativeUrl","mimetype","relUrl","location","origin","searchParams","substring","addURLParam","responseType","link","document","createElement","display","setAttribute","appendChild","click","removeChild","revokeObjectURL","reader","FileReader","readAsText","cancel","setNetworkProvider","MetaGetBuilder","what","updated","isP2PType","_lastSubsUpdate","withData","withLaterData","_maxSeq","withDataRanges","withDataList","withEarlierData","_minSeq","withDesc","ims","withLaterDesc","withSub","userOrTopic","opts","getType","withOneSub","withLaterOneSub","withLaterSub","withTags","withCred","withAux","withDel","withLaterDel","_maxDel","extract","build","CBuffer","buffer","compare_","unique_","elem","exact","pivot","found","splice","getAt","getLast","findLast","insert","delAt","delRange","reset","startIdx","beforeIdx","min","find","nearest","isEmpty","Topic","callbacks","created","touched","private","trusted","recv","mrrid","_users","_queuedSeqId","Const","_noEarlierMsgs","_mrrSeen","_recvNotificationTimer","_credentials","_aux","_messageVersions","_messages","_attached","_new","_delayedLeaveTimer","onData","onMeta","onPres","onInfo","onMetaDesc","onMetaSub","onSubsUpdated","onTagsUpdated","onCredsUpdated","onAuxUpdated","onReact","onDeleteTopic","onAllMessagesReceived","topicType","isMeTopicName","isSelfTopicName","isGroupTopicName","isP2PTopicName","isCommTopicName","isNewGroupTopicName","isChannelTopicName","head","replace","isSubscribed","subscribe","getParams","setParams","_cacheDelSelf","_cachePutSelf","ts","me","getMeTopic","desc","_noForwarding","_processMetaDesc","createMessage","noEcho","publish","publishMessage","_sending","_failed","swapMessageId","_maybeUpdateMessageVersionsCache","_routeData","publishDraft","_getQueuedSeqId","getCurrentUserID","noecho","_db","_cancelled","_fatal","leave","unsub","_resetSub","_gone","leaveDelayed","delay","getMeta","getMessagesPage","gaps","newer","startMetaQuery","_loadMessages","msgHasMoreMessages","getPinnedMessages","pins","aux","remains","setMeta","t","trim","toLowerCase","item","pos","ary","normalizeArray","_processMetaSubs","_processMetaTags","cred","_processMetaCreds","_processMetaAux","_processMetaReact","subscriber","am","invite","archive","arch","pinMessage","pin","pinned","changed","pinTopic","pinnedTopicRank","emo","msgMyReaction","reactions","vals","getServerParam","maxReactions","markReactionsSeen","_refreshContact","delMessages","hard","tosend","del","rec","flushMessageRange","flushMessage","delMessagesAll","hardDel","_all","delMessagesList","delMessagesEdits","messageVersions","delTopic","delSubscription","note","_updateMyReadRecv","noteRecv","noteRead","noteKeyPress","noteRecording","payload","oldVal","doUpdate","userDesc","_cacheGetUser","p2pPeerDesc","subscribers","cb","alias","origSeq","versions","messages","sinceId","beforeId","unused1","unused2","latest","latestMsgVersion","_origTs","_origSeq","findMessage","latestMessage","maxMsgSeq","minMsgSeq","maxClearId","messageCount","queuedMessages","msgReceiptCount","msgReadCount","msgRecvCount","msgReactions","users","hasUnseenReactions","gap","p","expected","isNewMessage","seqId","fromId","untilId","newSeqId","numMessages","cancelSend","msgStatus","getDefaultAccess","defacs","isArchived","isMeType","isSelfType","isChannelType","isGroupType","isCommType","isMe","targetSeq","parseInt","targetMsg","outgoing","webrtc","incoming","vc","maxReact","_routeInfo","_routeMeta","meta","_processDelMessages","delseq","_routePres","pres","online","isTopicCached","id2","dacs","info","subs","subcnt","_updateCachedUser","creds","_handleReactionDiff","delta","reacts","findIndex","existing","userIdx","emoIndex","oneReaction","_diff","seqIds","mr","_allMessagesReceived","_maxReact","cached","_cachePutUser","_updateReceived","TopicFnd","_contacts","updateCount","indexBy","getPrototypeOf","checkTagUniqueness","caller","contacts","TopicMe","onContactUpdate","turnOff","_myUID","cont","seen","when","cacheRemTopic","getTopic","cr","meth","done","resp","cacheGetTopic","tgt","ua","actor","dummy","delCredential","method","getContact","getCredentials","tpin","unshift","THE_CARD_MIME_TYPE","TheCard","imageUrl","imageMimeType","card","matches","photo","theCard","merge","that","stringify","addOrSetComm","proto","setOnly","comm","des","clearComm","IndexedDBProvider","b64EncodeUnicode","btoa","encodeURIComponent","p1","String","fromCharCode","jsonBuildHelper","pad","sp","repeat","millis","getUTCMilliseconds","getUTCFullYear","getUTCMonth","getUTCDate","getUTCHours","getUTCMinutes","getUTCSeconds","rfc3339DateString","jsonLoggerHelper","setFn","getFn","setNote","setPhoto","ext","getPhotoUrl","getOrg","org","setPhone","phone","setEmail","email","setTinodeID","tinodeID","addPhone","addEmail","addTinodeID","clearPhone","clearEmail","clearTinodeID","getComm","getEmails","getPhones","getFirstTinodeID","comms","exportVCard","vcard","surname","additional","prefix","suffix","bday","year","y","padStart","month","day","types","importVCard","vcardStr","rawLines","currentLine","commMap","Map","unescapeValue","char","decodeQuotedPrintable","bytes","hex","uint8Array","TextDecoder","keyPart","valueParts","keyParams","isQuotedPrintable","some","param","processedValue","dateStr","noHyphens","yy","cleaned","encoding","pKey","pValue","flatMap","equalIndex","mapKey","has","Set","isFileSupported","WebSocket","XMLHttpRequest","indexedDB","chars","global","input","output","charCode","bc","bs","DBCache","initForNonBrowserApp","Tinode","_appName","_browser","_platform","_hwos","_humanLanguage","_loggingEnabled","_trimLongStrings","_authenticated","_login","_inPacketCount","_messageId","floor","_serverInfo","_deviceToken","_pendingPromises","_expirePromises","_connection","_persist","_cache","onComplete","appName","platform","navigator","product","reactnative","priority","tmp","substr","tokens","m2","v","minor","getBrowserInfo","userAgent","language","detectTransport","promise","persist","all","args","dateString","log","onOK","errorText","onRawMessage","onNetworkProbe","onCtrlMessage","onMetaMessage","onDataMessage","onPresMessage","onInfoMessage","setInterval","expires","hello","clearInterval","func","_cacheDelUser","onLogin","credential","getVersion","getLibrary","isNullValue","isServerAssignedSeq","isValidTagValue","tagSplit","splitAt","setUniqueTag","uniqueTag","clearTagPrefix","tagByPrefix","clearStorage","initStorage","networkProbe","isAuthenticated","authorizeURL","parsed","account","scheme","secret","login","acc","tmpscheme","tmpsecret","extra","createAccount","createAccountBasic","username","password","updateAccountBasic","onConnect","setDeviceToken","dt","sent","loginBasic","uname","loginToken","requestResetAuthSecret","now","setAuthToken","dft","oobNotification","xfrom","finally","modeGiven","modeWant","delCurrentUser","newGroupTopicName","isChan","getFndTopic","getLargeFileHelper","getCurrentLogin","getServerInfo","report","defaultValue","enableLogging","enabled","trimLongStrings","setHumanLanguage","hl","isTopicOnline","getTopicAccessMode","wantAkn","onWebsocketOpen","MESSAGE_STATUS_NONE","MESSAGE_STATUS_QUEUED","MESSAGE_STATUS_SENDING","MESSAGE_STATUS_FAILED","MESSAGE_STATUS_FATAL","MESSAGE_STATUS_SENT","MESSAGE_STATUS_RECEIVED","MESSAGE_STATUS_READ","MESSAGE_STATUS_TO_ME","MAX_MESSAGE_SIZE","MAX_SUBSCRIBER_COUNT","MIN_TAG_LENGTH","MAX_TAG_LENGTH","MAX_TAG_COUNT","MAX_FILE_UPLOAD_SIZE","REQ_CRED_VALIDATORS","MSG_DELETE_AGE","URI_TOPIC_ID_PREFIX","URI_TOPIC_ALIAS_PREFIX","TAG_EMAIL","TAG_PHONE"],"ignoreList":[],"sourceRoot":""}